---
title: システム状態とベア メタル回復保護
description: Azure Backup Server を使用して、システム状態をバックアップし、ベア メタル回復 (BMR) 保護を実現します。
ms.topic: conceptual
ms.date: 05/15/2017
ms.openlocfilehash: 864a20ce806d1bf8e9e728c77a9c8f17adeed18b
ms.sourcegitcommit: f6e2ea5571e35b9ed3a79a22485eba4d20ae36cc
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 09/24/2021
ms.locfileid: "128656191"
---
# <a name="back-up-system-state-and-restore-to-bare-metal-by-using-azure-backup-server"></a>Azure Backup Server を使用してシステム状態をバックアップし、ベア メタルに復元する

Azure Backup Server は、システム状態をバックアップし、ベア メタル回復 (BMR) 保護を提供します。

* **システム状態のバックアップ**: オペレーティング システム ファイルをバックアップします。 このバックアップでは、コンピューターの起動時に回復を行えます。ただし、システム ファイルとレジストリは失われます。 システム状態のバックアップに含まれる要素は次のとおりです。
  * ドメインのメンバー: ブート ファイル、COM+ クラス登録データベース、レジストリ
  * ドメイン コントローラー:Windows Server Active Directory (NTDS)、ブート ファイル、COM+ クラス登録データベース、レジストリ、システム ボリューム (SYSVOL)
  * クラスター サービスを実行しているコンピューター: クラスター サーバーのメタデータ
  * 証明書サービスを実行しているコンピューター: 証明書データ
* **ベア メタル バックアップ**: オペレーティング システム ファイルと重要なボリューム上のすべてのデータ (ユーザー データを除く) をバックアップします。 定義上、BMR バックアップには、システム状態のバックアップが含まれます。 これは、コンピューターが起動せず、すべてを復旧する必要があるときの保護を提供します。

次の表は、バックアップと復旧を実行できる項目のまとめです。 システム状態と BMR で保護できるアプリのバージョンについては、[Azure Backup Server のバックアップ内容](backup-mabs-protection-matrix.md)に関するページを参照してください。

|バックアップ|問題|Azure Backup Server バックアップからの復旧|システム状態のバックアップからの復旧|BMR|
|----------|---------|---------------------------|------------------------------------|-------|
|**ファイル データ**<br /><br />通常のデータ バックアップ<br /><br />BMR/システム状態のバックアップ|失われたファイル データ|Y|N|N|
|**ファイル データ**<br /><br />ファイル データの Azure Backup Server のバックアップ<br /><br />BMR/システム状態のバックアップ|失われた、または壊れているオペレーティング システム|×|Y|Y|
|**ファイル データ**<br /><br />ファイル データの Azure Backup Server のバックアップ<br /><br />BMR/システム状態のバックアップ|サーバーの損失 (データ ボリュームは正常)|N|N|Y|
|**ファイル データ**<br /><br />ファイル データの Azure Backup Server のバックアップ<br /><br />BMR/システム状態のバックアップ|失われたサーバー (データ ボリュームが失われた状態)|Y|N|Y<br /><br />BMR (この後にバックアップ ファイル データの通常回復を実行)|
|**SharePoint データ**<br /><br />ファーム データの Azure Backup Server のバックアップ<br /><br />BMR/システム状態のバックアップ|サイト、リスト、リスト アイテム、ドキュメントの損失|Y|N|N|
|**SharePoint データ**<br /><br />ファーム データの Azure Backup Server のバックアップ<br /><br />BMR/システム状態のバックアップ|失われた、または壊れているオペレーティング システム|×|Y|Y|
|**SharePoint データ**<br /><br />ファーム データの Azure Backup Server のバックアップ<br /><br />BMR/システム状態のバックアップ|障害復旧|N|N|N|
|Windows Server 2012 R2 Hyper-V<br /><br />HYPER-V ホストまたはゲストの Azure Backup Server のバックアップ<br /><br />BMR/ホストのシステム状態のバックアップ|失われた VM|Y|N|N|
|Hyper-V<br /><br />HYPER-V ホストまたはゲストの Azure Backup Server のバックアップ<br /><br />BMR/ホストのシステム状態のバックアップ|失われた、または壊れているオペレーティング システム|×|Y|Y|
|Hyper-V<br /><br />HYPER-V ホストまたはゲストの Azure Backup Server のバックアップ<br /><br />BMR/ホストのシステム状態のバックアップ|失われた Hyper-V ホスト (VM は完全な状態)|×|N|Y|
|Hyper-V<br /><br />HYPER-V ホストまたはゲストの Azure Backup Server のバックアップ<br /><br />BMR/ホストのシステム状態のバックアップ|失われた Hyper-V ホスト (VM が失われた状態)|×|N|Y<br /><br />BMR、この後に通常の Azure Backup Server の回復を実行|
|SQL Server/Exchange<br /><br />Azure Backup Server のアプリのバックアップ<br /><br />BMR/システム状態のバックアップ|失われたアプリ データ|Y|×|×|
|SQL Server/Exchange<br /><br />Azure Backup Server のアプリのバックアップ<br /><br />BMR/システム状態のバックアップ|失われた、または壊れているオペレーティング システム|×|Y|Y|
|SQL Server/Exchange<br /><br />Azure Backup Server のアプリのバックアップ<br /><br />BMR/システム状態のバックアップ|失われたサーバー (データベース/トランザクション ログは完全な状態)|×|×|Y|
|SQL Server/Exchange<br /><br />Azure Backup Server のアプリのバックアップ<br /><br />BMR/システム状態のバックアップ|失われたサーバー (データベース/トランザクション ログが失われた状態)|N|N|Y<br /><br />BMR 回復、この後に通常の Azure Backup Server の回復を実行|

## <a name="how-system-state-backup-works"></a>システム状態のバックアップのしくみ

システム状態のバックアップを実行すると、Backup Server は、Windows Server バックアップと通信し、サーバーのシステム状態のバックアップを要求します。 既定では、Backup Server および Windows Server バックアップは、使用可能な空き領域が最大であるドライブを使用します。 このドライブについての情報は、*PSDataSourceConfig.xml* ファイルに保存されています。

Backup Server によってシステム状態のバックアップに使用されるドライブはカスタマイズできます。

1. 保護されたサーバーで、*C:\Program Files\Microsoft Data Protection Manager\MABS\Datasources* に移動します。
1. *PSDataSourceConfig.xml* ファイルを開き、編集します。
1. ドライブ文字の \<FilesToProtect\> 値を変更します。
1. ファイルを保存して閉じます。

コンピューターのシステム状態を保護するよう保護グループが設定されている場合、整合性チェックを実行します。 アラートが生成される場合は、アラートで **[保護グループの変更]** を選択し、ウィザードのページを完了します。 別の整合性チェックを実行します。

保護サーバーがクラスター内にある場合は、空き領域が最大のドライブとしてクラスター ドライブを選択できます。 そのドライブの所有権が別のノードに切り替わり、システム状態バックアップが実行されると、ドライブは使用できず、バックアップが失敗します。 このシナリオでは、*PSDataSourceConfig.xml* を変更してローカル ドライブを指すようにします。

次に、Windows Server バックアップによって、復元フォルダーのルートに *WindowsImageBackup* という名前のフォルダーが作成されます。 Windows Server バックアップがバックアップを作成するとき、すべてのデータがこのフォルダーに配置されます。 バックアップが完了したら、ファイルは Backup Server コンピューターに転送されます。 次の情報をメモしておきます。

* このフォルダーとその内容は、バックアップまたは転送が完了してもクリーンアップされません。 これを考慮する最適な方法は、次回のバックアップの完了に備えて領域を確保することです。
* フォルダーはバックアップのたびに作成されます。 時刻と日付のタイムスタンプは、最後のシステム状態のバックアップの時刻です。

## <a name="how-bmr-backup-works"></a>BMR バックアップのしくみ

BMR (システム状態のバックアップを含む) では、バックアップ ジョブは Backup Server のコンピューター上の共有に直接保存されます。 保護されるサーバー上のフォルダーには保存されません。

Backup Server は、Windows Server バックアップを呼び出し、その BMR バックアップのレプリカ ボリュームを共有します。 この場合、空き容量が最大のドライブが Windows Server バックアップで使用される必要はありません。 代わりに、ジョブ用に作成された共有を使用します。

バックアップが完了したら、ファイルは Backup Server コンピューターに転送されます。 ログは *C:\Windows\Logs\WindowsServerBackup* に格納されます。

## <a name="prerequisites-and-limitations"></a>前提条件と制限事項

* BMR は、Windows Server 2003 を実行しているコンピューターまたはクライアントのオペレーティング システムを実行しているコンピューターではサポートされません。

* 別の保護グループで同じコンピューターの BMR とシステム状態を保護することはできません。

* Backup Server のコンピューターは自身を保護して BMR を行うことはできません。

* テープへの短時間の保護 (Disk to Tape または D2T) は BMR ではサポートされていません。 テープへの長期保管 (Disk to Disk to Tape または D2D2T) はサポートされています。

* BMR 保護では、Windows Server バックアップを保護対象のコンピューターにインストールする必要があります。

* BMR 保護では、システム状態保護と異なり、Backup Server には保護されたコンピューターの容量要件がありません。 Windows Server バックアップは、Backup Server のコンピューターにバックアップを直接転送します。 バックアップ転送ジョブは、Backup Server の **[ジョブ]** ビューには表示されません。

* Backup Server は、BMR 用にレプリカ ボリュームに 30 GB の領域を予約しています。 この領域の割り当ては、保護グループの変更ウィザードの **[ディスクの割り当て]** ページで変更できます。 または、Get-DatasourceDiskAllocation and Set-DatasourceDiskAllocation PowerShell コマンドレットを使用できます。 復旧ポイント ボリュームでは、BMR 保護で 5 日間保持するために約 6 GB が必要です。
  * レプリカ ボリュームのサイズを 15 GB 未満に減らすことはできません。
  * Backup Server は、BMR データ ソースのサイズを計算しません。 すべてのサーバーに 30 GB を想定しています。 環境内の予想される BMR バックアップのサイズに基づいて値を変更します。 BMR バックアップのサイズは、すべての重要なボリュームの使用済み領域の合計として概算できます。 重要なボリューム = ブート ボリューム + システム ボリューム + Active Directory などのシステム状態データをホストしているボリューム。

* システム状態保護から BMR 保護に変更する場合は、BMR 保護に必要な "*回復ポイントのボリューム*" 上の領域が少なくなります。 ただし、ボリューム上の余分なスペースは再利用されません。 ボリューム サイズは、保護グループの変更ウィザードの **[ディスク割り当ての変更]** ページで手動で縮小できます。 または、Get-DatasourceDiskAllocation and Set-DatasourceDiskAllocation PowerShell コマンドレットを使用できます。

    システム状態保護から BMR 保護に変更する場合は、BMR 保護に必要な "*レプリカ ボリューム*" 上の領域が多くなります。 このボリュームは自動的に拡張されます。 既定の領域割り当てを変更したい場合は、Modify-DiskAllocation PowerShell コマンドレットを使用します。

* BMR 保護からシステム状態保護に変更する場合は、回復ポイントのボリューム上の必要な領域が多くなります。 Backup Serverは、このボリュームを自動的に増やそうとする場合があります。 記憶域プールに十分な領域がない場合は、エラーが発生します。

    BMR 保護からシステム状態保護に変更する場合は、保護されたコンピューター上に領域が必要になります。 領域が必要な理由は、システム状態保護ではレプリカをローカル コンピューターに書き込んだうえで Backup Server コンピューターに転送するためです。

## <a name="before-you-begin"></a>開始する前に

1. **Azure Backup Server をデプロイ** します。 Backup Server が正しくデプロイされていることを確認します。 詳細については、次を参照してください。
    * [Azure Backup Server のシステム要件](/system-center/dpm/install-dpm#setup-prerequisites)
    * [Backup Server の保護マトリックス](backup-mabs-protection-matrix.md)

1. **記憶域をセットアップ** します。 Azure では、ディスク、テープ、およびクラウドにバックアップ データを格納できます。 詳細については、[データ記憶域の準備](/system-center/dpm/plan-long-and-short-term-data-storage)に関するページを参照してください。

1. **保護エージェントをセットアップ** します。 バックアップを作成するコンピューターに保護エージェントをインストールします。 詳細については、[DPM 保護エージェントのデプロイ](/system-center/dpm/deploy-dpm-protection-agent)に関するページを参照してください。

## <a name="back-up-system-state-and-bare-metal"></a>システム状態とベア メタルのバックアップ

システム状態とベア メタルをバックアップするには:

1. Backup Server 管理者コンソールで新しい保護グループの作成ウィザードを開くには、 **[保護]**  >  **[アクション]**  >  **[保護グループの作成]** の順に選択します。

1. **[保護グループの種類の選択]** ページで、 **[サーバー]** を選択し、 **[次へ]** を選択します。

1. **[グループ メンバーの選択]** ページで、コンピューターを展開して、**BMR** または **システム状態** のいずれかを選択します。

    別のグループで同じコンピューターの BMR とシステム状態の両方を保護することはできません。 また、BMR を選択した場合、システム状態は自動的に有効になります。 詳細については、[保護グループのデプロイ](/system-center/dpm/create-dpm-protection-groups)に関するページを参照してください。

1. **[データの保護方法の選択]** ページで、短期バックアップと長期バックアップを処理する方法を選択します。

    短期バックアップは常にディスクへのバックアップが優先されますが、Azure Backup を使用してディスクから Azure にバックアップするオプションもあります (短期または長期)。 クラウドへの長期バックアップの代替方法は、スタンドアロン テープ デバイスまたは Backup Server に接続されているテープ ライブラリへの長期バックアップのセットアップです。

1. **[短期的な目標値の選択]** ページで、ディスクで短期的なストレージにバックアップする方法を選択します。
    * **[保有期間の範囲]** では、ディスクにデータを保持する期間を選択します。
    * **[同期の頻度]** では、ディスクへの増分バックアップを実行する頻度を選択します。 バックアップの間隔を設定しない場合は、 **[回復ポイントの直前]** を選択できます。 各回復ポイントがスケジュールされる直前に、Backup Server によって高速完全バックアップが実行されます。

1. 長期保管でテープにデータを格納する場合、 **[長期的な目標の指定]** ページで、テープのデータを保持する期間を選択します (1 から 99 年)。
    1. **[バックアップの頻度]** では、テープへのバックアップを実行する頻度を選択します。 頻度は、選択した保有期間の範囲に基づいています。
        * 保有期間の範囲が 1 から 99 年の場合は、毎日、毎週、隔週、毎月、四半期ごと、半年ごと、または毎年のバックアップを行えます。
        * 保有期間の範囲が 1 から 11 か月間の場合は、毎日、毎週、隔週、または毎月のバックアップを行えます。
        * 保有期間の範囲が 1 から 4 週の場合は、毎日または毎週のバックアップを行えます。

    1. **[テープとライブラリの詳細の選択]** ページでは、使用するテープとライブラリを選択します。 さらに、データを圧縮および暗号化するかどうかも選択します。

1. **[ディスク割り当ての確認]** ページでは、保護グループで使用可能な記憶域プール ディスク領域を確認します。

    * **合計データ サイズ** は、バックアップするデータのサイズです。
    * **Azure Backup Server でプロビジョニングされるディスク領域** は、Backup Server が保護グループ用に推奨する領域です。 Backup Server では、これらの設定を使用して理想的なバックアップ ボリュームを選択します。 **[Disk allocation details]\(ディスク割り当ての詳細\)** でバックアップ ボリュームの選択を編集できます。
    * ワークロードの場合、ドロップダウン メニューで、優先ストレージを選択します。 編集すると、 **[利用できるディスク ストレージ]** ウィンドウの **[ストレージの合計]** と **[空きストレージ]** の値が変わります。 過小にプロビジョニングされた領域は、スムーズなバックアップを確実に行うためにボリュームに追加するよう Backup Server から推奨されるストレージの量です。

1. **[レプリカの作成方法の選択]** ページで、最初の全データのレプリケーションを処理する方法を選択します。

    ネットワーク経由でレプリケートする場合、ピーク時以外を選択することをお勧めします。 データが大量にある場合や、ネットワークの状態が最適でない場合は、リムーバブル メディアを使用してオフラインでデータをレプリケートすることを検討してください。

1. **[整合性チェック オプションの選択]** ページで、整合性チェックを自動化する方法を選択します。

    整合性チェックは、レプリカ データが不整合になったときにのみ実行することや、スケジュールどおりに実行することを選択できます。 自動整合性チェックを構成しない場合は、いつでも手動でチェックを実行できます。 Backup Server 管理者コンソールの **保護** 領域で保護グループを右クリックし、 **[整合性チェックの実行]** を選択します。

1. Azure Backup を使用してクラウドにバックアップするよう選択した場合、 **[オンライン保護するデータの指定]** ページで、Azure にバックアップしたいワークロードを選択します。

1. **[オンライン バックアップ スケジュールの指定]** ページで、Azure への増分バックアップを行う頻度を選択します。

    毎日、毎週、毎月、毎年でバックアップの実行をスケジュールできます。 さらに、バックアップが実行される時刻と日付も選択できます。 バックアップは、最大 1 日に 2 回実行できます。 バックアップが実行されるたびに、Backup Server のディスクに格納されたバックアップ データのコピーから Azure にデータ回復ポイントが作成されます。

1. **[オンライン保持ポリシーの指定]** ページで、毎日、毎週、毎月、毎年のバックアップから作成される回復ポイントを Azure に保持する方法を選択します。

1. **[オンライン レプリケーションの選択]** ページで、最初の全データ レプリケーションの実行方法を選択します。

    ネットワーク経由でのレプリケーションまたはオフライン バックアップ (オフライン シード処理) を行えます。 オフライン バックアップでは、Azure のインポート機能を使用します。 詳細については、「[Azure Backup でのオフライン バックアップのワークフロー](offline-backup-azure-data-box.md)」を参照してください。

1. **[概要]** ページで、設定を確認します。 **[グループの作成]** を選択した後、データの初期レプリケーションが実行されます。 データのレプリケーションが終了すると、 **[ステータス]** ページで保護グループの状態が **[OK]** になります。 その後、保護グループの設定に従ってバックアップが実行されます。

## <a name="recover-system-state-or-bmr"></a>システム状態または BMR の回復

BMR またはシステム状態をネットワークの場所に回復できます。 BMR をバックアップした場合は、Windows 回復環境 (WinRE) を使用して、システムを起動し、ネットワークに接続します。 次に、Windows Server バックアップを使用して、ネットワークの場所から回復します。 システム状態をバックアップした場合は、Windows Server バックアップを使用して、ネットワークの場所から回復するだけです。

### <a name="restore-bmr"></a>BMR の復元

Backup Server コンピューターで回復を実行するには:

1. **[回復]** ペインで、回復したいコンピューターを検索します。 次に、 **[ベア メタル回復]** を選択します。

1. 使用可能な復旧ポイントがカレンダーに太字で示されます。 使用する復旧ポイントの日時を選択します。

1. **[回復の種類の選択]** ページで **[ネットワーク フォルダーにコピーする]** を選択します。

1. **[宛先の指定]** ページでデータのコピー先を選びます。

    宛先にはデータ用の空き領域が十分に必要であることに注意してください。 宛先として新しいフォルダーを作成することをお勧めします。

1. **[回復オプションの指定]** ページで、セキュリティ設定を選択します。 次に、回復を迅速に行うために、記憶域ネットワーク (SAN) ベースのハードウェア スナップショットを使用するかどうかを選択します。 このオプションが使用できるのは次の場合のみです。
    * この機能を実現する SAN がある。
    * クローンを作成して書き込み可能な状態に分割できる。
    * 保護されるコンピューターと Backup Server コンピューターが同じネットワークに接続されている。

1. 通知オプションを設定します。
1. **[確認]** ページで **[回復]** を選択します。

共有の場所を設定するには:

1. 復元場所で、バックアップのあるフォルダーに移動します。

1. *WindowsImageBackup* の 1 レベル上のフォルダーを共有し、共有フォルダーのルートが *WindowsImageBackup* フォルダーになるようにします。

    このフォルダーを共有しないと、復元でバックアップが検出されません。 WinRE を使用して接続するには、正しい IP アドレスと資格情報を使用して WinRE でアクセスできる共有が必要です。

システムを復元するには:

1. 復元中のシステムの Windows DVD を使用して、イメージを復元したいコンピューターを起動します。

1. 最初のページで、言語とロケールの設定を確認します。 **[インストール]** ページで、 **[コンピューターの修復]** を選択します。

1. **[システム回復オプション]** ページで、 **[以前に作成したシステム イメージを使用して、コンピューターを復元します]** を選択します。

1. **[システム イメージ バックアップの選択]** ページで、 **[システム イメージを選択する]**  >  **[詳細設定]**  >  **[ネットワーク上のシステム イメージを検索する]** の順に選択します。 警告が表示されたら、 **[はい]** を選択します。 共有パスに移動して資格情報を入力し、復旧ポイントを選択します。 その回復ポイントで使用可能な特定のバックアップがシステムによってスキャンされます。 使用する復旧ポイントを選択します。

1. **[バックアップを復元する方法を選択する]** ページで、 **[ディスクをフォーマットしてパーティションに再分割する]** を選択します。 次のページで設定を確認します。

1. 復元を開始するには、 **[完了]** を選択します。 再起動が必要です。

### <a name="restore-system-state"></a>システム状態の復元

Backup Server で回復を実行するには:

1. **[回復]** ウィンドウで、回復するコンピューターを検索し、 **[ベア メタル回復]** を選択します。

1. 使用可能な復旧ポイントがカレンダーに太字で示されます。 使用する復旧ポイントの日時を選択します。

1. **[回復の種類の選択]** ページで **[ネットワーク フォルダーにコピーする]** を選択します。

1. **[宛先の指定]** ページで、データのコピー場所を選択します。

    選択する宛先にはデータ用の空き領域が十分に必要であることに注意してください。 宛先として新しいフォルダーを作成することをお勧めします。

1. **[回復オプションの指定]** ページで、セキュリティ設定を選択します。 次に、回復を迅速に行うために、SAN ベースのハードウェア スナップショットを使用するかどうかを選択します。 このオプションが使用できるのは次の場合のみです。
    * この機能を実現する SAN がある。
    * クローンを作成して書き込み可能な状態に分割できる。
    * 保護されるコンピューターと Backup Server サーバーが同じネットワークに接続されている。

1. 通知オプションを設定します。
1. **[確認]** ページで **[回復]** を選択します。

Windows Server バックアップを実行するには:

1. **[アクション]**  >  **[回復]**  >  **[このサーバー]**  >  **[次へ]** の順に選択します。

1. **[別のサーバー]** を選択し、 **[バックアップの場所の種類指定]** ページを選択し、 **[リモート共有フォルダー]** を選択します。 復旧ポイントを含むフォルダーへのパスを入力します。

1. **[回復の種類の選択]** ページで **[システム状態]** を選択します。

1. **[システム状態の回復先の場所を選択]** ページで **[元の場所]** を選択します。

1. **[確認]** ページで **[回復]** を選択します。

1. 復元後、サーバーを再起動します。

また、コマンド プロンプトでもシステム状態の復元を実行できます。

1. 回復したいコンピューターで Windows Server バックアップを開始します。

1. バージョン識別子を取得するためにコマンド プロンプトに入力する内容:

   `wbadmin get versions -backuptarget \<servername\sharename\>`

1. バージョン識別子を使用してシステム状態の復元を開始します。 コマンド プロンプトに、次のコマンドを入力します。

   `wbadmin start systemstaterecovery -version:<versionidentified> -backuptarget:<servername\sharename>`

1. 回復を開始することを確認します。 コマンド プロンプト ウィンドウでプロセスを表示できます。 復元ログが作成されます。

1. 復元後、サーバーを再起動します。
