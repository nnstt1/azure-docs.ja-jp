---
title: Azure Backup Server を使用した SQL Server のバックアップ
description: この記事では、Microsoft Azure Backup Server (MABS) を使用して SQL Server データベースのバックアップを構成する方法について説明します。
ms.topic: conceptual
ms.date: 07/28/2021
ms.openlocfilehash: f97fc81b051b8c7d76ee1769b82ad4a2d489357b
ms.sourcegitcommit: 0046757af1da267fc2f0e88617c633524883795f
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 08/13/2021
ms.locfileid: "121722761"
---
# <a name="back-up-sql-server-to-azure-by-using-azure-backup-server"></a>Azure Backup Server を使用して SQL Server を Azure にバックアップする

Microsoft Azure Backup Server (MABS) は、SQL Server データベースのバックアップと回復機能を提供します。 SQL Server データベースをバックアップするだけでなく、SQL Server コンピューターのシステム バックアップや完全なベアメタル バックアップを実行できます。 MABS で保護できるものは以下です。

- スタンドアロンの SQL Server インスタンス
- SQL Server フェールオーバー クラスター インスタンス (FCI)

>[!Note]
>MABS v3 UR2 では、クラスターの共有ボリューム (CSV) を使用して、SQL Server フェールオーバー クラスター インスタンス (FCI) をサポートしています。
>
>Azure 上で記憶域スペース ダイレクトを使用した SQL Server FCI、および Azure 共有ディスクを使用した SQL Server FCIの保護は、この機能によってサポートされています。 Azure Virtual Machine 上にデプロイされている SQL FCI インスタンスを保護するには、Azure VM に DPM サーバーをデプロイする必要があります。
>
>以下の設定の SQL Server AlwaysOn 可用性グループ
>- [セカンダリを優先]
>- [セカンダリのみ]
>- 1 次式
>- [任意のレプリカ]

SQL Server データベースをバックアップし、それを Azure から回復するには:

1. Azure で SQL Server データベースを保護するためのバックアップ ポリシーを作成します。
1. オンデマンドでのバックアップ コピーを Azure に作成します。
1. Azure でデータベースを回復します。

## <a name="prerequisites-and-limitations"></a>前提条件と制限事項

* データベースのファイルがリモート ファイル共有にある場合、保護はエラー ID 104 で失敗します。 MABS では、リモート ファイル共有上の SQL Server データの保護はサポートされていません。
* リモート SMB 共有に保存されているデータベースを MABS で保護することはできません。
* [可用性グループのレプリカが読み取り専用として構成されている](/sql/database-engine/availability-groups/windows/configure-read-only-access-on-an-availability-replica-sql-server)ことを確認します。
* システム アカウント **NTAuthority\System** を SQL Server の Sysadmin グループに明示的に追加する必要があります。
* 部分的な包含データベースに対して別の場所への回復を実行する場合は、ターゲット SQL インスタンスで[包含データベース](/sql/relational-databases/databases/migrate-to-a-partially-contained-database#enable)機能が有効になっていることを確認する必要があります。
* ファイル ストリーム データベースに対して別の場所への回復を実行する場合、ターゲット SQL インスタンスで[ファイル ストリーム データベース](/sql/relational-databases/blob/enable-and-configure-filestream)機能が有効になっていることを確認する必要があります。
* SQL Server AlwaysOn の保護:
  * 保護グループの作成時に照会を実行するときに、MABS によって可用性グループが検出されます。
  * MABS によってフェールオーバーが検出され、データベース保護が続行されます。
  * MABS では、SQL Server のインスタンスに対するマルチサイト クラスター構成がサポートされます。
* AlwaysOn 機能を使用するデータベースを MABS で保護するときは、次の制限があります。
  * MABS では、次のように、バックアップ設定に基づいて SQL Server に設定されている可用性グループ用のバックアップ ポリシーに従います。
    * セカンダリ優先 - オンラインになっているのがプライマリ レプリカのみの場合を除き、バックアップは常にセカンダリ レプリカ上で発生します。 セカンダリ レプリカが複数ある場合は、バックアップの優先度が最も高いノードがバックアップ用に選択されます。 プライマリ レプリカのみを使用できる場合、バックアップはプライマリ レプリカ上で発生します。
    * セカンダリのみ - プライマリ レプリカでのバックアップは行いません。 オンラインになっているのがプライマリ レプリカのみの場合、バックアップは発生しません。
    * プライマリ - バックアップは常にプライマリ レプリカ上で発生します。
    * 任意のレプリカ - バックアップは、可用性グループ内の使用可能な任意のレプリカで発生できます。 バックアップ元となるノードは、各ノードのバックアップの優先度によって決まります。
  * 次のことを考慮してください。
    * 読み取り可能なレプリカ (プライマリ、同期セカンダリ、非同期セカンダリ) であれば、どれでもバックアップを発生させることができます。
    * レプリカがバックアップから除外されている場合 (たとえば **[レプリカの除外]** が有効であったり、レプリカが読み取り不可としてマークされていたりする場合) は、どのオプションでも、そのレプリカがバックアップ用に選択されることはありません。
    * 読み取り可能なレプリカが複数ある場合は、バックアップの優先度が最も高いノードがバックアップ用に選択されます。
    * 選択されたノード上でバックアップに失敗した場合、バックアップ操作は失敗します。
    * 元の場所への回復はサポートされていません。
* SQL Server 2014 以降のバックアップに関する問題:
  * [Windows Azure Blob Storage にオンプレミスの SQL Server 用のデータベース](/sql/relational-databases/databases/sql-server-data-files-in-microsoft-azure)を作成するための新機能が SQL Server 2014 に追加されました。 この構成を保護するために MABS を使用することはできません。
  * SQL AlwaysOn オプションの [セカンダリを優先] バックアップ設定には、いくつかの既知の問題があります。 MABS では、常にセカンダリからバックアップが作成されます。 セカンダリが見つからない場合、バックアップは失敗します。

## <a name="before-you-start"></a>開始する前に

開始する前に、[Azure Backup Server がインストールされ、準備完了状態になっている](backup-azure-microsoft-azure-backup.md)ことを確認してください。

## <a name="create-a-backup-policy"></a>バックアップ ポリシーの作成

Azure で SQL Server データベースを保護するには、最初にバックアップ ポリシーを作成します。

1. Azure Backup Server で、 **[保護]** ワークスペースを選択します。
1. **[新規]** を選択して保護グループを作成します。

    ![Azure Backup Server で保護グループを作成する](./media/backup-azure-backup-sql/protection-group.png)
1. スタート ページで、保護グループの作成に関するガイダンスを確認します。 **[次へ]** を選択します。
1. 保護グループの種類として **[サーバー]** を選択します。

    ![サーバーの保護グループの種類を選択する](./media/backup-azure-backup-sql/pg-servers.png)
1. バックアップするデータベースが配置されている SQL Server インスタンスを展開します。 そのサーバーからバックアップできるデータ ソースが表示されます。 **[All SQL Shares]\(すべての SQL 共有\)** を展開し、バックアップしたいデータベースを選択します。 この例では、ReportServer$MSDPM2012 と ReportServer$MSDPM2012TempDB を選択します。 **[次へ]** を選択します。

    ![SQL Server データベースを選択する](./media/backup-azure-backup-sql/pg-databases.png)
1. 保護グループに名前を付け、 **[オンライン保護を利用する]** を選択します。

    ![データ保護方法を選択する - 短期的なディスク保護または Azure でのオンライン保護](./media/backup-azure-backup-sql/pg-name.png)
1. **[短期的な目標値の指定]** ページで、ディスクへのバックアップ ポイントを作成するために必要な入力を指定します。

    この例では、 **[リテンション期間]** は "*5 日*" に設定されています。 バックアップの **[同期の頻度]** は、"*15 分*" に 1 回に設定されています。 **[高速完全バックアップ]** は "*午後 8:00*" に設定されています。

    ![バックアップ保護の短期的な目標値を設定する](./media/backup-azure-backup-sql/pg-shortterm.png)

   > [!NOTE]
   > この例では、毎日午後 8:00 にバックアップ ポイントが作成されます。 前日の午後 8:00 のバックアップ ポイント以降に変更されたデータが転送されます。 このプロセスは、 **高速完全バックアップ** と呼ばれます。 トランザクション ログは 15 分ごとに同期されますが、午後 9:00 にデータベースを回復する必要がある場合は、最新の高速完全バックアップ ポイント (この例では午後 8:00) からログを再生することでポイントが作成されます。
   >
   >

1. **[次へ]** を選択します。 MABS には、使用可能なストレージ領域全体が表示されます。 また、考えられるディスク領域使用率も表示されます。

    ![MABS でディスク割り当てを設定する](./media/backup-azure-backup-sql/pg-storage.png)

    既定では、MABS によってデータ ソース (SQL Server データベース) ごとに 1 つのボリュームが作成されます。 このボリュームは、初回バックアップ コピーに使用されます。 この構成では、論理ディスク マネージャー (LDM) によって MABS 保護が 300 データ ソース (SQL Server データベース) に制限されます。 この制限を避けるには、 **[DPM 記憶域プールにデータを併置する]** を選択します。 このオプションを使用すると、MABS では複数のデータソースに 1 つのボリュームが使用されます。 この設定により、MABS で最大 2,000 個の SQL Server データベースを保護できます。

    **[ボリュームを自動的に拡大する]** を選択すると、運用データの増大に合わせて MABS でバックアップ ボリュームを増やすことができます。 **[ボリュームを自動的に拡大する]** を選択しない場合、バックアップ ストレージは MABS によって保護グループ内のデータ ソースに制限されます。
1. 自分が管理者の場合、この初回バックアップを **ネットワーク経由で自動的** に転送することを選択し、転送するタイミングを選択できます。 または、**手動** でのバックアップの転送を選択します。 **[次へ]** を選択します。

    ![MABS でレプリカの作成方法を選択する](./media/backup-azure-backup-sql/pg-manual.png)

    初回バックアップ コピーでは、データ ソース (SQL Server データベース) 全体を転送する必要があります。 バックアップ データは、運用サーバー (SQL Server コンピューター) から MABS に移動されます。 このバックアップが大きい場合、ネットワーク経由でデータを転送すると、帯域幅の輻輳が発生する可能性があります。 このため、管理者は、リムーバブル メディアを使用して初回バックアップを **手動** で転送することを選択できます。 または、指定した時間に **自動的 (ネットワーク経由)** にデータを転送できます。

    初回バックアップが完了すると、バックアップは初回バックアップ コピーで増分的に続行されます。 増分バックアップは一般に非常に小さく、ネットワーク経由で容易に転送できます。
1. 整合性チェックを実行するタイミングを選択します。 **[次へ]** を選択します。

    ![整合性チェックを実行するタイミングを選択する](./media/backup-azure-backup-sql/pg-consistent.png)

    MABS では、バックアップ ポイントの整合性に関する整合性チェックを実行できます。 それにより、運用サーバー (この例では SQL Server コンピューター) のバックアップ ファイルと MABS にバックアップされたそのファイルのデータのチェックサムが計算されます。 チェックで競合が検出された場合は、MABS 内のバックアップ ファイルが破損していることが想定されます。 MABS からチェックサムの不一致に対応するブロックが送信され、バックアップ データが修正されます。 正常性チェックは負荷の高い処理なので、管理者は正常性チェックをスケジュールすることも、自動的に実行することもできます。
1. Azure で保護するデータ ソースを選択します。 **[次へ]** を選択します。

    ![Azure で保護するデータ ソースを選択する](./media/backup-azure-backup-sql/pg-sqldatabases.png)
1. 自分が管理者の場合は、組織のポリシーに合ったバックアップ スケジュールと保持ポリシーを選択できます。

    ![スケジュールと保持ポリシーを選択する](./media/backup-azure-backup-sql/pg-schedule.png)

    この例では、バックアップは毎日午後 12:00 と午後 8:00 に作成されます。

    > [!TIP]
    > 迅速な回復のために、ディスク上にいくつかの短期的な回復ポイントを保持します。 これらの回復ポイントは、オペレーショナル リカバリに使用されます。 Azure は、より高い SLA を実現し、可用性を確保するのに適したオフサイトの場所として機能します。
    >
    > Data Protection Manager (DPM) を使用して、ローカル ディスクのバックアップが終了した後に Azure のバックアップをスケジュールします。 この方法に従うと、最新のディスク バックアップが Azure にコピーされます。
    >

1. 保有ポリシーのスケジュールを選択します。 保持ポリシーのしくみの詳細については、[Azure Backup を使用したテープ インフラストラクチャの置換](backup-azure-backup-cloud-as-tape.md)に関するページを参照してください。

    ![MABS で保持ポリシーを選択する](./media/backup-azure-backup-sql/pg-retentionschedule.png)

    次の点に注意してください。

    * バックアップは毎日午後 12:00 と午後 8:00 に作成されます。 保持期間は 180 日間です。
    * 土曜日午後 12:00 のバックアップは、104 週間保持されます。
    * 月の最終土曜日午後 12:00 のバックアップは 60 か月間保持されます。
    * 3 月の最終土曜日午後 12:00 のバックアップは 10 年間保持されます。

    保持ポリシーを選択したら、 **[次へ]** を選択します。
1. 初回バックアップ コピーを Azure に転送する方法を選択します。

    * **[自動 (ネットワーク経由)]** オプションを選択すると、バックアップ スケジュールに従ってデータが Azure に転送されます。
    * **[オフライン バックアップ]** の詳細については、「[オフライン バックアップの概要](offline-backup-overview.md)」を参照してください。

    転送メカニズムを選択したら、 **[次へ]** を選択します。
1. **[概要]** ページで、ポリシーの詳細を確認します。 次に **[グループの作成]** を選択します。 **[閉じる]** を選択し、 **[監視]** ワークスペースでジョブの進行状況を確認できます。

    ![保護グループの作成の進行状況](./media/backup-azure-backup-sql/pg-summary.png)

## <a name="create-on-demand-backup-copies-of-a-sql-server-database"></a>SQL Server データベースのオンデマンド バックアップ コピーを作成する

初回バックアップが実行されると、回復ポイントが作成されます。 スケジュールが実行されるまで待つのではなく、回復ポイントの作成を手動でトリガーできます。

1. 保護グループで、データベースの状態が **[OK]** であることを確認します。

    ![データベースの状態が表示された保護グループ](./media/backup-azure-backup-sql/sqlbackup-recoverypoint.png)
1. データベースを右クリックし、 **[回復ポイントの作成]** を選択します。

    ![オンライン回復ポイントの作成を選択する](./media/backup-azure-backup-sql/sqlbackup-createrp.png)
1. ドロップダウン メニューで、 **[オンライン保護]** を選択します。 次に、 **[OK]** を選択して、Azure での回復ポイントの作成を開始します。

    ![Azure での回復ポイントの作成を開始する](./media/backup-azure-backup-sql/sqlbackup-azure.png)
1. ジョブの進行状況は **[監視]** ワークスペースで確認できます。

    ![[監視] コンソールでジョブの進行状況を表示する](./media/backup-azure-backup-sql/sqlbackup-monitoring.png)

## <a name="recover-a-sql-server-database-from-azure"></a>Azure からの SQL Server データベースの回復

SQL Server データベースなどの保護されたエンティティを Azure から回復するには:

1. DPM サーバーの管理コンソールを開きます。 **[回復]** ワークスペースに移動して、DPM によってバックアップされたサーバーを確認します。 データベース (この例では ReportServer$MSDPM2012) を選択します。 "**オンライン**" で終わる **[回復時刻]** を選択します。

    ![[回復ポイントの選択]](./media/backup-azure-backup-sql/sqlbackup-restorepoint.png)
1. データベース名を右クリックし、 **[回復]** を選択します。

    ![Azure からのデータベースを回復する](./media/backup-azure-backup-sql/sqlbackup-recover.png)
1. DPM に回復ポイントの詳細が表示されます。 **[次へ]** を選択します。 データベースを上書きするには、回復のタイプとして **[元の SQL Server のインスタンスに回復する]** を選択します。 **[次へ]** を選択します。

    ![データベースを元の場所に回復する](./media/backup-azure-backup-sql/sqlbackup-recoveroriginal.png)

    この例では、DPM によってデータベースを別の SQL Server インスタンスまたはスタンドアロンのネットワーク フォルダーに回復できます。
1. **[回復オプションの指定]** ページでは、回復オプションを選択できます。 たとえば、 **[ネットワークの使用帯域幅の調整]** を選択して、回復に使用する帯域幅を調整できます。 **[次へ]** を選択します。
1. **[概要]** ページに、現在の回復構成が表示されます。 **[回復]** を選択します。

    回復の状態に、データベースが回復されていることが表示されます。 **[閉じる]** を選択してウィザードを閉じ、 **[監視]** ワークスペースで進行状況を確認できます。

    ![回復プロセスを開始する](./media/backup-azure-backup-sql/sqlbackup-recoverying.png)

    回復が完了すると、復元されたデータベースはアプリケーションと整合性が取れています。

### <a name="next-steps"></a>次のステップ

詳細については、[Azure Backup に関する FAQ](backup-azure-backup-faq.yml) を参照してください。
