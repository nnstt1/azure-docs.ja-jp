---
title: Azure BLOB の運用バックアップの構成
description: Azure BLOB の運用バックアップを構成および管理する方法について説明します。
ms.topic: conceptual
ms.date: 09/28/2021
ms.openlocfilehash: 24a0f31a35342b53835563fdcca9754abd5d57ee
ms.sourcegitcommit: df2a8281cfdec8e042959339ebe314a0714cdd5e
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 09/28/2021
ms.locfileid: "129153902"
---
# <a name="configure-operational-backup-for-azure-blobs"></a>Azure BLOB の運用バックアップの構成

Azure Backup を使用すると、ストレージ アカウント内のブロック BLOB を保護するための運用バックアップを簡単に構成できます。 この記事では、Azure portal を使用して 1 つまたは複数のストレージ アカウントでの運用バックアップを構成する方法について説明します。 この記事では、以下について説明します。

- 開始する前の確認事項
- バックアップ コンテナーの作成
- 保護するストレージ アカウントでのバックアップ コンテナーへのアクセス許可の付与
- バックアップ ポリシーの作成
- 1 つまたは複数のストレージ アカウントでの運用バックアップの構成
- バックアップ ストレージ アカウントに対する影響

## <a name="before-you-start"></a>開始する前に

- BLOB の運用バックアップは、ソース ストレージ アカウント自体にデータを指定された期間保持するローカル バックアップ ソリューションです。 このソリューションを使用した場合、コンテナー内にデータの追加コピーは保持されません。
- このソリューションを使用すると、データを復元用に最大 360 日間保持することができます。 ただし、保持期間が長いと、復元操作にかかる時間が長くなる場合があります。
- このソリューションを使用した場合は、ソース ストレージ アカウントにしか復元を実行できず、データが上書きされるおそれがあります。
- Delete Container 操作を呼び出してストレージ アカウントからコンテナーを削除した場合、そのコンテナーは復元操作を使って復元できません。 後で復元が必要になる可能性がある場合は、コンテナー全体を削除するのではなく、個々の BLOB を削除してください。 また、コンテナーの誤削除防止のために、運用バックアップに加えてコンテナーの論理的な削除を有効にすることをお勧めします。
- **Microsoft.DataProtection** プロバイダーがサブスクリプションに登録されていることを確認します。
- サポートされているシナリオ、制限、および利用可能性の詳細については、[サポート マトリックス](blob-backup-support-matrix.md)を参照してください。

## <a name="create-a-backup-vault"></a>バックアップ コンテナーの作成

[バックアップ コンテナー](backup-vault-overview.md)は、時間の経過と共に作成された復旧ポイントを格納する管理エンティティであり、バックアップ関連の操作を実行するためのインターフェイスを提供するものです。 たとえば、オンデマンドのバックアップの作成、復元の実行、バックアップ ポリシーの作成などの操作です。 BLOB の運用バックアップはローカル バックアップであり、コンテナーにデータは "格納" されませんが、さまざまな管理操作のためにコンテナーが必要です。

>[!NOTE]
>バックアップ コンテナーは、新しくサポートされたワークロードをバックアップするために使用される新しいリソースであり、既存の Recovery Services コンテナーとは異なります。

バックアップ コンテナーを作成する方法については、[バックアップ コンテナーのドキュメント](backup-vault-overview.md#create-a-backup-vault)を参照してください。

## <a name="grant-permissions-to-the-backup-vault-on-storage-accounts"></a>ストレージ アカウントでのバックアップ コンテナーへのアクセス許可の付与

運用バックアップを使用すると、バックアップ所有の削除ロックを適用することによって、ストレージ アカウント (保護対象の BLOB が含まれている) の誤削除を防止することもできます。 これを行うには、保護する必要があるストレージ アカウントのバックアップ コンテナーに特定のアクセス許可が与えられている必要があります。 便利に使えるように、これらの最小限のアクセス許可は、**ストレージ アカウント バックアップの共同作成者** ロールに統合されています。 

バックアップを構成する前に、このロールを Backup コンテナーに割り当てすることをお勧めします。 ただし、バックアップの構成中にロールの割り当てを実行することもできます。 バックアップ センターを使用したバックアップの構成に関する詳細については、[こちら](#using-backup-center)をご覧ください。 

保護する必要があるストレージ アカウントに必要なロールを割り当てるには、次の手順に従います。

>[!NOTE]
>また、利便性に応じて、サブスクリプションまたはリソース グループのレベルでコンテナーにロールを割り当てることもできます。

1. 保護する必要があるストレージ アカウントで、左側のナビゲーション ウィンドウにある **[アクセス制御 (IAM)]** タブに移動します。
1. 必要なロールを割り当てるために、 **[ロールの割り当ての追加]** を選択します。

    ![ロールの割り当てを追加する](./media/blob-backup-configure-manage/add-role-assignments.png)

1. [ロールの割り当ての追加] ペインにおいて:

    1. **[ロール]** で **[ストレージ アカウント バックアップの共同作成者]** を選択します。
    1. **[アクセスの割り当て先]** で、 **[ユーザー、グループ、またはサービス プリンシパル]** を選択します。
    1. このストレージ アカウントで BLOB のバックアップに使用する Backup コンテナーを検索し、検索結果から選択します。
    1. **[保存]** を選択します。

        ![ロールの割り当てオプション](./media/blob-backup-configure-manage/role-assignment-options.png)

        >[!NOTE]
        >ロールの割り当ては、反映されるまで最大 10 分ほどかかることがあります。

## <a name="create-a-backup-policy"></a>バックアップ ポリシーの作成

通常、バックアップ ポリシーを使用してバックアップの保持期間とスケジュールを制御します。 BLOB の運用バックアップは継続的な性質のものであるため、バックアップを実行するスケジュールは必要ありません。 ポリシーは、基本的に保持期間を指定するために必要です。 バックアップ ポリシーを使用および再利用して、複数のストレージ アカウントのコンテナーへのバックアップを構成できます。

BLOB の運用バックアップのバックアップ ポリシーを作成する手順は、次のとおりです。

1. バックアップ コンテナーで、 **[バックアップ ポリシー]** に移動し、 **[+ 追加]** を選択してバックアップ ポリシーの作成を開始します。

    ![バックアップ ポリシー](./media/blob-backup-configure-manage/backup-policies.png)

1. **[基本]** タブで、バックアップ ポリシーの名前を指定し、データソースの種類として **[Azure BLOB]** を選択します。 選択したコンテナーの詳細を表示することもできます。

    ![バックアップ ポリシーを作成する](./media/blob-backup-configure-manage/create-backup-policy.png)

    >[!NOTE]
    >コンテナーの **[バックアップ ストレージの冗長性]** が表示されますが、実際には、冗長性は BLOB の運用バックアップには適用されません。このバックアップはローカルな性質のものであり、バックアップ コンテナーにデータは格納されないためです。 ここでのバックアップ コンテナーは、ストレージ アカウント内のブロック BLOB の保護を管理するために役立つ管理エンティティです。

1. **[バックアップ ポリシー]** タブで保持期間の詳細を指定します。 保持期間が 30 日の **[既定]** と呼ばれる保持規則が既に存在していることがわかります。 保持期間を編集する場合は、 **[保持規則の編集]** アイコンを使用して編集し、データを保持する期間を指定します。 最大 360 日までの保持期間を指定できます。

    ![[バックアップ ポリシー] タブ](./media/blob-backup-configure-manage/backup-policy-tab.png)

    >[!NOTE]
    >長期間を対象にした復元の場合、復元操作の完了に時間がかかることがあります。 さらに、一連のデータの復元にかかる時間は、復元期間中に行われた書き込みと削除の操作回数に基づきます。 たとえば、100 万オブジェクトを持つアカウントで毎日 3,000 オブジェクトが追加され、毎日 1,000 オブジェクトが削除される場合、過去 30 日間のポイントまで復元するのに約 2 時間必要になります。 過去 90 日間の保有期間と復元は、この変更率のアカウントには推奨されません。

1. **[確認と作成]** ペインでポリシーのすべての詳細を確認し、それができたら、 **[作成]** を選択してポリシーの作成を完了します。 バックアップ ポリシーが作成され、使用できる状態になると、確認の通知が表示されます。

    ![ポリシーの確認と作成](./media/blob-backup-configure-manage/review-create.png)

## <a name="configure-backup"></a>バックアップの構成

BLOB のバックアップは、ストレージ アカウント レベルで構成します。 そのため、ストレージ アカウント内のすべての BLOB が運用バックアップで保護されます。

バックアップ センターを使用して複数のストレージ アカウントのバックアップを構成できます。 ストレージ アカウントの **データ保護** プロパティを使用して、ストレージ アカウントのバックアップを構成することもできます。 このセクションでは、両方のバックアップ構成方法について説明します。

### <a name="using-backup-center"></a>バックアップ センターを使用する

バックアップの構成を開始するには:

1. 検索バーで「**バックアップ センター**」を検索します。

1. **[概要]**  ->  **[+ バックアップ]** に移動します。

    ![バックアップ センターの概要](./media/blob-backup-configure-manage/backup-center-overview.png)

1. **[開始: バックアップの構成]** タブで、データソースの種類として **[Azure BLOB (Azure Storage)]** を選択します。

    ![[開始: バックアップの構成] タブ](./media/blob-backup-configure-manage/initiate-configure-backup.png)

1. **[基本]** タブで、データソースの種類として **[Azure BLOB (Azure Storage)]** を指定し、ご自分のストレージ アカウントを関連付ける Backup コンテナーを選択します。<br></br>同じペインで選択したコンテナーの詳細を確認できます。

    ![[基本] タブ](./media/blob-backup-configure-manage/basics-tab.png)

    >[!NOTE]
    >BLOB に対して有効になるのは、運用バックアップのみです。これは、(Backup コンテナーではなく) ソース ストレージ アカウントにバックアップを格納します。 そのため、コンテナーに対して選択されたバックアップ ストレージの冗長性の種類は、BLOB のバックアップには適用されません。

1. 保持期間の指定に使用するバックアップ ポリシーを選択します。<br></br>画面の下部で選択したポリシーの詳細を確認できます。 運用データ ストアの列には、ポリシーで定義されている保持期間が表示されます。 **運用** とは、データがソース ストレージ アカウントでローカルに保持されることを意味します。
    
    ![バックアップ ポリシーを選択する](./media/blob-backup-configure-manage/choose-backup-policy.png)

    新しいバックアップ ポリシーを作成することもできます。 これを行うには、 **[新規作成]** を選択し、次の手順に従います。
    
    1. 作成するポリシーの名前を指定します。<br></br>他のボックスに正しいデータソースの種類とコンテナー名が表示されていることを確認します。
    
    1. **[バックアップ ポリシー]** タブで、データ保持期間を変更する保持規則の **[保持規則の編集]** アイコンを選択します。<br></br>最大 **360** 日までのデータ保持期間を設定できます。 
    
        >[!NOTE]
        >バックアップは保持期間の影響を受けませんが、復元操作は、復元するバックアップが古いほど完了までの時間が長くなる場合があります。

       ![新しいバックアップ ポリシーの作成](./media/blob-backup-configure-manage/new-backup-policy.png)

    1. **[確認と作成]** を選択してバックアップ ポリシーを作成します。

1. BLOB の保護を構成するために必要なストレージ アカウントを選択します。 一度に複数のストレージ アカウントを選択し、 [選択] を選択できます。<br></br>ただし、選択したコンテナーに、ストレージ アカウントでバックアップを構成するために必要な Azure ロールベースのアクセス制御 (Azure RBAC) ロールが割り当てられていることを確認してください。 詳しくは、「[ストレージ アカウントでのバックアップ コンテナーへのアクセス許可の付与](#grant-permissions-to-the-backup-vault-on-storage-accounts)」をご覧ください。<br></br>ロールが割り当てられていない場合でも、バックアップの構成中にロールを割り当てることができます。 手順 7 を参照してください。

    ![コンテナーのアクセス許可を確認する](./media/blob-backup-configure-manage/verify-vault-permissions.png)

    選択したストレージ アカウントでバックアップを構成するための十分なアクセス許可がコンテナーにあるかどうかが、Backup によって検証されます。 検証が完了するには、しばらく時間がかかります。
    
    ![バックアップの構成を許可するアクセス許可](./media/blob-backup-configure-manage/permissions-for-configuring-backup.png)

1. 検証が完了すると、 **[バックアップの準備]** 列に、Backup コンテナーに各ストレージ アカウントのバックアップを構成するための十分なアクセス許可があるかどうかが通知されます。

   ![Backup コンテナーのアクセス許可の情報](./media/blob-backup-configure-manage/information-of-backup-vault-permissions.png)

    検証でエラーが表示された場合 (上の図に一覧表示されている 2 つのストレージ アカウントの場合) は、**ストレージ アカウントのバックアップ共同作成者** ロールをこれらの [ストレージ アカウント](#grant-permissions-to-the-backup-vault-on-storage-accounts)に割り当てていません。 また、現在のアクセス許可に基づいて、ここで必要なロールを割り当てることもできます。 このエラー メッセージは、必要なアクセス許可があるかどうかを理解し、適切なアクションを実行するのに役立ちます。

    - **Role assignment not done (ロールの割り当てが完了していません):** このエラー (上の図の項目 _blobbackupdemo3_ に示されています) は、ユーザーが **ストレージ アカウント バックアップの共同作成者** ロールと、ストレージ アカウントに必要なその他のロールをコンテナーに割り当てるためのアクセス許可を持っていることを示しています。 ロールを選択し、ツールバーの **[Assign missing roles]\(不足しているロールの割り当て\)** をクリックします。 これにより、必要なロールがバックアップ コンテナーに自動的に割り当てられ、自動再検証もトリガーされます。<br><br>場合によっては、ロールの伝達に時間がかかり (最大 10 分)、再検証が失敗する場合があります。 このようなシナリオでは、数分待ってから、[再検証] ボタンをクリックして検証を再試行してください。
    
    - **Insufficient permissions for role assignment (ロールの割り当てに必要なアクセス許可が不十分です):** このエラー (上の図の項目 _blobbackupdemo4_ に示されています) は、コンテナーにバックアップを構成するために必要なロールがなく、ユーザーが必要なロールを割り当てるための十分なアクセス許可を持っていないことを示します。 ロールの割り当てを簡単にするために、Backup ではロールの割り当てテンプレートをダウンロードできるようにしています。これは、ストレージ アカウントのロールを割り当てるためのアクセス許可を持つユーザーと共有できます。 これを行うには、このようなストレージ アカウントを選択し、 **[Download role assignment template]\(ロール割り当てテンプレートのダウンロード\)** をクリックしてテンプレートをダウンロードします。<br><br>ロールが割り当てられたら、適切なユーザーと共有できます。 ロールが正常に割り当てられたら、 **[再検証]** をクリックしてアクセス許可を再度検証し、バックアップを構成します。
        >[!NOTE]
        >テンプレートには、選択したストレージ アカウントの詳細のみが含まれます。 そのため、異なるストレージ アカウントにロールを割り当てる必要があるユーザーが複数ある場合は、別のテンプレートをそれぞれ選択してダウンロードできます。
1. 選択したすべてのストレージ アカウントに対する検証が成功したら、バックアップの **レビューと構成** に進みます。<br><br>保護の構成の状態に関する情報とその完了を受け取ります。

### <a name="using-data-protection-settings-of-the-storage-account"></a>ストレージ アカウントのデータ保護設定を使用する

ストレージ アカウントの BLOB のバックアップは、ストレージ アカウントの [データ保護] 設定から直接構成できます。 

1. BLOB のバックアップを構成するストレージ アカウントに移動し、左側のペインの ( **[データ管理]** の下にある) **[データ保護]** に移動します。

1. 使用可能なデータ保護オプションの最初のオプションを使用すると、Azure Backup を使用した運用バックアップを有効にできます。

    ![Azure Backup を使用した運用バックアップ](./media/blob-backup-configure-manage/operational-backup-using-azure-backup.png)

1. **[Azure Backup で運用中のバックアップを有効にする]** に対応するチェック ボックスをオンにします。 次に、関連付ける Backup コンテナーと Backup ポリシーを選択します。<br><br>既存のコンテナーとポリシーを選択することも、必要に応じて新しく作成することもできます。

    >[!IMPORTANT]
    >選択したコンテナーに **ストレージ アカウント バックアップ共同作成者** ロールを割り当てている必要があります。 詳しくは、「[ストレージ アカウントでのバックアップ コンテナーへのアクセス許可の付与](#grant-permissions-to-the-backup-vault-on-storage-accounts)」をご覧ください。
    
    - 必要なロールが既に割り当てられている場合は、 **[保存]** をクリックしてバックアップの構成を完了します。 ポータルの通知に従って、バックアップの構成の進行状況を追跡します。
    - ロールをまだ割り当てていない場合は、 **[ID の管理]** をクリックし、次の手順に従って割り当てます。 

        ![Azure Backup で運用中のバックアップを有効にする](./media/blob-backup-configure-manage/enable-operational-backup-with-azure-backup.png)


        1. **[ID の 管理]** をクリックすると、ストレージ アカウントの [ID] ブレードが表示されます。 
        
        1. ロールの割り当てを開始するには、 **[ロールの割り当ての追加]** をクリックします。

            ![ロールの割り当てを開始するための [ロールの割り当ての追加]](./media/blob-backup-configure-manage/add-role-assignment-to-initiate-role-assignment.png)


        1. ロールに割り当てるスコープ、サブスクリプション、リソース グループ、またはストレージ アカウントを選択します。<br><br>複数のストレージ アカウントの BLOB に運用バックアップを構成する場合は、リソース グループ レベルでロールを割り当てることをお勧めします。

        1. **[ロール]** ドロップダウンから、 **[ストレージ アカウントのバックアップ共同作成者]** ロールを選択します。

            ![[ストレージ アカウントのバックアップ共同作成者ロール] の選択](./media/blob-backup-configure-manage/select-storage-account-backup-contributor-role.png)


        1. **[保存]** をクリックして、ロールの割り当てを完了します。<br><br>これが正常に完了すると、ポータルを通じて通知されます。 選択したコンテナーの既存のロールの一覧で、新しいロールが追加されていることを確認することもできます。

            ![ロールの割り当ての完了](./media/blob-backup-configure-manage/finish-role-assignment.png)

        1. 右上隅にあるキャンセル アイコン ( **[x]** ) をクリックして、ストレージ アカウントの **[データ保護]** ブレードに戻ります。<br><br>戻ったら、バックアップの構成を続行します。

## <a name="effects-on-backed-up-storage-accounts"></a>バックアップ対象ストレージ アカウントに対する影響

バックアップを構成すると、ストレージ アカウント内のブロック BLOB に対して行われた変更が追跡され、バックアップ ポリシーに従ってデータが保持されます。 バックアップを構成したストレージ アカウントには、次の変更点があることがわかるでしょう。

- ストレージ アカウントで次の機能が有効になっています。 これらは、ストレージ アカウントの **[データ保護]** タブで確認できます。
  - コンテナーのポイントインタイム リストア: バックアップ ポリシーで指定した保持期間
  - BLOB の論理的な削除: バックアップ ポリシーで指定した保持期間 + 5 日
  - BLOB のバージョン管理
  - BLOB の変更フィード

  バックアップ対象として構成したストレージ アカウントで、**コンテナーのポイントインタイム リストア** または **BLOB の論理的な削除** が (バックアップを構成する前に) 既に有効になっていた場合、Backup によって、少なくともバックアップ ポリシーで定義した保持期間が確保されます。 したがって、プロパティごとに次のようになります。

  - バックアップ ポリシーによる保持期間が、ストレージ アカウントに最初から存在する保持期間よりも長い場合: ストレージ アカウントでの保持期間は、バックアップ ポリシーに従って変更されます。
  - バックアップ ポリシーによる保持期間が、ストレージ アカウントに最初から存在する保持期間よりも短い場合: ストレージ アカウントでの保持期間は変更されず、当初の設定期間のままになります。

  ![[データ保護] タブ](./media/blob-backup-configure-manage/data-protection.png)

- **削除ロック** は、保護されているストレージ アカウントに Backup によって適用されます。 このロックは、ストレージ アカウントの誤削除を防ぐことを目的としています。 これは **[ストレージ アカウント]**  >  **[ロック]** で確認できます。

    ![ロックを削除する](./media/blob-backup-configure-manage/delete-lock.png)

## <a name="manage-operational-backup"></a>運用バックアップの管理

バックアップ センターは、すべてのバックアップを管理するための 1 つのウィンドウとして使用できます。 Azure BLOB の運用バックアップに関しては、バックアップ センターを使用して次のことを実行できます。

- 既に説明したように、これを使用してバックアップのコンテナーとポリシーを作成できます。 また、選択したサブスクリプションのすべてのコンテナーとポリシーを表示することもできます。
- バックアップ センターを使用すると、保護されているストレージ アカウントの保護の状態と、バックアップが現在構成されていないストレージ アカウントを簡単に監視できます。
- **[+ バックアップ]** ボタンを使用して任意のストレージ アカウントのバックアップを構成できます。
- **[復元]** ボタンを使用して復元を開始し、 **[バックアップ ジョブ]** を使用して復元を追跡します。 復元の実行の詳細については、「[Azure BLOB の復元](blob-backup-support-matrix.md)」を参照してください。
- バックアップ レポートを使用してバックアップの使用状況を分析します。

    ![バックアップ センター](./media/blob-backup-configure-manage/backup-center.png)

詳細については、「[バックアップ センターの概要](backup-center-overview.md)」を参照してください。

## <a name="stopping-protection"></a>保護の停止

必要に応じて、ストレージ アカウントの運用バックアップを停止できます。

>[!NOTE]
>保護を停止すると、Backup コンテナー (およびバックアップ センターなどの Backup ツール) からストレージ アカウントが関連付けを解除されるだけで、構成された BLOB のポイントインタイム リストア、バージョン管理、および変更フィードは無効になりません。

ストレージ アカウントのバックアップを停止するには、次の手順を実行します。

1. バックアップされるストレージ アカウントのバックアップ インスタンスに移動します。<br><br>これには、 **[ストレージ アカウント]**  ->  **[データ保護]**  ->  **[バックアップ設定の管理]** を使用してストレージ アカウントから移動することも、 **[バックアップ センター]**  ->  **[バックアップ インスタンス]** -> ストレージ アカウント名を検索して、バックアップ センターから直接移動することもできます。

    ![ストレージ アカウントの場所](./media/blob-backup-configure-manage/storage-account-location.png)

    ![バックアップ センターを使用したストレージ アカウントの場所](./media/blob-backup-configure-manage/storage-account-location-through-backup-center.png)


1. バックアップ インスタンスで、 **[削除]** をクリックして、特定のストレージ アカウントの運用バックアップを停止します。 
 
    ![運用バックアップの停止](./media/blob-backup-configure-manage/stop-operational-backup.png)

バックアップを停止すると、ストレージ アカウントの [データ保護] ブレードから、(バックアップの構成のために有効になっている) 他のストレージ データ保護機能を無効にすることができます。


## <a name="next-steps"></a>次のステップ

[Azure BLOB の復元](blob-restore.md)
