---
title: MABS を使用して Azure Stack HCI の仮想マシンをバックアップする
description: この記事では、Microsoft Azure Backup Server (MABS) を使用した仮想マシンのバックアップと回復の手順について説明します。
ms.topic: conceptual
ms.date: 07/27/2021
ms.openlocfilehash: e7a653f008541db548b4468a70c429fe72701797
ms.sourcegitcommit: bb1c13bdec18079aec868c3a5e8b33ef73200592
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 07/27/2021
ms.locfileid: "114722614"
---
# <a name="back-up-azure-stack-hci-virtual-machines-with-azure-backup-server"></a>Azure Backup Server を使用して Azure Stack HCI の仮想マシンをバックアップする

この記事では、Microsoft Azure Backup Server (MABS) を使用して Azure Stack HCI 上の仮想マシンをバックアップする方法について説明します。

## <a name="supported-scenarios"></a>サポートされるシナリオ

MABS を使用すると、次のシナリオで Azure Stack HCI の仮想マシンをバックアップすることができます。

- **Azure Stack HCI ホスト**: Azure Stack HCI ホストのシステム状態と BMR をバックアップおよび回復します。 MABS 保護エージェントをホストにインストールする必要があります。

- **ローカル ストレージまたは直接ストレージを使用するクラスターの仮想マシン**: ローカルまたは直接アタッチされたストレージのあるクラスター内のゲスト仮想マシンをバックアップします。 たとえば、ハード ドライブ、記憶域ネットワーク (SAN) デバイス、ネットワーク接続ストレージ (NAS) デバイスなどです。

- **CSV ストレージを使用するクラスター内の仮想マシン**: クラスター共有ボリューム (CSV) ストレージを使用する Azure Stack HCI クラスターでホストされているゲスト仮想マシンをバックアップします。 MABS 保護エージェントは、各クラスター ノードにインストールされます。

- **クラスター内での VM の移動**: VM がストレッチ クラスター内または通常クラスター内で移動されるとき、MABS 保護エージェントが Azure Stack HCI ホストにインストールされている限り、MABS により継続して仮想マシンが保護されます。 MABS で仮想マシンが保護される方法は、関係するライブ マイグレーションの種類によって異なります。 クラスター内での VM の移動では、MABS によって移行が検出され、ユーザーの介入を必要とせずに、新しいクラスター ノードから仮想マシンがバックアップされます。 ストレージの場所は変更されないため、MABS では高速完全バックアップが継続されます。 

- **別のストレッチまたは通常クラスターへの VM の移動**: 異なるストレッチ クラスターまたは通常クラスターへの VM の移動は、サポートされていません。

## <a name="host-versus-guest-backup"></a>ホスト バックアップとゲスト バックアップ

MABS で、Azure Stack HCI 上の VM のホスト レベルまたはゲスト レベルのバックアップを行うことができます。 ホスト レベルでは、MABS 保護エージェントは Azure Stack HCI ホスト サーバーまたはクラスターにインストールされ、そのホスト上で実行されている VM とデータ ファイル全体が保護されます。   ゲスト レベルでは、エージェントが各仮想マシンにインストールされ、そのコンピューター上のワークロードが保護されます。

どちらの方法にも長所と短所があります。

- ホスト レベルのバックアップは、ゲスト マシンで実行されている OS の種類に関係なく機能し、各 VM に MABS 保護エージェントをインストールする必要がないため、柔軟性があります。 ホスト レベルのバックアップをデプロイすると、仮想マシン全体、またはファイルとフォルダー (項目レベルの回復) を回復できます。

- ゲストレベルのバックアップは、仮想マシン上で実行されている特定のワークロードを保護する場合に役立ちます。 ホストレベルでは、VM または特定のファイル全体を回復できますが、特定のアプリケーションのコンテキストでの回復機能はありません。 たとえば、バックアップした VM から特定の SharePoint 項目を回復するには、その VM のゲストレベルのバックアップを実行する必要があります。 パススルー ディスクの格納データを保護する場合は、ゲストレベルのバックアップを使用します。 パススルーでは、仮想マシンがストレージ デバイスに直接アクセスすることが許可され、仮想ボリューム データは VHD ファイル内に格納されません。

## <a name="backup-prerequisites"></a>バックアップの前提条件

MABS で仮想マシンをバックアップするための前提条件を次に示します。

| 前提条件 | 詳細 |
| ------------ | ------- |
| MABS の前提条件 | <ul> <li>仮想マシンの項目レベルの回復を実行する (ファイル、フォルダー、ボリュームを回復する) 場合は、MABS サーバーに Hyper-V ロールをインストールする必要があります。 項目レベルではなく仮想マシンを回復するだけの場合、ロールは必要ありません。</li> <li>1 台の MABS サーバー上でそれぞれ 100 GB の仮想マシンを 800 台まで保護できます。また、複数の MABS サーバーを使用すると、さらに大きいクラスターをサポートできます。</li> <li>仮想マシンのバックアップ パフォーマンスを向上させるため、MABS では、増分バックアップからページ ファイルが除外されます。</li> <li>MABS では、MABS サーバーと同じドメイン内、または子ドメインや信頼されたドメイン内の、サーバーまたはクラスターをバックアップできます。 ワークグループまたは信頼されていないドメイン内の VM をバックアップする場合は、認証を設定する必要があります。 単一のサーバーの場合は、NTLM 認証または証明書認証を使用できます。 クラスターの場合は、証明書認証のみを使用できます。</li> <li>ホスト レベルのバックアップを使用してパススルー ディスク上の仮想マシン データをバックアップすることは、サポートされていません。 このシナリオでは、ホストレベルのバックアップを使用して VHD ファイルをバックアップし、ゲストレベルのバックアップを使用してホスト上では表示されない他のデータをバックアップすることをお勧めします。</li> <li>重複除去されたボリュームに格納されている VM をバックアップできます。</li> </ul> |
| VM | <ul> <li> 仮想マシン上で実行されている統合コンポーネントのバージョンは、Azure Stack HCI ホストのバージョンと同じである必要があります。 </li> <li> 仮想マシンの各バックアップでは、バックアップの間に、仮想ハード ディスク ファイルがホストされているボリューム上に、差分ディスク (AVHD) 用の十分な空き領域が必要です。 この領域は、最初のディスク サイズ *チャーン率* バックアップ期間という計算結果以上である必要があります。 クラスター上で複数のバックアップを実行している場合は、この計算を使用して各仮想マシンで AVHD に対応できる十分なストレージ容量が必要になります。 </li> </ul> |
| Linux の前提条件 | <ul><li> MABS を使用して、Linux 仮想マシンをバックアップできます。 ファイルの整合性があるスナップショットのみがサポートされます。</li></ul> |

## <a name="back-up-virtual-machines"></a>仮想マシンをバックアップする

1. [MABS サーバー](backup-azure-microsoft-azure-backup.md)と[ストレージ](backup-mabs-add-storage.md)を設定します。 ストレージを設定するときは、次のストレージ容量のガイドラインを使用してください。

   - 仮想マシンの平均サイズ - 100 GB
   - MABS サーバーあたりの仮想マシンの数 - 800
   - 800 台の VM の合計サイズ - 80 TB
   - バックアップ ストレージに必要な領域 - 80 TB

2. サーバーまたは各クラスター ノードで MABS 保護エージェントを設定します。

3. MABS 管理者コンソールで、 **[保護]**  >  **[保護グループの作成]** を選択し、**新しい保護グループの作成** ウィザードを開きます。

4. **[グループ メンバーの選択]** ページで、保護する VM を、それらが配置されているホスト サーバーから選択します。 同じ保護ポリシーを持つすべての VM を 1 つの保護グループにまとめることをお勧めします。 領域を効率的に使用するには、コロケーションを有効にします。 複数のデータ ソースが 1 つのレプリカと回復ポイントのボリュームを持つように、コロケーションを使用して、同じディスクまたはテープ ストレージ上の異なる保護グループのデータを配置することができます。

5. **[データの保護方法の選択]** ページで、保護グループ名を指定します。 Azure Backup サービスを使用して Azure にデータをバックアップする場合は、 **[次を使用して短期的な保護を行う: ディスク]** を選択し、 **[オンライン保護を利用する]** を選択します。

6. **[短期的な目標値の指定]**  >  **[保有期間の範囲]** で、ディスク データを保持する期間を指定します。 **[同期頻度]** で、データの増分バックアップを実行する頻度を指定します。 または、増分バックアップの間隔を選択する代わりに、 **[回復ポイントの直前]** を有効にすることができます。 この設定を有効にすると、MABS ではスケジュールされた各回復ポイントの直前に高速完全バックアップが実行されます。

    > [!NOTE]
    >アプリケーションで増分バックアップがサポートされている場合、アプリケーションのワークロードを保護していると、同期の頻度に従って回復ポイントが作成されます。 そうでない場合、MABS では増分バックアップではなく高速完全バックアップが実行され、高速バックアップのスケジュールに従って回復ポイントが作成されます。<br></br>バックアップ プロセスでは、VM に関連付けられているチェックポイントはバックアップされません。

7. **[ディスク割り当ての確認]** ページでは、保護グループに割り当てられている記憶域プールのディスク領域を確認します。

   **[合計データ サイズ]** は、バックアップするデータのサイズです。 **[Disk space to be provisioned on MABS]\(MABS にプロビジョニングするディスク領域\)** は、MABS が保護グループに推奨する領域です。 MABS では、設定に基づいて理想的なバックアップ ボリュームが選択されます。 ただし、 **[Disk allocation details]\(ディスク割り当ての詳細\)** でバックアップ ボリュームの選択を編集できます。 ワークロードの場合、ドロップダウン メニューで、優先ストレージを選択します。 編集すると、 **[利用できるディスク ストレージ]** ウィンドウの **[ストレージの合計]** と **[空きストレージ]** の値が変わります。 過小にプロビジョニングされた領域とは、今後もスムーズなバックアップを確実に行うためにボリュームに追加することを MABS から提案されるストレージの量です。

8. **[レプリカの作成方法の選択]** ページで、保護グループに含まれるデータの最初のレプリケーションの実行方法を指定します。 **[Automatically replicate over the network]\(ネットワーク経由で自動的にレプリケートする\)** を選択した場合は、オフピーク時を選択することをお勧めします。 データが大量にある場合や、ネットワークの状態が最適でない場合は、 **[手動]** を選択することを検討してください。この場合、リムーバブル メディアを使用してオフラインでデータをレプリケートする必要があります。

9. **[整合性チェック オプション]** ページで、整合性チェックを自動化する方法を選択します。 レプリカ データに不整合が生じた場合にのみ、またはスケジュールに従ってチェックを実行することができます。 自動整合性チェックを構成しない場合は、保護グループを右クリックし、 **[整合性チェックの実行]** を選択することで手動チェックをいつでも実行できます。

    保護グループを作成した後、選択した方法に従ってデータの最初のレプリケーションが行われます。 最初のレプリケーション後、各バックアップは保護グループの設定に従って実行されます。 バックアップ データを回復する必要がある場合は、次の点に注意します。

## <a name="back-up-replica-virtual-machines"></a>レプリカ仮想マシンをバックアップする

Windows Server 2012 R2 以降で MABS が実行されている場合は、レプリカ仮想マシンをバックアップできます。 これは次のいくつかの理由で役に立ちます。

**実行中のワークロードに対するバックアップの影響を軽減する** - 仮想マシンのバックアップを作成すると、スナップショットが作成されるときにオーバーヘッドが発生します。 バックアップ プロセスをセカンダリ リモート サイトにオフロードすることで、実行中のワークロードはバックアップ操作の影響を受けなくなります。 これは、バックアップ コピーがリモート サイトに保存され展開にのみ適用されます。 たとえば、バックアップを毎日作成し、データをローカルに保存して迅速な復元時間を確保しながら、長期保存のためにリモートに保存されたレプリカ仮想マシンから毎月または四半期ごとのバックアップを作成することができます。

**帯域幅を節約する** - 一般的なリモート ブランチ オフィス/本社の展開では、サイト間でバックアップ データを転送できる適切な量のプロビジョニングされた帯域幅が必要です。 データのバックアップ戦略に加え、レプリケーションとフェールオーバーの戦略を立てると、ネットワーク経由で送信される冗長データの量を減らすことができます。 プライマリではなくレプリカ仮想マシン データをバックアップすることで、バックアップ データをネットワーク経由で送信する際のオーバーヘッドを削減できます。

**ホスト バックアップを有効にする** - セカンダリ データセンターを必要とせずに、ホストされたデータセンターをレプリカ サイトとして使用できます。 この場合、ホスト SLA にはレプリカ仮想マシンの整合性のあるバックアップが必要です。

フェールオーバーが開始されるまでレプリカ仮想マシンは無効であり、VSS ではレプリカ仮想マシンのアプリケーション整合性バックアップを保証できません。 そのため、レプリカ仮想マシンのバックアップにはクラッシュ整合性のみがあります。 クラッシュ整合性を保証できない場合、バックアップは失敗します。これは次のようなさまざまな状況で発生する可能性があります。

- レプリカ仮想マシンは正常ではなく、重大な状態です。

- レプリカ仮想マシンは再同期中です ("再同期が進行中" または "再同期が必要" 状態)。

- プライマリ サイトとセカンダリ サイト間の最初のレプリケーションが、仮想マシンに対して進行中または保留中です。

- .hrl ログがレプリカ仮想マシンに適用されています。または、仮想ディスクに .hrl ログを適用する以前のアクションが失敗したか、取り消されたか、中断されました。

- レプリカ仮想マシンの移行またはフェールオーバーが進行中。

## <a name="recover-backed-up-virtual-machines"></a>バックアップされた仮想マシンを回復する

バックアップした仮想マシンを回復できる場合は、回復ウィザードを使用して仮想マシンと特定の回復ポイントを選択します。 回復ウィザードを開いて仮想マシンを回復するには、次の手順を実行します。

1. MABS 管理者コンソールで、VM の名前を入力するか、保護されている項目の一覧を展開し、 **[保護されるすべての HyperV データ]** に移動して、回復する VM を選択します。

2. **[回復ポイント]** ウィンドウのカレンダーで、任意の日付を選択して使用できる回復ポイントを確認します。 次に、 **[パス]** ウィンドウで、回復ウィザードで使用する回復ポイントを選択します。

3. **[操作]** メニューの **[回復]** を選択して回復ウィザードを開きます。

    選択した VM と回復ポイントが **[回復の選択の確認]** 画面に表示されます。 **[次へ]** を選択します。

4. **[回復の種類の選択]** 画面で、データを回復する場所を選択してから **[次へ]** を選択します。

    - **[元のインスタンスに回復する]** :元のインスタンスに回復すると、元の VHD と、関連するすべてのチェックポイントが削除されます。 MABS によって、Hyper-V VSS ライターが使用され、VHD と他の構成ファイルが元の場所に回復されます。 回復プロセスが終了しても、仮想マシンは高可用なままです。
        リソース グループは回復のために存在している必要があります。 使用できない場合は、別の場所に回復してから仮想マシンを高可用にします。

    - **[仮想マシンとして任意のホストに回復します]** : MABS では、別の場所への回復 (ALR) がサポートされており、プロセッサのアーキテクチャに関係なく、保護対象の Azure Stack HCI 仮想マシンを、同じクラスター内の異なるホストにシームレスに回復できます。 クラスター ノードに回復された Azure Stack HCI 仮想マシンは、高可用性ではありません。 このオプションを選択した場合、回復ウィザードには回復先と回復先のパスを識別する追加の画面が表示されます。
    
        >[!NOTE]
        >元のホストを選択した場合は、 **[元のインスタンスに回復する]** と同じ動作になります。 元の VHD と、関連付けられているすべてのチェックポイントが削除されます。

    - **[ネットワーク フォルダーにコピーする]** : MABS では、項目レベルの回復 (ILR) がサポートされています。これにより、ホストレベルの Azure Stack HCI 仮想マシンのバックアップからネットワーク共有または MABS で保護されたサーバー上のボリュームへのファイル、フォルダー、ボリューム、および仮想ハード ディスク (VHD) の項目レベルの回復を実行できます。 項目レベルの回復を実行するために、MABS 保護エージェントをゲスト内にインストールする必要はありません。 このオプションを選択した場合、回復ウィザードには回復先と回復先のパスを識別する追加の画面が表示されます。

5. **[回復オプションの指定]** で回復オプションを構成し、 **[次へ]** を選択します。

    - 低い帯域幅で VM を回復している場合は、 **[変更]** を選択して **[ネットワークの使用帯域幅の調整]** を有効にします。 調整オプションを有効にした後、使用できるようにする帯域幅の量と、その帯域幅を使用できる時間を指定できます。
    - ネットワークを構成した場合は、 **[ハードウェア スナップショットを使用した SAN ベースの回復を有効にする]** を選択します。
    - 回復処理が完了したらメール通知を送信する場合は、 **[Send an e-mail when the recovery completes]\(回復が完了したらメールを送信する\)** を選択し、メール アドレスを指定します。

6. [概要] 画面で、すべての詳細が正しいことを確認します。 詳細が正しくない場合、または変更する場合は、 **[戻る]** を選択します。 設定に問題がなければ、 **[復旧]** を選択して復旧プロセスを開始します。

7. **[回復状態]** 画面には、回復ジョブに関する情報が表示されます。

## <a name="next-steps"></a>次のステップ

[Azure Backup Server からのデータ復旧](./backup-azure-alternate-dpm-server.md)
