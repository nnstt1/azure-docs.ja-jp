---
title: SQL Server Always On 可用性グループをバックアップする
description: この記事では、SQL Server Always On 可用性グループをバックアップする方法について説明します。
ms.topic: conceptual
ms.date: 08/20/2021
ms.openlocfilehash: 84826d7d6d8f0611c73dcfda25ca3492d9370c97
ms.sourcegitcommit: dcf1defb393104f8afc6b707fc748e0ff4c81830
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 08/27/2021
ms.locfileid: "123113831"
---
# <a name="backup-sql-server-always-on-availability-groups"></a>SQL Server Always On 可用性グループをバックアップする

Azure Backup では、すべてのノードが Recovery Services コンテナーと同じリージョンおよびサブスクリプション内にある場合に、SQL Server Always On 可用性グループ (AG) のバックアップをエンド ツー エンドでサポートします。 ただし、AG ノードが複数のリージョン、サブスクリプション、またはオンプレミスや、Azure 全体に分散している場合は、注意すべき考慮事項がいくつかあります。

>[!Note]
>Azure Backup では、基本的な可用性グループ データベースのバックアップはサポートされていません。

Azure Backup の SQL AG で使用されるバックアップ設定では、プライマリ レプリカからの完全および差分バックアップのみがサポートされています。 そのため、これらのバックアップ ジョブは、バックアップの設定に関係なく、常にプライマリ ノードで実行されます。 コピーのみの完全およびトランザクション ログ バックアップの場合は、バックアップが実行されるノードを決定する際に AG のバックアップ設定が考慮されます。

| AG のバックアップの設定 | 完全および差分バックアップの実行場所 | コピーのみおよびログ バックアップの取得元 |
| -------------------- | ---------------------------- | ---------------------------------------- |
| プライマリ | プライマリ レプリカ | プライマリ レプリカ |
| [セカンダリのみ] | プライマリ レプリカ | セカンダリ レプリカのいずれか 1 つ |
| [セカンダリを優先] | プライマリ レプリカ | セカンダリ レプリカが推奨されますが、プライマリ レプリカでもバックアップを実行できます。 |
| なし/任意 | プライマリ レプリカ | 任意のレプリカ |

ワークロード バックアップ拡張機能は、ノードが Azure Backup サービスに登録されたときにインストールされます。 AG データベースがバックアップ用に構成されている場合は、バックアップ スケジュールが AG のすべての登録済みノードにプッシュされます。 それらのスケジュールがすべての AG ノードで起動すると、それらのノード上のワークロード バックアップ拡張機能によりノード間の同期がとられて、バックアップを実行するノードが決定します。 ノードの選択は、セクション 1 で説明するように、バックアップの種類とバックアップ設定によって異なります。 

選択したノードではバックアップ ジョブが続行されますが、他のノードでトリガーされたジョブはスキップされます。

>[!Note]
>Azure Backup では、セカンダリ レプリカの中から選ぶ際に、バックアップの優先順位やレプリカは考慮しません。

## <a name="register-ag-nodes-to-the-recovery-services-vault"></a>Recovery Services コンテナーへの AG ノードの登録

Recovery Services コンテナーでは、コンテナーと同じリージョンおよびサブスクリプション内の VM からのデータベースのバックアップのみをサポートしています。

- プライマリ ノードをコンテナーに登録する必要があります (そうしないと、完全バックアップを実行できません)。
- バックアップ設定が "_セカンダリのみ_" である場合は、少なくとも 1 つのセカンダリ ノードをコンテナーに登録する必要があります (そうしないと、ログまたはコピーのみの完全バックアップを実行できません)。

上記の条件が満たされていない場合は、エラー コード _FabricSvcBackupPreferenceCheckFailedUserError_ で AG データベースのバックアップの構成に失敗します。

参考として次の AG デプロイについて考えてみましょう。

:::image type="content" source="./media/backup-sql-server-on-availability-groups/ag-deployment.png" alt-text="参考としての AG デプロイの図。":::

上記の AG デプロイのサンプルを使用して、さまざまな考慮事項を次に示します。

- リージョン 1 およびサブスクリプション 1 内にプライマリ ノードがあるので、この AG を保護するには Recovery Services コンテナー (コンテナー 1) がリージョン 1 およびサブスクリプション 1 内にある必要があります。
- VM3 は別のサブスクリプション内にあるので、コンテナー 1 に登録することはできません。
- VM4 は別のリージョン内にあるので、コンテナー 1 に登録することはできません。
- バックアップ設定が "_セカンダリのみ_" である場合は、VM1 (プライマリ) と VM2 (セカンダリ) をコンテナー 1 に登録する必要があります (完全バックアップにはプライマリ ノードが必要で、ログにはセカンダリ ノードが必要なため)。 その他のバックアップ設定では、VM1 (プライマリ) をコンテナー 1 に登録する必要があり、VM2 は省略可能です (すべてのバックアップをプライマリ ノードで実行できるため)。
- VM3 はサブスクリプション 2 内のコンテナー 2 に登録でき、AG データベースはコンテナー 2 での保護の対象となりますが、コンテナー 2 にプライマリ ノードが存在しないため、バックアップの構成に失敗します。
- 同様に、VM4 はリージョン 2 内のコンテナー 4 に登録できますが、プライマリ ノードがコンテナー 4 に登録されていないので、バックアップの構成に失敗します。

## <a name="handle-failover"></a>フェールオーバーの処理

AG がセカンダリ ノードの 1 つにフェールオーバーされた後は、次のようになります。

- 完全および差分バックアップが新しいプライマリ ノードから続行されます (それがコンテナーに登録されている場合)。
- バックアップ設定に基づいて、ログおよびコピーのみの完全バックアップがプライマリまたはセカンダリ ノードから続行されます。

>[!Note]
>フェールオーバーがバックアップと重ならなければ、フェールオーバー時にログ チェーンは切断されません。

上記の AG デプロイのサンプルを使用して、考えられるさまざまなフェールオーバーを次に示します。

- VM2 へのフェールオーバー
  - 完全および差分バックアップが VM2 から行われます。
  - バックアップ設定に基づいて、ログおよびコピーのみの完全バックアップが VM1 または VM2 から行われます。
- VM3 (別のサブスクリプション) へのフェールオーバー
  - コンテナー 2 ではバックアップが構成されていないので、バックアップは行われません。
  - バックアップ設定が "セカンダリのみ" ではない場合は、プライマリ ノードがコンテナー 2 に登録されているので、コンテナー 2 でバックアップを構成できます。 ただし、これにより競合またはバックアップ エラーが発生する可能性があります。 これについて詳しくは、「[マルチリージョン AG のバックアップの構成](#configure-backups-for-a-multi-region-ag)」を参照してください。
- VM4 (別のリージョン) へのフェールオーバー
  - コンテナー 4 ではバックアップが構成されていないので、バックアップは行われません。
  - バックアップ設定が "セカンダリのみ" ではない場合は、プライマリ ノードがコンテナー 4 に登録されているので、コンテナー 4 でバックアップを構成できます。 ただし、これにより競合またはバックアップ エラーが発生する可能性があります。 これについて詳しくは、「[マルチリージョン AG のバックアップの構成](#configure-backups-for-a-multi-region-ag)」を参照してください。

## <a name="configure-backups-for-a-multi-region-ag"></a>マルチリージョン AG のバックアップの構成

Recovery Services コンテナーでは、異なるサブスクリプション間または異なるリージョン間のバックアップをサポートしていません。 ここでは、複数のサブスクリプションまたは Azure リージョンにまたがる AG のバックアップを有効にする方法と、関連する考慮事項について説明します。

- すべてのノードからのバックアップを本当に有効にする必要があるかどうかを評価します。 1 つのリージョンまたはサブスクリプションにほとんどの AG ノードが含まれており、他のノードへのフェールオーバーがめったに発生しない場合は、その最初のリージョンでバックアップを設定するだけで十分です。 他のリージョンまたはサブスクリプションへのフェールオーバーが頻繁に発生し、かつ長期間にわたる場合は、他のリージョンでもバックアップをプロアクティブに設定することをお勧めします。

- バックアップが有効になっている各コンテナーには、独自の復旧ポイント チェーンのセットがあります。 これらの復旧ポイントからの復元は、そのコンテナーに登録されている VM に対してのみ実行できます。

- 完全および差分バックアップは、プライマリ ノードを含むコンテナーでのみ正常に実行されます。 他のコンテナーでは、これらのバックアップは失敗し続けます。

- 新しいコンテナー (つまり、新しいプライマリ ノードが存在するコンテナー) 内でログ バックアップが実行されて、前のコンテナーのログ チェーンが "_切断される_" まで、ログ バックアップは前のコンテナーで動作し続けます。
  >[!Note]
  >15 日間というハード制限があり、それを超えると、ログ バックアップは失敗し始めます。

- コピーのみの完全バックアップは、すべてのコンテナーで機能します。

- 各コンテナーでの保護は個別のデータ ソースとして扱われ、別途請求されます。

2 つのコンテナー間のログ バックアップの競合を回避するために、バックアップ設定を [プライマリ] に設定することをお勧めします。 これにより、プライマリ ノードを含むどのコンテナーでもログ バックアップが作成されるようになります。

上記の AG デプロイのサンプルを使用して、すべてのノードからのバックアップを有効にする手順を次に示します。 すべての手順でバックアップ設定が満たされていることを前提としています。

### <a name="step-1-enable-backups-in-region-1-subscription-1-vault-1"></a>手順 1: リージョン 1、サブスクリプション 1 (コンテナー 1) でバックアップを有効にする

プライマリ ノードがリージョンおよびサブスクリプション内にあるので、バックアップを有効にする通常の手順が機能します。

### <a name="step-2-enable-backups-in-region-1-subscription-2-vault-2"></a>手順 2: リージョン 1、サブスクリプション 2 (コンテナー 2) でバックアップを有効にする

1. プライマリ ノードがコンテナー 2 に存在するように、AG を VM3 にフェールオーバーします。
1. コンテナー 2 で AG データベースのバックアップを構成します。
1. この時点で:
   1. 登録されているどのノードもこのバックアップを実行できないので、コンテナー 1 での完全または差分バックアップは失敗します。
   1. ログ バックアップがコンテナー 2 で実行され、コンテナー 1 のログ チェーンが "_切断される_" まで、コンテナー 1 でのログ バックアップは成功します。
1. AG を VM1 にフェールバックします。

### <a name="step-3-enable-backups-in-region-2-subscription-1-vault-4"></a>手順 3: リージョン 2、サブスクリプション 1 (コンテナー 4) でバックアップを有効にする

手順 2 と同じです。

## <a name="backup-an-ag-that-spans-azure-and-on-premises"></a>Azure とオンプレミスにまたがる AG のバックアップ

SQL Server 用の Azure Backup は、オンプレミスでは実行できません。 プライマリ ノードが Azure 内にあり、バックアップ設定が Azure 内のノードによって満たされている場合は、上記のマルチリージョン AG 用のガイダンスに従って、Azure でレプリカのバックアップを有効にできます。 オンプレミスのノードへのフェールオーバーが発生した場合、Azure での完全および差分バックアップは失敗し始めます。 ログ バックアップは、ログ チェーンが切断されるか、15 日が経過するまで続行できます。

## <a name="throttling-for-backup-jobs-in-an-ag-database"></a>AG データベースでのバックアップ ジョブの調整

現在、バックアップ調整の制限は、個々のマシン レベルで適用されます。 既定の制限は 20 です。20 件を超えるバックアップが同時にトリガーされると、最初の 20 件が実行され、残りはキューに入れられます。 実行中のジョブが完了すると、キューに入っているものの実行が開始されます。

同時実行のバックアップによってノード上のメモリ、IO、または CPU に負荷がかかっている場合は、この値を小さい値に変更できます。
**調整はノード レベルで行われるため、AG ノードが不均衡になると、バックアップの同期に関する問題が発生する可能性があります**。 これを理解するために、2 ノードの AG を例にとって考えてみましょう。

たとえば、1 つ目のノードで 50 個のスタンドアロン データベースが保護されており、両方のノードでそれぞれ 5 個の AG データベースが保護されています。 実質的には、ノード 1 で 55 件のデータベース バックアップ ジョブがスケジュールされているのに対し、ノード 2 ではわずか 5 件です。 また、これらのバックアップはすべて、1 時間おきに同時に実行されるように構成されています。 ある時点で、55 件のバックアップがすべてノード 1 でトリガーされ、そのうちの 35 件がキューに入れられます。 これらの一部は、AG データベースのバックアップになります。 しかし、ノード 2 では、AG データベースのバックアップがキューを使用せずに進められます。

AG データベース ジョブが一方のノードではキューに入れられ、もう一方のノードでは実行されているので、バックアップの同期 (セクション 6 で説明) が正しく機能しません。 ノード 2 ではノード 1 がダウンしているものと見なしている可能性があるため、そこからのジョブは同期の対象になっていません。 そのため、両方のノードで別々にバックアップを実行できるため、ログ チェーンの切断や追加のバックアップが発生する可能性があります。

保護されている AG データベースの数が調整の制限を超えると、同様の問題が発生する可能性があります。 そのような場合、DB1 などのバックアップがノード 1 ではキューに入れられる可能性があるのに対し、ノード 2 では実行されます。 

こうした同期の問題を回避するために、次のバックアップ設定を使用することをお勧めします。

- 2 ノードの AG の場合、バックアップ設定を [プライマリ] または [セカンダリのみ] に設定します。これにより、1 つのノードでのみバックアップを実行でき、他方では常にスキップされるようになります。 
- 2 ノードを超える AG の場合、バックアップ設定を [プライマリ] に設定します。これにより、プライマリ ノードのみでバックアップを実行でき、他方ではスキップされるようになります。

## <a name="billing-for-ag-backups"></a>AG バックアップの課金

スタンドアロンの SQL インスタンスと同様に、1 つのバックアップ AG インスタンスが 1 つの保護されたインスタンスと見なされます。 1 つのインスタンス内のすべての保護されたデータベースのフロントエンド サイズの合計について課金されます。 次のデプロイについて考えてみましょう。

:::image type="content" source="./media/backup-sql-server-on-availability-groups/protected-instances-calculation.png" alt-text="データベースの保護されたインスタンスの計算を示す図。":::

保護されたインスタンスは次のように計算されます。

| 保護されたインスタンス/課金インスタンス | フロントエンド サイズの計算対象となるデータベース |
| ------------------------------------ | -------------------------------------------------- |
| AG1 | DB1、DB2 |
| AG2 | DB4 |
| VM2 | DB3 |
| VM3 | DB6 |
| VM4 | DB5 |

## <a name="moving-a-protected-database-in-or-out-of-an-ag"></a>保護されたデータベースの AG 内外への移動

Azure Backup では、**SQL インスタンスまたは AG 名\データベース名** をデータベースの一意の名前と見なします。 スタンドアロン DB が保護されていた場合、その一意の名前は _StandAloneInstanceName\DBName_ でした。 それが AG の下に移動すると、一意の名前が _AGName\DBName_ に変わります。 そのスタンドアロン データベースのバックアップは、エラー コード _UserErrorBackupFailedStandaloneDatabaseMovedInToAG_ で失敗し始めます。

AG の下で保護されるように、そのデータベースを構成する必要があります。 これは、別の復旧ポイント チェーンを持つ新しいデータ ソースとして扱われます。 データを保持した状態でスタンドアロン データベースの以前の保護を停止することで、今後のバックアップがトリガーされて失敗するのを回避できます。 同様に、保護された AG データベースが AG の外部に移動して、スタンドアロン データベースになった場合、そのバックアップはエラー コード _UserErrorBackupFailedDatabaseMovedOutOfAG_ で失敗し始めます。

スタンドアロン インスタンスの下で保護されるように、そのデータベースを構成する必要があります。 これは、別の復旧ポイント チェーンを持つ新しいデータ ソースとして扱われます。 データを保持した状態で AG データベースの以前の保護を停止することで、今後のバックアップがトリガーされて失敗するのを回避できます。

## <a name="additionremoval-of-a-node-to-an-ag"></a>AG へのノードの追加または削除

バックアップ用に構成されている AG に新しいノードが追加されると、既に登録されている AG ノード上で実行されているワークロード バックアップ拡張機能により、AG トポロジの変更が検出され、次回のスケジュールされたデータベース検出ジョブの実行中に Azure Backup サービスに通知されます。 この新しいノードが、他の既存のノードと同じ Recovery Services コンテナーにバックアップ用として登録されると、Azure Backup サービスでは、AG バックアップの実行に必要なメタデータを使用してこの新しいノードを構成するワークフローをトリガーします。

この後、新しいノードでは、Azure Backup サービスからの AG バックアップ スケジュール情報を同期させ、同期されたバックアップ プロセスへの参加を開始します。 新しいノードでバックアップ スケジュールを同期させてバックアップに参加することができない場合、そのノードに対して再登録をトリガーすることで、そのノードを AG バックアップ用に強制的に再構成できます。 同様に、ノードの追加でも、この場合はワークロード拡張機能によって AG トポロジの変更が検出され、Azure Backup サービスに通知されます。 このサービスでは、削除されたノードでノードの "_構成解除_" ワークフローを開始して AG データベース用のバックアップ スケジュールをクリアし、AG 関連のメタデータを削除します。

## <a name="un-register-an-ag-node-from-azure-backup"></a>Azure Backup からの AG ノードの登録解除

1 つ以上のデータベースがバックアップ用に構成されている AG にノードが 1 つ含まれている場合、Azure Backup ではそのノードの登録解除を許可しません。 これは将来、そのノードがないとバックアップ設定を満たすことができない場合にバックアップ エラーが発生するのを防ぐためです。 ノードの登録を解除するには、最初にそれを AG から削除する必要があります。 ノードの "_構成解除_" ワークフローが完了したら、そのノードをクリーンアップして、登録を解除できます。

Azure Backup から AG SQL 可用性グループへのデータベースの復元では、データベースを AG に直接復元する方法がサポートされていません。 データベースをスタンドアロンの SQL インスタンスに復元してから、AG に参加させる必要があります。

## <a name="next-steps"></a>次のステップ

具体的には、次の方法を学習します。

* [バックアップした SQL Server データベースの復元](restore-sql-database-azure-vm.md)
* [バックアップした SQL Server データベースの管理](manage-monitor-sql-database-backup.md)
