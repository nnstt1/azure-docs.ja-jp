---
title: チュートリアル - Azure IoT Central アプリケーションでルールを作成して管理する
description: このチュートリアルでは、Azure IoT Central のルールを使用して、ほぼリアルタイムでデバイスを監視し、ルールがトリガーされたときに、電子メールの送信などのアクションを自動的に呼び出す方法について説明します。
author: dominicbetts
ms.author: dobett
ms.date: 01/08/2021
ms.topic: tutorial
ms.service: iot-central
services: iot-central
ms.openlocfilehash: 6a9a7d23d4fb8f11c27f279bdef8d2b46274b21e
ms.sourcegitcommit: 0046757af1da267fc2f0e88617c633524883795f
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 08/13/2021
ms.locfileid: "121743384"
---
# <a name="tutorial-create-a-rule-and-set-up-notifications-in-your-azure-iot-central-application"></a>チュートリアル:Azure IoT Central アプリケーションで規則を作成して通知を設定する

Azure IoT Central を使用して、接続されたデバイスをリモートで監視できます。 Azure IoT Central のルールを使用すると、ほぼリアルタイムでデバイスを監視し、電子メールの送信などのアクションを自動的に呼び出すことができます。 この記事では、自分のデバイスから送信されるテレメトリを監視するルールを作成する方法について説明します。

デバイスは、テレメトリを使用してデバイスから数値データを送信します。 選択したテレメトリが指定されたしきい値を超えると、ルールがトリガーされます。

このチュートリアルでは、シミュレートされたセンサー デバイスの温度が華氏 70&deg; を超えたときにメールを送信するルールを作成します。

このチュートリアルでは、以下の内容を学習します。

> [!div class="checklist"]
>
> * 規則を作成する
> * 電子メール アクションを作成する

## <a name="prerequisites"></a>前提条件

このチュートリアルを完了するには、以下が必要になります。

[!INCLUDE [iot-central-prerequisites-basic](../../../includes/iot-central-prerequisites-basic.md)]

## <a name="add-and-customize-a-device-template"></a>デバイス テンプレートを追加およびカスタマイズする

デバイス カタログからデバイス テンプレートを追加します。 このチュートリアルでは、**ESP32-Azure IoT Kit** デバイス テンプレートを使用します。

1. 新しいデバイス テンプレートを追加するには、 **[デバイス テンプレート]** ページで **[+ 新規]** を選択します。

1. **[種類の選択]** ページの **[Use a preconfigured device template]\(構成済みのデバイス テンプレートを使用する\)** セクションで、 **[ESP32-Azure IoT Kit]** タイルが表示されるまで下にスクロールします。

1. **[ESP32-Azure IoT Kit]** タイルを選択し、 **[Next: Review]\(次へ: 確認\)** をクリックします。

1. **[Review]\(レビュー\)** ページで、 **[Create]\(作成\)** を選択します。

作成したテンプレートの名前は **Sensor Controller** です。 このモデルには、**Sensor Controller**、**SensorTemp**、**Device Information interface** などのコンポーネントが含まれています。 コンポーネントによって、ESP32 デバイスの機能が定義されます。 機能には、テレメトリ、プロパティ、コマンドが含まれます。

**Sensor Controller** デバイス テンプレートに 2 つのクラウド プロパティを追加します。

1. **[クラウド プロパティ]** 、 **[+ クラウド プロパティの追加]** の順に選択します。 下表の情報に従って、デバイス テンプレートに 2 つのクラウド プロパティを追加します。

    | 表示名      | セマンティックの種類 | スキーマ |
    | ----------------- | ------------- | ------ |
    | Last Service Date | なし          | Date   |
    | Customer Name     | なし          | String |

1. **[保存]** を選択して変更を保存します。

デバイスを管理するためにデバイス テンプレートに新しいフォームを追加します。

1. **[ビュー]** ノードを選択し、 **[デバイスとクラウドのデータの編集]** タイルを選択して新しいビューを追加します。

1. フォーム名を「**デバイスの管理**」に変更します。

1. **[顧客名]** および **[Last Service Date]\(前回点検日\)** クラウド プロパティと、 **[Target Temperature]\(目標温度\)** プロパティを選択します。 次に、 **[セクションの追加]** を選択します。

1. **[保存]** を選択して新しいフォームを保存します。

次にデバイス テンプレートを発行します。

## <a name="create-a-rule"></a>規則を作成する

テレメトリ ルールを作成するには、デバイス テンプレートに少なくとも 1 つのテレメトリ値が含まれている必要があります。 このチュートリアルでは、温度と湿度のテレメトリを送信する、シミュレートされた **Sensor Controller** デバイスを使用します。 ルールは、デバイスによってレポートされる温度を監視し、70 度を超えたときに電子メールを送信します。

> [!NOTE]
> 1 アプリケーションあたり 50 個がルール数の上限となります。

1. 左側のペインで、 **[ルール]** を選択します。

1. まだルールを作成していない場合は、次の画面が表示されます。

    :::image type="content" source="media/tutorial-create-telemetry-rules/rules-landing-page.png" alt-text="ルールの空の一覧を示すスクリーンショット":::

1. **[+ 新規]** を選択して新しいルールを追加します。

1. ルールを識別するために「_Temperature monitor_」という名前を入力して、Enter キーを押します。

1. **[Sensor Controller]** デバイス テンプレートを選択します。 既定では、このルールはデバイス テンプレートに関連付けられたすべてのデバイスに自動的に適用されます。 デバイスのサブセットのためのフィルター処理を行うには、 **[+ フィルター]** を選択し、デバイス プロパティを使用してデバイスを識別します。 ルールを無効にするには、 **[有効/無効]** ボタンを切り替えます。

    :::image type="content" source="media/tutorial-create-telemetry-rules/device-filters.png" alt-text="ルール定義でのデバイス テンプレートの選択を示すスクリーンショット":::

### <a name="configure-the-rule-conditions"></a>ルールの条件を構成する

条件には、ルールが監視する基準を定義します。 このチュートリアルでは、温度が華氏 70&deg; を超えたときにルールがトリガーされるように構成します。

1. **[テレメトリ]** ドロップダウンから **[温度]** を選択します。

1. 次に、 **[演算子]** として **[次の値より大きい]** を選択し、 **[値]** に「_70_」を入力します。

    :::image type="content" source="media/tutorial-create-telemetry-rules/condition-filled-out.png" alt-text="ルールの温度条件を示すスクリーンショット":::

1. 必要に応じて、 **[時間の集計]** を設定できます。 時間の集計を選択する場合は、集計ドロップダウンから [平均] や [合計] などの集計の種類も選択する必要があります。

    * 集計を選択しない場合、条件を満たすテレメトリ データ ポイントごとにルールがトリガーします。 たとえば、温度が 70 度を超えるとトリガーされるようにルールを構成している場合、その値をデバイスの温度が超えると、ほぼ即座にルールがトリガーされます。
    * 集計を使用している場合は、時間枠のテレメトリ データ ポイントの集計値が条件を満たすとルールがトリガーされます。 たとえば、平均集計時間を 10 分として、温度が 70 度を超えたらトリガーされるように構成している場合、10 分の間隔で計算が行われ、70 度を越える平均温度がデバイスによってレポートされると、ルールがトリガーされます。

    :::image type="content" source="media/tutorial-create-telemetry-rules/aggregate-condition-filled-out.png" alt-text="入力された集計条件を示すスクリーンショット":::

複数の条件をルールに追加するには、 **[+ 条件]** を選択します。 複数の条件を追加する場合は、ルールをトリガーするために、すべての条件が満たされる必要があるか、またはいずれかの条件が満たされる必要があるかを指定できます。 複数の条件で時間の集計を使用している場合は、すべてのテレメトリ値を集計する必要があります。

### <a name="configure-actions"></a>アクションを構成する

条件を定義したら、ルールが適用されたときに実行するアクションを設定します。 アクションは、ルールに指定されたすべての条件が true と評価されたときに呼び出されます。

1. **[アクション]** セクションで **[+ 電子メール]** を選択します。

1. アクションの表示名として「_温度の警告_」と入力し、 **[宛先]** フィールドにメール アドレスを入力し、「_デバイスを確認する必要があります_」 と入力します (これは、メールの本文に注記として表示されます)。

    > [!NOTE]
    > 電子メールは、アプリケーションに追加されており、少なくとも 1 回はログインしているユーザーにのみ送信されます。 Azure IoT Central での[ユーザー管理](howto-administer.md)について詳しくは、こちらをご覧ください。

    :::image type="content" source="media/tutorial-create-telemetry-rules/configure-action.png" alt-text="ルールの電子メール アクションを示すスクリーンショット":::

1. アクションを保存するには、 **[Done]\(完了\)** を選択します。 ルールには複数のアクションを追加できます。

1. ルールを保存するには、 **[保存]** を選択します。 ルールは数分以内に有効になり、アプリケーションに送信されるテレメトリの監視が開始されます。 ルールで指定した条件を満たすと、構成した電子メールのアクションがトリガーされます。

しばらくしてから、ルールがトリガーされると電子メール メッセージを受け取ります。

:::image type="content" source="media/tutorial-create-telemetry-rules/email.png" alt-text="通知メールを示すスクリーンショット":::

## <a name="delete-a-rule"></a>規則を削除する

ルールが不要になった場合は、ルールを開き、 **[削除]** を選択して削除します。

## <a name="enable-or-disable-a-rule"></a>ルールを有効または無効にする

有効または無効にするルールを選択します。 ルールの **[Enabled/Disabled]\(有効/無効\)** ボタンを切り替えて、ルールのスコープ内にあるすべてのデバイスのルールを有効または無効にします。

## <a name="enable-or-disable-a-rule-for-specific-devices"></a>特定のデバイスのルールを有効または無効にする

カスタマイズしたいルールを選択します。 **[ターゲット デバイス]** セクションで 1 つ以上のフィルターを使用して、監視したいデバイスに対してルールのスコープを絞り込むことができます。

## <a name="clean-up-resources"></a>リソースをクリーンアップする

[!INCLUDE [iot-central-clean-up-resources](../../../includes/iot-central-clean-up-resources.md)]

## <a name="next-steps"></a>次のステップ

このチュートリアルでは、以下の内容を学習しました。

* テレメトリベースのルールを作成する
* アクションを追加する

しきい値に基づくルールを定義したので、次の手順では次の方法を学習することをお勧めします。

> [!div class="nextstepaction"]
> [ルールを構成する](howto-configure-rules.md)
