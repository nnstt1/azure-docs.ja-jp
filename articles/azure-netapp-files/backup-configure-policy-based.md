---
title: Azure NetApp Files 用にポリシー ベースのバックアップを構成する | Microsoft Docs
description: Azure NetApp Files ボリュームのポリシー ベースの (スケジュールされた) バックアップを構成する方法について説明します。
services: azure-netapp-files
documentationcenter: ''
author: b-juche
manager: ''
editor: ''
ms.assetid: ''
ms.service: azure-netapp-files
ms.workload: storage
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: how-to
ms.date: 10/13/2021
ms.author: b-juche
ms.openlocfilehash: 3ecb9926a03efe792f4a62e7a1cf5477e1e62269
ms.sourcegitcommit: 692382974e1ac868a2672b67af2d33e593c91d60
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 10/22/2021
ms.locfileid: "130224182"
---
# <a name="configure-policy-based-backups-for-azure-netapp-files"></a>Azure NetApp Files 用にポリシー ベースのバックアップを構成する 

Azure NetApp Files バックアップでは、ボリューム レベルで、"*ポリシー ベースの*" (スケジュールされた) バックアップと "*手動*" (オンデマンド) バックアップをサポートしています。 同じボリューム内で両方の種類のバックアップを使用できます。 構成プロセス中には、ポリシー ベースのバックアップまたは手動バックアップを行う前に、Azure NetApp Files ボリュームのバックアップ機能を有効にします。 

この記事では、ポリシー ベースのバックアップを構成する方法を示します。  手動バックアップの構成については、[手動バックアップの構成](backup-configure-manual.md)に関するページを参照してください。  

> [!IMPORTANT]
> Azure NetApp Files のバックアップ機能は、現在、プレビュー段階にあります。 機能にアクセスするための順番待ちリクエストを、「 **[Azure NetApp Files バックアップ パブリック プレビュー](https://aka.ms/anfbackuppreviewsignup)** 」ページから送信する必要があります。 Azure NetApp Files のバックアップ機能を使用するには、Azure NetApp Files チームからの正式な確認メールをお待ちください。

## <a name="about-policy-based-backups"></a>ポリシー ベースのバックアップについて  

ポリシー ベースのバックアップ機能が機能するためには、ボリュームに次の 2 種類のポリシーが必要です。  

* ボリュームのスナップショットがいつ作成されるかを制御する *スナップショット ポリシー*。
* どのスナップショットを Azure Storage へのバックアップに使用するかを制御する *バックアップ ポリシー*。

スナップショット ポリシーでは、ボリュームでのスナップショットの作成を取り扱います。 これは、スナップショットを Azure ストレージにバックアップするためにバックアップ機能によって使用されます。   

バックアップは、長時間にわたって実行される操作です。 システムでは、プライマリ ワークロード (高い優先順位が付与されます) に基づいてバックアップがスケジュールされ、バックグラウンドでバックアップが実行されます。 バックアップ対象のボリュームのサイズに応じて、バックグラウンドで数時間にわたってバックアップを実行できます。 バックアップの開始時間を選択するオプションはありません。 バックアップは、内部のスケジューリングと最適化のロジックに基づいて、サービスによって実行されます。 

ポリシーを割り当てると、ボリュームの現在の状態であるベースライン スナップショットが作成され、スナップショットが Azure ストレージに転送されます。 ベースライン スナップショットは、`snapmirror` で始まる名前を付けて作成されます。 このベースライン スナップショットは、(ポリシーに基づいて) 最初のスケジュールされたバックアップが完了したときに自動的に削除されます。 バックアップ ポリシーがボリュームにアタッチされている場合、ベースライン スナップショットが転送されるまでバックアップ リストは空になります。 バックアップが完了すると、ボリュームのバックアップ リスト内にベースライン バックアップのエントリが表示されます。 ベースラインの転送後、リストはポリシーに基づいて毎日更新されます。 空のバックアップ リストは、ベースライン バックアップが進行中であることを示します。 バックアップ ポリシーを割り当てる前に、ボリュームに既存の手動バックアップが既にある場合、ベースライン スナップショットは作成されません。 ベースライン スナップショットが作成されるのは、ボリュームに以前のバックアップがないときだけです。

## <a name="configure-and-apply-a-snapshot-policy"></a>スナップショット ポリシーを構成して適用する  

スナップショット ポリシーを作成して、バックアップするボリュームにスナップショット ポリシーを関連付ける必要があります。 1 つのスナップショット ポリシーを、複数のボリュームにアタッチできます。 スナップショット ポリシーに変更があると、ボリュームのバックアップ機能に影響する可能性があります。 

1. Azure portal にサインインして、 **[Azure NetApp Files]** に移動します。    
2. Azure NetApp Files アカウントを選択します。   
3. **[スナップショット ポリシー]** を選択します。   

    ![[スナップショット ポリシー] オプションに移動する方法を示すスクリーンショット。](../media/azure-netapp-files/backup-navigate-snapshot-policy.png)   

4.  **[スナップショット ポリシーの追加]** を選択します。
5.  表示される [スナップショット ポリシー] ページで、保持するスナップショットの数と、ボリュームのスナップショットを作成するためのスケジュールを指定します。 **[保存]** をクリックします。  

    現時点では、バックアップ機能でバックアップできるのは、毎日、毎週、毎月のスナップショットのみです。 (時間単位のバックアップはサポートされていません。)   

    * 毎日のスナップショット構成の場合は、スナップショットを作成する時刻を指定します。 
    * 毎週のスナップショット構成の場合は、スナップショットを作成する曜日と時刻を指定します。 
    * 毎月のスナップショット構成の場合は、スナップショットを作成する日付と時刻を指定します。 
    * スナップショット構成ごとに、保持するスナップショットの数を指定します。

    たとえば、毎日のバックアップを作成する場合は、毎日のスナップショット スケジュールとスナップショット数を指定してスナップショット ポリシーを構成してから、その毎日のスナップショット ポリシーをボリュームに適用する必要があります。 スナップショット ポリシーを変更するか、毎日のスナップショット構成を削除した場合、新しい毎日のスナップショットは作成されなくなり、毎日のバックアップは行われなくなります。 同じプロセスと動作が、毎週と毎月のバックアップに適用されます。  

    各スナップショットに、一意のスナップショット スケジュール構成が設定されているようにします。 設計上、Azure NetApp Files により、最新のバックアップの削除が防止されます。 時間が同じスナップショットが複数ある場合 (たとえば、毎日と毎週のスケジュール構成が同一)、Azure NetApp Files ではそれらが最新のスナップショットと見なされて、それらのバックアップの削除が防がれます。  

    次の例は、毎日のスナップショット ポリシー構成を示しています。 

    ![毎日のスナップショット ポリシー構成を示すスクリーンショット。](../media/azure-netapp-files/backup-daily-snapshot-policy.png)

6.  バックアップするボリュームにスナップショット ポリシーを適用します。  

    1. **[ボリューム]** ページに移動し、スナップショット ポリシーを適用するボリュームを右クリックして、 **[編集]** を選択します。   
        ![ボリュームの [編集] メニューを示すスクリーンショット。](../media/azure-netapp-files/backup-volume-edit-menu.png)   

    2. [編集] ウィンドウの **[スナップショット ポリシー]** で、適用するポリシーを選択します。 **[OK]** をクリックします。   
        ![[スナップショット ポリシー] プルダウンが開いた [編集] ウィンドウを示すスクリーンショット。](../media/azure-netapp-files/backup-volume-edit-snapshot-policy.png)    

## <a name="configure-a-backup-policy"></a>バックアップ ポリシーを構成する

バックアップ ポリシーを使用すると、スケジュールされた定期的間隔でボリュームを保護できます。  

バックアップ ポリシーを作成して、バックアップするボリュームにバックアップ ポリシーを関連付ける必要があります。 1 つのバックアップ ポリシーを、複数のボリュームにアタッチできます。 ポリシーを無効にするか、ボリューム レベルでバックアップを無効にすると、バックアップを一時的に停止できます。 バックアップは、ボリューム レベルで完全に無効にすることもできます。その結果、Azure ストレージ内のすべての関連データがクリーンアップされます。 バックアップ ポリシーがいずれかのボリュームに関連付けられている場合、そのバックアップ ポリシーは削除できません。

ポリシー ベースの (スケジュールされた) バックアップを有効にするには: 

1. Azure portal にサインインして、 **[Azure NetApp Files]** に移動します。 
2. Azure NetApp Files アカウントを選択します。
3. **[バックアップ]** を選択します。 

    ![[バックアップ] オプションに移動する方法を示すスクリーンショット。](../media/azure-netapp-files/backup-navigate.png)

4. **[バックアップ ポリシー]** を選択します。
5. **[追加]** を選択します。 
6. **[バックアップ ポリシー]** ページで、バックアップ ポリシーの名前を指定します。  毎日、毎週、毎月のバックアップで保持するバックアップの数を入力します。 **[保存]** をクリックします。

    ![[バックアップ ポリシー] ウィンドウを示すスクリーンショット。](../media/azure-netapp-files/backup-policy-window-daily.png)

    * スナップショット ポリシーをアタッチせずにバックアップ ポリシーを構成してボリュームにアタッチすると、バックアップは正しく機能しません。 Azure ストレージに転送されるベースライン スナップショットは 1 つだけになります。 
    * 構成するバックアップ ポリシー (毎日のバックアップなど) ごとに、対応するスナップショット ポリシー構成 (毎日のスナップショットなど) が存在することを確認します。
    * バックアップ ポリシーには、スナップショット ポリシーへの依存関係があります。 まだスナップショット ポリシーを作成していない場合は、[バックアップ ポリシー] ウィンドウで **[スナップショット ポリシーの作成]** チェック ボックスをオンにして両方のポリシーを同時に構成できます。   

        ![スナップショット ポリシーが選択されている [バックアップ ポリシー] ウィンドウを示すスクリーンショット。](../media/azure-netapp-files/backup-policy-snapshot-policy-option.png)
 
### <a name="example-of-a-valid-configuration"></a>有効な構成の例

次の構成例では、ボリュームに対してデータ保護ポリシーを構成する方法を示します。ボリュームのスナップショット数は、毎日の最新のものが 5 つ、毎週の最新のものが 4 つ、毎月の最新のものが 3 つです。 この構成により、最新の毎日のスナップショットが 15 個、最新の毎週のスナップショットが 6 個、最新の毎月のスナップショットが 4 個バックアップされることになります。

* スナップショット ポリシー:   
    毎日: `Number of Snapshots to Keep = 5`   
    毎週: `Number of Snapshots to Keep = 4`   
    毎月: `Number of Snapshots to Keep = 3`
* バックアップ ポリシー:   
    毎日: `Daily Backups to Keep = 15`   
    毎週: `Weekly Backups to Keep = 6`   
    毎月: `Monthly Backups to Keep = 4`

### <a name="example-of-an-invalid-configuration"></a>無効な構成の例

次の構成例では、毎日のバックアップのためにバックアップ ポリシーが構成されていますが、スナップショット ポリシーに、対応する構成がありません。 結果として、バックアップ ポリシーによってバックアップされる毎日のスナップショットが作成されません。 この構成では、毎週と毎月のスナップショットのみがバックアップされます。

* スナップショット ポリシー:   
    毎週: `Number of Snapshots to Keep = 4`   
    毎月: `Number of Snapshots to Keep = 3`   
* バックアップ ポリシー:   
    毎日: `Daily Backups to Keep = 15`   
    毎週: `Weekly Backups to Keep = 6`   
    毎月: `Monthly Backups to Keep = 4`   

## <a name="enable-backup-functionality-for-a-volume-and-assign-a-backup-policy"></a>ボリュームのバックアップ機能を有効にしてバックアップ ポリシーを割り当てる

バックアップ (ポリシー ベースまたは手動) を行う前に、すべての Azure NetApp Files ボリュームでバックアップ機能が有効になっている必要があります。 

バックアップ機能を有効にした後で、ポリシー ベースのバックアップが有効になるようにバックアップ ポリシーをボリュームに割り当てる必要があります。 (手動バックアップの場合、バックアップ ポリシーは省略可能です。)

ボリュームのバックアップ機能を有効にするには:  

1. **[ボリューム ]** に移動し、バックアップを有効にするボリュームを選択します。
2. **[構成]** をクリックします。
3. [バックアップの構成] ページで、 **[有効]** の設定を **[オン]** に切り替えます。
4. **[スナップショット ポリシー]** ドロップダウンメニューで、そのボリュームのために使用するスナップショット ポリシーを割り当てます。 
5. **[バックアップ ポリシー]** ドロップダウンメニューで、そのボリュームのために使用するバックアップ ポリシーを割り当てます。 **[OK]** をクリックします。

    コンテナー情報は事前に入力されています。  

    ![[バックアップの構成] ウィンドウを示すスクリーンショット。](../media/azure-netapp-files/backup-configure-window.png)


## <a name="next-steps"></a>次のステップ  

* [Azure NetApp Files バックアップについて](backup-introduction.md)
* [Azure NetApp Files バックアップの要件と考慮事項](backup-requirements-considerations.md)
* [Azure NetApp Files のリソース制限](azure-netapp-files-resource-limits.md)
* [手動バックアップの構成](backup-configure-manual.md)
* [バックアップ ポリシーを管理する](backup-manage-policies.md)
* [バックアップを検索する](backup-search.md)
* [バックアップを新しいボリュームに復元する](backup-restore-new-volume.md)
* [ボリュームのバックアップ機能を無効にする](backup-disable.md)
* [ボリュームのバックアップを削除する](backup-delete.md)
* [ボリュームのバックアップ メトリック](azure-netapp-files-metrics.md#volume-backup-metrics)
* [Azure NetApp Files のバックアップに関する FAQ](faq-backup.md)


