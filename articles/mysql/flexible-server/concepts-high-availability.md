---
title: Azure Database for MySQL - フレキシブル サーバーでのゾーン冗長 HA
description: Azure Database for MySQL - フレキシブル サーバーでのゾーン冗長高可用性の概念の概要について説明します。
author: SudheeshGH
ms.author: sunaray
ms.service: mysql
ms.topic: conceptual
ms.date: 08/26/2021
ms.openlocfilehash: 1d1ec1b6196dd543b9310a945fc9b07e26673c84
ms.sourcegitcommit: 702df701fff4ec6cc39134aa607d023c766adec3
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 11/03/2021
ms.locfileid: "131472772"
---
# <a name="high-availability-concepts-in-azure-database-for-mysql-flexible-server"></a>Azure Database for MySQL フレキシブル サーバーでの高可用性の概念

[!INCLUDE[applies-to-mysql-flexible-server](../includes/applies-to-mysql-flexible-server.md)]

Azure Database for MySQL フレキシブル サーバーでは、自動フェールオーバーによる高可用性を構成できます。 高可用性ソリューションは、コミットされたデータが障害によって失われないこと、データベースがソフトウェア アーキテクチャでの単一障害点にならないことを保証するように設計されています。 高可用性が構成されている場合、フレキシブル サーバーは、スタンバイ レプリカを自動的にプロビジョニングして管理します。 高可用性アーキテクチャ モデルには、次の 2 つがあります。

* **ゾーン冗長 HA**。 このオプションは、複数の可用性ゾーンにわたるインフラストラクチャの完全な分離と冗長性を実現する場合に適しています。 最高レベルの可用性が提供されますが、複数のゾーンにわたってアプリケーションの冗長性を構成する必要があります。 可用性ゾーン内のインフラストラクチャ障害に対して最高レベルの可用性を実現する必要があり、可用性ゾーン全体の待機時間を許容できる場合は、ゾーン冗長 HA が推奨されます。 サーバーを作成するときにのみ有効にすることができます。 ゾーン冗長 HA は、リージョンで複数の[可用性ゾーン](../../availability-zones/az-overview.md)がサポートされていて、[ゾーン冗長 Premium ファイル共有](../..//storage/common/storage-redundancy.md#zone-redundant-storage)が利用可能な、[Azure リージョンのサブセット](./overview.md#azure-regions)で利用できます。

* **同一ゾーン HA**。 このオプションは、プライマリ サーバーとスタンバイ サーバーが同じ可用性ゾーンに存在するので、ネットワーク待機時間が短いインフラストラクチャの冗長性に適しています。 高可用性を実現するのに、ゾーンをまたいでアプリケーションの冗長性を構成する必要がありません。 単一の可用性ゾーン内で、ネットワーク待機時間が最も短い最高レベルの可用性を実現する必要がある場合は、同一ゾーン HA が推奨されます。 同一ゾーン HA は、Azure Database for MySQL - フレキシブル サーバーを使用できるすべての [Azure リージョン](./overview.md#azure-regions)で使用できます。  

## <a name="zone-redundant-ha-architecture"></a>ゾーン冗長 HA のアーキテクチャ
 
ゾーン冗長 HA を使用してサーバーをデプロイすると、2 つのサーバーが作成されます。 
- 1 つの可用性ゾーン内のプライマリ サーバー
- 同じ Azure リージョンの別の可用性ゾーン内に、プライマリ サーバーと同じ構成 (コンピューティング レベル、コンピューティング サイズ、ストレージ サイズ、ネットワーク構成) のスタンバイ レプリカ サーバー
 
プライマリとスタンバイのレプリカの可用性ゾーンは選択できます。 スタンバイ データベース サーバーとスタンバイ アプリケーションを同じゾーンに配置すると、待機時間が短縮されます。 また、ディザスター リカバリー状況や "ゾーン ダウン" のシナリオに対して、より適切に備えることもできます。

:::image type="content" source="./media/concepts-high-availability/1-flexible-server-overview-zone-redundant-ha.png" alt-text="ゾーン冗長高可用性のアーキテクチャを示す図。":::

データ ファイルとログ ファイルは、[ゾーン冗長ストレージ (ZRS)](../../storage/common/storage-redundancy.md#redundancy-in-the-primary-region) でホストされます。 これらのファイルは、ZRS で利用可能なストレージ レベルのレプリケーションを介して、スタンバイ サーバーにレプリケートされます。 フェールオーバーが発生した場合: 
- スタンバイ レプリカがアクティブにされます。 
- プライマリ サーバーのバイナリ ログ ファイルが、スタンバイ サーバーに続けて適用され、プライマリで最後にコミットされたトランザクションまでオンラインになります。 

ZRS のログには、プライマリ サーバーが使用できない場合でもアクセスできます。 この可用性により、データが失われないことが保証されます。 スタンバイ レプリカがアクティブにされて、バイナリ ログが適用された後は、現在のスタンバイ レプリカ サーバーがプライマリ サーバーの役割を引き継ぎます。 クライアントの再接続時に、クライアントの接続が新しいプライマリに転送されるように、DNS が更新されます。 フェールオーバーは、クライアント アプリケーションから完全に透過的で、ユーザーによる操作は必要ありません。 その後、HA ソリューションによって、可能であれば古いプライマリ サーバーが回復され、スタンバイとして配置されます。
 
プライマリ サーバーへのアプリケーションの接続には、データベース サーバー名が使用されます。 スタンバイ レプリカの情報が、直接アクセスのために公開されることはありません。 プライマリ サーバーの ZRS でログ ファイルがフラッシュされた後で、コミットと書き込みが認められます。 ZRS ストレージで使用される同期レプリケーション テクノロジのため、アプリケーションによる書き込みとコミットの待機時間が 5% から 10% 増加する場合があります。
 
スナップショットとログ バックアップ両方の自動バックアップは、ゾーン冗長ストレージ上でプライマリ データベース サーバーから実行されます。

## <a name="same-zone-ha-architecture"></a>同一ゾーン HA のアーキテクチャ
 
同じゾーン HA を使用してサーバーをデプロイすると、同じゾーンに 2 つのサーバーが作成されます。 
- プライマリ サーバー
- プライマリ サーバーと同じ構成 (コンピューティング レベル、コンピューティング サイズ、ストレージ サイズ、ネットワーク構成) のスタンバイ レプリカ サーバー 

スタンバイ サーバーにより、別の仮想マシン (コンピューティング) でインフラストラクチャの冗長性が提供されます。 この冗長性では、コロケーションのため、フェールオーバーの時間と、アプリケーションとデータベース サーバーの間のネットワーク待機時間が短縮されます。

:::image type="content" source="./media/concepts-high-availability/flexible-server-overview-same-zone-ha.png" alt-text="同一ゾーン高可用性のアーキテクチャを示す図。":::

データ ファイルとログ ファイルは、[ローカル冗長ストレージ (LRS)](../../storage/common/storage-redundancy.md#locally-redundant-storage) でホストされます。 これらのファイルは、LRS で利用可能なストレージ レベルのレプリケーションを介して、スタンバイ サーバーにレプリケートされます。

フェールオーバーが発生した場合: 
- スタンバイ レプリカがアクティブにされます。 
- プライマリ サーバーのバイナリ ログ ファイルが、スタンバイ サーバーに続けて適用され、プライマリで最後にコミットされたトランザクションまでオンラインになります。 

LRS のログには、プライマリ サーバーが使用できない場合でもアクセスできます。 この可用性により、データが失われないことが保証されます。 スタンバイ レプリカがアクティブにされて、バイナリ ログが適用された後は、現在のスタンバイ レプリカがプライマリ サーバーの役割を引き継ぎます。 クライアントの再接続時に、接続が新しいプライマリにリダイレクトされるように、DNS が更新されます。 フェールオーバーは、クライアント アプリケーションから完全に透過的で、ユーザーによる操作は必要ありません。 その後、HA ソリューションによって、可能であれば古いプライマリ サーバーが回復され、スタンバイとして配置されます。
 
プライマリ サーバーへのアプリケーションの接続には、データベース サーバー名が使用されます。 スタンバイ レプリカの情報が、直接アクセスのために公開されることはありません。 プライマリ サーバーの LRS でログ ファイルがフラッシュされた後で、コミットと書き込みが認められます。 プライマリとスタンバイ レプリカが同じゾーン内にあるため、アプリケーション サーバーとデータベース サーバーの間のレプリケーションの遅延が小さくなり、待機時間が短くなります。 依存するインフラストラクチャが特定の可用性ゾーンでダウンしたときは、同一ゾーンのセットアップによって高可用性は提供されません。 その可用性ゾーンですべての依存サービスがオンラインに戻るまで、ダウンタイムが発生します。
 
スナップショットとログ バックアップ両方の自動バックアップは、ローカル冗長ストレージ上でプライマリ データベース サーバーから実行されます。

>[!Note]
>ゾーン冗長 HA と同一ゾーン HA の両方について:
>* 障害が発生した場合、スタンバイ レプリカがプライマリの役割を引き継ぐのに必要な時間は、スタンバイでのバイナリ ログの適用によって異なります。 そのため、フェールオーバー時間を短縮するには、すべてのテーブルで主キーを使用することをお勧めします。 フェールオーバーの時間は、通常、60 から 120 秒です。 
>* スタンバイ サーバーは、読み取りまたは書き込み操作には使用できません。 高速フェールオーバーを可能にするためのパッシブ スタンバイです。
>* プライマリ サーバーへの接続には、常に完全修飾ドメイン名 (FQDN) を使用します。 接続に IP アドレスを使用しないようにします。 フェールオーバーが発生した場合、プライマリ サーバーとスタンバイ サーバーの役割が切り替えられた後で、DNS A レコードが変更される可能性があります。 その変更により、接続文字列で IP アドレスが使用されている場合、アプリケーションが新しいプライマリ サーバーに接続できなくなるおそれがあります。

## <a name="failover-process"></a>フェールオーバー プロセス 
 
### <a name="planned-forced-failover"></a>計画的: 強制フェールオーバー
 
Azure Database for MySQL - フレキシブル サーバーの強制フェールオーバーを使用すると、手動でフェールオーバーを強制実行できます。 この機能を使用すると、アプリケーションのシナリオで機能をテストすることができ、障害に備えることができます。 

強制フェールオーバーによってトリガーされるフェールオーバーでは、スタンバイ レプリカがアクティブにされ、DNS レコードが更新されることで、同じデータベース サーバー名を使用するプライマリ サーバーになります。 元のプライマリ サーバーは再起動されて、スタンバイ レプリカに切り替えられます。 クライアント接続は切断されるので、操作を再開するには再接続する必要があります。 

フェールオーバー全体の時間は、現在のワークロードと最後のチェックポイントによって異なります。 一般に、60 から 120 秒かかることが予想されます。
 
### <a name="unplanned-automatic-failover"></a>計画外: 自動フェールオーバー 
 
計画外のサービス ダウンタイムの原因として可能性があるのは、ソフトウェアのバグ、コンピューティング、ネットワーク、ストレージの障害などのインフラストラクチャの障害、データベースの可用性に影響を与える停電などです。 データベースが使用できなくなった場合、スタンバイ レプリカへのレプリケーションは停止され、スタンバイ レプリカがアクティブにされてプライマリ データベースになります。 DNS が更新された後、クライアントはデータベース サーバーに再接続され、操作が再開されます。 

全体的なフェールオーバー時間は、60 から 120 秒の範囲と予想されます。 ただし、フェールオーバーの時点でのプライマリ データベース サーバー内のアクティビティ (大規模なトランザクションや回復時など) によっては、フェールオーバーがこれより長くなる場合があります。

## <a name="monitoring-for-high-availability"></a>高可用性の監視
HA の正常性は、概要ページで継続的に監視され、報告されます。 レプリケーションには次のような状態があります。

| **状態** | **説明** |
| :----- | :------ |
| **NotEnabled** | ゾーン冗長 HA は有効ではありません。 |
| **ReplicatingData** | スタンバイは、作成された後でプライマリ サーバーに追い付こうとしています。 |
| **FailingOver** | データベース サーバーは、プライマリからスタンバイにフェールオーバー中です。 |
| **Healthy** | ゾーン冗長 HA は、安定した状態で正常です。 |
| **RemovingStandby** | ユーザーがスタンバイ レプリカを削除し、削除が進行中です。| 

##  <a name="limitations"></a>制限事項 
 
高可用性を使用する場合、次の点にご注意ください。
* ゾーン冗長高可用性は、フレキシブル サーバーが作成されるときにのみ設定できます。
* 高可用性は、バースト可能なコンピューティング レベルではサポートされません。
* 静的パラメーターの変更を取得するためにプライマリ データベース サーバーを再起動すると、スタンバイ レプリカも再起動されます。
* 読み取りレプリカは HA サーバーではサポートされていません。
* HA サーバーのデータイン レプリケーションはサポートされていません。
* HA ソリューションでは GTID が使用されるので、GTID モードが有効になります。 お使いのワークロードに、[GTID を使用したレプリケーションに関する制限](https://dev.mysql.com/doc/refman/5.7/en/replication-gtids-restrictions.html)があるかどうかを調べてください。  
 
## <a name="frequently-asked-questions-faq"></a>よく寄せられる質問 (FAQ)
 
**読み取りまたは書き込み操作にスタンバイ レプリカを使用できますか?** </br>
スタンバイ サーバーは、読み取りまたは書き込み操作には使用できません。 高速フェールオーバーを可能にするためのパッシブ スタンバイです。</br>
**フェールオーバーが発生するとデータが失われますか?**</br>
ZRS のログには、プライマリ サーバーが使用できない場合でもアクセスできます。 この可用性により、データが失われないことが保証されます。 スタンバイ レプリカがアクティブにされて、バイナリ ログが適用された後は、それがプライマリ サーバーの役割を引き継ぎます。 </br>
**フェールオーバーの後で、何かを実行する必要がありますか?**</br>
フェールオーバーは、クライアント アプリケーションから完全に透過的です。 何らかのアクションをとる必要はありません。 アプリケーションで必要なのは、接続に対して再試行ロジックを使用することだけです。 </br>
**スタンバイ レプリカに特定のゾーンを選択しないとどうなりますか。後でゾーンを変更できますか?**</br>
ゾーンを選択しないと、ランダムに選択されます。 プライマリ サーバーに使用されるものではなくなります。 後でゾーンを変更するには、**[高可用性]** ペインで **[高可用性]** を **[無効]** に設定した後、設定を **[ゾーン冗長]** に戻してゾーンを選択します。</br>
**プライマリ レプリカとスタンバイ レプリカの間のレプリケーションは同期的ですか?**</br>
 プライマリとスタンバイの間のレプリケーションは、MySQL での[半同期モード](https://dev.mysql.com/doc/refman/5.7/en/replication-semisync.html)に似ています。 トランザクションがコミットされるとき、必ずしもスタンバイにコミットされるとは限りません。 ただし、プライマリが使用できないときは、データが失われないように、スタンバイによってプライマリからすべてのデータ変更がレプリケートされます。</br> 
**計画外のすべての障害で、スタンバイ レプリカへのフェールオーバーが行われますか?**</br>
データベースのクラッシュやノードの障害が発生すると、フレキシブル サーバー VM が同じノードで再起動されます。 同時に、自動フェールオーバーがトリガーされます。 フェールオーバーが完了する前にフレキシブル サーバー VM の再起動が成功した場合、フェールオーバー操作は取り消されます。 プライマリ レプリカとしてどのサーバーを使用するかは、最初に終了するプロセスによって決まります。</br>
**HA を使用すると、パフォーマンスに影響がありますか?**</br>
ゾーン冗長 HA では、ネットワーク待機時間が比較的長い (2 から 4 ms) 可用性ゾーン間でデータベース サーバーに接続しているアプリケーションの場合、待機時間が 5% から 10% 悪化するおそれがあります。 同一ゾーン HA の場合は、プライマリとスタンバイのレプリカが同じゾーン内にあるため、レプリケーションの遅延は低くなります。 同じ Azure 可用性ゾーン内にある場合、アプリケーション サーバーとデータベース サーバーの間の待機時間は短くなります。</br>
**HA サーバーのメンテナンスはどのように行われますか?**</br>
コンピューティングのスケーリングやマイナー バージョンのアップグレードなどの計画的なイベントは、プライマリとスタンバイで同時に発生します。 HA サーバーの[予定メンテナンス期間](./concepts-maintenance.md)は、フレキシブル サーバーの場合と同じように設定できます。 ダウンタイムの長さは、HA が無効になっているときの Azure Database for MySQL - フレキシブル サーバーのダウンタイムと同じになります。 フェールオーバー メカニズムを使用した HA サーバーのダウンタイムの短縮は、ロードマップで予定されており、間もなく提供されます。 </br>
**HA サーバーのポイントインタイム リストア (PITR) を行うことはできますか?**</br>
HA が有効になっている Azure Database for MySQL - フレキシブル サーバーから、HA が無効になっている新しい Azure Database for MySQL - フレキシブル サーバーへの [PITR](./concepts-backup-restore.md#point-in-time-restore) を行うことができます。 ソース サーバーがゾーン冗長 HA で作成されている場合は、復元されたサーバーでゾーン冗長 HA または同一ゾーン HA を後で有効にできます。 ソース サーバーが同一ゾーン HA で作成されている場合、復元されたサーバーで有効にできるのは同一ゾーン HA だけです。</br>
**サーバーの作成後に、サーバーで HA を有効にすることはできますか?**</br>
ゾーン冗長 HA は、サーバーの作成時に有効にする必要があります。 同一ゾーン HA は、サーバーを作成した後で有効にすることができます。 同一ゾーン HA を有効にする前に、サーバー パラメーターの "enforce_gtid_consistency" と ["gtid_mode"](./concepts-read-replicas.md#global-transaction-identifier-gtid) が ON に設定されていることを確認してください。</br> 
**サーバーの作成後に、サーバーの HA を無効にすることはできますか?** </br>
サーバーを作成した後で、サーバーの HA を無効にできます。 課金はすぐに停止します。  </br>
**ダウンタイムを軽減するにはどうすればよいですか?**</br>
HA を使用していない場合でも、アプリケーションのダウンタイムを軽減できる必要があります。 計画的なパッチ、マイナー バージョン アップグレード、またはコンピューティングのスケーリングなどのお客様が開始する操作のようなサービス ダウンタイムは、予定メンテナンス期間の間に実行できます。 Azure によって開始されるメンテナンス タスクがアプリケーションに与える影響を軽減するには、アプリケーションに対する影響が最も小さい曜日と時刻に、それらをスケジュールできます。</br>
**HA が有効になっているサーバーに対して読み取りレプリカを使用できますか?**</br>
読み取りレプリカは HA サーバーではサポートされていません。 この機能はロードマップで予定されており、間もなく使用できるように作業が行われています。</br>
**HA サーバーにデータイン レプリケーションを使用できますか?**</br>
HA サーバーのデータイン レプリケーションはサポートされていません。 ただし、HA サーバーのデータイン レプリケーションはロードマップで予定されており、間もなく利用可能になります。 現在、移行にデータイン レプリケーションを使用する場合は、次の手順を使用できます。
1. ゾーン冗長 HA が有効なサーバーを作成します。
1. HA を無効にします。
1. [データイン レプリケーションを設定する](./concepts-data-in-replication.md)手順を完了します。  (ソース サーバーとターゲット サーバーで、`gtid_mode` の設定が同じになるようにしてください。)
1. カットオーバー後に、データイン レプリケーションの構成を削除します。
1. HA を有効にします。

**ダウンタイムを短くするため、サーバーの再起動中、またはスケールアップやスケールダウンの間に、スタンバイ サーバーにフェールオーバーできますか?** </br>
現在、スケールアップまたはスケールダウン操作を実行すると、スタンバイとプライマリが同時にスケーリングされます。 そのため、フェールオーバーは役に立ちません。 最初にスタンバイをスケールアップし、次にフェールオーバーを行ってから、プライマリをスケールアップできるようにする機能は、ロードマップで予定されていますが、まだサポートされていません。</br>

**サーバーの可用性モード (ゾーン冗長 HA/同一ゾーン) を変更できますか** </br>
サーバーをゾーン冗長 HA モードを有効にして作成した場合は、ゾーン冗長 HA から同一ゾーンに変更できます。その逆も可能です。 可用性モードを変更するには、**[高可用性]** ペインで **[高可用性]** を **[無効]** に設定した後、設定を **[ゾーン冗長] または [同一ゾーン]** に戻し、**[高可用性モード]** を選択します。</br>  

## <a name="next-steps"></a>次のステップ

- [ビジネス継続性](./concepts-business-continuity.md)について確認する。
- [ゾーン冗長高可用性](./concepts-high-availability.md)について確認する。
- [バックアップと回復](./concepts-backup-restore.md)について確認する。
