---
title: 読み取りレプリカ - Azure Database for MySQL - フレキシブル サーバー
description: 'Azure Database for MySQL フレキシブル サーバーの読み取りレプリカについて次の内容を説明します: レプリカの作成、レプリカへの接続、レプリケーションの監視、レプリケーションの停止。'
author: savjani
ms.author: pariks
ms.service: mysql
ms.topic: conceptual
ms.date: 06/17/2021
ms.openlocfilehash: 7def4d2afac4a1f52db89defb226857b7f8b41fa
ms.sourcegitcommit: 702df701fff4ec6cc39134aa607d023c766adec3
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 11/03/2021
ms.locfileid: "131468349"
---
# <a name="read-replicas-in-azure-database-for-mysql---flexible-server"></a>Azure Database for MySQL - フレキシブル サーバーでの読み取りレプリカ

[!INCLUDE[applies-to-mysql-flexible-server](../includes/applies-to-mysql-flexible-server.md)]

MySQL は、インターネット規模の Web およびモバイル アプリケーションを実行するための一般的なデータベース エンジンの 1 つです。 多くのお客様は、オンライン教育サービス、ビデオ ストリーミング サービス、デジタル支払いソリューション、eコマース プラットフォーム、ゲーム サービス、ニュース ポータル、政府機関、医療機関の Web サイトなどにそれを使用しています。 これらのサービスは、Web またはモバイル アプリケーションでのトラフィックの増加に合わせて、サービスを提供し、スケーリングする必要があります。

アプリケーション側に関しては、通常、アプリケーションは Java または PHP で開発され、Azure 仮想マシン スケール セットや Azure App Services で実行されるように移行されたり、Azure Kubernetes Service (AKS) で実行するようにコンテナー化されたりします。 仮想マシン スケール セット、App Service、または AKS が基盤のインフラストラクチャである場合、アプリケーションのスケーリングは、新しい VM が即座にプロビジョニングされ、要求に対応するためにアプリケーションのステートレス コンポーネントがレプリケートされることによって簡単に行われますが、多くの場合、データベースが集中的なステートフル コンポーネントとしてボトルネックになります。

読み取りレプリカ機能を使用すると、Azure Database for MySQL フレキシブル サーバーから読み取り専用サーバーに、データをレプリケートできます。 ソース サーバーから最大で **10** 個のレプリカにレプリケートできます。 レプリカは、MySQL エンジンのネイティブなバイナリ ログ (binlog) ファイルの位置ベースのレプリケーション テクノロジを使用して、非同期で更新されます。 binlog レプリケーションの詳細については、[MySQL binlog レプリケーションの概要](https://dev.mysql.com/doc/refman/5.7/en/binlog-replication-configuration-overview.html)に関する記事を参照してください。

レプリカは、ソース Azure Database for MySQL フレキシブル サーバーと同じようにユーザーが管理する新しいサーバーです。 読み取りレプリカごとに、仮想コアでのプロビジョニング済みコンピューティングとストレージ (GB/月) に基づいて課金されます。 詳細については、[価格](./concepts-compute-storage.md#pricing)に関するページを参照してください。

> [!NOTE]
> 読み取りレプリカ機能は、汎用とメモリ最適化のどちらかの価格レベルにおける Azure Database for MySQL - フレキシブル サーバーにのみ使用可能です。 ソース サーバーがこれらの価格レベルのいずれであるかを確認します。

MySQL レプリケーションの機能と問題の詳細については、[MySQL レプリケーションに関するドキュメント](https://dev.mysql.com/doc/refman/5.7/en/replication-features.html)を参照してください。

> [!NOTE]
> この記事には、Microsoft が使用しなくなった "*スレーブ*" という用語への言及が含まれています。 ソフトウェアからこの用語が削除された時点で、この記事から削除します。

## <a name="common-use-cases-for-read-replica"></a>読み取りレプリカの一般的なユース ケース

読み取りレプリカ機能は、読み取り集中型ワークロードのパフォーマンスとスケールの向上に役立ちます。 読み取りワークロードをレプリカに分離しながら、書き込みワークロードはソースに送ることができます。

一般的なシナリオを次に示します。

* [ProxySQL](https://aka.ms/ProxySQLLoadBalanceReplica) のような軽量の接続プロキシを使用するか、マイクロサービス ベースのパターンを使用して、アプリケーションからの読み取りクエリを読み取りレプリカにスケールアウトすることによる、アプリケーションからの読み取りワークロードのスケーリング
* BI または分析のレポート ワークロードで、レポートのデータソースとして読み取りレプリカを使用できる
* 複数の読み取りレプリカがデータのレポートに使用されている間に、テレメトリ情報が MySQL データベース エンジンに取り込まれる、IoT または製造シナリオの場合

レプリカは読み取り専用であるため、ソースへの書き込み容量の負担を直接減らすことにはなりません。 この機能は、書き込み集中型ワークロードを対象としていません。

読み取りレプリカ機能は、MySQL の非同期レプリケーションを使用します。 機能は、同期レプリケーション シナリオを目的としていません。 ソースとレプリカの間には測定可能な遅延が発生します。 レプリカ上のデータは、最終的にソース上のデータと整合するようになります。 この機能は、この遅延に対応できるワークロードに使用してください。

## <a name="create-a-replica"></a>レプリカの作成

ソース サーバーに既存のレプリカ サーバーがない場合、まずレプリケーションの準備のためにソースが再起動されます。

レプリカ作成ワークフローを開始すると、空の Azure Database for MySQL サーバーが作成されます。 新しいサーバーには、ソース サーバー上にあったデータが設定されます。 作成時間は、ソース上のデータ量と、最後の週次完全バックアップからの経過時間に依存します。 時間の範囲は、数分から数時間になる可能性があります。

> [!NOTE]
> ソースと同じサーバー構成で、読み取りレプリカが作成されます。 作成された後、レプリカ サーバーの構成を変更できます。 レプリカ サーバーは、ソース サーバーと同じリソース グループ、同じ場所、および同じサブスクリプションに常に作成されます。 レプリカ サーバーを別のリソース グループや別のサブスクリプションに作成したい場合は、作成後に[レプリカ サーバーを移動](../../azure-resource-manager/management/move-resource-group-and-subscription.md)します。 レプリカが確実にソースに追随できるように、レプリカ サーバーの構成をソースと同じかそれ以上の値にしておくことをお勧めします。

[Azure portal で読み取りレプリカを作成する](how-to-read-replicas-portal.md)方法を確認してください。

## <a name="connect-to-a-replica"></a>レプリカへの接続

作成時に、レプリカはソース サーバーの接続方法を継承します。 ユーザーは、レプリカの接続方法を変更できません。 たとえば、ソース サーバーで **プライベート アクセス (VNet 統合)** が使用されている場合、レプリカで **パブリック アクセス (許可された IP アドレス)** を使用することはできません。

レプリカの管理者アカウントは、ソース サーバーから継承されます。 ソース サーバー上のすべてのユーザー アカウントが、読み取りレプリカにレプリケートされます。 ソース サーバー上で使用可能なユーザー アカウントのみを使って読み取りレプリカに接続できます。

通常の Azure Database for MySQL フレキシブル サーバーの場合と同じように、ホスト名と有効なユーザー アカウントを使用してレプリカに接続できます。 管理者ユーザー名が **myadmin** の **myreplica** というサーバーの場合、mysql CLI を使用して、レプリカに接続できます。

```bash
mysql -h myreplica.mysql.database.azure.com -u myadmin -p
```

メッセージが表示されたら、ユーザー アカウントのパスワードを入力します。

## <a name="monitor-replication"></a>レプリケーションを監視します

Azure Database for MySQL フレキシブル サーバーにより、Azure Monitor に **レプリケーションのラグ (秒単位)** メトリックが提供されます。 このメトリックは、レプリカのみで使用できます。 このメトリックは、MySQL の `SHOW SLAVE STATUS` コマンドで使用できる `seconds_behind_master` メトリックを使用して計算されます。 レプリケーションのラグがワークロードに対して許容できない値に達したときに通知されるアラートを設定します。

レプリケーションのラグが増加している場合は、[レプリケーションの待機時間のトラブルシューティング](./../howto-troubleshoot-replication-latency.md)に関する記事を参照して、考えられる原因を把握し、トラブルシューティングします。

## <a name="stop-replication"></a>レプリケーションの停止

ソースとレプリカの間のレプリケーションを停止できます。 ソース サーバーと読み取りレプリカの間のレプリケーションを停止すると、レプリカがスタンドアロン サーバーになります。 スタンドアロン サーバー内のデータは、レプリケーション停止コマンドが起動された時点でレプリカで使用可能だったデータです。 スタンドアロン サーバーにはソース サーバーへの変更が反映されなくなっています。

レプリカへのレプリケーションを停止すると、以前のソースと他のレプリカへのリンクがすべて失われます。 ソースとそのレプリカの間に自動フェールオーバーはありません。

> [!IMPORTANT]
>スタンドアロン サーバーをもう一度レプリカにすることはできません。
> 読み取りレプリカでレプリケーションを停止する前に、レプリカに必要なすべてのデータがあることを確認してください。

[レプリカへのレプリケーションを停止する](how-to-read-replicas-portal.md)方法を確認します。

## <a name="failover"></a>[フェールオーバー]

ソースとレプリカの各サーバー間で、自動フェールオーバーは行われません。

読み取りレプリカは、読み取り中心のワークロードのスケーリングを目的としたものであり、サーバーの高可用性のニーズを満たすようには設計されていません。 この手動フェールオーバーを実行するには、読み取りレプリカでのレプリケーションを停止して、読み取り/書き込みモードでオンラインにします。

レプリケーションは非同期であるため、ソースとレプリカの間にラグがあります。 ラグは、ソース サーバーで実行されているワークロードの負荷とデータ センター間の待機時間など、多くの要因によって影響を受ける可能性があります。 ほとんどの場合、レプリカのラグは数秒から数分の範囲になります。 各レプリカで利用可能な *レプリカのラグ* メトリックを使用して、実際のレプリケーションのラグを追跡できます。 このメトリックでは、最後に再生されたトランザクションからの時間が表示されます。 長期間にわたってレプリカのラグを観察することで、平均ラグを特定することをお勧めします。 予想される範囲外に出た場合に対処できるように、レプリカのラグにアラートを設定できます。

> [!Tip]
> レプリカにフェールオーバーする場合、ソースからレプリカのリンクを解除したときのラグによって、どれだけのデータが失われたかを示します。

レプリカにフェールオーバーすることを決定したら、次の操作を行います。

1. レプリカへのレプリケーションを停止する<br/>
   この手順では、レプリカ サーバーで書き込みを受け入れられるようにすることが必要です。 このプロセスの一部として、レプリカ サーバーはソースからリンクを解除されます。 レプリケーションの停止を開始すると、通常、バックエンド プロセスは完了するまでに約 2 分かかります。 このアクションの影響を理解するには、この記事の「[レプリケーションの停止](#stop-replication)」セクションを参照してください。

2. ご利用のアプリケーションが (以前の) レプリカを指すように設定する<br/>
   各サーバーには一意の接続文字列があります。 ソースではなく、(以前の) レプリカを指すようにアプリケーションを更新します。

ご利用のアプリケーションで読み取りと書き込みが正常に処理されると、フェールオーバーが完了します。 アプリケーションで経験するダウンタイムは、問題を検出し、上記の手順 1 と 2 を完了したタイミングによって異なります。

## <a name="global-transaction-identifier-gtid"></a>グローバル トランザクション識別子 (GTID)

グローバル トランザクション識別子 (GTID) は、ソース サーバー上でコミットされた各トランザクションで作成される一意の識別子であり、Azure Database for MySQL フレキシブル サーバーでは既定でオフになっています。 GTID はバージョン 5.7 と 8.0 でサポートされています。 GTID の詳細とレプリケーションでの使用方法については、MySQL の [GTID を使用したレプリケーション](https://dev.mysql.com/doc/refman/5.7/en/replication-gtids.html)に関するドキュメントを参照してください。

GTID を構成するために、次のサーバー パラメーターを使用できます。

|**サーバー パラメーター**|**説明**|**既定値**|**値**|
|--|--|--|--|
|`gtid_mode`|トランザクションを識別するために GTID を使用するかどうかを示します。 モード間の変更は、一度に 1 つのステップで昇順でのみ実行できます (例: `OFF` -> `OFF_PERMISSIVE` -> `ON_PERMISSIVE` -> `ON`)|`OFF*`|`OFF`:新規とレプリケーションのトランザクションの両方が匿名である必要があります <br> `OFF_PERMISSIVE`:新しいトランザクションは匿名です。 レプリケートされたトランザクションは、匿名または GTID トランザクションのいずれかにすることができます。 <br> `ON_PERMISSIVE`:新しいトランザクションは GTID トランザクションです。 レプリケートされたトランザクションは、匿名または GTID トランザクションのいずれかにすることができます。 <br> `ON`:新規およびレプリケートされたトランザクションは、どちらも GTID トランザクションである必要があります。|
|`enforce_gtid_consistency`|トランザクション セーフな方法でログに記録できるステートメントのみを実行できるようにすることで、GTID の一貫性を強制的に適用します。 GTID レプリケーションを有効にする前に、この値を `ON` に設定する必要があります。 |`OFF*`|`OFF`:すべてのトランザクションが GTID の一貫性に違反することが許可されます。  <br> `ON`:すべてのトランザクションが GTID の一貫性に違反することが許可されません。 <br> `WARN`:すべてのトランザクションは GTID の一貫性に違反することが許可されますが、警告が生成されます。 |

**高可用性機能が有効になっている Azure Database for MySQL フレキシブル サーバーの場合、既定値は `ON` に設定されています*
> [!NOTE]
>
> * いったん GTID を有効になると、無効に戻すことはできません。 GTID をオフにする必要がある場合は、サポートにお問い合わせください。
>
> * GTID をある値から別の値に変更するには、一度に 1 つのステップをモードの昇順で実行します。 たとえば、gtid_mode が現在 OFF_PERMISSIVE に設定されている場合、ON_PERMISSIVE に変更することはできますが、ON にはできません。
>
> * レプリケーションの整合性を維持するために、マスターまたはレプリカ サーバーに対してこれを更新することはできません。
>
> * gtid_mode=ON を設定する前に enforce_gtid_consistency を ON に設定することをお勧めします

GTID を有効にして整合性動作を構成するには、[Azure portal](how-to-configure-server-parameters-portal.md)、[Azure CLI](how-to-configure-server-parameters-cli.md) を使用して、`gtid_mode` と `enforce_gtid_consistency` のサーバー パラメーターを更新します。

ソース サーバーで GTID が有効になっている場合 (`gtid_mode` = ON)、新しく作成されたレプリカでも GTID が有効になり、GTID レプリケーションが使用されます。 レプリケーションの一貫性を確保するために、GTID が有効になっているマスターまたはレプリカ サーバーを作成した後で `gtid_mode` を変更することはできません。

## <a name="considerations-and-limitations"></a>考慮事項と制限事項

| シナリオ | 制限と考慮事項 |
|:-|:-|
| HA が有効になっているサーバー上のレプリカ | サポートされていません |
| バースト可能価格レベルでのサーバー上のレプリカ| サポートされていません |
| リージョン間読み取りレプリケーション | サポートされていません |
| 価格 | レプリカ サーバーの実行のコストは、レプリカ サーバーが実行されているリージョンに基づきます |
| ソース サーバーの再起動 | 既存のレプリカがないソースのレプリカを作成すると、ソースは最初に、レプリケーションの準備をするために再起動します。 これを考慮して、これらの操作はオフピーク期間中に実行します |
| 新しいレプリカ | 読み取りレプリカは、新しい Azure Database for MySQL フレキシブル サーバーとして作成されます。 既存のサーバーをレプリカにすることはできません。 別の読み取りレプリカのレプリカを作成することはできません |
| レプリカ構成 | レプリカは、ソースと同じサーバー構成を使用して作成されます。 レプリカが作成されたら、ソース サーバーとは独立していくつかの設定 (コンピューティング世代、仮想コア、ストレージ、バックアップ保持期間) を変更できます。 コンピューティング レベルは、個別に変更することもできます。<br> <br> **重要**  <br> - ソース サーバーの構成を新しい値に更新する前に、レプリカの構成をそれと同じ値またはそれより大きい値に更新します。 このアクションにより、ソースに対して行われたすべての変更をレプリカで把握できるようになります。 <br/> 接続方法とパラメーターの設定は、レプリカの作成時に、ソース サーバーからレプリカに継承されます。 その後、レプリカの規則は独立したものなります。 |
| 停止されたレプリカ | ソース サーバーと読み取りレプリカの間のレプリケーションを停止すると、停止されたレプリカは、読み取りと書き込みの両方を受け入れるスタンドアロン サーバーになります。 スタンドアロン サーバーをもう一度レプリカにすることはできません。 |
| 削除されたソースおよびスタンドアロン サーバー | ソース サーバーが削除されると、すべての読み取りレプリカへのレプリケーションが停止されます。 これらのレプリカは自動的にスタンドアロン サーバーになり、読み取りと書き込みの両方を受け入れることができます。 ソース サーバー自体は削除されます。 |
| ユーザー アカウント | ソース サーバー上のユーザーは、読み取りレプリカにレプリケートされます。 ソース サーバー上で使用可能なユーザー アカウントのみを使って読み取りレプリカに接続できます。 |
| サーバー パラメーター | データが非同期にならないようにするため、また潜在的なデータの損失や破損を防ぐために、一部のサーバー パラメーターは、読み取りレプリカの使用時に更新されないようにロックされます。 <br> 次のサーバー パラメーターは、ソースとレプリカの両サーバーでロックされます。<br> - [`innodb_file_per_table`](https://dev.mysql.com/doc/refman/8.0/en/innodb-file-per-table-tablespaces.html) <br> - [`log_bin_trust_function_creators`](https://dev.mysql.com/doc/refman/5.7/en/replication-options-binary-log.html#sysvar_log_bin_trust_function_creators) <br> [`event_scheduler`](https://dev.mysql.com/doc/refman/5.7/en/server-system-variables.html#sysvar_event_scheduler) パラメーターは、レプリカ サーバーでロックされます。 <br> ソース サーバーで上記のパラメーターのいずれかを更新するには、レプリカ サーバーを削除し、ソースでパラメーターの値を更新してから、レプリカを再作成してください。
<br> 読み取りレプリカで「foreign_keys_checks」などのセッション レベルのパラメーターを構成する場合は、読み取りレプリカで設定されているパラメーター値がソース サーバーのパラメーター値と一致していることを確認してください。|
| その他 | - レプリカのレプリカを作成することはサポートされていません。 <br> - メモリ内テーブルを使用すると、レプリカが同期しなくなる可能性があります。これは、MySQL レプリケーション テクノロジの制限事項です。 詳細については、[MySQL のリファレンス ドキュメント](https://dev.mysql.com/doc/refman/5.7/en/replication-features-memory.html)をお読みください。 <br>- ソース サーバーのテーブルに主キーがあることを確認します。 主キーがないと、ソースとレプリカ間でレプリケーションの待機時間が発生する可能性があります。<br>- MySQL のレプリケーションの制限事項の完全な一覧については、[MySQL のドキュメント](https://dev.mysql.com/doc/refman/5.7/en/replication-features.html)を確認してください |

## <a name="next-steps"></a>次のステップ

* [Azure portal を使用して読み取りレプリカの作成と管理](how-to-read-replicas-portal.md)を行う方法について確認する。
* [Azure CLI を使用して読み取りレプリカの作成と管理](how-to-read-replicas-cli.md)を行う方法について確認する。
