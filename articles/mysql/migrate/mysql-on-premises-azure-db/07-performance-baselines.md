---
title: 'オンプレミスの MySQL を Azure Database for MySQL に移行する: パフォーマンス ベースライン'
description: 既存の MySQL のワークロードを理解することは、移行を成功させるために行うことのできる最善の投資の 1 つです。
ms.service: mysql
ms.subservice: migration-guide
ms.topic: how-to
author: arunkumarthiags
ms.author: arthiaga
ms.reviewer: maghan
ms.custom: ''
ms.date: 06/21/2021
ms.openlocfilehash: 2077ef62ddabf7910d5a634c07262c9d29905cf4
ms.sourcegitcommit: 8b38eff08c8743a095635a1765c9c44358340aa8
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 06/30/2021
ms.locfileid: "113084968"
---
# <a name="migrate-mysql-on-premises-to-azure-database-for-mysql-performance-baselines"></a>オンプレミスの MySQL を Azure Database for MySQL に移行する: パフォーマンス ベースライン

[!INCLUDE[applies-to-mysql-single-flexible-server](../../includes/applies-to-mysql-single-flexible-server.md)]

## <a name="prerequisites"></a>前提条件

[テスト計画](06-test-plans.md)

## <a name="overview"></a>概要

既存の MySQL のワークロードを理解することは、移行を成功させるために行うことのできる最善の投資の 1 つです。 優れたシステム パフォーマンスは、適切なハードウェアと優れたアプリケーション設計に依存します。 CPU、メモリ、ディスク、ネットワークなどの項目は、予想される負荷に合わせて適切にサイズを設定し、構成する必要があります。 ハードウェアと構成は、システム パフォーマンスの要素の一部です。 開発者は、データベース クエリの負荷と、実行負荷の最も高いクエリを理解する必要があります。 最も負荷の高いクエリに注目すると、全体的なパフォーマンス メトリックに大きな差をもたらすことができます。

移行プロジェクトでは、クエリのパフォーマンスのベースラインを作成することが不可欠です。 パフォーマンス ベースラインは、移行後のデータ ワークロードに対する Azure ランディング ゾーンの構成を検証するために使用できます。 ほとんどのシステムは連続して実行され、負荷がピークになる時間が異なります。 ベースラインでピーク時のワークロードをキャプチャすることが重要です。 メトリックは複数回キャプチャされます。 このドキュメントの後半では、移行元サーバーのパラメーターと、パフォーマンス ベースラインの全体像にとってそれらがどのように重要かを説明します。 移行プロジェクトの間に、サーバー パラメーターを見落とさないようにしてください。

## <a name="tools"></a>ツール

サーバーのメトリックとデータベースのワークロードの情報を収集するために使用するツールを以下に示します。 キャプチャされたメトリックを使用して、適切な Azure Database for MySQL のレベルと、関連するスケーリング オプションを決定します。

  - [MySQL Enterprise Monitor:](https://www.mysql.com/products/enterprise/monitor.html) この無料の Enterprise Edition ツールを使用すると、最も負荷の高いクエリの並べ替え済みのリスト、サーバー メトリック、ファイル I/O、トポロジ情報を入手できます

  - [Percona Monitoring and Management (PMM)](https://www.percona.com/software/database-tools/percona-monitoring-and-management): 優れたオープンソースのデータベース監視ソリューションです。 これは、デプロイされた場所に関係なく、複雑さを軽減し、パフォーマンスを最適化し、ビジネス クリティカルなデータベース環境のセキュリティを強化するのに役立ちます。

## <a name="server-parameters"></a>サーバー パラメーター

MySQL サーバーの既定の構成は、ワークロードをサポートするのに適切でない場合があります。 MySQL には多数のサーバー パラメーターがありますが、ほとんどの場合、移行チームはそのうちの少数のものに焦点を当てる必要があります。 **移行元** と **移行先** の環境で、次のパラメーターを評価する必要があります。 構成が正しくないと、移行の速度に影響する可能性があります。 移行手順を実行するときに、これらのパラメーターを再度見直します。

  - **innodb\_buffer\_pool\_size**: 値が大きい場合、ディスク I/O を利用する前にまずメモリ内のリソースが使用されます。 一般的な値は、使用可能なメモリの 80 - 90% の範囲です。 たとえば、システムのメモリが 8 GB の場合、プール サイズに 5 - 6 GB を割り当てる必要があります。

  - **innodb\_log\_file\_size**: 再実行ログは、高速の持続的書き込みを保証するために使用されます。 このトランザクション バックアップは、システムのクラッシュ時に役立ちます。 innodb\_log\_file\_size = 512M (1 GB の再実行ログ) 以上にすると、書き込み用に十分な空き領域が得られます。 MySQL 5.6 以降を使用する書き込みが多いアプリケーションでは、innodb\_log\_file\_size = 4G 以上にする必要があります。

  - **max\_connections**: このパラメーターは、`Too many connections` エラーを軽減するのに役立ちます。 既定値は 151 接続です。 アプリケーション レベルで接続プールを使用することをお勧めしますが、サーバー接続の構成も増やすことが必要になる場合があります。

  - **innodb\_file\_per\_table**: この設定は、データとインデックスを、共有テーブルスペースに格納するか、それともテーブルごとの separate.ibd ファイルに格納する必要があるかを、InnoDB に指示します。 テーブルごとにファイルを作成すると、テーブルの削除、切り捨て、または再構築が行われるときに、サーバーで領域を再利用できるようになります。 多数のテーブルが含まれるデータベースでは、ファイルごとのテーブルの構成を使用しないでください。 MySQL 5.6 以降では、既定値は ON です。 以前のバージョンのデータベースでは、データを読み込む前に、構成を ON に設定する必要があります。 この設定は、新しく作成されるテーブルにのみ影響します。

  - **innodb\_flush\_log\_at\_trx\_commit**: 既定の設定である 1 は、InnoDB が完全な ACID に準拠していることを意味します。 この低リスクのトランザクション構成を使用すると、変更のたびに再実行ログにフラッシュするために余分な fsync が必要になるので、低速のディスクのシステムでは、大きなオーバーヘッドが発生する可能性があります。 パラメーターを 2 に設定すると、コミットされたトランザクションは 2 回に 1回だけ再実行ログにフラッシュされるため、信頼性がやや低くなります。 一部のマスター環境ではリスクを許容できる可能性があり、レプリカの場合は間違いなく適切な値です。 値を 0 にすると、システムのパフォーマンスは向上しますが、データベース サーバーで障害が発生したときにデータが失われる可能性が高くなります。 結論として、値 0 はレプリカに対してのみ使用してください。

  - **innodb\_flush\_method**: この設定は、データとログをディスクにフラッシュする方法を制御します。 バッテリで保護されたライトバック キャッシュを備えたハードウェア RAID コントローラーが存在する場合は、`O_DIRECT` を使用します。 他のシナリオでは、`fdatasync` (既定値) を使用します。

  - **innodb\_log\_buffer\_size**: この設定は、まだコミットされていないトランザクション用のバッファーのサイズです。 通常は、既定値 (1 MB) で問題ありません。 大きい BLOB またはテキストのフィールドがあるトランザクションでは、バッファーが短時間で埋まり、余分な I/O 負荷が発生する可能性があります。 `Innodb_log_waits` 状態変数を調べて、それが 0 でない場合は、`innodb_log_buffer_size` を増やします。

  - **query\_cache\_size**: クエリ キャッシュは、中程度のコンカレンシーの間に発生する可能性があることが知られているボトルネックです。 初期値は 0 に設定して、キャッシュを無効にする必要があります。 例を示します: `query_cache_size = 0`。 MySQL 5.6 以降ではこれが既定値です。

  - **log\_bin**: この設定により、バイナリ ログが有効になります。 サーバーがレプリケーション マスターとして機能する場合は、バイナリ ログを有効にすることが必須です。

  - **server\_id**: この設定は、レプリケーション トポロジ内でサーバーを識別するための一意の値になります。

  - **expire\_logs\_days**: この設定は、バイナリ ログが自動的に消去される日数を制御します。

  - **skip\_name\_resolve**: クライアントのホスト名解決を実行するために使用します。 DNS が遅い場合、接続が低速になります。 名前解決を無効にしたときは、GRANT ステートメントで IP アドレスのみを使用する必要があります。 以前に行われた GRANT ステートメントは、IP を使用して再実行する必要があります。

確認のためにサーバー パラメーターをファイルにエクスポートするには、次のコマンドを実行します。 Azure Database for MySQL サーバーに適している場合は、いくつかの簡単な解析を使用し、移行後に同じサーバー パラメーターを再適用するために出力を使用できます。 「[Azure portal を使用して Azure Database for MySQL サーバーのサーバー パラメータを構成する](../../howto-server-parameters.md)」を参照してください。

`mysql -u root -p -A -e "SHOW GLOBAL VARIABLES;" > settings.txt`

MySQL 5.5.60 により既定でインストールされるサーバー パラメーターは、[付録](15-appendix.md#default-server-parameters-mysql-55-and-azure-database-for-mysql)で確認できます。

移行を始める前に、移行元の MySQL の構成設定をエクスポートします。 移行後に、それらの値を Azure ランディング ゾーン インスタンスの設定と比較します。 移行先の Azure ランディング ゾーン インスタンスで既定値から変更された設定がある場合は、移行後に設定が元に戻されていることを確認します。 また、移行ユーザーは、移行前にサーバー パラメーターを設定できることを確認する必要があります。

構成できないサーバー パラメーターの一覧については、「[構成不可能なサーバー パラメーター](../../concepts-server-parameters.md#non-configurable-server-parameters)」を参照してください。

### <a name="egress-and-ingress"></a>エグレスとイングレス

データ移行ツールとパスごとに、可能な限り速いエグレスとイングレスがサポートされるように、移行元と移行先の MySQL のサーバー パラメーターを変更する必要があります。 ツールによって、パラメーターが異なる場合があります。 たとえば、移行を並列に実行するツールでは、単一スレッドのツールより多くの接続が、移行元と移行先で必要になる場合があります。

データセットの影響を受ける可能性のあるタイムアウト パラメーターを確認します。 これには以下が含まれます。

  - [connect\_timeout](https://dev.mysql.com/doc/refman/8.0/en/server-system-variables.html#sysvar_connect_timeout)

  - [wait\_timeout](https://dev.mysql.com/doc/refman/8.0/en/server-system-variables.html#sysvar_wait_timeout)

さらに、最大値に影響を与えるパラメーターを確認します。

  - [max\_allowed\_packet](https://dev.mysql.com/doc/refman/8.0/en/server-system-variables.html#sysvar_max_allowed_packet)

> [!NOTE]
> 一般的な移行エラーは `MySQL server has gone away` です。 ここで説明したパラメーターは、このエラーを解決するための一般的な原因です。

## <a name="wwi-scenario"></a>WWI のシナリオ

WWI によりその Conference データベースのワークロードが調べられ、負荷が非常に小さいことが確認されました。 基本レベルのサーバーは機能していましたが、後で別のレベルに移行するための作業を行いたくはありませんでした。 デプロイされているサーバーで最終的に他の MySQL データ ワークロードがホストされるので、`General Performance` レベルを選択しました。

MySQL データベースを確認したところ、MySQL 5.5 サーバーは、初期インストール時に設定される既定のサーバー パラメーターで実行されています。

## <a name="next-steps"></a>次のステップ

> [!div class="nextstepaction"]
> [データ移行](./08-data-migration.md)
