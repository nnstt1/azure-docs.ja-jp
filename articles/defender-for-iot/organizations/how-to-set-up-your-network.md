---
title: ネットワークをセットアップする
description: ネットワークが Azure Defender for IoT アプライアンスと連携するように正しく設定するために必要なソリューションのアーキテクチャ、ネットワークの準備、前提条件、およびその他の情報について説明します。
ms.date: 11/09/2021
ms.topic: how-to
ms.openlocfilehash: 1e41cc1f8e491e92d2fe4896b90e61b4cd3fe835
ms.sourcegitcommit: 677e8acc9a2e8b842e4aef4472599f9264e989e7
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 11/11/2021
ms.locfileid: "132278818"
---
# <a name="about-microsoft-defender-for-iot-network-setup"></a>Microsoft Defender for IoT のネットワーク設定について

Microsoft Defender for IoT では、継続的な ICS 脅威の監視とデバイスの検出を実現できます。 このプラットフォームには、次のコンポーネントが含まれています。

**Defender for IoT センサー:** センサーは、パッシブ (エージェントレス) 監視を使用して、ICS ネットワーク トラフィックを収集します。 このセンサーは、パッシブで非侵入型であるため、OT と IoT のネットワークとデバイスのパフォーマンスには影響しません。 このセンサーは、SPAN ポートまたはネットワーク TAP に接続し、ネットワークの監視を直ちに開始します。 検出はセンサー コンソールに表示されます。 ここで、ネットワーク マップ、デバイス インベントリ、広範なレポートによって、それらを表示、調査、分析できます。 たとえば、リスク評価レポート、データ マイニング クエリ、攻撃ベクトルなどがあります。

**Defender for IoT のオンプレミスの管理コンソール**:オンプレミスの管理コンソールには、すべてのネットワーク デバイスの統合ビューが表示されます。 これにより、すべての施設の重要な OT と IoT のリスク インジケーターとアラートのリアルタイムのビューが提供されます。 SOC ワークフローとプレイブックに緊密に統合されているため、軽減アクティビティの優先順位付けと脅威のクロスサイト関連付けを簡単に行うことができます。

**Azure portal の Defender for IoT:** Defender for IoT アプリケーションは、ソリューション アプライアンスの購入、ソフトウェアのインストールと更新、および TI パッケージの更新に役立ちます。

この記事では、Defender for IoT アプライアンスと連携するようにネットワークを正しく設定するための、ソリューションのアーキテクチャ、ネットワークの準備、前提条件などについて説明します。 この記事の情報を使用する読者には、OT および IoT ネットワークの運用と管理に関する知識が必要です。 たとえば、オートメーション エンジニア、プラント マネージャー、OT ネットワーク インフラストラクチャ サービス プロバイダー、サイバー セキュリティ チーム、CISO、CIO などです。

支援やサポートについては、[Microsoft サポート](https://support.microsoft.com/supportforbusiness/productselection?sapId=82c88f35-1b8e-f274-ec11-c6efdd6dd099)にお問い合わせください。

## <a name="on-site-deployment-tasks"></a>オンサイトのデプロイ タスク

サイトのデプロイ タスクには、次が含まれています。

- [サイト情報を収集する](#collect-site-information)

- [構成ワークステーションを準備する](#prepare-a-configuration-workstation)

- [証明書を設定する](#set-up-certificates)

- [構成ワークステーションを準備する](#prepare-a-configuration-workstation)

- [ラックの取り付けを計画する](#plan-rack-installation)

### <a name="collect-site-information"></a>サイト情報を収集する

次のようなサイト情報を記録します。

- センサー管理のネットワーク情報。

- サイトのネットワーク アーキテクチャ。

- 物理環境。

- システムの統合。

- 計画されたユーザー資格情報。

- 構成ワークステーション。

- SSL 証明書 (省略可能ですが推奨されます)。

- SMTP 認証 (省略可能)。 認証で SMTP サーバーを使用するには、サーバーに必要な資格情報を準備します。

- DNS サーバー (省略可能)。 DNS サーバーの IP とホスト名を準備します。

重要なサイト情報の詳細な一覧と説明については、「[デプロイ前のチェックリスト](#predeployment-checklist)」を参照してください。

#### <a name="successful-monitoring-guidelines"></a>正常な監視のガイドライン

各運用ネットワークでアプライアンスを接続する最適な場所を見つけるには、次の手順に従うことをお勧めします。

:::image type="content" source="media/how-to-set-up-your-network/production-network-diagram.png" alt-text="運用ネットワークのセットアップ例の図。":::

### <a name="prepare-a-configuration-workstation"></a>構成ワークステーションを準備する

以下を含む、Windows ワークステーションを準備します。

- センサー管理インターフェイスへの接続。

- サポートされているブラウザー

- ターミナル ソフトウェア (PuTTY など)。

ワークステーションで必要なファイアウォール規則が有効であることを確認します。 詳細については、「[ネットワーク アクセスの要件](#network-access-requirements)」を参照してください。

#### <a name="supported-browsers"></a>サポートされているブラウザー

センサーとオンプレミスの管理コンソール Web アプリケーションでは、次のブラウザーがサポートされています。

- Microsoft Edge (最新バージョン)

- Safari (最新バージョン、Mac のみ)

- Chrome (最新バージョン)

- Firefox (最新バージョン)

サポートされているブラウザーの詳細については、「[推奨されるブラウザー](../../azure-portal/azure-portal-supported-browsers-devices.md#recommended-browsers)」を参照してください。

### <a name="set-up-certificates"></a>証明書を設定する

センサーとオンプレミス管理コンソールのインストール後に、ローカルの自己署名証明書が生成され、センサーの Web アプリケーションにアクセスするために使用されます。 管理者ユーザーは、Defender for IoT に初めてサインインするときに、SSL/TLS 証明書を指定するように求められます。 さらに、この証明書を検証するオプションとその他のシステム証明書を検証するオプションも自動的に有効になります。 詳細については、「[証明書について](how-to-deploy-certificates.md)」を参照してください。

### <a name="network-access-requirements"></a>ネットワーク アクセスの要件

組織のセキュリティ ポリシーによって、以下へのアクセスが許可されていることを確認します。

#### <a name="user-access-to-the-sensor-and-management-console"></a>センサーと管理コンソールへのユーザー アクセス

| プロトコル | トランスポート | /アウトの選択 | Port | 使用 | 目的 | source | 宛先 |
|--|--|--|--|--|--|--|--|
| HTTPS | TCP | /アウトの選択 | 443 | センサー、オンプレミスの管理コンソール、Web コンソールにアクセスするため。 | Web コンソールへのアクセス | Client | センサーおよびオンプレミスの管理コンソール |
| SSH | TCP | /アウトの選択 | 22 | CLI | CLI にアクセスするため。 | Client | センサーおよびオンプレミスの管理コンソール |

#### <a name="sensor-access-to-azure-portal"></a>センサーから Azure portal へのアクセス

| プロトコル | トランスポート | /アウトの選択 | Port | 使用 | 目的 | source | 到着地 |
|--|--|--|--|--|--|--|--|
| HTTPS または WebSocket | TCP | /アウトの選択 | 443 | センサーから Azure portal へのアクセスを許可します。 (省略可能) プロキシ経由でアクセスを許可できます。 | Azure portal へのアクセス | Sensor | Azure portal |

#### <a name="sensor-access-to-the-on-premises-management-console"></a>センサーからオンプレミスの管理コンソールへのアクセス

| プロトコル | トランスポート | /アウトの選択 | Port | 使用 | 目的 | source | 到着地 |
|--|--|--|--|--|--|--|--|
| SSL | TCP | /アウトの選択 | 443 | センサーからオンプレミスの管理コンソールへのアクセスを許可します。 | センサーとオンプレミスの管理コンソール間の接続 | Sensor | オンプレミスの管理コンソール |
| NTP | UDP | /アウトの選択 | 123 | 時間同期 | NTP をオンプレミスの管理コンソールに接続します。 | Sensor | オンプレミスの管理コンソール |

#### <a name="additional-firewall-rules-for-external-services-optional"></a>外部サービス向けの追加のファイアウォール規則 (省略可能)

以下のポートを開くと、Defender for IoT の追加サービスを許可できます。

| プロトコル | トランスポート | /アウトの選択 | Port | 使用 | 目的 | source | 到着地 |
|--|--|--|--|--|--|--|--|
| HTTP | TCP | アウト | 80 | 証明書のアップロード時に証明書検証用の CRL をダウンロードします。 | CRL サーバーへのアクセス | センサーおよびオンプレミスの管理コンソール | CRL サーバー |
| LDAP | TCP | /アウトの選択 | 389 | Active Directory | アクセス権を持つユーザーの Active Directory 管理を許可し、システムにログインできるようにします。 | オンプレミスの管理コンソールとセンサー | LDAP サーバー |
| LDAPS | TCP | /アウトの選択 | 636 | Active Directory | アクセス権を持つユーザーの Active Directory 管理を許可し、システムにログインできるようにします。 | オンプレミスの管理コンソールとセンサー | LDAPS サーバー |
| [SNMP](how-to-set-up-snmp-mib-monitoring.md) | UDP | アウト | 161 | 監視 | センサーの正常性を監視します。 | オンプレミスの管理コンソールとセンサー | SNMP サーバー |
| SMTP | TCP | アウト | 25 | Email | アラートとイベントの電子メールを送信するために、顧客のメール サーバーを開く場合に使用します。 | センサーおよびオンプレミスの管理コンソール | 電子メール サーバー |
| syslog | UDP | アウト | 514 | LEEF | オンプレミスの管理コンソールから Syslog サーバーに送信されるログ。 | オンプレミスの管理コンソールとセンサー | Syslog サーバー |
| DNS | TCP/UDP | /アウトの選択 | 53 | DNS | DNS サーバー ポート。 | オンプレミスの管理コンソールとセンサー | DNS サーバー |
| [WMI](how-to-configure-windows-endpoint-monitoring.md) | TCP/UDP | アウト | 135、1025-65535 | 監視 | Windows エンドポイント監視。 | Sensor | 関連するネットワーク要素 |
| トンネリング | TCP | / | 9000 </br></br> さらに、ポート 443 </br></br> センサーまたはエンド ユーザーからオンプレミスの管理コンソールへのアクセスを許可します。 </br></br> ポート 22 (センサーからオンプレミスの管理コンソールへ)。 | 監視 | トンネリング | Sensor | オンプレミスの管理コンソール |
| プロキシ | TCP/UDP | /アウトの選択 | 443 | プロキシ | センサーをプロキシ サーバーに接続するため | オンプレミスの管理コンソールとセンサー | プロキシ サーバー |

### <a name="plan-rack-installation"></a>ラックの取り付けを計画する

ラックの取り付けを計画するには、次の操作を行います。

1. アプライアンスのネットワーク設定のためのモニターとキーボードを準備します。

1. アプライアンス用のラック スペースを割り当てます。

1. アプライアンスで AC 電源を使用できるようにします。

1. ネットワーク スイッチに管理を接続するための LAN ケーブルを準備します。

1. スイッチ SPAN (ミラー) ポートを接続するための LAN ケーブルと、Defender for IoT アプライアンスへのネットワーク タップを準備します。

1. アーキテクチャ レビュー セッションで説明されているように、ミラー化されたスイッチで SPAN ポートを構成、接続、および検証します。

1. Wireshark を実行しているコンピューターに構成済みの SPAN ポートを接続し、ポートが正しく構成されていることを確認します。

1. 関連するすべてのファイアウォール ポートを開きます。

## <a name="about-passive-network-monitoring"></a>パッシブ ネットワークの監視について

アプライアンスは、スイッチのミラー ポート (SPAN ポート) またはネットワーク TAP のいずれかによって、複数の発信元からのトラフィックを受信します。 管理ポートは、オンプレミスの管理コンソールまたは Azure portal の Defender for IoT への接続を備えた、ビジネス、企業、またはセンサー管理ネットワークに接続されています。

:::image type="content" source="media/how-to-set-up-your-network/switch-with-port-mirroring.png" alt-text="ポート ミラーリングを使用したマネージド スイッチの図。":::

### <a name="purdue-model"></a>Purdue モデル

以下のセクションでは、Purdue レベルについて説明します。

:::image type="content" source="media/how-to-set-up-your-network/purdue-model.png" alt-text="Purdue モデルの図。":::

#### <a name="level-0-cell-and-area"></a>Level 0:セルと領域  

レベル 0 は、基本的な製造プロセスに関係するさまざまなセンサー、アクチュエータ、およびデバイスで構成されています。 これらのデバイスは、次のような、産業オートメーションおよび制御システムの基本的な機能を実行します。

- モーターの駆動。

- 変数の測定。
- 出力の設定。
- 塗装、溶接、曲げなどの主要な機能の実行。

#### <a name="level-1-process-control"></a>Level 1: プロセス制御

レベル 1 は、主要な機能がレベル 0 のデバイスと通信する、製造プロセスを制御および操作する組み込みのコントローラーで構成されます。 ディスクリート型製造業では、これらのデバイスはプログラマブル ロジック コントローラー (PLC) またはリモート テレメトリ ユニット (RTU) です。 プロセス型製造業では、基本的なコントローラーは分散制御システム (DC) と呼ばれます。

#### <a name="level-2-supervisory"></a>Level 2: 監督

レベル 2 は、生産施設のエリアの実行時の監督と運用に関連付けられたシステムと機能を表します。 通常、これらには次のようなものがあります。 

- 演算子インターフェイスまたは HMI

- アラームまたは警告システム

- プロセス ヒストリアンとバッチ管理システム

- コントロール ルームのワークステーション

これらのシステムは、レベル 1 の PLC および RTU と通信します。 場合によっては、サイトまたはエンタープライズ (レベル 4 およびレベル 5) のシステムおよびアプリケーションと通信したりデータを共有したりすることがあります。 これらのシステムは、主に標準のコンピューティング機器とオペレーティング システム (Unix または Microsoft Windows) に基づいています。

#### <a name="levels-3-and-35-site-level-and-industrial-perimeter-network"></a>レベル 3 および 3.5:サイトレベルおよび産業用境界ネットワーク

サイト レベルは、最高レベルの産業オートメーションおよび制御システムを表します。 このレベルに存在するシステムとアプリケーションは、サイト全体の産業オートメーションおよび制御機能を管理します。 レベル 0 ～ 3 は、サイトの運用にとって重要であると見なされます。 このレベルに存在するシステムと機能には、次のようなものがあります。

- 運用レポート (サイクル時間、品質指数、予測メンテナンスなど)

- プラント ヒストリアン

- 詳細な運用スケジュール

- サイトレベルの運用管理

- デバイスおよび資材の管理

- パッチ起動サーバー

- ファイル サーバー

- 産業用ドメイン、Active Directory、ターミナル サーバー

これらのシステムは、運用ゾーンと通信し、エンタープライズ (レベル 4 およびレベル 5) のシステムおよびアプリケーションとデータを共有します。  

#### <a name="levels-4-and-5-business-and-enterprise-networks"></a>レベル 4 および 5:ビジネスおよびエンタープライズ ネットワーク

レベル 4 とレベル 5 は、一元化された IT システムと機能が存在するサイトまたはエンタープライズ ネットワークを表します。 IT 組織は、これらのレベルでサービス、システム、アプリケーションを直接管理します。

## <a name="planning-for-network-monitoring"></a>ネットワーク監視の計画

次の例で、産業用制御ネットワークのさまざまな種類のトポロジと、センサーの最適な監視と配置のための考慮事項を示します。

### <a name="what-should-be-monitored"></a>何を監視すべきか

レイヤー 1 と 2 を通過するトラフィックを監視する必要があります。

### <a name="what-should-the-defender-for-iot-appliance-connect-to"></a>Defender for IoT アプライアンスを何に接続すべきか

Defender for IoT アプライアンスは、レイヤー 1 と 2 (場合によってはレイヤー 3 も) 間の産業用通信を監視する、マネージド スイッチに接続する必要があります。

次の図は、マルチレイヤーのマルチテナント ネットワークの一般的な抽象化であり、通常は SOC と MSSP によって運用される、広範なサイバー セキュリティ エコシステムを備えています。

通常、NTA センサーは、OSI モデルのレイヤー 0 ～ 3 に配置されます。

:::image type="content" source="media/how-to-set-up-your-network/osi-model.png" alt-text="OSI モデルの図。":::

#### <a name="example-ring-topology"></a>例:リング型トポロジ

リング ネットワークは、各スイッチまたはノードが正確に 2 つの他のスイッチに接続し、トラフィックに対して 1 つの連続する経路を形成するトポロジです。

:::image type="content" source="media/how-to-set-up-your-network/ring-topology.PNG" alt-text="リング型トポロジの図。":::

#### <a name="example-linear-bus-and-star-topology"></a>例:線形バスとスター型トポロジ

スター型ネットワークでは、すべてのホストが中央ハブに接続されています。 最も単純な形式では、1 つの中央ハブがメッセージを転送するパイプとして機能します。 次の例では、下位のスイッチは監視されず、これらのスイッチに対してローカルのままのトラフィックは表示されません。 デバイスは ARP メッセージに基づいて識別される場合がありますが、接続情報はありません。

:::image type="content" source="media/how-to-set-up-your-network/linear-bus-star-topology.PNG" alt-text="線形バスとスター型トポロジの図。":::

#### <a name="multisensor-deployment"></a>複数センサーの配置

以下に示すのは、複数のセンサーの配置に関する推奨事項です。

| **Number** | **メートル** | **依存関係** | **センサーの数** |
|--|--|--|--|
| スイッチ間の最大距離 | 80 メートル | 準備したイーサネット ケーブル | 2 以上 |
| OT ネットワークの数 | 2 以上 | 物理的な接続なし | 2 以上 |
| スイッチの数 | RSPAN 構成を使用できる | ケーブル接続の距離によってセンサーの近くにローカル スパンがある最大 8 個のスイッチ | 2 以上 |

#### <a name="traffic-mirroring"></a>トラフィックのミラーリング  

トラフィック分析に関連する情報のみを表示するには、Defender for IoT プラットフォームを、産業用 ICS と SCADA のトラフィックのみを含むスイッチまたは TAP のミラーリングポートに接続する必要があります。

:::image type="content" source="media/how-to-set-up-your-network/switch.jpg" alt-text="セットアップには、このスイッチを使用します。":::

次の方法を使用して、スイッチのトラフィックを監視できます。

- [スイッチの SPAN ポート](#switch-span-port)

- [リモート SPAN (RSPAN)](#remote-span-rspan)

- [アクティブおよびパッシブのアグリゲーション TAP](#active-and-passive-aggregation-tap)

SPAN と RSPAN は Cisco の用語です。 その他のブランドのスイッチにも類似した機能がありますが、別の用語を使用している場合があります。

#### <a name="switch-span-port"></a>スイッチの SPAN ポート

スイッチ ポート アナライザーは、スイッチ上のインターフェイスから同じスイッチ上のインターフェイスへのローカル トラフィックをミラー化します。 次にいくつかの考慮事項を示します。

- 関連するスイッチでポート ミラーリング機能がサポートされていることを確認してください。  

- 既定では、ミラーリング オプションは無効になっています。

- データが接続されていない場合でも、スイッチのすべてのポートを構成することをお勧めします。 そうしないと、悪意のあるデバイスが監視されていないポートに接続され、センサーでアラートが表示されなくなる可能性があります。

- ブロードキャストまたはマルチキャスト メッセージングを使用する OT ネットワークでは、RX (受信) 転送のみをミラー化するようにスイッチを構成してください。 そうしないと、マルチキャスト メッセージがアクティブなポート数だけ繰り返され、帯域幅が乗算されます。

次の構成例は参照専用で、IOS を実行している Cisco 2960 スイッチ (24 ポート) に基づいています。 これらは一般的な例にすぎないため、指示として使用しないでください。 他の Cisco オペレーティング システムや他のブランドのスイッチのミラー ポートは、別の方法で構成されています。

:::image type="content" source="media/how-to-set-up-your-network/span-port-configuration-terminal-v2.png" alt-text="SPAN ポート構成ターミナルの図。":::
:::image type="content" source="media/how-to-set-up-your-network/span-port-configuration-mode-v2.png" alt-text="SPAN ポート構成モードの図。":::

##### <a name="monitoring-multiple-vlans"></a>複数の VLAN の監視

Defender for IoT では、ネットワークに構成されている VLAN を監視できます。 Defender for IoT システムの構成は必要ありません。 ユーザーは、ネットワーク内のスイッチが、Defender for IoT に VLAN タグを送信するように構成されていることを確認する必要があります。

次の例では、Defender for IoT の VLAN の監視を有効にするために Cisco スイッチで構成する必要がある必須のコマンドを示します。

**セッションの監視**: このコマンドは、VLAN を SPAN ポートに送信する処理を行います。

- monitor session 1 source interface Gi1/2

- monitor session 1 filter packet type good Rx

- monitor session 1 destination interface fastEthernet1/1 encapsulation dot1q

**トランク ポート F.E. Gi1/1 の監視**:VLAN はトランク ポートで構成されます。

- interface GigabitEthernet1/1

- switchport trunk encapsulation dot1q

- switchport mode trunk

#### <a name="remote-span-rspan"></a>リモート SPAN (RSPAN)

リモート SPAN セッションでは、複数の分散ソース ポートからのトラフィックが専用のリモート VLAN にミラー化されます。  

:::image type="content" source="media/how-to-set-up-your-network/remote-span.png" alt-text="リモート SPAN の図。":::

その後、VLAN 内のデータは、複数のスイッチにまたがるトランク ポートを介して、物理的な宛先ポートを含む特定のスイッチに配信されます。 このポートは、Defender for IoT プラットフォームに接続します。  

##### <a name="more-about-rspan"></a>RSPAN の詳細

- RSPAN は、SPAN によってスイッチ間で監視されるトラフィックを伝送するために特別な VLAN を必要とする高度な機能です。 RSPAN は、すべてのスイッチでサポートされているわけではありません。 スイッチで RSPAN 機能がサポートされていることを確認してください。

- 既定では、ミラーリング オプションは無効になっています。

- リモート VLAN は、発信元と宛先のスイッチ間のトランク ポートで許可されている必要があります。

- 同じ RSPAN セッションを接続するすべてのスイッチは、同じ製造元のものである必要があります。

> [!NOTE]
> スイッチ間でリモート VLAN を共有しているトランク ポートが、ミラー セッションの発信元ポートとして定義されていないことを確認します。
>
> リモート VLAN では、ミラー化されたセッションの帯域幅のサイズによって、トランク ポートの帯域幅が増加します。 それがスイッチのトランク ポートでサポートされていることを確認してください。  

:::image type="content" source="media/how-to-set-up-your-network/remote-vlan.jpg" alt-text="リモート VLAN の図。":::

#### <a name="rspan-configuration-examples"></a>RSPAN 構成の例

RSPAN：Cisco catalyst 2960 (24 ポート) をベースにしています。

**発信元スイッチの構成例:**

:::image type="content" source="media/how-to-set-up-your-network/rspan-configuration.png" alt-text="RSPAN 構成のスクリーンショット。":::

1. グローバル構成モードに入ります。

1. 専用 HSM を作成します。

1. VLAN を RSPAN VLAN として識別します。

1. 「ターミナル構成」モードに戻ります。

1. 24 のポートすべてをセッション発信元として構成します。

1. RSPAN VLAN をセッション発信先として構成します。

1. 特権 EXEC モードに戻ります。

1. ポート ミラーリングの構成を確認します。

**発信先スイッチの構成例:**

1. グローバル構成モードに入ります。

1. RSPAN VLAN をセッション発信元として構成します。

1. 物理ポート 24 をセッション発信先として構成します。

1. 特権 EXEC モードに戻ります。

1. ポート ミラーリングの構成を確認します。

1. 構成を保存します。

#### <a name="active-and-passive-aggregation-tap"></a>アクティブおよびパッシブのアグリゲーション TAP

アクティブまたはパッシブのアグリゲーション TAP はネットワーク ケーブルにインラインで取り付けられています。 これにより、RX と TX の両方が監視センサーに複製されます。

ターミナル アクセス ポイント (TAP) は、ネットワーク トラフィックを中断せずにポート A からポート B、およびポート B からポート A にフローできるようにするハードウェア デバイスです。 ネットワークの整合性を損なうことなく、両方の側のトラフィック フローの正確なコピーが継続的に作成されます。 一部の TAP では、必要に応じて、スイッチの設定を使用して送信トラフィックと受信トラフィックを集約します。 集約がサポートされていない場合、各 TAP では、2 つのセンサー ポートを使用して送受信トラフィックを監視します。

TAP はさまざまな理由で便利です。 これらはハードウェアベースであり、セキュリティを侵害することはできません。 これらは、スイッチがドロップすることがよくある破損したメッセージも含めて、すべてのトラフィックを渡します。 これらはプロセッサに依存しないため、パケットのタイミングは正確であり、スイッチはミラー化されたパケットのタイミングに影響する可能性がある優先順位の低いタスクとしてミラー機能を処理します。 科学捜査を目的とする場合は、TAP が最適なデバイスです。

ポートの監視には TAP アグリゲーターも使用できます。 これらのデバイスはプロセッサベースであり、本質的にハードウェア TAP ほど安全ではありません。 正確なパケットのタイミングが反映されない可能性があります。

:::image type="content" source="media/how-to-set-up-your-network/active-passive-tap-v2.PNG" alt-text="アクティブおよびパッシブ TAP の図。":::

##### <a name="common-tap-models"></a>一般的な TAP モデル

これらのモデルは互換性についてテスト済みです。 他の製造元やモデルにも互換性がある場合があります。

| Image | モデル |
|--|--|
| :::image type="content" source="media/how-to-set-up-your-network/garland-p1gccas-v2.png" alt-text="Garland P1GCCAS のスクリーンショット。"::: | Garland P1GCCAS |
| :::image type="content" source="media/how-to-set-up-your-network/ixia-tpa2-cu3-v2.png" alt-text="IXIA TPA2-CU3 のスクリーンショット。"::: | IXIA TPA2-CU3 |
| :::image type="content" source="media/how-to-set-up-your-network/us-robotics-usr-4503-v2.png" alt-text="US Robotics USR 4503 のスクリーンショット。"::: | US Robotics USR 4503 |

##### <a name="special-tap-configuration"></a>特殊な TAP 構成

| Garland TAP | US Robotics TAP |
| ----------- | --------------- |
| ジャンパーが次のようにセットされていることを確認します。<br />:::image type="content" source="media/how-to-set-up-your-network/jumper-setup-v2.jpg" alt-text="US Robotics スイッチのスクリーンショット。":::| アグリゲーション モードがアクティブになっていることを確認します。 |

## <a name="deployment-validation"></a>デプロイの検証

### <a name="engineering-self-review"></a>エンジニアリングの自己レビュー  

OT および ICS ネットワーク図を確認することは、接続するのに最適な場所を定義するための最も効率的な方法であり、監視に最も関連性の高いトラフィックがわかります。

サイト エンジニアは、ネットワークがどのように見えるかを把握しています。 ローカルのネットワークや運用のチームとのレビュー セッションを行うことで、通常は期待されるものが明確になり、アプライアンスを接続するのに最適な場所が定義されます。

関連情報:

- 既知のデバイスの一覧 (スプレッドシート)  

- 推定されるデバイスの数  

- 製造元と産業用プロトコル

- スイッチのモデル。ポート ミラーリング オプションが使用可能であることを確認するため

- スイッチの管理者 (IT など) と外部リソースかどうかに関する情報

- サイトにある OT ネットワークの一覧

#### <a name="common-questions"></a>一般的な質問

- 実装の全体的な目標は何ですか? 完全なインベントリと正確なネットワーク マップは重要ですか?

- ICS に複数または冗長なネットワークはありますか? すべてのネットワークが監視されていますか?

- ICS とエンタープライズ (ビジネス) ネットワークの間に通信はありますか? これらの通信は監視されていますか?

- ネットワーク設計で VLAN は構成されていますか?

- 固定または一時的なデバイスで、ICS のメンテナンスはどのように行われますか?

- ファイアウォールは監視対象のネットワークのどこにインストールされていますか?

- 監視対象のネットワークにルーティングはありますか?

- 監視対象のネットワークではどの OT プロトコルがアクティブですか?

- このスイッチに接続すると、HMI と PLC の間の通信が表示されますか?

- ICS スイッチとエンタープライズ ファイアウォールの間の物理的な距離はどれくらいですか? 

- 管理されていないスイッチをマネージド スイッチに交換することはできますか? それとも、ネットワーク TAP の使用はオプションですか?

- ネットワークにシリアル通信はありますか? ある場合は、それをネットワーク図に示してください。

- Defender for IoT アプライアンスをそのスイッチに接続する必要がある場合、そのキャビネットには物理的に使用可能なラック スペースがありますか?

#### <a name="other-considerations"></a>その他の考慮事項

Defender for IoT アプライアンスの目的は、レイヤー 1 と 2 からのトラフィックを監視することです。

一部のアーキテクチャでは、このレイヤーに OT トラフィックが存在する場合、Defender for IoT アプライアンスでレイヤー 3 も監視されます。 サイトのアーキテクチャを確認し、スイッチを監視するかどうかを決定する際には、次の不確定要素を考慮してください。

- このスイッチを監視することの重要性に対するコストと利点は何ですか?

- スイッチが管理されていない場合、上位レベルのスイッチからのトラフィックを監視することはできますか?

  ICS アーキテクチャがリング トポロジの場合は、このリング内の 1 つのスイッチのみを監視する必要があります。

- このネットワークのセキュリティや運用上のリスクはどのようなものですか?

- スイッチの VLAN を監視することはできますか? 監視できる別のスイッチに VLAN が表示されていますか?

#### <a name="technical-validation"></a>技術的な検証

スイッチの SPAN (またはミラー) ポートから記録されたトラフィック (PCAP ファイル) のサンプルを受信すると、次のことに役立ちます。

- スイッチが正しく構成されているかどうかを検証できます。

- スイッチを通過するトラフィックが監視 (OT トラフィック) に関連するかどうかを確認できます。

- このスイッチの帯域幅と推定されるデバイスの数を特定できます。

Wireshark アプリケーションを使用して、既に構成されている SPAN ポートにノート PC を接続することで、サンプルの PCAP ファイルを記録できます (数分)。

:::image type="content" source="media/how-to-set-up-your-network/laptop-connected-to-span.jpg" alt-text="SPAN ポートに接続されているラップトップのスクリーンショット。":::
:::image type="content" source="media/how-to-set-up-your-network/sample-pcap-file.PNG" alt-text="サンプルの PCAP ファイルの記録のスクリーンショット。":::

#### <a name="wireshark-validation"></a>Wireshark の検証

- 記録するトラフィックに *ユニキャスト パケット* があることを確認します。 ユニキャストは、あるアドレスから別のアドレスへのものです。 ほとんどのトラフィックが ARP メッセージの場合は、スイッチのセットアップが正しくありません。

- **[統計]**  >  **[プロトコル階層]** の順に移動します。 産業用プロトコルが存在することを確認します。

:::image type="content" source="media/how-to-set-up-your-network/wireshark-validation.png" alt-text="Wireshark 検証のスクリーンショット。":::

## <a name="troubleshooting"></a>トラブルシューティング

問題のトラブルシューティングについては、次のセクションを使用してください。

- [Web インターフェイスを使用して接続できない](#cant-connect-by-using-a-web-interface)

- [アプライアンスが応答していない](#appliance-is-not-responding)

### <a name="cant-connect-by-using-a-web-interface"></a>Web インターフェイスを使用して接続できない

1. 接続しようとしているコンピューターが、アプライアンスと同じネットワーク上にあることを確認します。

2. GUI ネットワークがセンサーの管理ポートに接続されていることを確認します。

3. アプライアンスの IP アドレスに対して ping を実行します。 ping に対する応答がない場合は、次の操作を行います。

    1. モニターとキーボードをアプライアンスに接続します。

    1. **support** ユーザーとパスワードを使用してサインインします。

    1. コマンド **network list** を使用して、現在の IP アドレスを確認します。

    :::image type="content" source="media/how-to-set-up-your-network/list-of-network-commands.png" alt-text="network list コマンドのスクリーンショット。":::

4. ネットワーク パラメーターが正しく構成されていない場合は、次の手順に従って変更します。

    1. コマンド **network edit-settings** を使用します。

    1. 管理ネットワークの IP アドレスを変更するには、 **[Y]** を選択します。

    1. サブネット マスクを変更するには、 **[Y]** を選択します。

    1. DNS を変更するには、 **[Y]** を選択します。

    1. 既定のゲートウェイ IP アドレスを変更するには、 **[Y]** を選択します。

    1. 入力インターフェイスの変更の場合は (センサーのみの場合)、 **[Y]** を選択します。

    1. ブリッジ インターフェイスの場合は、 **[N]** を選択します。

    1. 設定を適用するには、 **[Y]** を選択します。

5. 再起動後、ユーザー サポートに接続し、**network list** コマンドを使用してパラメーターが変更されたことを確認します。

6. もう一度 ping を実行し、GUI から接続します。

### <a name="appliance-is-not-responding"></a>アプライアンスが応答していない

1. モニターとキーボードを使用してアプライアンスに接続するか、PuTTY を使用して CLI にリモートで接続します。

2. サポート資格情報を使用してサインインします。

3. **system sanity** コマンドを使用して、すべてのプロセスが実行されていることを確認します。

    :::image type="content" source="media/how-to-set-up-your-network/system-sanity-command.png" alt-text="system sanity コマンドのスクリーンショット。":::

その他の問題については、[Microsoft サポート](https://support.microsoft.com/en-us/supportforbusiness/productselection?sapId=82c88f35-1b8e-f274-ec11-c6efdd6dd099)にお問い合わせください。

## <a name="predeployment-checklist"></a>デプロイ前のチェックリスト

デプロイ前のチェックリストを使用して、ネットワークのセットアップに必要な重要な情報を取得して確認します。

### <a name="site-checklist"></a>サイトのチェックリスト

サイトのデプロイの前に、次の一覧を確認してください。

| **#** | **タスクまたはアクティビティ** | **状態** | **コメント** |
|--|--|--|--|
| 1 | アプライアンスを注文する。 | ☐ |  |
| 2 | ネットワーク内のサブネットの一覧を準備する。 | ☐ |  |
| 3 | 運用ネットワークの VLAN リストを用意する。 | ☐ |  |
| 4 | ネットワーク内のスイッチ モデルの一覧を用意する。 | ☐ |  |
| 5 | 産業機器の製造元とプロトコルの一覧を用意する。 | ☐ |  |
| 6 | センサーのネットワークの詳細 (IP アドレス、サブネット、D GW、DNS) を用意する。 | ☐ |  |
| 7 | サードパーティ製スイッチの管理 | ☐ |  |
| 8 | 必要なファイアウォール規則とアクセス リストを作成する。 | ☐ |  |
| 9 | ポートの監視用のスイッチに SPAN ポートを作成するか、必要に応じてネットワーク タップを構成する。 | ☐ |  |
| 10 | センサー アプライアンス用のラック スペースを準備する。 | ☐ |  |
| 11 | スタッフ用のワークステーションを準備する。 | ☐ |  |
| 12 | Defender for IoT ラック デバイス用のキーボード、モニター、マウスを用意する。 | ☐ |  |
| 13 | アプライアンスをラックに取り付けてケーブルを接続する。 | ☐ |  |
| 14 | サイトにデプロイをサポートするリソースを割り当てる。 | ☐ |  |
| 15 | Active Directory グループまたはローカル ユーザーを作成する。 | ☐ |  |
| 16 | トレーニング (自己学習) を設定する。 | ☐ |  |
| 17 | 決行または中止する。 | ☐ |  |
| 18 | デプロイ日をスケジュールする。 | ☐ |  |


| **日付** | **注:** | **デプロイ日** | **注:** |
|--|--|--|--|
| Defender for IoT |  | サイト名* |  |
| 名前 |  | 名前 |  |
| [位置] |  | [位置] |  |

#### <a name="architecture-review"></a>アーキテクチャ レビュー

産業用ネットワーク図の概要を使用して、Defender for IoT 機器の適切な場所を定義できます。

1. **グローバル ネットワーク図** - 産業用 OT 環境のグローバル ネットワーク図を表示します。 次に例を示します。

    :::image type="content" source="media/how-to-set-up-your-network/backbone-switch.png" alt-text="グローバル ネットワークの産業用 OT 環境の図。":::

    > [!NOTE]
    > Defender for IoT アプライアンスは、スイッチのポート間のトラフィックを認識する下位レベルのスイッチに接続する必要があります。  

1. **コミット済みデバイス** - 監視するネットワーク デバイスの概数を指定します。 この情報は、Azure portal で Defender for IoT へサブスクリプションをオンボードするときに必要になります。 オンボード プロセス中に、デバイス数を 1,000 単位で入力するように求められます。

1. **(省略可能) サブネットの一覧** - 運用ネットワークのサブネットの一覧と説明 (省略可能) を用意します。

    |  **#**  | **サブネット名** | **説明** |
    |--| --------------- | --------------- |
    | 1  | |
    | 2  | |
    | 3  | |
    | 4  | |

1. **VLAN** - 運用ネットワークの VLAN リストを用意します。

    | **#** | **VLAN 名** | **説明** |
    |--|--|--|
    | 1 |  |  |
    | 2 |  |  |
    | 3 |  |  |
    | 4 |  |  |

1. **スイッチ モデルとミラーリングのサポート** - スイッチにポート ミラーリング機能があることを確認するには、Defender for IoT プラットフォームで接続する必要があるスイッチのモデル番号を指定します。

    | **#** | **スイッチ** | **Model** | **トラフィックのミラーリングのサポート (SPAN、RSPAN、またはなし)** |
    |--|--|--|--|
    | 1 |  |  |
    | 2 |  |  |
    | 3 |  |  |
    | 4 |  |  |

1. **サードパーティ製スイッチの管理** - サード パーティがスイッチを管理していますか? Y または N 

    「はい」の場合、だれですか? __________________________________ 

    そのポリシーは何ですか? __________________________________ 

    次に例を示します。

    - Siemens

    - Rockwell Automation - イーサネットまたは IP

    - Emerson – DeltaV、Ovation

1. **シリアル接続** - ネットワークのシリアル接続を介して通信するデバイスはありますか? はい、いいえ

    「はい」の場合、そのシリアル通信プロトコルか記入してください: ________________

    「はい」の場合、ネットワーク図に、どのデバイスがシリアル プロトコルと通信し、それらがどこにあるかをマークしてください:

    "*マークされたシリアル接続を含むネットワーク図を追加します*"

1. **サービスの品質** - サービスの品質 (QoS) では、センサーの既定の設定は 1.5 Mbps です。 これを変更する場合は記入してください: ________________

   事業単位 (BU): ________________

1. **センサー** - サイトの機器の仕様

    センサー アプライアンスは、ネットワーク アダプターを介してスイッチの SPAN ポートに接続されています。 これは、もう 1 つの専用ネットワーク アダプターを介して管理するために、顧客の企業のネットワークに接続されています。

    企業のネットワークに接続されるセンサー NIC のアドレスの詳細を記入してください。

    | 項目 | アプライアンス 1 | アプライアンス 2 | アプライアンス 3 |
    |--|--|--|--|
    | アプライアンスの IP アドレス |  |  |  |
    | Subnet |  |  |  |
    | デフォルト ゲートウェイ |  |  |  |
    | DNS |  |  |  |
    | ホスト名 |  |  |  |

1. **iDRAC/iLO/サーバー管理**

    | 項目 | アプライアンス 1 | アプライアンス 2 | アプライアンス 3 |
    |--|--|--|--|
    | アプライアンスの IP アドレス |  |  |  |
    | Subnet |  |  |  |
    | デフォルト ゲートウェイ |  |  |  |
    | DNS |  |  |  |

1. **オンプレミスの管理コンソール**

    | 項目 | アクティブ | パッシブ (HA を使用する場合) |
    |--|--|--|
    | IP アドレス |  |  |
    | Subnet |  |  |
    | デフォルト ゲートウェイ |  |  |
    | DNS |  |  |

1. **SNMP**  

    | 項目 | 詳細 |
    |--|--|
    | IP |  |
    | IP アドレス |  |
    | ユーザー名 |  |
    | Password |  |
    | 認証の種類 | MD5 または SHA |
    | 暗号化 | DES または AES |
    | 秘密鍵 |  |
    | SNMP v2 コミュニティ文字列 |

1. **オンプレミスの管理コンソールの SSL 証明書**

    VPN デバイスを使用する予定はありますか? はい、いいえ

    「はい」の場合は、どのサービスを使用して生成しますか? 証明書にはどの属性を含めますか (ドメインや IP アドレスなど)?

1. **SMTP 認証**

    電子メール サーバーにアラートを転送するために SMTP を使用する予定ですか? はい、いいえ

    「はい」の場合は、どの認証方法を使用しますか?  

1. **Active Directory またはローカル ユーザー**

    Active Directory 管理者に連絡して、Active Directory サイト ユーザー グループを作成するか、ローカル ユーザーを作成してください。 ユーザーにデプロイ日の準備ができていることを確認してください。

1. ネットワーク内の IoT デバイスの種類

    | デバイスの種類 | ネットワークブ内のデバイスの数 | 平均帯域幅 |
    | --------------- | ------ | ----------------------- |
    | カメラ | |
    | X 線機器 | |
    |  |  |
    |  |  |
    |  |  |
    |  |  |
    |  |  |
    |  |  |
    |  |  |
    |  |  |

## <a name="next-steps"></a>次のステップ

[Defender for IoT のインストールについて](how-to-install-software.md)
