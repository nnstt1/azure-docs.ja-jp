---
title: 証明書をデプロイする
description: Defender for IoT 用の証明書を設定してデプロイする方法について説明します。
ms.date: 11/09/2021
ms.topic: how-to
ms.openlocfilehash: df2b0484d9f9302443dc37870a6a97de31ded3b1
ms.sourcegitcommit: 677e8acc9a2e8b842e4aef4472599f9264e989e7
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 11/11/2021
ms.locfileid: "132343707"
---
# <a name="about-certificates"></a>証明書について

この記事では、Microsoft Defender for IoT 用の証明書を作成してデプロイするときに必要な情報を提供します。 セキュリティ、PKI、または他の資格のある証明書の責任者が、証明書の作成とデプロイを処理する必要があります。

Defender for IoT では、SSL/TLS 証明書が使用され、次のシステム コンポーネント間の通信がセキュリティで保護されます。 

- ユーザーとアプライアンスの Web コンソールとの間。 
- センサーとオンプレミスの管理コンソールとの間。 
- 管理コンソールと高可用性管理コンソールとの間。
- センサーおよびオンプレミスの管理コンソール上の REST API まで。 

Defender for IoT 管理者ユーザーは、[SSL/TLS 証明書] ダイアログ ボックスから、センサー コンソールとそれらのオンプレミスの管理コンソールに証明書をアップロードできます。

:::image type="content" source="media/how-to-deploy-certificates/certificate-upload.png" alt-text="証明書アップロード ダイアログ ボックス。":::

## <a name="about-certificate-generation-methods"></a>証明書生成方法について

次を使用した、すべての証明書生成方法がサポートされています。  

- プライベートおよびエンタープライズ キー インフラストラクチャ (プライベート PKI) 
- 公開キー基盤 (パブリック PKI) 
- アプライアンス上のローカルで生成された (ローカルで自己署名された) 証明書。 

> [!Important]
> ローカルで自己署名された証明書の使用は推奨されません。 この種類の接続はセキュリティで保護されていないため、テスト環境でのみ使用してください。 証明書の所有者を検証できず、システムのセキュリティを維持することもできないため、自己署名証明書は実稼働ネットワークには使用しないでください。

## <a name="about-certificate-validation"></a>証明書の検証について

ユーザーは、システム コンポーネント間の通信をセキュリティで保護するだけでなく、証明書の検証を実行することもできます。  

検証は次に対して評価されます。

- 証明書失効リスト (CRL)
- 証明書の有効期限  
- 証明書の信頼チェーン

検証は 2 回実行されます。

1. センサーおよびオンプレミスの管理コンソールに証明書をアップロードするとき。 検証が失敗した場合、証明書をアップロードすることはできません。
1. 次の間の暗号化通信を開始するとき:

    - センサーとオンプレミスの管理コンソールなどの Defender for IoT システム コンポーネント。

    - 転送ルールで定義されている Defender for IoT と特定のサード パーティ サーバー。  詳細については、「[転送されるアラート情報について](how-to-forward-alert-information-to-partners.md#about-forwarded-alert-information)」を参照してください。  

検証に失敗した場合は、関連コンポーネント間の通信が停止し、検証エラーがコンソールに表示されます。

## <a name="about-certificate-upload-to-defender-for-iot"></a>Defender for IoT への証明書のアップロードについて

センサーとオンプレミスの管理コンソールのインストール後に、ローカルの自己署名証明書が生成され、センサーとオンプレミスの管理コンソールの Web アプリケーションにアクセスするために使用されます。

管理者ユーザーがセンサーとオンプレミスの管理コンソールに初めてサインインすると、SSL/TLS 証明書をアップロードするように求められます。 SSL/TLS 証明書を使用することが強く推奨されます。

証明書が証明書の責任者によって適切に作成されていない場合、またはそれへの接続の問題がある場合、証明書をアップロードできず、ユーザーはローカルに署名された証明書を使用せざるを得なくなります。  

アップロードされた証明書とサードパーティの証明書を検証するオプションは自動的に有効になりますが、無効にすることもできます。 無効にすると、証明書が無効な場合でも、コンポーネント間の暗号化された通信が続行されます。

## <a name="certificate-deployment-tasks"></a>証明書のデプロイ タスク

このセクションでは、証明書のデプロイをスムーズに実行するために必要な手順について説明します。

**証明書をデプロイするには、次のことを確認します。**

- セキュリティ、PKI、または証明書のスペシャリストが、作成しているか、または証明書作成を監督している。 
- センサー、管理コンソール、および HA マシンごとに一意の証明書を作成している。
- 証明書作成要件を満たしている。 「 [証明書作成要件](#certificate-creation-requirements)」を参照してください。
- 管理者ユーザーが各 Defender for IoT センサーにログインし、オンプレミスの管理コンソールと HA マシンから証明書にアクセスできる。

## <a name="certificate-creation-requirements"></a>証明書作成要件

このセクションでは、次のような証明書作成要件について説明します。

- [証明書の検証のためのポート アクセス要件](#port-access-requirements-for-certificate-validation)

- [ファイルの種類の要件](#file-type-requirements)

- [キー ファイルの要件](#key-file-requirements)

- [証明書チェーン ファイルの要件 (.pem が使用されている場合)](#certificate-chain-file-requirements-if-pem-is-used)

### <a name="port-access-requirements-for-certificate-validation"></a>証明書の検証のためのポート アクセス要件

証明書の検証を操作する場合は、ポート 80 へのアクセスが使用可能であることを確認します。

証明書の検証は、証明書失効リストと証明書の有効期限に照らして評価されます。 つまり、アプライアンスで証明書によって定義された CRL サーバーへの接続を確立できるようにする必要があります。 既定では、証明書は HTTP ポート 80 の CRL URL を参照します。 

組織のセキュリティ ポリシーによっては、このポートへのアクセスがブロックされる場合があります。 組織がポート 80 にアクセスできない場合は、以下を実行できます。 

1. 証明書に別の URL と特定のポートを定義します。

    - URL は、 https:// ではなく http:// として定義する必要があります。

    - 接続先 CRL サーバーが、定義したポートでリッスンできることを確認します。 

1. ポート 80 で CRL にアクセスするプロキシ サーバーを使用します。

### <a name="file-type-requirements"></a>ファイルの種類の要件

Defender for IoT では、各 CA 署名証明書に、.key ファイルと .crt ファイルが含まれている必要があります。 これらのファイルは、ログイン後にセンサーおよびオンプレミスの管理コンソールにアップロードされます。 組織によっては、.pem ファイルが必要になる場合があります。 Defender for IoT では、このファイルの種類は必要ありません。

**.crt - 証明書コンテナー ファイル**

異なる拡張子を使用した .pem または .der 形式のファイル。 このファイルは、エクスプローラーで証明書として認識されます。 エクスプローラーでは .pem ファイルは認識されません。

**.key - 秘密キー ファイル**

キー ファイルは PEM ファイルと同じ形式ですが、拡張子は異なります。

**.pem - 証明書コンテナー ファイル (省略可能)**

PEM は、証明書テキストの Base64 エンコード、証明書の先頭と末尾を示すプレーンテキストのヘッダーおよびフッターを含むテキスト ファイルです。

既存のファイルの種類を、サポートされている種類に変換する必要がある場合があります。 詳細については、「[既存のファイルをサポートされているファイルに変換する](#convert-existing-files-to-supported-files)」を参照してください。

### <a name="certificate-file-parameter-requirements"></a>証明書ファイル パラメーターの要件

証明書を作成する前に、次のパラメーターの要件を満たしていることを確認します。

- [CRT ファイルの要件](#crt-file-requirements)
- [キー ファイルの要件](#key-file-requirements)
- [証明書チェーン ファイルの要件 (.pem が使用されている場合)](#certificate-chain-file-requirements-if-pem-is-used)

### <a name="crt-file-requirements"></a>CRT ファイルの要件

このセクションでは、.crt フィールドの要件について説明します。

- 署名アルゴリズム = SHA256RSA 
- 署名ハッシュ アルゴリズム = SHA256 
- 有効期間の開始 = 有効な過去の日付 
- 有効期間の終了 = 有効な将来の日付 
- 公開キー = RSA 2048 ビット (最小) または 4096 ビット 
- CRL 配布ポイント = .crl ファイルへの URL 
- サブジェクト CN (共通名) = アプライアンスのドメイン名。例: Sensor.contoso.com または *.contoso.com  
- サブジェクトの国 (C) = 定義済み。例: US 
- サブジェクトの組織単位 (OU) = 定義済み。例: Contoso Labs 
- サブジェクトの組織 (O) = 定義済み。例: Contoso Inc. 

他のパラメーターを含む証明書が機能する場合がありますが、Microsoft ではサポートされません。  

### <a name="key-file-requirements"></a>キー ファイルの要件

RSA 2048 ビット または 4096 ビットを使用します。

4096 ビットのキー長を使用すると、各接続の開始時の SSL ハンドシェイクが遅くなります。 さらに、ハンドシェイク中に CPU 使用率が増加します。

### <a name="certificate-chain-file-requirements-if-pem-is-used"></a>証明書チェーン ファイルの要件 (.pem が使用されている場合)

証明書につながる信頼チェーン内のすべての証明機関の証明書を含む .pem ファイル。  

バッグ属性は、証明書チェーン ファイルでサポートされています。

## <a name="create-certificates"></a>証明書の作成

証明書管理プラットフォームを使用して、証明書を作成します (自動 PKI 管理プラットフォームなど)。 証明書が証明書ファイルの要件を満たしていることを確認します。 作成するファイルのテストについては、「証明書のテスト」を参照してください。

証明書検証を実行していない場合は、証明書の CRL URL 参照を削除します。 このパラメーターの詳細については、「[CRT ファイルの要件](#crt-file-requirements)」を参照してください。

証明書を自動的に作成できるアプリケーションがない場合は、セキュリティ、PKI、または他の資格のある証明書の責任者に問い合わせてください。

[作成した証明書をテスト](#test-certificates-you-create)できます。  

新しい証明書ファイルを作成しない場合は、既存の証明書ファイルを変換することもできます。 詳細については、「[既存のファイルをサポートされているファイルに変換する](#convert-existing-files-to-supported-files)」を参照してください。

### <a name="sample-certificate"></a>サンプル証明書

証明書を以下のサンプル証明書と比較できます。 同じフィールドが存在し、フィールドの順序が同じであることを確認します。

:::image type="content" source="media/how-to-deploy-certificates/sample-certificate.png" alt-text="sample-certificate":::

## <a name="test-certificates-you-create"></a>作成した証明書をテストする

証明書は、センサーおよびオンプレミスの管理コンソールにデプロイする前にテストできます。 証明書 .csr ファイルまたはプライベート キー ファイル内の情報を確認する場合は、次のコマンドを使用します。

| **テスト** | **CLI コマンド** |
|--|--|
| 証明書署名要求 (CSR) を確認する | openssl req -text -noout -verify -in CSR.csr |
| 秘密キーを確認する  | openssl rsa -in privateKey.key -check  |
| 証明書を確認する  | openssl x509 -in certificate.crt -text -noout |

これらのテストが失敗した場合は、「[証明書ファイル パラメーターの要件](#certificate-file-parameter-requirements)」を確認して、ファイル パラメーターが正確か確認するか、証明書の責任者に問い合わせてください。

## <a name="convert-existing-files-to-supported-files"></a>既存のファイルをサポートされているファイルに変換する 

このセクションでは、既存の証明書ファイルを、サポートされている形式に変換する方法について説明します。

|**説明** | **CLI コマンド** |
|--|--|
| .crt ファイルを .pem ファイルに変換する   | `openssl x509 -inform PEM -in <full path>/<pem-file-name>.pem -out <fullpath>/<crt-file-name>.crt`  | 
| .pem ファイルを .crt ファイルに変換する   | `openssl x509 -inform PEM -in <full path>/<pem-file-name>.pem -out <fullpath>/<crt-file-name>.crt` |  
| 秘密キーと証明書を含む PKCS#12 ファイル (.pfx. p12) を PEM に変換する   | `openssl pkcs12 -in keyStore.pfx -out keyStore.pem -nodes`. -nocerts を追加して秘密キーのみを出力するか、-nokeys を追加して証明書のみを出力することができます。  |  

## <a name="troubleshooting"></a>トラブルシューティング  

このセクションでは、証明書のアップロードと検証時に発生する可能性があるさまざまな問題と、問題を解決するための手順について説明します。

### <a name="troubleshoot-ca-certificate-upload"></a>CA 証明書のアップロードのトラブルシューティング  

センサーまたはオンプレミス管理コンソールに初めてログインしようとする管理者ユーザーは、CA 署名証明書が適切に作成されていないか無効な場合に、その証明書をアップロードできません。 証明書のアップロードが失敗した場合、1 つまたは複数のエラー メッセージが表示されます。

| **証明書の検証エラー** | **推奨** |
|--|--|
| パスフレーズがキーと一致しません | 正しいパスフレーズを入力していることを確認します。 問題が解決しない場合は、正しいパスフレーズを使用して証明書を再作成してみてください。 |
| 信頼チェーンを検証できません。 指定された証明書とルート CA が一致しません。  | .pem ファイルが .crt ファイルに関連付けられていることを確認します。 問題が解決しない場合は、正しい信頼チェーン (.pem ファイルで定義) を使用して、証明書を再作成してみてください。 |
| この SSL 証明書は有効期限が切れているので、有効と見なされません。  | 有効な日付で新しい証明書を作成します。|
| この SSL 証明書は有効期限が切れているので、有効と見なされません。  | 有効な日付で新しい証明書を作成します。|
|この証明書は CRL によって失効されており、セキュリティで保護された接続には信頼できません | 新しい未失効証明書を作成します。 |
|CRL (証明書失効リスト) の場所に到達できません。 このアプライアンスから URL にアクセスできることを確認してください | ネットワーク構成により、アプライアンスが証明書で定義されている CRL サーバーに到達できることを確認します。直接接続の確立に制限がある場合は、プロキシ サーバーを使用できます。  
|証明書の検証に失敗しました  | これは、アプライアンスの一般的なエラーを示します。 [Microsoft サポート](https://support.microsoft.com/supportforbusiness/productselection?sapId=82c8f35-1b8e-f274-ec11-c6efdd6dd099)に問い合わせてください。|

### <a name="troubleshoot-file-conversions"></a>ファイル変換のトラブルシューティング  

ファイル変換によって有効な証明書が作成されない場合があります。 たとえば、ファイル構造が不正確である可能性があります。

変換が失敗した場合:  

- 「[既存のファイルをサポートされているファイルに変換する](#convert-existing-files-to-supported-files)」で説明されている変換コマンドを使用します。
- ファイル パラメーターが正確であることを確認します。 詳細については、「[ファイルの種類の要件](#file-type-requirements)」および「[証明書ファイル パラメーターの要件](#certificate-file-parameter-requirements)」を参照してください。  
- 証明書の責任者に問い合わせてください。
