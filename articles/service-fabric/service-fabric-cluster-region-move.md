---
title: Azure Service Fabric クラスターを新しいリージョンに移動する
description: Azure Service Fabric クラスターとアプリケーションを別のリージョンに移行する方法。
ms.topic: conceptual
ms.date: 07/20/2021
ms.author: micraft
ms.openlocfilehash: 3cbd2e21508296b6174a2322559973fb98728e2b
ms.sourcegitcommit: 106f5c9fa5c6d3498dd1cfe63181a7ed4125ae6d
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 11/02/2021
ms.locfileid: "131083481"
---
# <a name="move-an-azure-service-fabric-cluster-to-a-new-region"></a>Azure Service Fabric クラスターを新しいリージョンに移動する

Service Fabric クラスター リソースは、本質的に 1 つのリージョンにスコープ指定されます。 このスコープは、現在の "リージョン移動" は、最初に宛先リージョンに新しいクラスターを作成し、既存のワークロードを移行してから、その新しい宛先リージョンにトラフィックを送信して実現されることを意味します。 このドキュメントでは、この移行を実現するために必要な手順について説明します。 移行を多かれ少なかれ複雑にする可能性のあるいくつかの意思決定ポイントがあります。 これらの入力には、クラスターとアプリケーションの設定と構成方法、クラスターでの通信のしくみ、ワークロードがステートレスかステートフルか、またはその 2 つの組み合わせであるかどうかが含まれます。  


## <a name="steps-to-follow-for-a-region-migration"></a>リージョンの移行の手順

リージョンの移行に取り組む前に、テスト環境を確立し、これらの手順を練習することをお勧めします。 

## <a name="create-new-cluster"></a>新しいクラスターを作成する
1. お使いのクラスターとインフラストラクチャ トポロジの既存の ARM テンプレートを再利用して、[新しいリージョンにクラスターを設定します](./service-fabric-cluster-creation-via-arm.md#use-your-own-custom-template)。 クラスターを記述する ARM テンプレートが現在ない場合は、[Azure Resource Explorer](https://resources.azure.com/) から現在の ARM テンプレートを取得することをお勧めします。 Azure Resource Explorer は、現在デプロイされているリソースとその構成情報を検出するのに役立ちます。これらを使用すると、1 つ以上の ARM テンプレートを作成して、既存の環境のクローンを繰り返しデプロイすることができます。 続行する前に、この段階で既存の環境のクローンをデプロイできる ARM テンプレートが機能していることをテストして確認します。 

## <a name="move-applications-and-traffic"></a>アプリケーションとトラフィックを移動する
1. [ARM を使用して既存のアプリケーションとサービスをデプロイします](service-fabric-application-arm-resource.md)。 実行したアプリケーション パラメーターまたは構成のカスタマイズを保持するように注意してください。 たとえば、アプリケーションに既定値が 5 のパラメーター "count" があるが、ソース環境で、そのパラメーターの値を 7 にアップグレードした場合は、新しいリージョンでのアプリケーションのデプロイの値が 7 に設定されていることを確認する必要があります。 ARM を使用してアプリケーションとサービス インスタンスを管理しない場合は、現在のリージョンで実行されているアプリケーションとサービスの現在のセットとその構成を特定し、新しいリージョンまたはクラスターでそれらのアプリケーションとサービスを複製する必要があります。 

2. サービスを移行する  
   -  ステートフル ワークロードの場合: 
      * <p>ステートフル サービスが安定したポイントに到達していることを確認するには、まず、それらのサービスへの着信トラフィックが停止していることを確認します。 これを行う方法は、サービスへのトラフィックの配信方法によって異なります。 たとえば、適切なルーティングまたは転送規則を削除することで、サービスを Event Hubs から切断したり、APIM や Azure ネットワーク ロード バランサーのようなサービスがトラフィックをサービスにルーティングしないようにしたりする必要がある場合があります。 トラフィックが停止し、サービスがそれらの要求に関連するすべてのバックグラウンド作業を完了したら、続行できます。 </p>
      
      * [バックアップ復元サービス](service-fabric-reliable-services-backup-restore.md)を使用し、[オンデマンド バックアップ](service-fabric-backup-restore-service-ondemand-backup.md)を実行して、任意のステートフル サービスからバックアップを作成します。 これは必ず、トラフィックが停止し、バックグラウンド処理作業が完了してから行ってください。 完了したら、新しいリージョンとクラスターのステートフル サービスに[データを復元](service-fabric-backup-restore-service-trigger-restore.md)できます。 バックアップの作成に使用する Azure ストレージ アカウントは、新しいリージョンからアクセスできる必要があります。

   -  ステートレスの場合、次のようになります。 
      * <p>新しいクラスターにサービスをデプロイする以外に、追加の作業を行う必要はありません。理想的には、手順 2 で実行した ARM アプリケーションのデプロイの一環として、これらがソース クラスターと同じように構成されていることを確認します。</p>

   -  すべてのサービスの場合:  
      * <p>クライアントとサービス間の通信ステージが、ソース クラスターと同様に構成されていることを確認します。 たとえば、この検証には、Event Hubs、ネットワーク ロード バランサー、App Gateway、または API Management などの中継局が、クラスターへのトラフィックのフローを許可するために必要な規則で設定されていることの確認が含まれる場合があります。</p>  

3. 古いリージョンから新しいリージョンにトラフィックをリダイレクトします。 移行には、さまざまな[ルーティング方法](../traffic-manager/traffic-manager-routing-methods.md)を提供している [Azure Traffic Manager](../traffic-manager/traffic-manager-overview.md) を使用することをお勧めします。 トラフィック ルーティング規則をどの程度正確に更新するかは、既存のリージョンを維持するか非推奨にするかによって異なります。また、アプリケーション内でトラフィックがどのように流れるかによっても異なります。 場合によっては、プライベートまたはパブリック IP あるいは DNS 名を異なるリージョンの異なる Azure リソース間で移動できるかどうかを調査する必要があります。 Service Fabric ではシステムのこの部分が認識されないため、特に複雑な場合やワークロードで待ち時間が重要な場合には、調査を行い、必要に応じてトラフィック フローに関与する Azure チームを調査に参加させてください。 [カスタム ドメインの構成](../api-management/configure-custom-domain.md)、[パブリック IP アドレス](../virtual-network/ip-services/public-ip-addresses.md)、[DNS ゾーンとレコード](../dns/dns-zones-records.md)などに関するドキュメントが役立つ場合があります。また、これらはトラフィック フローとプロトコルに応じて必要になる情報の例です。 トラフィック ルーティングの更新にアプローチする方法を示す 2 つのシナリオ例を次に示します。  
   * 既存のソース リージョンを保持する予定がなく、元のソース クラスターへの呼び出しを配信しているネットワーク ロード バランサーのパブリック IP に関連付けられている DNS/CNAME がある場合。 新しいリージョンの新しいネットワーク ロード バランサーの新しいパブリック IP に関連付けられるように DNS/CNAME を更新します。 この転送を完了すると、既存のクラスターを使用しているクライアントは、新しいクラスターを使用するように切り替えられます。 
  
   * 既存のソース リージョンを保持する予定があり、元のソース クラスターへの呼び出しを配信していたネットワーク ロード バランサーのパブリック IP に関連付けられている DNS/CNAME がある場合。 Azure Traffic Manager のインスタンスを設定してから、DNS 名をその Azure Traffic Manager インスタンスに関連付けます。 この Azure Traffic Manager はその後、各リージョン内の個々のネットワーク ロード バランサーにルーティングするように構成できます。 

4. 両方のリージョンを保持する予定がある場合は、通常、何らかの "バック同期" があります。この場合、信頼できる情報源が、SQL、CosmosDB、BLOB、File Storage など、何らかのリモート ストアに保持され、リージョン間で同期されます。 ご自分のワークロードがこれに当てはまる場合は、データが期待どおりにリージョン間を流れていることを確認することをお勧めします。  

## <a name="final-validation"></a>最終的な検証
1. 最終的な検証として、トラフィックが期待どおりに流れていること、および新しいリージョン (および場合によっては古いリージョン) のサービスが期待どおりに動作していることを確認します。 

2. 元のソース リージョンを保持する予定がない場合は、この時点で、そのリージョン内のリソースを削除できます。 元のソース リージョンへのロールバックが必要な問題が検出された場合に備えて、リソースを削除する前にしばらく待つことをお勧めします。  

## <a name="next-steps"></a>次の手順
クラスターとアプリケーションを新しいリージョンに移動したので、必要なデータを保護するためにバックアップが設定されていることを確認する必要があります。

> [!div class="nextstepaction"]
> [移行後にバックアップを設定する](service-fabric-backuprestoreservice-quickstart-azurecluster.md)