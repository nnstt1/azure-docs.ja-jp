---
title: シングルテナント ワークフローと仮想ネットワーク間のトラフィックをセキュリティで保護する
description: Azure Logic Apps の仮想ネットワーク、ストレージ アカウント、およびシングルテナント ワークフロー間のトラフィックをセキュリティで保護します。
services: logic-apps
ms.suite: integration
ms.reviewer: estfan, azla
ms.topic: how-to
ms.date: 08/31/2021
ms.openlocfilehash: 500ec9c14dea994b528528389ed03d2b561c1a56
ms.sourcegitcommit: 692382974e1ac868a2672b67af2d33e593c91d60
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 10/22/2021
ms.locfileid: "130241822"
---
# <a name="secure-traffic-between-virtual-networks-and-single-tenant-workflows-in-azure-logic-apps-using-private-endpoints"></a>プライベート エンドポイントを使用して Azure Logic Apps の仮想ネットワークとシングルテナント ワークフロー間のトラフィックをセキュリティで保護する

ロジック アプリ ワークフローと仮想ネットワークの間で安全かつプライベートに通信するために、受信トラフィック用に "*プライベート エンドポイント*" を設定し、送信トラフィック用に仮想ネットワーク統合を使用できます。

プライベート エンドポイントとは、Azure Private Link を使用するサービスにプライベートかつ安全に接続するネットワーク インターフェイスです。 このサービスは、Azure Logic Apps、Azure Storage、Azure Cosmos DB、SQL などの Azure サービスでも、独自の Private Link サービスでもかまいません。 プライベート エンドポイントによって、ご自分の仮想ネットワークのプライベート IP アドレスが使用され、実質的に、そのサービスが仮想ネットワークに組み込まれます。

この記事では、受信トラフィック、送信トラフィック、およびストレージ アカウント接続に対して、プライベート エンドポイントを経由してアクセスを設定する方法について説明します。

詳細については、次のドキュメントを確認してください。

- [Azure プライベート エンドポイントとは](../private-link/private-endpoint-overview.md)

- [Azure Private Link とは](../private-link/private-link-overview.md)

- [Azure Logic Apps のシングルテナント ロジック アプリ ワークフローとは](single-tenant-overview-compare.md)

## <a name="prerequisites"></a>前提条件

新規または既存の Azure 仮想ネットワークに、委任のないサブネットが含まれている必要があります。 このサブネットは、仮想ネットワークからプライベート IP アドレスを配置して割り当てるために使用されます。

詳細については、次のドキュメントを確認してください。

- [クイック スタート:Azure Portal を使用した仮想ネットワークの作成](../virtual-network/quick-create-portal.md)

- [サブネットの委任とは](../virtual-network/subnet-delegation-overview.md)

- [サブネットの委任を追加または削除する](../virtual-network/manage-subnet-delegation.md)

<a name="set-up-inbound"></a>

## <a name="set-up-inbound-traffic-through-private-endpoints"></a>プライベート エンドポイントを経由する受信トラフィックを設定する

ワークフローへの受信トラフィックをセキュリティで保護するには、大まかに次の手順を行います。

1. 要求トリガーや HTTP + Webhook トリガーなど、受信要求を受信して処理できる組み込みトリガーを使用して、ワークフローを開始します。 このトリガーにより、呼び出し可能なエンドポイントを使用するワークフローが設定されます。

1. 仮想ネットワーク内にプライベート エンドポイントを追加します。

1. テスト呼び出しを行って、エンドポイントへのアクセスを確認します。 ロジック アプリ ワークフローをこのエンドポイントを設定した後に呼び出すには、仮想ネットワークに接続されている必要があります。

### <a name="prerequisites-for-inbound-traffic-through-private-endpoints"></a>プライベート エンドポイントを経由する受信トラフィックの前提条件

[最重要の前提条件である仮想ネットワーク設定](#prerequisites)に加えて、要求を受け取ることができる組み込みトリガーを使って開始される新しいまたは既存のシングルテナント ベースのロジック アプリ ワークフローが必要です。

たとえば、要求トリガーによって、ワークフローを含む他の呼び出し元からの受信要求を受信して処理できるエンドポイントがワークフローに作成されます。 このエンドポイントから、ワークフローの呼び出しとトリガーに使用できる URL が提供されます。 この例では、要求トリガーを使用して手順を続行します。

詳細については、次のドキュメントを確認してください。

- [Azure Logic Apps でシングルテナント ロジック アプリのワークフローを作成する](create-single-tenant-workflows-azure-portal.md)

- [Azure Logic Apps を使用して受信 HTTP 要求を受信して応答する](../connectors/connectors-native-reqres.md)

### <a name="create-the-workflow"></a>ワークフローを作成する

1. まだ作成していない場合は、シングルテナント ベースのロジック アプリと空のワークフローを作成します。

1. デザイナーが開いたら、ワークフローの最初のステップとして要求トリガーを追加します。

   > [!NOTE]
   > 要求トリガーと Webhook トリガーは仮想ネットワーク内からのみ呼び出すことができます。 マネージド API Webhook トリガーとアクションは、呼び出しを受信するためにパブリック エンドポイントが必要なため、機能しません。 

1. シナリオの要件に基づいて、ワークフローで実行する他のアクションを追加します。

1. 完了したら、ワークフローを保存します。

詳細については、[Azure Logic Apps でシングルテナント ロジック アプリのワークフローを作成する](create-single-tenant-workflows-azure-portal.md)に関する記事をご確認ください。

#### <a name="copy-the-endpoint-url"></a>エンドポイントの URL をコピーする

1. ワークフロー メニューで、 **[概要]** を選択します。

1. **[概要]** ページで、後で使用できるように **ワークフロー URL** をコピーして保存します。

   ワークフローをトリガーするには、要求を呼び出すか、この URL に送信します。

1. 要求を呼び出すか、URL に送信することで、URL が機能することを確認します。 Postman など、要求を送信する任意のツールを使用できます。

### <a name="set-up-private-endpoint-connection"></a>プライベート エンドポイント接続を設定する

1. ロジック アプリのメニューの **[設定]** で、 **[ネットワーク]** を選択します。

1. **[ネットワーク]** ページの **[プライベート エンドポイント接続]** で、 **[プライベート エンドポイント接続の構成]** を選択します。

1. **[プライベート エンドポイント接続]** ページで、 **[追加]** を選択します。

1. **[プライベート エンドポイントの追加]** ペインが表示されるので、エンドポイントに関して要求される情報を入力します。

   詳細については、「[プライベート エンドポイントのプロパティ](../private-link/private-endpoint-overview.md#private-endpoint-properties)」をご確認ください。

1. プライベート エンドポイントが Azure によって正常にプロビジョニングされたら、ワークフロー URL の呼び出しを再試行します。

   今回は、予想どおりに `403 Forbidden` エラーが発生します。これは、プライベート エンドポイントが設定され、正しく動作していることを意味します。

1. 接続が正しく動作するようにするには、そのプライベート エンドポイントがある同じ仮想ネットワーク内に仮想マシンを作成し、ロジック アプリ ワークフローを呼び出してみてください。

### <a name="considerations-for-inbound-traffic-through-private-endpoints"></a>プライベート エンドポイントを経由する受信トラフィックに関する考慮事項

- 仮想ネットワークの外部からアクセスした場合、監視ビューはトリガーとアクションからの入力と出力にアクセスできません。

- Visual Studio Code または Azure CLI からのデプロイは、仮想ネットワーク内からのみ機能します。 デプロイ センターを使用して、ロジック アプリを GitHub リポジトリにリンクできます。 その後、Azure インフラストラクチャを使用してコードをビルドし、デプロイできます。

  GitHub インテグレーションを機能させるには、ロジック アプリから `WEBSITE_RUN_FROM_PACKAGE` 設定を削除するか、値を `0` に設定します。

- Private Link を有効にしても、送信トラフィックには影響なく、App Service インフラストラクチャを引き続き経由します。

<a name="set-up-outbound"></a>

## <a name="set-up-outbound-traffic-through-private-endpoints"></a>プライベート エンドポイントを経由する送信トラフィックを設定する

ロジック アプリからの送信トラフィックをセキュリティで保護するために、ロジック アプリを仮想ネットワークと統合できます。 既定では、ロジック アプリからの送信トラフィックは、`10.0.0.0/8`、`172.16.0.0/12`、`192.168.0.0/16` などのプライベート アドレスに向かうときのみ、ネットワーク セキュリティ グループ (NSG) とユーザー定義ルート (UDR) の影響を受けます。

仮想ネットワークで独自のドメイン ネーム サーバー (DNS) を使用する場合は、ロジック アプリ リソースの `WEBSITE_DNS_SERVER` アプリ設定をその DNS の IP アドレスに設定します。 セカンダリ DNS がある場合は、`WEBSITE_DNS_ALT_SERVER` という名前の別のアプリ設定を追加し、その値を DNS の IP にも設定します。 また、内部 IP アドレスのプライベート エンドポイントを指し示すように DNS レコードを更新します。 プライベート エンドポイントは、特定のリソースのパブリック アドレスではなく、プライベート アドレスに DNS 参照を送信することで機能します。 詳細については、[プライベート エンドポイントでアプリを Azure 仮想ネットワークに統合する](../app-service/overview-vnet-integration.md#private-endpoints)方法に関するページを参照してください。

> [!IMPORTANT]
> Azure Logic Apps ランタイムが動作するには、バックエンド ストレージへの接続が中断されないようにする必要があります。 Azure でホストされるマネージド コネクタを機能させるには、マネージド API サービスへの接続が中断されないようにする必要があります。

### <a name="considerations-for-outbound-traffic-through-private-endpoints"></a>プライベート エンドポイントを経由する送信トラフィックに関する考慮事項

仮想ネットワークの設定は、送信トラフィックにのみ影響します。 引き続き App Service 共有エンドポイントを使用する受信トラフィックをセキュリティで保護するには、「[プライベート エンドポイントを経由する受信トラフィックを設定する](#set-up-inbound)」を参照してください。

詳細については、次のドキュメントを確認してください。

- [アプリを Azure 仮想ネットワークに統合する](../app-service/overview-vnet-integration.md)

- [ネットワーク セキュリティ グループ](../virtual-network/network-security-groups-overview.md)

- [仮想ネットワーク トラフィックのルーティング](../virtual-network/virtual-networks-udr-overview.md)

## <a name="connect-to-storage-account-with-private-endpoints"></a>プライベート エンドポイントを使用してストレージ アカウントに接続する

仮想ネットワーク内のリソースのみが接続できるように、ストレージ アカウントのアクセスを制限できます。 Azure Storage は、ストレージ アカウントへのプライベート エンドポイントの追加をサポートしています。 これにより、ロジック アプリ ワークフローで、これらのエンドポイントを使用してストレージ アカウントと通信できます。 詳細については、「[Azure Storage のプライベート エンドポイントを使用する](../storage/common/storage-private-endpoints.md)」を参照してください。

> [!NOTE]
> 次の手順では、ストレージ アカウントでパブリック アクセスを一時的に有効にする必要があります。 組織のポリシーが原因でパブリック アクセスを有効にできない場合でも、プライベート ストレージ アカウントを使用してロジック アプリをデプロイできます。 ただし、デプロイには Azure Resource Manager テンプレート (ARM テンプレート) を使用する必要があります。 ARM テンプレートの例については、[セキュリティで保護されたストレージ アカウントとプライベート エンドポイントを使用してロジック アプリをデプロイする](https://github.com/VeeraMS/LogicApp-deployment-with-Secure-Storage)方法に関するページを参照してください。

1. テーブル、キュー、BLOB、ファイル ストレージ サービスごとに異なるプライベート エンドポイントを作成します。

1. ロジック アプリをデプロイするときに、ストレージ アカウントで一時的なパブリック アクセスを有効にします。

   1. [Azure portal](https://portal.azure.com) でストレージ アカウント リソースを開きます。

   1. ストレージ アカウント リソース メニューの **[セキュリティとネットワーク]** で、 **[ネットワーク]** を選択します。

   1. **[ネットワーク]** ペインの **[ファイアウォールと仮想ネットワーク]** タブにある **[許可するアクセス元:]** で、 **[すべてのネットワーク]** を選択します。

1. Azure portal または Visual Studio Code のいずれかを使用して、ロジック アプリ リソースをデプロイします。

1. デプロイが完了したら、ロジック アプリと、ストレージ アカウントに接続する仮想ネットワークまたはサブネット上のプライベート エンドポイント間の統合を有効にします。

   1. [Azure portal](https://portal.azure.com) で、ロジック アプリ リソースを開きます。

   1. ロジック アプリ リソース メニューの **[設定]** で、 **[ネットワーク]** を選択します。

   1. ロジック アプリとプライベート エンドポイント用の IP アドレスの間に必要な接続を設定します。

   1. 仮想ネットワークを使用してロジック アプリのワークフロー データにアクセスするには、ロジック アプリ リソースの設定で、`WEBSITE_CONTENTOVERVNET` の設定を `1` に設定します。

   仮想ネットワークで独自のドメイン ネーム サーバー (DNS) を使用する場合は、ロジック アプリ リソースの `WEBSITE_DNS_SERVER` アプリ設定をその DNS の IP アドレスに設定します。 セカンダリ DNS がある場合は、`WEBSITE_DNS_ALT_SERVER` という名前の別のアプリ設定を追加し、その値を DNS の IP にも設定します。 また、内部 IP アドレスのプライベート エンドポイントを指し示すように DNS レコードを更新します。 プライベート エンドポイントは、特定のリソースのパブリック アドレスではなく、プライベート アドレスに DNS 参照を送信することで機能します。 詳細については、[プライベート エンドポイントでアプリを Azure 仮想ネットワークに統合する](../app-service/overview-vnet-integration.md#private-endpoints)方法に関するページを参照してください。

1. これらのアプリ設定を適用した後に、ストレージ アカウントからパブリック アクセスを削除できます。

## <a name="next-steps"></a>次の手順

- [どこでも使用できる Logic Apps: Logic Apps (シングルテナント) を使用したネットワークの可能性](https://techcommunity.microsoft.com/t5/integrations-on-azure/logic-apps-anywhere-networking-possibilities-with-logic-app/ba-p/2105047)