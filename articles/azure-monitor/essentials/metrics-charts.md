---
title: Azure メトリックス エクスプローラーの高度な機能
description: Azure メトリックス エクスプローラーの高度な使用方法について説明します。
author: vgorbenko
services: azure-monitor
ms.topic: conceptual
ms.date: 06/30/2020
ms.author: vitalyg
ms.openlocfilehash: bd0fef05913c66f767cb81e3c999fda4edaa8c21
ms.sourcegitcommit: 7d63ce88bfe8188b1ae70c3d006a29068d066287
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 07/22/2021
ms.locfileid: "114456526"
---
# <a name="advanced-features-of-the-azure-metrics-explorer"></a>Azure メトリックス エクスプローラーの高度な機能

> [!NOTE]
> この記事では、Azure Monitor の Azure メトリックス エクスプローラー機能の基本的な機能について理解していることを前提としています。 新規のユーザーで、初めてのメトリック グラフを作成する方法を確認したい場合は、[メトリックス エクスプローラーの概要](./metrics-getting-started.md)に関する記事を参照してください。

Azure Monitor において[メトリックス](data-platform-metrics.md)とは、時間をかけて収集および保存された一連の測定値とカウントです。 メトリックスには、標準 ("プラットフォーム" とも呼ばれます) またはカスタムがあります。 

標準メトリックスは、Azure プラットフォームによって提供されています。 これは、Azure リソースの状態と使用状況の統計を反映します。 

## <a name="resource-scope-picker"></a>リソース スコープ ピッカー
リソース スコープ ピッカーを使用すると、1 つのリソースまたは複数のリソースにわたるメトリックスを表示できます。 以下のセクションでは、リソース スコープ ピッカーの使用方法について説明します。 

### <a name="select-a-single-resource"></a>1 つのリソースを選択する
**[Azure Monitor]** メニューまたはリソースのメニューの **[監視]** セクションから **メトリック** を選択します。 次に、 **[スコープを選択する]** を選択し、スコープ ピッカーを開きます。 

スコープ ピッカーを使用して、メトリックスを表示するリソースを選択します。 リソースのメニューから Azure メトリックス エクスプローラーを開いた場合は、スコープが既に設定されています。 

![リソース スコープ ピッカーを開く方法を示すスクリーンショット。](./media/metrics-charts/scope-picker.png)

一部のリソースでは、一度に 1 つのリソースのメトリックスのみを表示できます。 **[リソースの種類]** メニューの場合、これらのリソースは **[すべてのリソースの種類]** セクションにあります。

![1 つのリソースを示すスクリーンショット。](./media/metrics-charts/single-resource-scope.png)

リソースを選択すると、そのリソースを含むすべてのサブスクリプションとリソース グループが表示されます。

![使用可能なリソースを示すスクリーンショット。](./media/metrics-charts/available-single-resource.png)

> [!TIP]
> 複数のリソースのメトリックスを同時に表示する機能が必要な場合、あるいはサブスクリプションまたはリソース グループ全体のメトリックスを表示する場合は、 **[Upvote]\(投票\)** を選択します。

選択が完了したら、 **[適用]** を選択します。

### <a name="view-metrics-across-multiple-resources"></a>複数のリソースのメトリックスの表示
一部の種類のリソースでは、複数のリソースのメトリックスに対してクエリを実行することができます。 このようなリソースは、同じサブスクリプションおよび場所にある必要があります。 これらの種類のリソースは、 **[リソースの種類]** メニューの上部にあります。 

詳細については、「[複数のリソースの選択](./metrics-dynamic-scope.md#select-multiple-resources)」を参照してください。

![クロスリソースの種類を示すスクリーンショット。](./media/metrics-charts/multi-resource-scope.png)

複数のリソースに互換性のある種類の場合、サブスクリプションまたは複数のリソース グループにわたるメトリックスに対してクエリを実行することもできます。 詳細については、「[リソース グループまたはサブスクリプションの選択](./metrics-dynamic-scope.md#select-a-resource-group-or-subscription)」を参照してください。

## <a name="multiple-metric-lines-and-charts"></a>複数のメトリックの線とグラフ

Azure メトリックス エクスプローラーを使用すると、複数のメトリックの線をプロットするグラフを作成したり、一度に複数のメトリック グラフを表示したりすることができます。 この機能を利用すると、次のことが可能になります。

- 1 つの値が別の値とどのように関連しているかを確認できるように、同じグラフ上の関連するメトリックスの相互関係を示す。
- 異なる測定単位を使用するメトリックスを近くに表示する。
- 複数のリソースのメトリックスを視覚的に集計して比較する。

たとえば、5 つのストレージ アカウントを所有しており、それらが合わせてどのくらいの領域を消費しているかを知りたいとします。 その場合、特定の時点における個々の値とすべての値の合計を表示する (積み上げ) 面グラフを作成できます。

### <a name="multiple-metrics-on-the-same-chart"></a>同じグラフ上の複数のメトリック

同じグラフで複数のメトリックを表示するには、まず[新しいグラフを作成](./metrics-getting-started.md#create-your-first-metric-chart)します。 次に、 **[メトリックの追加]** を選択します。 この手順を繰り返して、同じグラフに別のメトリックを追加します。

> [!NOTE]
> 通常、グラフでは、異なる測定単位を使用するメトリックスを混在させることはできません。 たとえば、ミリ秒が使用されているあるメトリックを、キロバイトが使用されている別のメトリックと混在させないようにします。 また、スケールが大きく異なるメトリックスも混在させないようにします。 
>
> このような場合は、代わりに複数のグラフを使用することを検討してください。 メトリクス エクスプローラーで **[新規グラフ]** を選択して、新しいグラフを作成します。

![複数のメトリクスを示すスクリーンショット。](./media/metrics-charts/multiple-metrics-chart.png)

### <a name="multiple-charts"></a>複数のグラフ

異なるメトリックを使用する別のグラフを作成するには、 **[新規グラフ]** を選択します。

複数のグラフの順序を変更したり削除したりするには、省略記号 ( **...** ) ボタンをクリックして、グラフ メニューを開きます。 その後、 **[上へ移動]** 、 **[下へ移動]** 、または **[削除]** を選択します。

![複数のグラフを示すスクリーンショット。](./media/metrics-charts/multiple-charts.png)

## <a name="time-range-controls"></a>時間の範囲コントロール

[[時刻の選択パネル]](metrics-getting-started.md#select-a-time-range) を使用して時間の範囲を変更するだけでなく、グラフ エリアのコントロールを使用してパンおよびズームすることもできます。
### <a name="pan"></a>パン

パンするには、グラフの端にある左矢印と右矢印をクリックします。  これにより、選択した時間の範囲がグラフの期間の半分ずつ移動します。  たとえば、過去 24 時間を表示している場合は、左矢印をクリックすると、時間の範囲が 1 日半から 12 時間前にシフトします。

ほとんどのメトリックでは 93 日のデータ保有期間がサポートされていますが、一度に表示できるのは 30 日間だけです。  パン コントロールを使用すると、過去 30 日間を確認してから、一度に 15 日間戻り、残りの保持期間を簡単に確認できます。

![左および右のパン コントロールを表示するアニメーション gif。](./media/metrics-charts/metrics-pan-controls.gif)

### <a name="zoom"></a>ズーム

グラフのセクションをズームするには、グラフをクリックしてドラッグします。  ズームすると、選択範囲にまたがるようにグラフの時間範囲が更新され、時間グレインが [自動] に設定されている場合は、より小さな時間グレインが選択されます。  新しい時間の範囲は、メトリックのすべてのグラフに適用されます。

![メトリックのズーム機能を表示するアニメーション gif。](./media/metrics-charts/metrics-zoom-control.gif)

## <a name="aggregation&quot;></a>集計

グラフにメトリックを追加すると、メトリックス エクスプローラーによって自動的に既定の集計が適用されます。 基本的なシナリオでは、この既定値が適しています。 しかし、別の集計を使用することで、メトリックに関する分析情報をさらに得ることができます。 

グラフ上でさまざまな集計を使用する前に、メトリックス エクスプローラーでこれらがどのように処理されるかを理解しておく必要があります。 メトリックスは、ある期間を通してキャプチャされた一連の測定値 (または &quot;メトリック値") です。 グラフをプロットすると、選択されたメトリックの値は、*時間グレイン* で個別に集計されます。 

期間粒度のサイズを選択するには、メトリックス エクスプローラーの[時刻の選択パネル](./metrics-getting-started.md#select-a-time-range)を使用します。 期間粒度を明示的に選択しない場合は、現在選択されている時間の範囲が既定で使用されます。 期間粒度が決定されると、各期間粒度でキャプチャされたメトリック値が集計され、期間粒度ごとに 1 つのデータ ポイントがグラフに配置されます。

たとえば、"*サーバーの応答時間*" メトリックが表示されているグラフがあるとします。 これは、"*過去 24 時間*" の期間にわたって "*平均*" の集計を使用しています。 次の点に注意してください。

- 時間粒度が 30 分に設定されている場合、集計された 48 個のデータ ポイントからグラフが描画されます。 つまり、折れ線グラフでは、グラフのプロット エリア上にある 48 個の点が結ばれています (1 時間あたり 2 個 x 24 時間分のデータ ポイント)。 各データ ポイントは、対象となる 30 分間に発生したサーバー要求においてキャプチャされたすべての応答時間の "*平均*" を表します。
- 時間の粒度を 15 分に切り替えると、集計された 96 個のデータ ポイントが取得されます。  つまり、1 時間あたり 4 個 x 24 時間分のデータ ポイントとなります。

メトリックス エクスプローラーには、sum、count、min、max、および average という 5 つの基本的な統計集計方法があります。 *sum* 集計は、*total* 集計とも呼ばれています。 メトリックス エクスプローラーでは、多くのメトリックスについて、関連性のない集計が非表示になり、使用できなくなります。 

メトリック集計の仕組みについて詳しくは、「[Azure Monitor メトリックの集計と表示](metrics-aggregation-explained.md)」をご覧ください。

* **Sum**:集計間隔でキャプチャされたすべての値の合計。

    ![sum 要求のスクリーンショット。](./media/metrics-charts/request-sum.png)

* **Count**:集計間隔でキャプチャされた測定値の数。 
    
    このメトリックが常に 1 の値でキャプチャされる場合、count 集計は合計集計と同じになります。 このシナリオは、メトリックが個別のイベントの数を追跡し、各測定が 1 つのイベントを表す場合によく見られます。 このコードを使用すると、新しい要求が到着するたびにメトリック レコードが生成されます。

    ![count 要求のスクリーンショット。](./media/metrics-charts/request-count.png)

* **Average**: 集計間隔でキャプチャされたメトリック値の平均。

    ![average 要求のスクリーンショット。](./media/metrics-charts/request-avg.png)

* **Min**:集計間隔でキャプチャされた値の最小値。

    ![min 要求のスクリーンショット。](./media/metrics-charts/request-min.png)

* **Max**:集計間隔でキャプチャされた値の最大値。

    ![max 要求のスクリーンショット。](./media/metrics-charts/request-max.png)

## <a name="filters"></a>フィルタ

ディメンションを持つメトリックスが含まれるグラフには、フィルターを適用することができます。 たとえば、"Response type" ディメンションを持つ "Transaction count" メトリックがあるとします。 このディメンションは、トランザクションからの応答が成功したか失敗したかを示します。 このディメンションをフィルター処理すると、成功したトランザクションのみ (または失敗したトランザクションのみ) のグラフ線が表示されます。 

### <a name="add-a-filter"></a>フィルターを追加する

1. グラフの上から、 **[フィルターの追加]** を選択します。

2. フィルターを適用するディメンション (プロパティ) を選択します。

   ![フィルター処理できるディメンション (プロパティ) のスクリーンショット。](./media/metrics-charts/028.png)

3. ディメンション (プロパティ) に適用する演算子を選択します。 既定の演算子は = (等しい) です。

   ![フィルターで使用できる演算子を示すスクリーンショット。](./media/metrics-charts/filter-operator.png)

4. グラフを描画するときにフィルターに適用するディメンションの値を選択します (この例では、成功したストレージ トランザクションを除外しています)。

   ![フィルター処理された成功したストレージ トランザクションを示すスクリーンショット。](./media/metrics-charts/029.png)

5. フィルターの値を選択したら、フィルター セレクターの外側をクリックして、セレクターを閉じます。 これで、グラフには、失敗したストレージ トランザクションの数が表示されます。

   ![失敗したストレージ トランザクションの数を示すスクリーンショット。](./media/metrics-charts/030.png)

6. 手順 1 ～ 5 を繰り返して、同じグラフに複数のフィルターを適用できます。


## <a name="metric-splitting"></a>メトリックの分割

メトリックをディメンションで分割することで、メトリックのセグメントがどのように異なるかを視覚化することもできます。 分割は、ディメンションの値が異常なセグメントを識別するのにも役立ちます。

### <a name="apply-splitting"></a>[Apply splitting]\(分割の適用\)

1. グラフの上にある **[Apply splitting]\(分割の適用\)** を選択します。
 
   > [!NOTE]
   > 複数のメトリックスが含まれるグラフでは、分割機能を使用できません。 また、グラフには複数のフィルターを含めることができますが、分割することができるディメンションは 1 つだけです。

2. グラフをセグメント化するディメンションを選択します。

   ![グラフをセグメント化するディメンションが選択されたスクリーンショット。](./media/metrics-charts/031.png)

   これで、グラフにはそれぞれがディメンションのセグメントである複数の線が表示されます。

   ![複数の線のスクリーンショット。ディメンションのセグメントごとに線が 1 本あります。](./media/metrics-charts/segment-dimension.png)
   
3. 選択したディメンションで分割した後に表示される値の数の制限を選択します。 上の図に示したように、既定の制限は 10 です。 制限の範囲は 1 ～ 50 です。
   
   ![分割された後の値の数を制限する分割制限を示すスクリーンショット。](./media/metrics-charts/segment-dimension-limit.png)
   
4. セグメントの並べ替え順序として、[昇順] または [降順] を選択します。 既定では、降順が選択されています。
   
   ![分割された値の並べ替え順序を示すスクリーンショット。](./media/metrics-charts/segment-dimension-sort.png)

5. **グループ セレクター** の外側のクリックして、セレクターを閉じます。
   

   > [!NOTE]
   > シナリオとは無関係のセグメントを非表示にしてグラフを読みやすくするには、同じディメンションでフィルター処理と分割の両方を使用します。

## <a name="locking-the-range-of-the-y-axis"></a>Y 軸の範囲のロック

大きな値のわずかな変動を表すグラフの場合、値 (Y) 軸の範囲をロックすることが重要となります。 

たとえば成功した要求のボリュームが 99.99% から 99.5% に低下した場合、サービスの品質としては、大幅な悪化を表している可能性があります。 しかし、グラフの既定の設定を使用している場合、数値のわずかな変動は気付きにくいか、まったくわからないこともあります。 この場合、グラフの下限境界を 99% にロックすることで、このわずかな低下を目立たせることができます。 

別の例として、使用可能なメモリの変動があります。 このシナリオにおいて、技術的には値が 0 になることはありません。 より高い値に範囲を固定することで、使用可能なメモリ量の低下が特定しやすくなると考えられます。 

Y 軸の範囲を制御するには、グラフ メニュー ( **...** ) を開きます。その後、 **[グラフの設定]** を選択して、グラフの詳細設定にアクセスします。

![[グラフの設定] の選択が強調表示されているスクリーンショット。](./media/metrics-charts/033.png)

**[Y 軸の範囲]** セクションの各値を変更するか、 **[自動]** を選択して既定値に戻します。
 
 ![[Y 軸の範囲] セクションが強調表示されているスクリーンショット。](./media/metrics-charts/034.png)

> [!WARNING]
> 一定期間 (count、sum、min、または max の集計を使用) のカウントや合計を追跡するグラフの Y 軸の境界をロックする必要がある場合は、通常、固定の時間粒度を指定する必要があります。 この場合、自動の既定値は使用しないでください。 
>
> 固定の時間粒度を選択するのは、ユーザーがブラウザのウィンドウのサイズを変更したり、画面の解像度を変更したりすると、時間の粒度が自動的に変更され、グラフの値が変化するためです。 それによって生じた時間の粒度の変化がグラフの外観に影響を及ぼし、Y 軸の範囲に対する現在の選択が適さなくなってしまいます。

## <a name="line-colors"></a>線の色

グラフを構成すると、グラフの線の色は既定のパレットから自動的に割り当てられます。 これらの色は変更できます。

グラフの線の色を変更するには、グラフに対応する凡例の色分けされたバーを選択します。 カラー ピッカーのダイアログ ボックスが開きます。 カラー ピッカーを使用して、線の色を構成します。

![色の変更方法を示すスクリーンショット。](./media/metrics-charts/035.png)

ダッシュボードにグラフをピン留めしても、カスタマイズした色は保持されます。 次のセクションでは、グラフをピン留めする方法について説明します。

## <a name="pinning-to-dashboards"></a>ダッシュボードへのピン留め 

グラフを構成したら、それをダッシュボードに追加することができます。 ダッシュボードにグラフをピン留めすることで、チームがそのグラフにアクセスしやすくすることができます。 それだけでなく、他の監視テレメトリの文脈で情報を表示することで、分析情報を得ることもできます。

構成したグラフをダッシュボードにピン留めするには、グラフの右上隅にある **[ダッシュボードにピン留めする]** を選択します。

![グラフをダッシュボードにピン留めする方法を示すスクリーンショット。](./media/metrics-charts/036.png)

## <a name="alert-rules"></a>アラート ルール

視覚化条件を使用して、メトリックベースのアラート ルールを作成できます。 新しいアラート ルールには、グラフのターゲット リソース、メトリック、分割、およびフィルター ディメンションが含まれます。 これらの設定を変更するには、アラート ルールの作成ウィンドウを使用します。

開始するには、 **[新しいアラート ルール]** を選択します。

![赤で強調表示されている [新しいアラート ルール] ボタンを示すスクリーンショット。](./media/metrics-charts/042.png)

アラート ルールの作成ペインが開きます。 このペインには、グラフのメトリック ディメンションが表示されていることがわかります。 ペイン内のフィールドは、ルールをカスタマイズする際の参考用に事前設定されています。

![ルールの作成ペインを示すスクリーンショット。](./media/metrics-charts/041.png)

詳細については、[メトリック アラートを作成、表示、管理する](../alerts/alerts-metric.md)方法に関するページを参照してください。

## <a name="correlate-metrics-to-logs"></a>メトリックをログに関連付ける
メトリック チャートの異常の根本原因を診断できるように、"ログの詳細を表示" が作成されました。 "ログの詳細を表示" を使用すると、メトリック グラフの急増をログとクエリに関連付けることができます。 

エクスペリエンスについて説明する前に、まず、提供されているさまざまな種類のログとクエリを紹介します。 

| 期間             | 定義  | 
|------------------|-------------|
| アクティビティ ログ    | Service Health イベントの更新に加えて、外部 ("管理プレーン") からサブスクリプションの各 Azure リソースに対する操作についての分析情報を提供します。 アクティビティ ログを使用して、サブスクリプションのリソースに対して行われるすべての書き込み操作 (PUT、POST、DELETE) について、何を、誰が、いつ行ったのかを確認できます。 Azure サブスクリプションごとに 1 つのアクティビティ ログがあります。  |   
| 診断ログ   | Azure リソース (データ プレーン) 内で実行された操作に関する分析情報を提供します。たとえば、キー コンテナーからのシークレットの取得や、データベースに対する要求などです。 リソース ログの内容は、Azure サービスとリソースの種類によって異なります。 **注:** サービスによって提供され、お客様が有効にする必要があります  | 
| 推奨されるログ | お客様がメトリック エクスプローラーで異常を調査するために利用できるシナリオベースのクエリ。  |

現在、"ログの詳細を表示" は選択されたリソース プロバイダーで使用できます。 [ログの詳細を表示] エクスペリエンスを備えているリソース プロバイダーは、次のとおりです。 

* Application Insights 
* 自動スケール 
* アプリケーション サービス  
* ストレージ  

Application Insights リソース プロバイダーのサンプル エクスペリエンスを以下に示します。

![App Insights メトリック ブレードでの障害の急増](./media/metrics-charts/drill-into-log-ai.png)

失敗した要求のスパイクを診断するには、[ログの詳細を表示] をクリックします。

![[ログの詳細を表示] ドロップダウンのスクリーンショット](./media/metrics-charts/drill-into-logs-dropdown.png)

エラー オプションをクリックすると、失敗した操作、上位の例外の種類、依存関係を示すカスタム エラー ブレードが表示されます。 

![App Insights のエラー ブレードのスクリーンショット](./media/metrics-charts/ai-failure-blade.png)

### <a name="common-problems-with-drill-into-logs"></a>"ログの詳細を表示" に関する一般的な問題

* ログとクエリが無効になる - 推奨されるログとクエリを表示するには、診断ログを Log Analytics にルーティングする必要があります。 この方法については、[こちらのドキュメント](./diagnostic-settings.md)を参照してください。 
* アクティビティ ログのみが提供される - "ログの詳細を表示" 機能は、選択されたリソース プロバイダーでのみ使用できます。 既定では、アクティビティ ログが提供されます。 

 
## <a name="troubleshooting"></a>トラブルシューティング

グラフにデータが表示されない場合は、次のトラブルシューティング情報を確認してください。

* フィルターは、ペイン上のすべてのグラフに適用されます。 あるグラフに注目する際は、別のグラフ上のすべてのデータを除外するフィルターを設定していないことを確認します。

* グラフごとに異なるフィルターを設定するには、異なるブレードでグラフを作成します。 その後、グラフを別のお気に入りとして保存します。 必要に応じて、グラフを一緒に表示できるように、グラフをダッシュボードに固定できます。

* メトリックで定義されていないプロパティを使用してグラフをセグメント化すると、グラフに内容が表示されません。 セグメント化 (分割) を削除するか、別のプロパティを選択してください。

## <a name="next-steps"></a>次のステップ

メトリックスを使用してアクション可能なダッシュボードを作成する方法については、[カスタム KPI ダッシュボードの作成](../app/tutorial-app-dashboards.md)に関するページを参照してください。
