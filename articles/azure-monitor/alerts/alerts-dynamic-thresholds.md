---
title: Azure Monitor で動的なしきい値を使用したアラートを作成する
description: 機械学習ベースの動的なしきい値を使用したアラートを作成します。
author: yanivlavi
ms.author: yalavi
ms.topic: conceptual
ms.date: 01/04/2021
ms.openlocfilehash: 4761550c3d08b66fc949c9b6e2950dc08278eea8
ms.sourcegitcommit: b11257b15f7f16ed01b9a78c471debb81c30f20c
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 06/08/2021
ms.locfileid: "111592234"
---
# <a name="metric-alerts-with-dynamic-thresholds-in-azure-monitor"></a>Azure Monitor の動的しきい値を使用したメトリック アラート

動的しきい値を使用したメトリック アラートでは、高度な機械学習 (ML) を活用して、メトリックの動きの履歴を学び、パターンや、サービスの問題の可能性を示す異常を識別します。 ユーザーが Azure Resource Manager API でアラート ルールを構成でき、完全に自動化された方法で、単純な UI と規模に応じた操作の両方がサポートされます。

アラート ルールが作成された後、調整されたしきい値に基づいて、監視対象のメトリックが予期したとおりに動作しない場合のみルールが実行されます。

ご意見、ご感想がある場合は、<azurealertsfeedback@microsoft.com> までお寄せください。

## <a name="why-and-when-is-using-dynamic-condition-type-recommended"></a>動的な条件タイプが推奨される理由とその状況

1. **スケーラブル アラート** – 動的なしきい値の警告ルールは、一度に数百のメトリックシリーズに合わせて調整されたしきい値を作成できますが、1つのメトリックでアラートルールを定義するのと同じくらい簡単です。 作成および管理するアラートの量を減らすことができます。 Azure portal または Azure Resource Manager API を使用して作成できます。 スケーラブルな方法が特に役立つのは、メトリックのディメンションを処理する場合、あるいは、すべてのサブスクリプションのリソースなどの複数のリソースに適用する場合です。 [動的しきい値を使用したメトリック アラートを構成するためにテンプレートを使用する方法はこちらをご覧ください](./alerts-metric-create-templates.md)。

1. **スマート メトリック パターン認識** – MLテクノロジーを使用して、メトリックパターンを自動的に検出し、時間の経過に伴うメトリックの変化に適応できます。これには、季節性（時間/日/週）が含まれることがあります。 時間経過に伴うメトリックの動きに合わせて、パターンからの偏差に基づいてアラートを生成することにより、各メトリックの 「正しい」しきい値を知っておくという負担が軽減されます。 動的しきい値で使用される ML アルゴリズムは、予期されるパターンを含まない、ノイズの多い (低精度) しきい値またはワイドな (低再現率) しきい値を抑制するように設計されています。

1. **直感的な構成** – 動的しきい値を使用すると、高度な概念を使用したメトリック アラートを設定でき、メトリックについて広範なドメイン知識を持つ必要が少なくなります。

## <a name="how-to-configure-alerts-rules-with-dynamic-thresholds"></a>動的しきい値を使用したアラート ルールの構成方法

動的しきい値を使用したアラートは、Azure Monitor の [メトリック アラート] で設定できます。 [メトリック アラートの構成方法はこちらをご覧ください](alerts-metric.md)。

## <a name="how-are-the-thresholds-calculated"></a>しきい値の計算方法

動的しきい値は、メトリックの系列のデータを学習し続け、一連のアルゴリズムとメソッドを使用してモデル化しようとします。 季節性 (毎時/毎日/毎週) のようなデータのパターンを検出し、ノイズの多いメトリック (マシンの CPU またはメモリなど) と分散性が低いメトリック (可用性やエラー率など) を処理できるようになります。

しきい値からの偏差がメトリックの動作の異常を示すように、しきい値を選択します。

> [!NOTE]
> 動的しきい値を使用すると、時間単位、日単位、または週単位のパターンの季節性を検出することができます。 その他のパターン、たとえば 2 時間ごと、または週に 2 回の季節性は検出されない場合があります。 週単位の季節性を検出するには、3 週間分以上の履歴データが必要です。 

## <a name="what-does-sensitivity-setting-in-dynamic-thresholds-mean"></a>動的しきい値の "秘密度" 設定とは

アラートしきい値の秘密度は、アラートをトリガーするために必要なメトリックの動作からの偏差の量を制御する高度な概念です。
この方法では、静的しきい値のようにメトリックに関するドメインの知識は不要です。 次の方法を使用できます。

- 高 – しきい値は、メトリックの系列パターンに近い値になります。 アラート ルールは最小の偏差でトリガーされ、アラートは増えます。
- 中 – ゆとりがあるバランスの取れたしきい値です。高秘密度 (既定) よりもアラート数が少なくなります。
- 低 – メトリックの系列パターンから離れます。 アラート ルールは大きい偏差でトリガーされ、アラートは減ります。

## <a name="what-are-the-operator-setting-options-in-dynamic-thresholds"></a>動的しきい値の "演算子" 設定オプションとは

動的しきい値のアラート ルールは、同じアラート ルールを使用して上限と下限について、メトリックの動作に基づいて調整したしきい値を作成できます。
次の 3 つの条件のいずれかを基にアラートをトリガーするよう選択できます。

- 上限しきい値より大きいか、下限しきい値より小さい (既定値)
- 上限しきい値より大きい
- 下限しきい値より小さい

## <a name="what-do-the-advanced-settings-in-dynamic-thresholds-mean"></a>動的しきい値の高度な設定の意味

**失敗期間** - 動的しきい値では、「アラートをトリガーする違反の数」も構成できます。これは、システムがアラートを発生させるために特定の時間枠内で必要な最小数の偏差を構成することもできます (既定時間枠は 20 分間に 4 回の偏差)。 ユーザーは、失敗期間を構成し、失敗期間と時間ウィンドウを変更してアラートの対象を選択できます。 この機能により、一時的なスパイクによって生成されるアラートのノイズが軽減されます。 次に例を示します。

20 分間問題が継続するとき、つまり所定の 5 分ごとの区切りで 4 回連続してしきい値を超えた場合にアラートをトリガーするには、次の設定を使用します。

![問題の継続が 20 分間 (所定の 5 分間の区切りで連続 4 回) の失敗期間の設定](media/alerts-dynamic-thresholds/0008.png)

5 分ごとの区切りで過去 30 分間のうち 20 分間で動的しきい値を超えた状態が続いた場合に、アラートをトリガーするには、次の設定を使用します。

![過去 30 分 (5 分ごとの区切り) のうち 20 分間問題がある失敗期間の設定](media/alerts-dynamic-thresholds/0009.png)

**以前のデータを無視** - ユーザーは必要に応じて、システムによるしきい値の計算の開始日付を定義することもできます。 一般的なユース ケースとしては、リソースがテスト モードで実行していたが、運用環境のワークロードを処理するように昇格された場合があります。このとき、テスト フェーズでのメトリックの動作は無視する必要があります。

## <a name="how-do-you-find-out-why-a-dynamic-thresholds-alert-was-triggered"></a>動的しきい値アラートがトリガーされた理由を知る方法

トリガーされたアラートのインスタンスは、メールまたはテキスト メッセージのリンクをクリックしてアラート ビューで調査できるほか、ブラウザーで Azure portal のアラート ビューにアクセスして調査することができます。 [アラート ビューの詳細については、こちらを参照してください](./alerts-overview.md#alerts-experience)。

アラート ビューには、次の情報が表示されます。

- 動的しきい値アラートの発生時点におけるすべてのメトリック情報。
- アラートがトリガーされた期間のグラフ。これにはその時点で使用された動的しきい値が含まれます。
- 動的しきい値アラートとアラート ビューのエクスペリエンスに関するフィードバックを送信する機能。これは、将来の検出機能の向上に役立てられます。

## <a name="will-slow-behavior-changes-in-the-metric-trigger-an-alert"></a>メトリックの動作の変化が遅いとアラートがトリガーされますか？

答えはおそらく「いいえ」でしょう。 動的しきい値は、緩やかに変化する問題ではなく、大きな偏差を検出する場合に有効です。

## <a name="how-much-data-is-used-to-preview-and-then-calculate-thresholds"></a>しきい値のプレビューと計算に使用されるデータの量

アラート ルールが最初に作成されると、グラフに表示されるしきい値は、時間または毎日の季節パターン (10日間) を計算するのに十分な履歴データに基づいて計算されます。 アラートルールが作成されると、動的しきい値は必要なすべての利用可能な履歴データを使用し、新しいデータに基づいて継続的に学習および適応してしきい値をより正確にします。 つまり、この計算の後には、グラフも週パターンを表示します。

## <a name="how-much-data-is-needed-to-trigger-an-alert"></a>アラートをトリガーするためにどれくらいのデータが必要ですか。

新しいリソースがあるか、またはメトリック データが不足している場合、しきい値の精度を保つため、メトリック データの利用が可能になる 3 日前、かつサンプル数が 30 以上になるまで、動的しきい値ではアラートがトリガーされません。
十分なメトリック データがある既存のリソースの場合、動的しきい値を使用してすぐにアラートをトリガーできます。

## <a name="dynamic-thresholds-best-practices"></a>動的しきい値のベスト プラクティス

動的しきい値は、ほとんどのプラットフォームおよび Azure Monitor のカスタム メトリックに適用できます。さらに、一般的なアプリケーションとインフラストラクチャのメトリック用に調整されてきました。
次の項目は、動的しきい値を使用するこれらのメトリックのいくつかにアラートを構成する方法に関するベスト プラクティスです。

### <a name="dynamic-thresholds-on-virtual-machine-cpu-percentage-metrics"></a>仮想マシンの CPU 割合メトリックの動的しきい値

1. [Azure portal](https://portal.azure.com) で、 **[モニター]** をクリックします。 [モニター] ビューでは、すべての監視設定とデータが 1 つのビューにまとめられています。

2. **[アラート]** をクリックして、 **[+ 新しいアラート ルール]** をクリックします。

    > [!TIP]
    > ほとんどのリソース ブレードにも **[監視]** のリソース メニューに **[アラート]** があり、そこからもアラートを作成できます。

3. **[ターゲットの選択]** をクリックし、読み込まれるコンテキスト ウィンドウで、アラートを設定するターゲット リソースを選択します。 **サブスクリプション** と **[リソースの種類] の [Virtual Machines]** ドロップダウンを使用して、監視するリソースを検索します。 検索バーを使用して、リソースを検索することもできます。

4. ターゲット リソースを選択した後、 **[条件の追加]** をクリックします。

5. **[CPU の割合]** を選択します。

6. 必要に応じて、 **[期間]** と **[集計]** を調整して、メトリックを設定し直します。 このメトリックの種類で、集計の種類として [最大] を使用することはお勧めしません。理由は、動きの表現力が低いためです。 [最大] という集計の種類では、静的しきい値のほうが適切である可能性があります。

7. 過去 6 時間のメトリックのグラフが表示されます。 アラートのパラメーターを定義します。
    1. **[条件の種類]** : [動的] オプションを選択します。
    1. **[感度]** : アラートのノイズを減らすために、[中] または [低] を選択します。
    1. **[演算子]** : 動きがアプリケーションの使用状況を表す場合を除き、[より大きい] を選択します。
    1. **[頻度]** : アラートのビジネスへの影響に基づいて低くすることを検討してください。
    1. **[失敗期間]** : (高度なオプション) ルックバック期間は 15 分以上にする必要があります。 たとえば、[期間] が 5 分に設定されている場合、[失敗期間] は 3 以上にする必要があります。

8. メトリック グラフに、最新のデータに基づいて計算されたしきい値が表示されます。

9. **[Done]** をクリックします。

10. **[アラート ルール名]** 、 **[説明]** 、 **[重大度]** などの **[アラートの詳細]** を指定します。

11. 既存のアクション グループを選択するか、新しいアクション グループを作成して、アラートにアクション グループを追加します。

12. **[完了]** をクリックして、メトリック アラート ルールを保存します。

> [!NOTE]
> ポータルで作成したメトリック アラート ルールは、ターゲット リソースと同じリソース グループに作成されます。

### <a name="dynamic-thresholds-on-application-insights-http-request-execution-time"></a>Application Insights での HTTP 要求の実行時間の動的しきい値

1. [Azure portal](https://portal.azure.com) で、 **[モニター]** をクリックします。 [モニター] ビューでは、すべての監視設定とデータが 1 つのビューにまとめられています。

2. **[アラート]** をクリックして、 **[+ 新しいアラート ルール]** をクリックします。

    > [!TIP]
    > ほとんどのリソース ブレードにも **[監視]** のリソース メニューに **[アラート]** があり、そこからもアラートを作成できます。

3. **[ターゲットの選択]** をクリックし、読み込まれるコンテキスト ウィンドウで、アラートを設定するターゲット リソースを選択します。 **サブスクリプション** と **[リソースの種類] の [Application Insights]** ドロップダウンを使用して、監視するリソースを検索します。 検索バーを使用して、リソースを検索することもできます。

4. ターゲット リソースを選択した後、 **[条件の追加]** をクリックします。

5. **[HTTP 要求の実行時間]** を選択します。

6. 必要に応じて、 **[期間]** と **[集計]** を調整して、メトリックを設定し直します。 このメトリックの種類で、集計の種類として [最大] を使用することはお勧めしません。理由は、動きの表現力が低いためです。 [最大] という集計の種類では、静的しきい値のほうが適切である可能性があります。

7. 過去 6 時間のメトリックのグラフが表示されます。 アラートのパラメーターを定義します。
    1. **[条件の種類]** : [動的] オプションを選択します。
    1. **[演算子]** : 持続時間が改善されたときに発生するアラートを減らすために、[より大きい] を選択します。
    1. **[頻度]** : アラートのビジネスへの影響に基づいて低くすることを検討してください。

8. メトリック グラフに、最新のデータに基づいて計算されたしきい値が表示されます。

9. **[Done]** をクリックします。

10. **[アラート ルール名]** 、 **[説明]** 、 **[重大度]** などの **[アラートの詳細]** を指定します。

11. 既存のアクション グループを選択するか、新しいアクション グループを作成して、アラートにアクション グループを追加します。

12. **[完了]** をクリックして、メトリック アラート ルールを保存します。

> [!NOTE]
> ポータルで作成したメトリック アラート ルールは、ターゲット リソースと同じリソース グループに作成されます。

## <a name="interpreting-dynamic-threshold-charts"></a>動的なしきい値グラフの解釈

次に示すのは、メトリック、動的なしきい値の制限、および値が許可されたしきい値を超えたときに発生した警告を示すグラフです。

![メトリック アラートの構成方法を学習する](media/alerts-dynamic-thresholds/threshold-picture-8bit.png)

次の情報を使用して、前のグラフを解釈します。

- **青色の線** - 時間の経過と共に実際に測定されたメトリックです。
- **青色の網掛けされた領域の**-メトリックで許容される範囲を示します。 メトリック値がこの範囲内にある限り、アラートは発生しません。
- **青いドット** - グラフの一部を左クリックし、青い線の上にマウスポインターを置くと、個々の集計されたメトリック値を示す青い点がカーソルの下に表示されます。
- **[青いドットでポップアップする]** - 測定されたメトリック値 (青いドット) と、許容範囲の上限値と下限値を表示します。  
- **黒い円で囲まれた赤い点** - 許容範囲外の最初のメトリック値が表示されます。 この値は、メトリックアラートを発生させ、アクティブな状態にします。
- **赤色のドット** - 許容範囲外の追加の測定値を示します。 追加のメトリックアラートは発生しませんが、アラートはアクティブな状態のままになります。
- **赤色の領域**-メトリック値が許容範囲外であった時刻を示します。 アラートは、後続の測定値が許容範囲外にある限りアクティブ状態のままですが、新しいアラートは発生しません。
- **赤色の領域の終了** - 青い線が許可された値の内側に戻ると、赤色の領域が停止し、測定値の線が青に変わります。 黒色の輪郭付きの赤いドットの時点で発生したメトリックアラートの状態が [解決済み] に設定されます。
