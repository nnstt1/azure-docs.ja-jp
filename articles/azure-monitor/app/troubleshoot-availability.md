---
title: Azure Application Insights 可用性テストのトラブルシューティング
description: Azure Application Insights の Web テストのトラブルシューティングを行います。 Web サイトが使用できなくなったり、応答速度が低下したりした場合に、アラートを受け取ります。
ms.topic: conceptual
ms.date: 02/14/2021
ms.reviewer: sdash
ms.openlocfilehash: 09e7a59e25be45dcd0d0c68612fbe13715200d2f
ms.sourcegitcommit: 147910fb817d93e0e53a36bb8d476207a2dd9e5e
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 10/18/2021
ms.locfileid: "130131697"
---
# <a name="troubleshooting"></a>トラブルシューティング

この記事は、可用性の監視機能を使用しているときに遭遇する可能性のある一般的な問題のトラブルシューティングに役立ちます。

## <a name="troubleshooting-report-steps-for-ping-tests"></a>ping テストのレポート ステップのトラブルシューティング

トラブルシューティング レポートを使用すると、**ping テスト** で失敗する原因となる一般的な問題を簡単に診断できます。

![障害を選択して [可用性] タブからエンドツーエンド トランザクションの詳細に移動し、トラブルシューティング レポートを表示しているアニメーション](./media/troubleshoot-availability/availability-to-troubleshooter.gif)

1. Application Insights リソースの [可用性] タブで、全体または可用性テストの 1 つを選択します。
2. **[失敗]** を選択してから左側の [ドリルイン] の下にあるテストを選択するか、散布図のいずれかの点を選択します。
3. エンドツーエンド トランザクションの詳細ページで、[トラブルシューティング レポートの概要] の下にあるイベントを選択し、 **[ステップに移動]** を選択して、トラブルシューティング レポートを表示します。

> [!NOTE]
>  接続の再利用の手順が存在する場合、DNS 解決、接続の確立、および TLS トランスポートの手順は存在しません。

|手順 | エラー メッセージ | 考えられる原因 |
|-----|---------------|----------------|
| 接続の再利用 | N/A | 通常、以前に確立された接続に依存します。これは、Web テスト ステップが依存することを意味します。 そのため、DNS、接続、または SSL の手順は必要ありません。 |
| DNS の解決 | リモート名を解決できませんでした: "URL" | DNS 解決プロセスが失敗しました。DNS レコードが正しく構成されていないか、DNS サーバーの一時的な障害が原因である可能性があります。 |
| 接続の確立 | 接続済みの呼び出し先が一定の時間を過ぎても正しく応答しなかったため、接続の試みが失敗しました。 | 通常、サーバーが HTTP 要求に応答していないことを意味します。 一般的な原因として、テスト エージェントがサーバーのファイアウォールによってブロックされていることが考えられます。 Azure Virtual Network 内でテストする場合は、可用性サービス タグを環境に追加する必要があります。|
| TLS トランスポート  | クライアントとサーバーは共通のアルゴリズムを保持していないため通信できません。| サポートされるのは、TLS 1.0、1.1、1.2 のみです。 XML はサポートされていません。 この手順では、SSL 証明書を検証するのではなく、セキュリティで保護された接続のみを確立します。 このステップは、エラーが発生した場合にのみ表示されます。 |
| 受信応答ヘッダー | データをトランスポート接続から読み取れません。 接続はクローズされました。 | サーバーが応答ヘッダーにプロトコル エラーをコミットしました。 たとえば、応答が完全ではない場合、サーバーによって接続がクローズされます。 |
| 受信応答本文 | データをトランスポート接続から読み取れません: 接続はクローズされました。 | サーバーが応答本文にプロトコル エラーをコミットしました。 たとえば、応答が完全に読み取られていない場合、またはチャンク サイズがチャンク応答本文で間違っている場合、サーバーによって接続がクローズされます。 |
| リダイレクト制限検証 | この Web ページのリダイレクト数が多すぎます。 この要求が自動リダイレクトの制限を超えたため、このループはここで終了します。 | 1 テストあたりのリダイレクトは 10 個に制限されています。 |
| 状態コード検証 | `200 - OK` が予期された状態 `400 - BadRequest` と一致しません。 | 成功としてカウントされる、返される状態コード。 200 は、通常の Web ページが返されたことを示すコードです。 |
| コンテンツの検証 | 要求されたテキスト "hello" が応答にありませんでした。 | 文字列は、応答内で大文字と小文字が完全に一致しません (例: 文字列 "Welcome!")。 これは、ワイルドカード文字 (アスタリスクなど) のないプレーン文字列である必要があります。 ページ コンテンツが変更された場合は、この文字列も更新する必要がある可能性があります。 コンテンツの一致では、英字のみがサポートされています。 |
  
## <a name="common-troubleshooting-questions"></a>一般的なトラブルシューティングの質問

### <a name="site-looks-okay-but-i-see-test-failures-why-is-application-insights-alerting-me"></a>サイトには問題がないように見えますがテストが失敗します。 Application Insights からアラートが通知されるのはどうしてですか。

   * ご利用のテストでは **[依存する要求の解析]** が有効になっていますか。 それが有効になっていると、スクリプトやイメージなどのリソースに対して厳密なチェックが行われます。ブラウザー上で、この種のエラーはわかりにくい場合があります。 イメージ、スクリプト、スタイル シート、およびページによって読み込まれるその他のファイルすべてを確認してください。 これらのいずれかにエラーがある場合、メインの HTML ページの読み込みに問題がない場合でも、テストはエラーとしてレポートされます。 このようなリソース エラーをテストで検出しないようにするには、テスト構成で [依存する要求の解析] をオフにするだけです。

   * ネットワークの一時的な問題によるノイズの可能性を減らすには、[Enable retries for test failures]\(テストが失敗した場合に再試行を有効にする\) 構成がオンになっていることを確認します。 複数の場所からテストを行い、アラート ルールのしきい値を適宜管理して、過度のアラートの原因となっている場所固有の問題を防ぐこともできます。

   * 可用性散布図エクスペリエンスで赤い点のいずれかをクリックするか、または Search エクスプローラーで任意の可用性エラーをクリックすると、エラーが報告された理由の詳細が表示されます。 テスト結果に加えて、サーバー側の相関関係を持つテレメトリ (有効になっている場合) は、テストが失敗した理由を理解するのに役立つはずです。 一時的な問題が発生する原因は、一般にネットワークまたは接続の問題にあります。

   * テストがタイムアウトになりましたか。 2 分後にテストを中止します。 ping または複数手順のテストが 2 分を経過しても完了しない場合は、エラーとして報告されます。 より短い時間で完了するようにテストを複数のテストに分割することを検討してください。

   * すべての場所でエラーが報告されましたか、それとも一部の場所でのみエラーが報告されましたか。 一部の場所でのみエラーが報告された場合は、ネットワーク/CDN の問題が原因です。 繰り返しになりますが、赤色のドットをクリックすると、その場所でエラーが報告された理由を理解するのに役立つ情報が表示されます。

### <a name="i-did-not-get-an-email-when-the-alert-triggered-or-resolved-or-both"></a>アラートがトリガーされたとき、もしくは解決されたとき、あるいはその両方で、電子メールが届きませんでした。

アラートのアクション グループの構成を調べて、目的のメールがリストに直接含まれること、または自分が登録されている配布リストが通知を受け取るように構成されていることを確認します。 そのようになっている場合は、配布リストの構成を調べて、外部の電子メールを受信できるように構成されていることを確認します。 また、メール管理者が所有するポリシーがこの問題を引き起こす可能性のある構成になっていないか確認します。

### <a name="i-did-not-receive-the-webhook-notification"></a>Webhook 通知が届きませんでした。

Web hook 通知を受信するアプリケーションが利用可能であること、さらにそのアプリケーションによって Web hook 要求が適切に処理されることを確認します。 詳細については、[こちら](../alerts/alerts-log-webhook.md)をご覧ください。

### <a name="i-am-getting--403-forbidden-errors-what-does-this-mean"></a>403 Forbidden エラーが発生しました。これはどういう意味でしょうか。

このエラーは、可用性エージェントがお客様のターゲット URL をテストできるように、お客様の方でファイアウォールの例外を追加する必要があることを示しています。 許可するエージェント IP アドレスの完全な一覧については、[IP の例外に関する記事](./ip-addresses.md#availability-tests)を参照してください。

### <a name="intermittent-test-failure-with-a-protocol-violation-error"></a>プロトコル違反エラーでテストが断続的に失敗します。

エラー ("プロトコル違反..CR の後には LF を指定しなければなりません") は、サーバー (または依存関係) に問題があることを示しています。 これは、応答に形式が正しくないヘッダーが設定されている場合に発生します。 ロード バランサーまたは CDN が原因である可能性があります。 具体的には、行末の指定で CRLF を使用していないヘッダーがあります。これは HTTP 仕様に違反しているため、.NET WebRequest レベルで失敗します。 応答を検査して、違反の可能性のあるヘッダーを見つけます。

> [!NOTE]
> HTTP ヘッダーの緩和された検証を行うブラウザーでは、URL は 失敗しない場合があります。 この問題の詳細については、こちらのブログ記事を参照してください: http://mehdi.me/a-tale-of-debugging-the-linkedin-api-net-and-http-protocol-violations/  

### <a name="i-dont-see-any-related-server-side-telemetry-to-diagnose-test-failures"></a>テストの失敗を診断するためのサーバー側の関連するテレメトリが表示されません。*

サーバー側のアプリケーションに対して Application Insights を設定している場合は、[サンプリング](./sampling.md)操作中のためである可能性があります。 別の可用性の結果を選択します。

### <a name="can-i-call-code-from-my-web-test"></a>Web テストからコードを呼び出すことはできますか。

いいえ。 テストの手順は、.webtest ファイルに含まれている必要があります。 他の Web テストの呼び出しまたはループの使用は許可されていません。 ただし、役に立つさまざまなプラグインがあります。


### <a name="is-there-a-difference-between-web-tests-and-availability-tests"></a>"Web テスト" と "可用性テスト" に違いはありますか。

この 2 つの用語は、同じ意味で参照されることがあります。 可用性テストは、複数ステップから成る Web テストに加えて単一の URL Ping テストも含む、より一般的な用語です。

### <a name="id-like-to-use-availability-tests-on-our-internal-server-that-runs-behind-a-firewall"></a>ファイアウォールの内側で稼働している内部サーバーに対して可用性テストを使用したいと考えています。

   この解決方法には、次の 2 つが挙げられます。

   * [Web テスト エージェントの IP アドレス](./ip-addresses.md)からの受信要求を許可するようにファイアウォールを構成します。
   * 内部サーバーを定期的にテストする独自のコードを作成します。 このコードを、バック グラウンド プロセスとして、ファイアウォールの内側のテスト サーバーで実行します。 テスト プロセスは、コア SDK パッケージ内の [TrackAvailability()](/dotnet/api/microsoft.applicationinsights.telemetryclient.trackavailability) API を使用して、その結果を Application Insights に送信できます。 この方法では、テスト サーバーに Application Insights のインジェスト エンドポイントへの送信アクセスが必要となりますが、受信要求を許可する代替方法と比べて、セキュリティのリスクは大幅に小さくなります。 結果は可用性 Web テストブレードに表示されますが、エクスペリエンスはポータルによって作成されたテストに対して使用できるものより少し簡単になります。 カスタム可用性テストは、分析、検索、およびメトリックにも可用性の結果として表示されます。

### <a name="uploading-a-multi-step-web-test-fails"></a>複数ステップの Web テストのアップロードが失敗します。

これを引き起こす可能性があるいくつかの原因:
   * 300 K のサイズ制限があります。
   * ループはサポートされていません。
   * 他の Web テストへの参照はサポートされていません。
   * データ ソースはサポートされていません。

### <a name="my-multi-step-test-doesnt-complete"></a>複数ステップのテストが完了しません。

1 テストあたりの要求は 100 個に制限されています。 また、実行時間が 2 分を超えると、テストは停止します。

### <a name="how-can-i-run-a-test-with-client-certificates"></a>クライアント証明書でテストを実行するにはどうすればよいですか。

現在これはサポートされていません。

## <a name="next-steps"></a>次のステップ

* [複数ステップ Web テスト](availability-multistep.md)
* [URL の ping テスト](monitor-web-app-availability.md)