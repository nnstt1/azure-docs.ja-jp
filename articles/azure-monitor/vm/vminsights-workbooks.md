---
title: VM Insights のブックを使用して対話型レポートを作成する
description: VM Insights 用の定義済みおよびカスタムのパラメーター化されたブックを使用して、複雑なレポートの作成を簡単にします。
ms.topic: conceptual
author: bwren
ms.author: bwren
ms.date: 03/12/2020
ms.openlocfilehash: a448c5b7ecb69c79c05c28c03593058e4c5ab87a
ms.sourcegitcommit: 5fabdc2ee2eb0bd5b588411f922ec58bc0d45962
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 06/23/2021
ms.locfileid: "112540998"
---
# <a name="create-interactive-reports-vm-insights-with-workbooks"></a>VM Insights のブックを使用して対話型レポートを作成する

ブックでは、テキスト、 [ログ クエリ](/azure/data-explorer/kusto/query/)、メトリック、パラメーターが、内容豊富な対話型レポートに組み合わされます。 ブックは、同じ Azure リソースにアクセスできる他のチーム メンバーが編集できます。

Workbooks は次のようなシナリオで便利です。

* 目的のメトリックが事前にわかっていないときに、仮想マシンの使用状況を調べます。CPU 使用率、ディスク領域、メモリ、ネットワークの依存関係など。他の使用状況分析ツールとは異なり、ブックを使用すると複数の種類の視覚化ツールや分析ツールを結合できるため、この種のフリーフォーム探索に適しています。
* 主要なカウンターと他のログ イベントに関するメトリックを示すことによって、最近プロビジョニングされた VM のパフォーマンスをチームに説明します。
* VM のサイズ変更実験の結果を、チームの他のメンバーと共有します。 実験の目標をテキストで説明した後に、その実験の評価に使用される使用状況メトリックと 分析クエリ、および各メトリックが目標を上回ったかまたは下回ったかどうかを明確に提示します。
* 停止が VM の使用に及ぼす影響を報告し、データ、テキスト説明、および次の手順についての話し合いを組み合わせて将来の停止を防止します。

## <a name="vm-insights-workbooks"></a>VM Insights ブック
VM Insights には、次のブックが含まれます。 これらのブックは、そのまま使用することも、特定の要件に対応するカスタム ブックを作成するための開始点として使用することもできます。

### <a name="single-virtual-machine"></a>1 つの仮想マシン

| Workbooks | 説明 |
|----------|-------------|
| パフォーマンス | 有効になっているすべての Log Analytics パフォーマンス カウンターを利用して、パフォーマンス ビューのカスタマイズ可能なバージョンを提供します。 | 
| 接続 | VM からの受信接続および VM への送信接続に関する詳細なビューを提供します。 | 

### <a name="multiple-virtual-machines"></a>複数の仮想マシン

| Workbooks | 説明 |
|----------|-------------|
| パフォーマンス | 有効になっているすべての Log Analytics パフォーマンス カウンターを利用して、上位 N 位までのリストとグラフ ビューのカスタマイズ可能なバージョンを 1 つのブックで提供します。|
| パフォーマンス カウンター | パフォーマンス カウンターの広範なセットに関する上位 N 位までのグラフ ビューです。 |
| 接続 | 監視対象の VM からの受信接続および VM への送信接続に関する詳細なビューを提供します。 |
| アクティブなポート | 選択された期間における、監視対象の VM のポートにバインドされたプロセスの一覧とそれらのアクティビティを提供します。 |
| ポートを開く | 監視対象の VM で開かれているポートの数と、それらの開かれたポートの詳細を提供します。 |
| 失敗した接続 | 監視対象の VM で失敗した接続の数、失敗の傾向、失敗の割合が時間と共に増えているかどうかが、表示されます。 |
| [Security and Audit] | 全体的な接続、悪意のある接続、IP エンドポイントの世界的な配置に関して報告される TCP/IP トラフィックの分析です。  すべての機能を有効にするには、セキュリティの検出を有効にする必要があります。 |
| TCP トラフィック | 監視対象の VM と、その送信、受信、および合計ネットワーク トラフィックに関するランク付けレポートのグリッド表示とトレンド ライン表示です。 |
| トラフィックの比較 | このブックでは、1 つのマシンまたはマシンのグループのネットワーク トラフィックの傾向を比較できます。 |

## <a name="creating-a-new-workbook"></a>新しいブックを作成する

ブックは、個別に編集可能なグラフ、テーブル、テキスト、入力コントロールで構成される複数のセクションで構成されます。 ブックをより深く理解するため、テンプレートを開いて、カスタム ブックの作成について説明しましょう。 

1. [Azure portal](https://portal.azure.com) にサインインします。

2. **[仮想マシン]** を選択します。

3. 一覧から VM を選択します。

4. [VM] ページの **[監視]** セクションで、 **[Insights]** を選択します。

5. VM 分析情報ページで、 **[パフォーマンス]** または **[マップ]** タブを選択し、ページのリンクから **[View Workbooks]\(ブックの表示\)** を選択します。 ドロップダウン リストの **[ギャラリーに移動]** を選択します。

    ![ブックのドロップダウン リストのスクリーンショット](media/vminsights-workbooks/workbook-dropdown-gallery-01.png)

    作業を開始する際に役立つ多数の作成済みブックが含まれたブック ギャラリーが起動します。

7. **[New]\(新規\)** を選択して、新しいブックを作成します。

    ![ブック ギャラリーのスクリーンショット](media/vminsights-workbooks/workbook-gallery-01.png)

## <a name="editing-workbook-sections"></a>ブックのセクションの編集

ブックには、**編集モード** と **閲覧モード** の 2 つのモードがあります。 新しいブックを最初に起動したときは、**編集モード** でブックが開きます。 このモードでは、他の方法では非表示になるステップやパラメーターも含め、ブックのすべてのコンテンツが表示されます。 **閲覧モード** では、簡素化されたレポート スタイルのビューが表示されます。 閲覧モードでは、レポートの作成時に生じた複雑さを排除できます。変更が必要な場合は、数回クリックするだけで元になるメカニズムを表示できます。

![編集コントロールが強調表示されている編集モードの新しいブックを表示している Azure Monitor の Virtual Machines ブック セクションのスクリーンショット。](media/vminsights-workbooks/workbook-new-workbook-editor-01.png)

1. セクションの編集が完了したら、セクションの左下隅にある **[編集完了]** をクリックします。

2. セクションの複製を作成するには、 **[このセクションの複製]** アイコンをクリックします。 セクションを複製すると、前のイテレーションを失うことなくクエリを繰り返すことができるので便利です。

3. ブックのセクションを移動するには、 **[上へ移動]** アイコンまたは **[下へ移動]** アイコンをクリックします。

4. セクションを完全に削除するには、 **[削除]** アイコンをクリックします。

## <a name="adding-text-and-markdown-sections"></a>テキストと [マークダウン] セクションを追加する

ブックに見出し、説明、およびコメントを追加すると、テーブルやグラフのセットをナレーションに変えるのに役立ちます。 ブックのテキスト セクションは、見出し、ボールド、斜体、箇条書きなどのテキスト形式として、[マークダウン構文](https://daringfireball.net/projects/markdown/)をサポートします。

ブックにテキスト セクションを追加するには、ブックの下部またはセクションの下部にある **[テキストの追加]** ボタンを使用します。

## <a name="adding-query-sections"></a>クエリ セクションを追加する

![ブックのクエリ セクション](media/vminsights-workbooks/005-workbook-query-section.png)

ブックにクエリ セクションを追加するには、ブックの下部またはセクションの下部にある **[クエリの追加]** ボタンを使用します。

クエリ セクションは柔軟性が高く、次のような質問の回答を得るために使用できます。

* ネットワーク トラフィックが増加したのと同じ期間中の CPU 使用率
* 過去 1 か月間の使用可能なディスク領域の傾向
* 過去 2 週間に VM で発生したネットワーク接続エラーの数 

ブックを起動した仮想マシンのコンテキストからのクエリだけに限定されているわけではありません。 複数の仮想マシンや Log Analytics ワークスペースでクエリを実行できます (ただし、これらのリソースへのアクセス許可が必要です)。

他の Log Analytics ワークスペースまたは特定の Application Insights アプリからのデータを含めるには、**ワークスペース** 識別子を使います。 リソース間のクエリの詳細については、[公式のガイダンス](../logs/cross-workspace-query.md)をご覧ください。

### <a name="advanced-analytic-query-settings"></a>分析クエリの詳細設定

各セクションには独自の詳細設定があります。これらの設定には、 **[パラメーターの追加]** ボタンの右側にある設定 ![ブック セクション編集コントロール](media/vminsights-workbooks/006-settings.png) アイコンからアクセスできます。

![Azure Monitor の Virtual Machines ブック セクションの [詳細設定] ダイアログのスクリーンショット。 ダイアログを開くアイコンが強調表示されています。](media/vminsights-workbooks/007-settings-expanded.png)

| 設定 | 説明 |
| ---------------- |:-----|
| ユーザー設定の幅    | 項目を任意のサイズにします。多数の項目を 1 行に収めることができるので、グラフやテーブルを内容豊富な対話型レポートに効果的に整理できます。  |
| 条件付きで表示 | 閲覧モード時にパラメーター値に基づいてステップを非表示にすることを指定します。 |
| パラメーターをエクスポート| グリッドまたはグラフ内で選択した行について、後のステップで値を変更したり、表示したりすることができます。  |
| 編集中でないときにクエリを表示 | 閲覧モードのときでも、グラフまたはテーブルの上にクエリが表示されます。
| 編集中でないときに、[分析で開く] ボタンを表示 | グラフの右隅に青色の Analytics アイコンが追加され、ワンクリックでアクセスできるようになります。|

これらの設定のほとんどは非常に直感的ですが、**パラメーターのエクスポート** を理解するには、この機能を使用しているブックを確認することをお勧めします。

作成済みのブックの 1 つ - **[TCP トラフィック]** は VM からの接続メトリックに関する情報を提供します。

ブックの最初のセクションは、ログ クエリ データに基づいています。 2 番目のセクションもログ クエリ データに基づいていますが、最初のテーブルで行を選択すると、グラフの内容が対話形式で更新されます。

![作成済みブックの TCP トラフィックを示す Azure Monitor の Virtual Machines セクションのスクリーンショット。](media/vminsights-workbooks/008-workbook-tcp-traffic.png)

その動作は、テーブルのログ クエリの詳細設定で、 **[項目が選択されている場合、パラメーターをエクスポートします]** を有効にすることによって可能になります。

![[項目が選択されている場合、パラメーターをエクスポートします] オプションがオンになっている Virtual Machines ブックの [詳細設定] ダイアログのスクリーンショット。](media/vminsights-workbooks/009-settings-export.png)

行を選択すると、2 番目のログ クエリで、エクスポートされた値が使用され、セクションの見出しやグラフで使用される値のセットが作成されます。 行を選択しないと、セクションの見出しとグラフが表示されません。 

たとえば、2 番目のセクションの非表示パラメーターでは、グリッドで選択された行から次の参照が使用されます。

```
VMConnection
| where TimeGenerated {TimeRange}
| where Computer in ("{ComputerName}") or '*' in ("{ComputerName}") 
| summarize Sent = sum(BytesSent), Received = sum(BytesReceived) by bin(TimeGenerated, {TimeRange:grain})
```

## <a name="adding-metrics-sections"></a>メトリック セクションを追加する

メトリック セクションでは、Azure Monitor のメトリック データを対話型レポートに組み込むためのフル アクセスが提供されます。 VM Insights では、通常、作成済みのブックにはメトリック データではなく、分析クエリ データが含まれます。  メトリック データでのブックの作成を選択でき、両方の機能の利点をすべて 1 か所で最大限に活用できます。 また、アクセス可能なサブスクリプションのリソースからメトリック データを取得することもできます。

仮想マシンのデータをブックに取り込んで、CPU のパフォーマンスをグリッドで表示している例を次に示します。

![Azure Monitor の仮想マシン ブックのメトリック セクションのスクリーンショット。 各仮想マシンの CPU パフォーマンスがグラフィカルに表示されています。](media/vminsights-workbooks/010-metrics-grid.png)

## <a name="adding-parameter-sections"></a>パラメーター セクションを追加する

ブックのパラメーターを使用すると、クエリ セクションやテキスト セクションを手動で編集しなくても、ブックの値を変更できます。 これにより、基になる分析クエリ言語を理解する必要がなくなり、ブックベースのレポート作成の潜在的な対象ユーザーが大幅に拡大されます。

パラメーターの値は、``{parameterName}`` のようにパラメーター名を中かっこで囲むことによって、クエリ、テキスト、または他のパラメーター セクションで置き換えられます。 パラメーター名には、JavaScript 識別子と同様の規則が適用され、英文字またはアンダースコアの後に英数字またはアンダースコアが続きます。 たとえば、**a1** は許可されますが、**1a** は許可されません。

パラメーターは線形であり、ブックの先頭から始まり、後のステップへと流れます。  ブックの後の部分で宣言されたパラメーターは、前の部分で宣言されたパラメーターをオーバーライドできます。 これにより、クエリを使用するパラメーターは、前の部分で定義されたパラメーターの値にアクセスすることもできます。 パラメーターのステップ自体の中でも、パラメーターは線形 (左から右) であり、右側のパラメーターはその同じステップで以前に宣言されたパラメーターに依存することができます。
 
現在、次の 4 種類のパラメーターがサポートされています。

| パラメーター | 説明 |
| ---------------- |:-----|
| Text    | ユーザーはテキスト ボックスを編集します。必要に応じて、既定値を入力するためのクエリを提供できます。 |
| ドロップダウン | ユーザーが一連の値から選択できるようにします。 |
| 時間の範囲の選択| ユーザーは、時間の範囲の値の定義済みセットから選択するか、カスタムの時間の範囲から選択することができます。|
| リソースの選択 | ユーザーは、そのブック用に選択されたリソースの中から選択できます。|

### <a name="using-a-text-parameter"></a>テキスト パラメーターを使用する

ユーザーがテキスト ボックスに入力した値は、エスケープしたり、引用符で囲んだりせずに、クエリで直接置き換えられます。 必要な値が文字列の場合、クエリでは **'{parameter}'** のようにパラメーターを引用符で囲む必要があります。

テキスト パラメーターにより、テキスト ボックス内の値を任意の場所で使用できるようになります。 値には、テーブル名、列名、関数名、演算子などを指定できます。テキスト パラメーターには、 **[Get default value from analytics query]\(分析クエリから既定値を取得する\)** という設定があります。この設定を使用すると、ブックの作成者はクエリを使用してそのテキスト ボックスの既定値を設定できます。

ログ クエリから取得した既定値を使用する場合、最初の行の最初の値 (行 0、列 0) だけが既定値として使用されます。 そのため、1 行および 1 列だけを返すようにクエリを制限することをお勧めします。 クエリによって返されるその他のデータは無視されます。 

クエリから返される値は、エスケープしたり引用符で囲んだりせずに直接置き換えられます。 クエリから行が返されない場合、パラメーターの結果は空の文字列になるか (パラメーターが必須でない場合)、未定義になります (パラメーターが必須の場合)。

### <a name="using-a-drop-down"></a>ドロップダウンの使用

ドロップダウン パラメーターを使用すると、1 つまたは複数の値を選択できるドロップダウン コントロールを作成できます。

ドロップダウンはログ クエリまたは JSON によって設定されます。 クエリから 1 つの列が返される場合、その列の値はドロップダウン コントロールの値とラベルの両方になります。 クエリから 2 つの列が返される場合は、最初の列が値になり、2 番目の列がドロップダウンに表示されるラベルになります。 クエリから 3 つの列が返される場合は、3 番目の列を使用して、そのドロップダウンの既定の選択が示されます。 この列には任意の型を指定できますが、最も簡単なのはブール型または数値型を使用することです。この場合、0 が false、1 が true です。

列が文字列型の場合、null/空の文字列は false とみなされ、その他の値は true とみなされます。 単一選択ドロップダウンの場合、値が true である最初の値が既定の選択として使用されます。  複数選択ドロップダウンの場合、値が true であるすべての値が既定の選択セットとして使用されます。 ドロップダウンの項目は、クエリから行が返された順序で表示されます。 

接続の概要レポートに表示されるパラメーターを見てみましょう。 **[方向]** の横の編集記号をクリックします。

![Azure Monitor でのレポート パラメーターの追加と編集のためのセクションのスクリーンショット。 Direction パラメーターの [編集] アイコンが選択されています。](media/vminsights-workbooks/011-workbook-using-dropdown.png)

これにより、 **[パラメーターの編集]** メニュー項目が表示されます。

![[パラメーターの編集] ダイアログのスクリーンショット。 パラメーター名は Direction、パラメーターの型はドロップダウンで、JSON からのデータの取得が選択されています。](media/vminsights-workbooks/012-workbook-edit-parameter.png)

JSON では、コンテンツを含む任意のテーブルを生成することができます。 たとえば、次の JSON では、ドロップダウンの 2 つの値が生成されます。

```
[
    { "value": "inbound", "label": "Inbound"},
    { "value": "outbound", "label": "Outbound"}
]
```

より適切な例として、ドロップダウンを使用したパフォーマンス カウンターのセットからの名前での選択があります。

```
Perf
| summarize by CounterName, ObjectName
| order by ObjectName asc, CounterName asc
| project Counter = pack('counter', CounterName, 'object', ObjectName), CounterName, group = ObjectName
```

このクエリでは、次のような結果が表示されます。

![パフォーマンス カウンター ドロップダウン](media/vminsights-workbooks/013-workbook-edit-parameter-perf-counters.png)

ドロップダウンは、対話型レポートをカスタマイズおよび作成するための非常に強力なツールです。

### <a name="time-range-parameters"></a>時間の範囲のパラメーター

ドロップダウン パラメーターを使用して独自のカスタムの時間の範囲パラメーターを作成できますが、同程度の柔軟性を必要としない場合は、すぐに使用できる時間の範囲パラメーターを使用することもできます。 

時間の範囲パラメーターには、5 分から過去 90 日間まで、15 個の既定の範囲があります。 カスタムの時間の範囲を選択できるオプションもあります。このオプションでは、レポートを操作するユーザーが時間の範囲の明示的な開始値と停止値を選択できます。

### <a name="resource-picker"></a>リソースの選択

リソースの選択パラメーターを使用すると、レポートの範囲を特定の種類のリソースに設定できます。 リソースの選択を活用している作成済みのブックの例として、**パフォーマンス** ブックがあります。

![ワークスペースのドロップダウン](media/vminsights-workbooks/014-workbook-edit-parameter-workspaces.png)

## <a name="saving-and-sharing-workbooks-with-your-team"></a>ブックを保存してチームと共有する

ブックのギャラリーにアクセスする方法に応じて、ブックは Log Analytics ワークスペース内または仮想マシン リソース内に保存されます。 ブックは、ユーザー個人の **[個人用レポート]** セクションか、リソースにアクセスできるユーザーであれば誰でもアクセスできる **[共有レポート]** セクションのいずれかに保存されます。 リソース内のすべてのブックを表示するには、操作バーの **[開く]** ボタンをクリックします。

**[個人用レポート]** にあるブックを共有するには:

1. 操作バーで、 **[開く]** をクリックします。
2. 共有するブックの横にある [...] ボタンをクリックします。
3. **[Move to Shared Reports]\(共有レポートに移動\)** をクリックします。

リンクまたは電子メールでブックを共有するには、操作バーで **[共有]** をクリックします。 リンクの受信者がブックを表示するには、Azure Portal でこのリソースにアクセスできる必要があります。 受信者が編集するには、そのリソースに対する共同作成者以上のアクセス許可が必要です。

ブックへのリンクを Azure Dashboard にピン留めするには:

1. 操作バーで、 **[開く]** をクリックします。
2. ピン留めするブックの横にある [...] ボタンをクリックします。
3. **[ダッシュボードにピン留め]** をクリックします。

## <a name="next-steps"></a>次のステップ

- 制限および全体的な VM のパフォーマンスを識別するには、[Azure VM のパフォーマンスの表示](vminsights-performance.md)に関するページを参照してください。

- 検出されたアプリケーションの依存関係については、[VM Insights のマップの表示](vminsights-maps.md)に関する記事をご覧ください。
