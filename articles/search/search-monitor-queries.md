---
title: クエリを監視する
titleSuffix: Azure Cognitive Search
description: パフォーマンスとスループットに対するクエリ メトリックを監視します。 リソース ログにクエリ文字列の入力を収集して分析します。
manager: nitinme
author: HeidiSteen
ms.author: heidist
ms.service: cognitive-search
ms.topic: conceptual
ms.date: 01/26/2021
ms.openlocfilehash: e3932ee9a0683689bd74fb2d912d98cd29715da6
ms.sourcegitcommit: 677e8acc9a2e8b842e4aef4472599f9264e989e7
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 11/11/2021
ms.locfileid: "132343043"
---
# <a name="monitor-query-requests-in-azure-cognitive-search"></a>Azure Cognitive Search でクエリ要求を監視する

この記事では、メトリックとリソース ログを使用してクエリのパフォーマンスと量を測定する方法について説明します。 また、クエリで使用される入力用語を収集する方法についても説明します。これは、検索コーパスの有用性と有効性を評価する必要がある場合に欠かせない情報です。

Azure portal には、クエリの待ち時間、クエリ負荷 (QPS)、スロットリングに関する基本的なメトリックが表示されます。 これらのメトリックにフィードされる履歴データは、30 日間保存されます。 保有期間を延長する場合、またはオペレーショナル データとクエリ文字列についてレポートする場合は、ログに記録されたイベントとメトリックを保持するためのストレージ オプションを指定する[診断設定](search-monitor-logs.md)を有効にしてください。

データ測定の整合性を最大化する条件には、次のようなものがあります。

+ 課金対象のサービス (Basic または Standard レベルで作成されたサービス) を使用します。 無料のサービスは、複数のサブスクライバーによって共有されます。そのため、負荷の変化に応じて一定量の変動性が生じます。

+ 可能であれば、単一のレプリカとパーティションを使用して、独立した分離された環境を作成します。 複数のレプリカを使用する場合、クエリ メトリックは複数のノード間で平均化されるため、結果の精度が低下する可能性があります。 同様に、複数のパーティションはデータが分割されることを意味し、インデックス作成も進行中の場合、一部のパーティションには異なるデータが含まれている可能性があります。 クエリのパフォーマンスを調整する場合、ノードとパーティションを単一にすることにより、テスト用の環境の安定性が高まります。

> [!Tip]
> 追加のクライアント側コードと Application Insights を使用すると、何がアプリケーション ユーザーの関心を引くかについてより深い分析情報を得るために、クリックスルー データをキャプチャすることもできます。 詳しくは、「[検索トラフィックの分析](search-traffic-analytics.md)」をご覧ください。

## <a name="query-volume-qps"></a>クエリ量 (QPS)

量は、**1 秒あたりの検索クエリ数** (QPS) として測定されます。これは組み込みメトリックであり、1 分という時間枠内で実行されるクエリの平均値、カウント値、最小値、または最大値としてリポートできます。 メトリックの 1 分間隔 (TimeGrain = "PT1M") は、システム内で固定されています。

クエリはミリ秒単位で実行されるのが一般的であるため、秒として測定されるクエリのみがメトリックに表示されます。

| 集計の種類 | 説明 |
|------------------|-------------|
| Average | クエリの実行が行われた、1 分以内の平均秒数。|
| Count | 1 分の間隔内でログに生成されたメトリックの数。 |
| 最大値 | 1 分間に登録された、1 秒あたりの検索クエリの最大数。 |
| 最小値 | 1 分間に登録された、1 秒あたりの検索クエリの最小数。  |
| SUM | 1 分以内に実行されたすべてのクエリの合計。  |

たとえば、1 分間のうち、1 秒は非常に負荷が高く、続く 58 秒は平均的な負荷で、最後の 1 秒はクエリが 1 つだけというパターンがあるとします。この場合、最初の 1 秒の値が SearchQueriesPerSecond の最大値、最後の １ 秒の値が最小値となります。

別の例として、ノードが 100 メトリックを生成し、各メトリックの値が 40 である場合、"カウント" は 100、"合計" は 4,000、"平均" は 40、"最大" は 40 になります。

## <a name="query-performance"></a>クエリ パフォーマンス

サービス全体のクエリ パフォーマンスは、検索の待ち時間 (クエリが完了するまでに要する時間) と、リソースの競合の結果として削除された、スロットルされたクエリ数として測定されます。

### <a name="search-latency"></a>検索の待ち時間

| 集計の種類 | Latency | 
|------------------|---------|
| Average | 平均クエリ期間 (ミリ秒単位)。 | 
| Count | 1 分の間隔内でログに生成されたメトリックの数。 |
| 最大値 | サンプル内で実行時間が最長のクエリ。 | 
| 最小値 | サンプル内で実行時間が最短のクエリ。  | 
| 合計 | 間隔 (1 分) 内に実行される、サンプル内のすべてのクエリの合計実行時間。  |

次の **検索の待機時間** メトリックの例を考えてみます。86 件のクエリがサンプリングされ、平均時間は 23.26 ミリ秒であるとします。 最小値 0 は、一部のクエリが削除されたことを示します。 実行時間の最も長いクエリは、完了までに 1,000 ミリ秒かかりました。 合計実行時間は 2 秒でした。

![待ち時間の集計](./media/search-monitor-usage/metrics-latency.png "待ち時間の集計")

### <a name="throttled-queries"></a>スロットルされたクエリ

スロットルされたクエリとは、処理されずに削除されたクエリのことです。 ほとんどの場合、スロットリングは通常のサービス実行の一部です。  必ずしも、何か問題があることを示しているわけではありません。

スロットリングは、現在処理されている要求の数が、使用可能なリソースを超えると発生します。 レプリカがローテーションから外されたときまたはインデックス作成時に、スロットルされた要求が増加する場合があります。 クエリ要求もインデックス作成要求も、同じリソースのセットによって処理されます。

サービスは、リソース消費量に基づいて、要求を削除するかどうかを決定します。 メモリ、CPU、ディスク IO 全体で消費されるリソースの割合は、一定期間で平均化されます。 この割合がしきい値を超えると、インデックスに対するすべての要求は、要求の量が減少するまでスロットルされます。 

クライアントに応じて、スロットルされた要求は次の方法で示されます。

+ サービスから "You are sending too many requests. 後でもう一度やり直してください。" というエラー メッセージが表示されることがあります。 
+ サービスから、現在サービスが利用できないことを示す 503 エラー コードが返されます。 
+ ポータル (Search エクスプローラーなど) を使用している場合、クエリは通知なしで削除されるため、再度 [検索] をクリックする必要があります。

スロットルされたクエリを確認するには、**スロットルされた検索クエリ** メトリックを使用します。 この記事で説明されているように、メトリックをポータルで調べるか、アラート メトリックを作成することができます。 サンプリング間隔内で削除されたクエリについては、"*合計*" を使用して、実行されなかったクエリの割合を取得します。

| 集計の種類 | Throttling |
|------------------|-----------|
| Average | 間隔内で削除されたクエリの割合。 |
| Count | 1 分の間隔内でログに生成されたメトリックの数。 |
| 最大値 | 間隔内で削除されたクエリの割合。|
| 最小値 | 間隔内で削除されたクエリの割合。 |
| 合計 | 間隔内で削除されたクエリの割合。 |

**Throttled Search Queries Percentage** の場合は、最小値、最大値、平均値、および合計値はすべて同じ値になります。これは、スロットルされた検索クエリの割合であり、1 分間の検索クエリの合計数に基づきます。

次のスクリーンショットでは、最初の数はカウント (つまり、ログに送信されるメトリックの数) です。 上部、またはメトリックにカーソルを合わせたときに表示されるその他の集計には、平均、最大、および合計が含まれます。 このサンプルでは、​​要求は削除されませんでした。

![スロットルの集計](./media/search-monitor-usage/metrics-throttle.png "スロットルの集計")

## <a name="explore-metrics-in-the-portal"></a>ポータルでメトリックについて調べる

現在の数値を簡単に確認できるように、サービスの [概要] ページの **[監視]** タブには、3 つのメトリック (**検索の待ち時間**、**秒あたりの検索クエリ数 (検索ユニットごと)** 、**スロットルされた検索クエリの割合**) が表示されます。これらは、一定の間隔で時間、日、および週単位で測定されるほか、集計の種類を変更するオプションが用意されています。

さらに詳しく調べるには、 **[監視]** メニューからメトリックス エクスプローラーを開き、データを階層化、拡大、および視覚化して、傾向や異常を確認します。 メトリックス エクスプローラーの詳細を確認するには、この[メトリックのグラフの作成に関するチュートリアル](../azure-monitor/essentials/tutorial-metrics.md)を完了してください。

1. [監視] セクションの下で、 **[メトリックス]** を選択し、スコープがお使いの検索サービスに設定されているメトリックス エクスプローラーを開きます。

2. [メトリック] でドロップダウン リストからいずれかを選択し、選択した種類で使用可能な集計の一覧を確認します。 この集計では、収集された値を期間ごとにどのようにサンプリングするかを定義します。

   ![QPS メトリックのメトリックス エクスプローラー](./media/search-monitor-usage/metrics-explorer-qps.png "QPS メトリックのメトリックス エクスプローラー")

3. 右上隅で、期間を設定します。

4. 視覚化方法を選択します。 既定では折れ線グラフになっています。

5. 集計を追加して階層化するには、 **[メトリックの追加]** を選択し、異なる集計を選択します。

6. 折れ線グラフ上で、関心領域を拡大します。 領域の先頭にマウス ポインターを置き、マウスの左ボタンを押したまま領域のもう一方の側にドラッグしてボタンを離します。 その時間範囲のグラフが拡大されます。

## <a name="return-query-strings-entered-by-users"></a>ユーザーによって入力されたクエリ文字列を返す

リソース ログを有効にすると、システムによってクエリ要求が **AzureDiagnostics** テーブルにキャプチャされます。 前提条件として、Log Analytics ワークスペースまたは別のストレージ オプションを指定して既に[リソース ログ](search-monitor-logs.md)を有効にしていることが必要です。

1. [監視] セクションで **[ログ]** を選択し、Log Analytics で空のクエリ ウィンドウを開きます。

1. 次の式を実行して、Query.Search 操作を検索します。操作名、クエリ文字列、クエリ対象のインデックス、および検出されたドキュメントの数で構成される表形式の結果セットが返されます。 最後の 2 つのステートメントは、サンプル インデックス全体から、空または未指定の検索から成るクエリ文字列を除外し、結果に含まれるノイズを削減します。

   ```kusto
      AzureDiagnostics
   | project OperationName, Query_s, IndexName_s, Documents_d
   | where OperationName == "Query.Search"
   | where Query_s != "?api-version=2020-06-30&search=*"
   | where IndexName_s != "realestate-us-sample-index"
   ```

1. 必要に応じて、*Query_s* に列フィルターを設定して、特定の構文または文字列を検索します。 たとえば、`?api-version=2020-06-30&search=*&%24filter=HotelName` "*に等しい*" というフィルターを設定することができます。

   ![ログ記録されたクエリ文字列](./media/search-monitor-usage/log-query-strings.png "ログ記録されたクエリ文字列")

この手法はその場限りの調査に有用ですが、レポートを作成すると、分析しやすいレイアウトでクエリ文字列を統合して表示できます。

## <a name="identify-long-running-queries"></a>実行時間の長いクエリを特定する

実行時間列を追加して、メトリックとして取得されたクエリだけでなく、すべてのクエリの数値を取得します。 このデータを並べ替えると、どのクエリが完了までに最も時間がかかるかがわかります。

1. [監視] セクションで **[ログ]** を選択して、ログ情報に対してクエリを実行します。

1. 次の基本的なクエリを実行すると、ミリ秒単位の実行時間で並べ替えられたクエリが返されます。 実行時間が最も長いクエリは一番上にあります。

   ```Kusto
   AzureDiagnostics
   | project OperationName, resultSignature_d, DurationMs, Query_s, Documents_d, IndexName_s
   | where OperationName == "Query.Search"
   | sort by DurationMs
   ```

   ![実行時間でクエリを並べ替える](./media/search-monitor-usage/azurediagnostics-table-sortby-duration.png "実行時間でクエリを並べ替える")

## <a name="create-a-metric-alert"></a>メトリック アラートの作成

メトリック アラートでは、ユーザーに通知を送信するか事前に定義した是正措置をトリガーするしきい値を設定します。 

検索サービスの場合、検索の待ち時間とスロットルされたクエリに関するメトリック アラートを作成するのが一般的です。 クエリがいつ削除されるかがわかっている場合は、負荷を軽減したり容量を増やしたりする対処方法を探すことができます。 たとえば、スロットルされたクエリがインデックスの作成中に増加する場合は、クエリ アクティビティが減少するまでインデックス作成を延期できます。

特定のレプリカとパーティションの構成の制限に達しそうな場合は、クエリの量のしきい値 (QPS) のアラートを設定することも役立ちます。

1. [監視] セクションの **[アラート]** を選択し、 **[+ 新しいアラート ルール]** をクリックします。 お使いの検索サービスがリソースとして選択されていることを確認します。

1. [条件] で、 **[追加]** をクリックします。

1. シグナル ロジックを構成します。 シグナルの種類として **[メトリック]** を選択した後、シグナルを選択します。

1. シグナルを選択した後、グラフを使用して履歴データを視覚化し、条件の設定を進める方法に関して、情報に基づいた決定を行うことができます。

1. 次に、[アラート ロジック] まで下へスクロールします。 概念実証の場合、テスト目的で人為的に低い値を指定できます。

   ![アラート ロジック](./media/search-monitor-usage/alert-logic-qps.png "アラート ロジック")

1. 次に、アクション グループを指定するか作成します。 これは、しきい値に達したときに呼び出される応答です。 これには、プッシュ通知または自動応答を指定できます。

1. 最後に、アラートの詳細を指定します。 アラートに名前と説明を指定し、重要度の値を割り当てて、ルールを有効な状態と無効の状態のどちらで作成するかを指定します。

   ![アラートの詳細](./media/search-monitor-usage/alert-details.png "[アラートの詳細]")

メール通知を指定した場合、"Microsoft Azure" から、"Azure: Activated Severity: 3 `<your rule name>`" という件名のメールを受信します。

## <a name="next-steps"></a>次のステップ

まだ行っていない場合は、検索サービスの監視の基礎を確認し、すべての監視機能について理解してください。

> [!div class="nextstepaction"]
> [Azure Cognitive Search の操作とアクティビティを監視する](search-monitor-usage.md)