---
title: Azure Site Recovery で暗号化された Azure VM のレプリケーションを有効にする
description: この記事では、Site Recovery を使用して、カスタマー マネージド キー (CMK) 対応ディスクを含む VM のある Azure リージョンから別の Azure リージョンへのレプリケーションを構成する方法について説明します。
author: mayurigupta13
manager: rochakm
ms.service: site-recovery
ms.topic: article
ms.date: 07/25/2021
ms.author: mayg
ms.openlocfilehash: 7a0e7696cb631bee8b114cf2277a277b9c81cbd1
ms.sourcegitcommit: 0046757af1da267fc2f0e88617c633524883795f
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 08/13/2021
ms.locfileid: "121732500"
---
# <a name="replicate-machines-with-customer-managed-keys-cmk-enabled-disks"></a>カスタマー マネージド キー (CMK) 対応ディスクを含むコンピューターをレプリケートする

この記事では、カスタマー マネージド キー (CMK) 対応マネージド ディスクを含む Azure VM をある Azure リージョンから別の Azure リージョンにレプリケートする方法について説明します。

## <a name="prerequisite"></a>前提条件
CMK 対応マネージド ディスクを含む仮想マシンのレプリケーションを有効にする前に、ターゲット サブスクリプションのターゲット リージョン内にディスク暗号化セットを作成する必要があります。

## <a name="enable-replication"></a>レプリケーションを有効にする

この例では、プライマリ Azure リージョンが東アジア、セカンダリ リージョンが東南アジアです。

1. コンテナー内で、 **[+Replicate]\(+レプリケート\)** を選択します。
2. 次のフィールドに注意してください。
    - **ソース**:VM の起点。この例では **Azure** です。
    - **ソースの場所**:仮想マシンを保護する Azure リージョン。 この例では、ソースの場所は "東アジア" です。
    - **デプロイ モデル**:ソース マシンの Azure デプロイ モデル。
    - **ソース サブスクリプション**:ソース仮想マシンが属しているサブスクリプション。 これは、Recovery Services コンテナーと同じ Azure Active Directory テナント内のどのサブスクリプションでもかまいません。
    - **リソース グループ**:ソース仮想マシンが属しているリソース グループ。 選択したリソース グループ内のすべての VM が、次の手順で保護対象として表示されます。

3. **[仮想マシン]**  >  **[仮想マシンの選択]** で、レプリケートする各 VM を選択します。 選択できるのは、レプリケーションを有効にできるマシンのみです。 **[OK]** をクリックします。

4. **[設定]** では、次のターゲット サイトの設定を構成できます。

    - **ターゲットの場所**: ソース仮想マシンのデータがレプリケートされる場所。 Recovery Services コンテナーと同じ場所にすることをお勧めします。
    - **ターゲット サブスクリプション**:ディザスター リカバリーに使用されるターゲット サブスクリプション。 既定では、ターゲット サブスクリプションはソース サブスクリプションと同じです。
    - **ターゲット リソース グループ**:レプリケートされたすべての仮想マシンが属するリソース グループ。 既定では、Site Recovery により、ターゲット リージョン内に新しいリソース グループが作成されます。 名前のサフィックスは `asr` になります。 Azure Site Recovery によって作成されたリソース グループが既に存在する場合は、そのグループが再利用されます。 次のセクションで示すように、それをカスタマイズすることもできます。 ターゲット リソース グループの場所は、ソース仮想マシンがホストされているリージョンを除き、どの Azure リージョンでもかまいません。
    - **ターゲット仮想ネットワーク**:既定では、Site Recovery により、ターゲット リージョン内に新しい仮想ネットワークが作成されます。 名前のサフィックスは `asr` になります。 これはソース ネットワークにマップされ、今後の保護で使用されます。 ネットワーク マッピングの詳細については、[こちら](./azure-to-azure-network-mapping.md)を参照してください。
    - **ターゲット ストレージ アカウント (ソース VM でマネージド ディスクが使用されていない場合)** :既定では、Site Recovery によって、ソース VM ストレージと同じ構成で新しいターゲット ストレージ アカウントが作成されます。 ストレージ アカウントが既に存在する場合は、再利用されます。
    - **レプリカ マネージド ディスク (ソース VM でマネージド ディスクが使用されている場合)** :Site Recovery によってターゲット リージョン内に新しいレプリカ マネージド ディスクが作成され、ソース VM のマネージド ディスクと同じストレージ タイプ (Standard または Premium) のソース VM のマネージド ディスクがミラーリングされます。
    - **ストレージ アカウントのキャッシュ**:Site Recovery では、"*キャッシュ ストレージ*" と呼ばれる追加のストレージ アカウントがソース リージョンに必要です。 ソース VM 上の変更はすべて追跡され、キャッシュ ストレージ アカウントに送信されます。 次に、これらは、ターゲットの場所にレプリケートされます。
    - **可用性セット**:既定では、Site Recovery により、ターゲット リージョン内に新しい可用性セットが作成されます。 名前のサフィックスは `asr` になります。 Site Recovery によって作成された可用性セットが既に存在する場合は、それが再利用されます。
    - **ディスク暗号化セット (DES)** : Site Recovery では、レプリカ マネージド ディスクやターゲット マネージド ディスクにディスク暗号化セットを使用する必要があります。 レプリケーションを有効にする前に、ターゲット サブスクリプションとターゲット リージョン内に DES を事前に作成しておく必要があります。 既定では、DES は選択されません。 ソース ディスクごとに DES を選択するには、[カスタマイズ] をクリックする必要があります。
    - **レプリケーション ポリシー**:復旧ポイントのリテンション履歴と、アプリ整合性スナップショットの頻度の設定を定義します。 既定では、新しいレプリケーション ポリシーが、既定の設定で Site Recovery によって作成されます。つまり、このポリシーの復旧ポイントのリテンション期間は "*24 時間*" に、アプリ整合性スナップショットの頻度は "*60 分*" に設定されます。

    ![CMK 対応ディスクを含むコンピューターのレプリケーションを有効にする](./media/azure-to-azure-how-to-enable-replication-cmk-disks/cmk-enable-dr.png)

## <a name="customize-target-resources"></a>ターゲット リソースのカスタマイズ

Site Recovery の既定のターゲット設定を変更するには、次の手順に従います。

1. [ターゲット サブスクリプション] の横にある **[カスタマイズ]** を選択して、既定のターゲット サブスクリプションを変更します。 Azure AD テナント内で使用可能なサブスクリプションの一覧からサブスクリプションを選択します。

2. [リソース グループ、ネットワーク、ストレージ、可用性セット] の横にある **[カスタマイズ]** を選択して、次の既定の設定を変更します。
    - **[ターゲット リソース グループ]** では、サブスクリプションのターゲットの場所にあるリソース グループの一覧から、リソース グループを選択します。
    - **[ターゲット仮想ネットワーク]** では、ターゲットの場所にある仮想ネットワークの一覧から、ネットワークを選択します。
    - **[可用性セット]** では、可用性セットの設定を VM に追加できます (それら可用性セットがソース リージョン内の可用性セットの一部である場合)。
    - **[ターゲット ストレージ アカウント]** では、使用するアカウントを選択します。

3. カスタマー マネージド キー (CMK) 対応ソース マネージド ディスクごとにターゲット DES を選択するには、[ストレージ暗号化の設定] の横にある **[カスタマイズ]** を選択します。 選択の時点で、その DES がどのターゲット キー コンテナーに関連付けられているかも確認できます。

4. **[Create target resource]\(ターゲット リソースを作成する\)**  >  **[レプリケーションを有効にする]** の順に選択します。
5. VM のレプリケーションが有効になったら、 **[レプリケートされたアイテム]** で VM の正常性の状態を確認できます。

![VM の正常性状態を確認する場所を示すスクリーンショット。](./media/azure-to-azure-how-to-enable-replication-cmk-disks/cmk-customize-target-disk-properties.png)

>[!NOTE]
>初期レプリケーションの間は、状態の更新に少し時間がかかり、処理が進行していないように見える場合があります。 **[更新]** をクリックすると、最新の状態を確認できます。

## <a name="faqs"></a>FAQ

* 既存のレプリケートされたアイテムで CMK を有効にしました。CMK がターゲット リージョンにも適用されるようにするにはどうすればよいですか?

    (Azure Site Recovery によってターゲット リージョン内に作成された) レプリカ マネージド ディスクの名前を見つけ、このレプリカ ディスクに DES をアタッチすることができます。 ただし、アタッチすると、[ディスク] ブレードで DES の詳細を確認することはできなくなります。 あるいは、VM のレプリケーションを無効にしてから、再度有効にすることも選択できます。 これにより、レプリケートされたアイテムの [ディスク] ブレードで DES とキー コンテナーの詳細を確認できるようになります。

* レプリケートされたアイテムに新しい CMK 対応ディスクを追加しました。 Azure Site Recovery でこのディスクをレプリケートするにはどうすればよいですか?

    既存のレプリケートされたアイテムへの新しい CMK 対応ディスクの追加はサポートされていません。 レプリケーションを無効にし、仮想マシンのレプリケーションを再度有効にしてください。

* プラットフォーム キーとカスタマー マネージド キーの両方を有効にした場合、どのようにしてディスクを保護できますか?

    Site Recovery では、プラットフォーム キーとカスタマー マネージド キーの両方を使用した二重暗号化の有効化がサポートされています。 コンピューターを保護するには、この記事の手順に従ってください。 二重暗号化を有効にした DES を、ターゲット リージョンに事前に作成しておく必要があります。 このような VM のレプリケーションを有効にするときに、この DES を Site Recovery に渡すことができます。
