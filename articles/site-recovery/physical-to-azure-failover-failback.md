---
title: Site Recovery を使用して物理サーバーのフェールオーバーとフェールバックを設定する
description: Azure Site Recovery を使用して、ディザスター リカバリーのために物理サーバーを Azure へフェールオーバーする方法と、オンプレミスにフェールバックする方法について説明します
services: site-recovery
ms.service: site-recovery
ms.topic: article
ms.date: 12/17/2019
ms.openlocfilehash: 607e7e679d378992bcb25785d2a5fd6c1045a08e
ms.sourcegitcommit: 0046757af1da267fc2f0e88617c633524883795f
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 08/13/2021
ms.locfileid: "121739029"
---
# <a name="fail-over-and-fail-back-physical-servers-replicated-to-azure"></a>Azure にレプリケートされた物理サーバーのフェールオーバーとフェールバック

このチュートリアルでは、[Azure Site Recovery](site-recovery-overview.md) を使用して Azure にレプリケートしているオンプレミスの物理サーバーをフェールオーバーする方法について説明します。 フェールオーバーした後、オンプレミス サイトが使用可能になったら Azure からそのサイトにフェールバックします。

## <a name="before-you-start"></a>開始する前に

- ディザスター リカバリーのフェールオーバー プロセスについて[学習](failover-failback-overview.md)してください。
- 複数のマシンをフェールオーバーする場合は、復旧計画でマシンをまとめる方法について[学習](recovery-plan-overview.md)します。
- 完全なフェールオーバーを実行する前に、[ディザスター リカバリーのテスト](site-recovery-test-failover-to-azure.md)を実行して、すべてが想定どおりに機能することを確認してください。
- [この手順](site-recovery-failover.md#prepare-to-connect-after-failover)に従って、フェールオーバーの後の Azure VM への接続を準備します。



## <a name="run-a-failover"></a>フェールオーバーの実行

### <a name="verify-server-properties"></a>サーバーのプロパティを確認する

サーバーのプロパティで、サーバーが Azure VMの [Azure の要件](vmware-physical-azure-support-matrix.md#replicated-machines)に準拠していることを確認します。

1. **[保護されたアイテム]** で、 **[レプリケートされたアイテム]** をクリックし、マシンを選びます。
2. **[レプリケートされたアイテム]** ウィンドウには、マシンの情報、正常性状態、および最新の使用可能な復旧ポイントの概要が表示されます。 **[プロパティ]** をクリックすると、詳細が表示されます。
3. **[コンピューティングとネットワーク]** で、Azure 名、リソース グループ、ターゲット サイズ、[可用性セット](../virtual-machines/windows/tutorial-availability-sets.md)、およびマネージド ディスクの設定を変更できます
4. ネットワーク設定 (フェールオーバー後に Azure VM が配置されるネットワークやサブネット、割り当てられる IP アドレスなど) を表示および変更できます。
5. **[ディスク]** で、マシンのオペレーティング システム ディスクとデータ ディスクに関する情報を確認できます。

### <a name="fail-over-to-azure"></a>Azure にフェールオーバーする

1. **[設定]**  >  **[レプリケートされたアイテム]** で、[マシン] > **[フェールオーバー]** をクリックします。
2. **[フェールオーバー]** で、フェールオーバーする **[復旧ポイント]** を選択します。 次のいずれかのオプションを使うことができます。
   - **Latest**:最初に、Site Recovery に送信されるすべてのデータを処理します。 フェールオーバー後に作成された Azure VM は、フェールオーバーがトリガーされた時点で Site Recovery にレプリケートされたすべてのデータを保持しているため、RPO (目標復旧時点) を最も低くすることができます。
   - **最後に処理があった時点**:Site Recovery によって処理された最新の復旧ポイントに マシンをフェールオーバーします。 このオプションを使用すると、未処理のデータの処理に時間がかからないため、RTO (目標復旧時間) を低くできます。
   - **最新のアプリ整合性**:Site Recovery によって処理されたアプリ整合性の最新の復旧ポイントにマシンをフェールオーバーします。
   - **Custom**:復旧ポイントを指定します。

3. Site Recovery でフェールオーバーをトリガーする前にそのソース マシンをシャットダウンする場合は、 **[フェールオーバーを開始する前にマシンをシャットダウンします]** を選択します。 仮にシャットダウンが失敗したとしても、フェールオーバーは続行されます。 フェールオーバーの進行状況は **[ジョブ]** ページで確認できます。
4. Azure VM に接続する準備が完了したら、フェールオーバー後に接続して確認します。
5. 確認が完了したら、フェールオーバーを **コミット** します。 これにより、利用可能なすべての復旧ポイントが削除されます。

> [!WARNING]
> 進行中のフェールオーバーを取り消さないでください。 フェールオーバーが開始する前にマシンのレプリケーションが停止します。 フェールオーバーを取り消すと、フェールオーバーは停止しますが、マシンが再びレプリケートしなくなります。
> 物理サーバーの場合、追加のフェールオーバー処理が完了するまでに 8 分から 10 分程度かかります。

## <a name="automate-actions-during-failover"></a>フェールオーバー中のアクションを自動化する

フェールオーバー中のアクションを自動化することができます。 これを行うために、復旧計画でスクリプトや Azure Automation Runbook を使用できます。

- スクリプトの追加など、復旧計画の作成とカスタマイズについて[学習](site-recovery-create-recovery-plans.md)してください。
- 復旧計画への Azure Automation Runbook の追加について[学習](site-recovery-runbook-automation.md)してください。

## <a name="configure-settings-after-failover"></a>フェールオーバーの後に設定を構成する

フェールオーバーの後、レプリケートされた Azure VM に接続するように [Azure の設定を構成](site-recovery-failover.md#prepare-in-azure-to-connect-after-failover)する必要があります。 さらに、[内部およびパブリック](site-recovery-failover.md#set-up-ip-addressing) IP アドレス指定を設定します。

## <a name="prepare-for-reprotection-and-failback"></a>再保護とフェールバックを準備する

Azure にフェールオーバーした後、Azure VM をオンプレミス サイトにレプリケートすることによって再保護します。 その後、レプリケーションが完了したら、Azure からオンプレミス サイトへのフェールオーバーを実行することによってオンプレミスにフェールバックできます。

1. Site Recovery を使用して Azure にレプリケートされた物理サーバーは、VMware VM としてしかフェールバックできません。 フェールバックするには VMware インフラストラクチャが必要です。 [この記事](vmware-azure-prepare-failback.md)の手順に従って、再保護とフェールバックを準備します。これには、Azure のプロセス サーバーおよびオンプレミスのマスター ターゲット サーバーのセットアップや、フェールバックのためのサイト間 VPN または ExpressRoute プライベート ピアリングの構成が含まれます。
2. オンプレミスの構成サーバーが実行され、Azure に接続されていることを確認してください。 Azure へのフェールオーバー中は、オンプレミス サイトにアクセスできない可能性があるため、構成サーバーは使用できないか、またはシャットダウンされることがあります。 フェールバック時は、VM が構成サーバー データベースに存在している必要があります。 それ以外の場合、フェールバックは失敗します。
3. オンプレミスのマスター ターゲット サーバー上のスナップショットをすべて削除してください。 スナップショットが存在すると、再保護は機能しません。  VM 上のスナップショットは、再保護ジョブ中に自動的にマージされます。
4. マルチ VM 整合性のためにレプリケーション グループに収集された VM を再保護している場合は、それらがすべて同じオペレーティング システム (Windows または Linux) を使用していること、およびデプロイするマスター ターゲット サーバーが同じ種類のオペレーティング システムを使用していることを確認してください。 レプリケーション グループ内の VM では、すべて同じマスター ターゲット サーバーを使用する必要があります。
5. フェールバックのために[必要なポート](vmware-azure-prepare-failback.md#ports-for-reprotectionfailback)を開きます。
6. フェールバックの前に、vCenter Server が接続されていることを確認してください。 接続されていない場合、ディスクの切断と仮想マシンへの再接続は失敗します。
7. vCenter サーバーによってフェールバック先の VM が管理されている場合は、必要なアクセス許可があることを確認してください。 読み取り専用ユーザー vCenter の検出を実行し、仮想マシンを保護すると、適切に保護され、フェールオーバーが機能します。 ただし、再保護中は、データストアを検出できず、データストアは一覧表示されないため、フェールオーバーは失敗します。 この問題を解決するには、[適切なアカウント/アクセス許可](vmware-azure-tutorial-prepare-on-premises.md#prepare-an-account-for-automatic-discovery)を使用して vCenter 資格情報を更新してから、ジョブを再試行できます。 
8. テンプレートを使用して仮想マシンを作成した場合は、各 VM のディスクに独自の UUID が割り当てられていることを確認してください。 オンプレミス VM の UUID とマスター ターゲット サーバーの UUID が、どちらも同じテンプレートから作成されたために衝突している場合、再保護は失敗します。 異なるテンプレートからデプロイしてください。
9. 別の vCenter サーバーにフェールバックする場合は、新しい vCenter サーバーとマスター ターゲット サーバーが検出されることを確認してください。 通常は、これらがデータストアではないか、アクセスできないか、または **[再保護]** に表示されない場合です。
10. フェールバックできない次のシナリオを確認してください。
    - ESXi 5.5 無料エディションまたは vSphere 6 Hypervisor 無料エディションのどちらかを使用している場合。 別のバージョンにアップグレードしてください。
    - Windows Server 2008 R2 SP1 物理サーバーを使用している場合。
    - 移行されている VM。
    - 別のリソース グループに移動されている VM。
    - 削除されているレプリカ Azure VM。
    - 保護されていない (オンプレミス サイトにレプリケートされている) レプリカ Azure VM。
10. 使用できる[フェールバックの種類 (元の場所への復旧と別の場所への復旧)](concepts-types-of-failback.md) を確認してください。


## <a name="reprotect-azure-vms-to-an-alternate-location"></a>Azure VM を別の場所に再保護する

この手順では、オンプレミス VM が使用できないことを想定しています。

1. コンテナーの **[設定]**  >  **[レプリケートされたアイテム]** で、フェールオーバーされたコンピューターを右クリックし、 **[再保護]** をクリックします。
2. **[再保護]** で、 **[Azure からオンプレミスへ]** が選択されていることを確認します。
3. オンプレミス マスター ターゲット サーバーとプロセス サーバーを指定します。
4. **[データストア]** で、オンプレミスのディスクの復旧先のデータストアを選択します。
       - このオプションは、オンプレミス VM が削除されたか、または存在せず、新しいディスクを作成する必要がある場合に使用します。
       - ディスクが既に存在する場合、この設定は無視されますが、値は指定する必要があります。
5. マスター ターゲットのリテンション ドライブを選択します。 フェールバック ポリシーは自動的に選択されます。
6. **[OK]** をクリックして再保護を開始します。 Azure VM をオンプレミス サイトにレプリケートするジョブが開始されます。 進行状況は **[ジョブ]** タブで追跡できます。

> [!NOTE]
> Azure VM を既存のオンプレミスの VM に復旧する場合、マスター ターゲット サーバーの ESXi ホスト上で、読み取り/書き込みアクセス権のあるオンプレミスの仮想マシンのデータストアをマウントします。


## <a name="fail-back-from-azure"></a>Azure からのフェールバック

次のようにフェールオーバーを実行します。

1. **[レプリケートされたアイテム]** ページでマシンを右クリックし、 **[計画されていないフェールオーバー]** をクリックします。
2. **[フェールオーバーの確認]** で、フェールオーバーの方向が Azure からであることを確認します。
3. フェールオーバーに使用する復旧ポイントを選択します。
    - **[最新]** 復旧ポイントを使用することをお勧めします。 アプリケーション整合性ポイントは最新の時点より古いため、一部のデータが失われます。
    - **[最新]** はクラッシュ整合性復旧ポイントです。
    - フェールオーバーが実行されると、Site Recovery は Azure VM をシャットダウンし、オンプレミスの VM を起動します。 ある程度のダウンタイムが発生するため、適切な時刻に実行してください。
4. マシンを右クリックし、 **[コミット]** をクリックします。 Azure VM を削除するジョブがトリガーされます。
5. 予想どおりに Azure VM がシャットダウンされたことを確認します。


## <a name="reprotect-on-premises-machines-to-azure"></a>オンプレミスのマシンを Azure で再保護する

データはオンプレミス サイトに戻りましたが、Azure へのレプリケートは実行されていません。 Azure へのレプリケートを再開するには、次の手順を実行します。

1. コンテナーの **[設定]** > **[レプリケートされたアイテム]** で、フェールバックされた VM を選択し、 **[再保護]** をクリックします。
2. レプリケートされたデータを Azure に送信するために使用するプロセス サーバーを選択し、 **[OK]** をクリックします。


## <a name="next-steps"></a>次のステップ

再保護ジョブが完了すると、オンプレミス VM が Azure にレプリケートされます。 必要に応じて、Azure への[別のフェールオーバーを実行](site-recovery-failover.md)できます。
