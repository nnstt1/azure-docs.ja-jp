---
title: Azure Site Recovery における Azure から Azure へのディザスター リカバリー アーキテクチャ
description: Azure Site Recovery サービスを使用して、Azure リージョン間に Azure VM のディザスター リカバリーを設定するときに使用されるアーキテクチャの概要。
services: site-recovery
ms.service: site-recovery
ms.topic: conceptual
ms.date: 3/13/2020
ms.openlocfilehash: a59760378eef7412a963f661e80debc6a7af56d5
ms.sourcegitcommit: 0fd913b67ba3535b5085ba38831badc5a9e3b48f
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 07/07/2021
ms.locfileid: "113486555"
---
# <a name="azure-to-azure-disaster-recovery-architecture"></a>Azure から Azure へのディザスター リカバリー アーキテクチャ


この記事では、[Azure Site Recovery](site-recovery-overview.md) サービスを使用して Azure 仮想マシン (VM) のためのディザスター リカバリーをデプロイするときに使用されるアーキテクチャ、コンポーネント、プロセスについて説明します。 ディザスター リカバリーが設定されていると、Azure VM によって別のターゲット リージョンへのレプリケートが継続的に行われます。 障害が発生した場合は、セカンダリ リージョンに VM をフェールオーバーし、そこからそれらにアクセスできます。 すべてが再び正常に動作するようになったら、フェールバックして、プライマリの場所で作業を続行できます。



## <a name="architectural-components"></a>アーキテクチャ コンポーネント

Azure VM のディザスター リカバリーに関連するコンポーネントを次の表にまとめます。

**コンポーネント** | **必要条件**
--- | ---
**ソース リージョンの VM** | [サポートされているソース リージョン](azure-to-azure-support-matrix.md#region-support)内の 1 つ以上の Azure VM。<br/><br/> VM は、[サポートされているオペレーティング システム](azure-to-azure-support-matrix.md#replicated-machine-operating-systems)のうちのどれを実行していてもかまいません。
**ソース VM ストレージ** | Azure VM では、マネージド ディスクでも、複数のストレージ アカウントに分散するアンマネージド ディスクでも使用できます。<br/><br/>サポートされる Azure ストレージについては[こちらをご覧ください](azure-to-azure-support-matrix.md#replicated-machines---storage)。
**ソース VM ネットワーク** | VM は、ソース リージョンの仮想ネットワーク (VNet) 内の 1 つまたは複数のサブネット内に存在できます。 ネットワークの要件については[こちらをご覧ください](azure-to-azure-support-matrix.md#replicated-machines---networking)。
**キャッシュ ストレージ アカウント** | ソース ネットワークにはキャッシュ ストレージ アカウントが必要です。 レプリケーション中に、VM の変更は、ターゲット ストレージに送信される前に、キャッシュに格納されます。  キャッシュ ストレージ アカウントは Standard である必要があります。<br/><br/> キャッシュを使用することにより、VM で実行されている運用アプリケーションへの影響を最小限に抑えられます。<br/><br/> キャッシュ ストレージの要件について詳しくは、[こちらをご覧ください](azure-to-azure-support-matrix.md#cache-storage)。 
**ターゲット リソース** | ターゲット リソースは、レプリケーション中およびフェールオーバーの発生時に使用されます。 ターゲット リソースは、Site Recovery によって既定で設定することも、作成/カスタマイズすることもできます。<br/><br/> ターゲット リージョンでは、VM を作成できること、および必要な VM サイズをサポートするのに十分なリソースがサブスクリプションにあることを確認します。 

![ソースとターゲットのレプリケーションを示す図。](./media/concepts-azure-to-azure-architecture/enable-replication-step-1-v2.png)

## <a name="target-resources"></a>ターゲット リソース

VM のレプリケーションを有効にすると、Site Recovery でターゲット リソースを自動的に作成できます。 

**ターゲット リソース** | **既定の設定**
--- | ---
**ターゲット サブスクリプション** | ソース サブスクリプションと同じです。
**ターゲット リソース グループ** | フェールオーバー後に VM が所属するリソース グループです。<br/><br/> ソース リージョンを除く任意の Azure リージョンに作成できます。<br/><br/> Site Recovery では "asr" というサフィックスを持つターゲット リージョンに、新しいリソース グループが作成されます。<br/><br/>
**ターゲット VNet** | フェールオーバー後、レプリケートされた VM が配置される仮想ネットワーク (VNet) です。 ソース仮想ネットワークとターゲット仮想ネットワークの間にネットワーク マッピングが作成されます (または、その逆)。<br/><br/> Site Recovery では、"asr" というサフィックスを持つ新しい VNet とサブネットが作成されます。
**ターゲット ストレージ アカウント** |  VM でマネージド ディスクが使用されていない場合、このストレージ アカウントにデータがレプリケートされます。<br/><br/> Site Recovery によってターゲット リージョンに新しいストレージ アカウントが作成されて、ソース ストレージ アカウントがミラーリングされます。
**レプリカ マネージド ディスク** | VM でマネージド ディスクが使用されている場合、このマネージド ディスクにデータがレプリケートされます。<br/><br/> Site Recovery によりストレージ リージョンにソースをミラーリングするレプリカ マネージド ディスクが作成されます。
**ターゲット可用性セット** |  フェールオーバー後、レプリケートされた VM が配置される可用性セット。<br/><br/> Site Recovery では、ソースの場所の可用性セットに配置されている VM 用に、"asr" というサフィックスでターゲット リージョンに可用性セットが作成されます。 可用性セットが存在する場合はそれが使用され、新しくは作成されません。
**ターゲット可用性ゾーン** | ターゲット リージョンで可用性ゾーンがサポートされている場合、ソース リージョンと同じゾーン数が Site Recovery によって割り当てられます。

### <a name="managing-target-resources"></a>ターゲット リソースの管理

次のようにターゲット リソースを管理できます。

- レプリケーションを有効にするときに、ターゲットの設定を変更できます。 ターゲット リージョン VM の既定の SKU は、ソース VM SKU (または、ソース VM SKU と比較して、次に最適な使用できる SKU) と同じであることにご注意ください。 ドロップダウン リストには、ソースの VM と同じファミリの関連 SKU だけが表示されます (Gen 1 または Gen2)。
- レプリケーションが既に動作した後で、ターゲットの設定を変更できます。 ターゲット リソース グループ、ターゲット名などのその他のリソースと同様に、ターゲット リージョン VM SKU は、レプリケーションの進行後に更新することもできます。 可用性の種類 (1 つのインスタンス、セット、またはゾーン) は、更新できないリソースです。 この設定を変更するには、レプリケーションを無効にして、設定を変更し、再度有効にする必要があります。 

## <a name="replication-policy"></a>Replication policy 

Azure VM レプリケーションを有効にするときに、既定で Site Recovery によって、次の表に示す既定の設定で新しいレプリケーション ポリシーが作成されます。

**ポリシーの設定** | **詳細** | **[Default]**
--- | --- | ---
**復旧ポイントの保持期間** | Site Recovery で復旧ポイントを保持する長さを指定します | 24 時間
**アプリ整合性スナップショットの頻度** | Site Recovery でアプリ整合性スナップショットを取得する頻度。 | 4 時間ごと

### <a name="managing-replication-policies"></a>レプリケーション ポリシーの管理

次のように既定のレプリケーション ポリシーの設定を変更および管理できます。
- レプリケーションを有効にするときに、設定を変更できます。
- いつでもレプリケーション ポリシーを作成でき、レプリケーションを有効にするときに適用することができます。

### <a name="multi-vm-consistency"></a>マルチ VM 整合性

複数の VM を一緒にレプリケートし、フェールオーバー時にクラッシュ整合性復旧ポイントとアプリ整合性復旧ポイントを共有する場合は、レプリケーション グループにまとめることができます。 マルチ VM 整合性はワークロードのパフォーマンスに影響を与えるので、すべてのマシン間で整合性を必要とするワークロードを実行している VM にのみ使用する必要があります。 



## <a name="snapshots-and-recovery-points"></a>スナップショットと復旧ポイント

復旧ポイントは、特定の時点で取得された VM のディスクのスナップショットから作成されます。 VM をフェールオーバーするときは、復旧ポイントを使用してターゲットの場所に VM を復元します。

フェールオーバーでは、通常、破損やデータ損失なしで VM が起動し、オペレーティング システムおよび VM で実行されるアプリについて VM のデータが一貫していることが必要です。 これは、作成されるスナップショットの種類に依存します。

Site Recovery では、次のようにスナップショットが作成されます。

1. Site Recovery では、既定でデータのクラッシュ整合性スナップショットが作成され、ユーザーが頻度を指定するとアプリ整合性スナップショットが作成されます。
2. 復旧ポイントはスナップショットから作成されて、レプリケーション ポリシーでの保持期間の設定に従って格納されます。

### <a name="consistency"></a>一貫性

次の表で、整合性の種類について説明します。

### <a name="crash-consistent"></a>クラッシュ整合性

**説明** | **詳細** | **推奨**
--- | --- | ---
クラッシュ整合性スナップショットでは、スナップショットが作成されたときにディスクに存在していたデータがキャプチャされます。 メモリ内のものは含まれません。<br/><br/> スナップショットが作成された瞬間に VM がクラッシュしたり、電源コードがサーバーから抜かれたりした場合にディスク上に存在していたデータと同じものが含まれます。<br/><br/> クラッシュ整合性では、オペレーティング システムや VM 上のアプリのデータ整合性は保証されません。 | Site Recovery では、既定で 5 分ごとにクラッシュ整合性復旧ポイントが作成されます。 この設定を変更することはできません。<br/><br/>  | 現在、ほとんどのアプリでは、クラッシュ整合性ポイントから十分に復旧できます。<br/><br/> クラッシュ整合性復旧ポイントは、通常、オペレーティング システム、および DHCP サーバーやプリント サーバーなどのアプリの複製に十分です。

### <a name="app-consistent"></a>アプリ整合性

**説明** | **詳細** | **推奨**
--- | --- | ---
アプリ整合性復旧ポイントは、アプリ整合性スナップショットから作成されます。<br/><br/> アプリ整合性スナップショットには、クラッシュ整合スナップショット内のすべての情報に加えて、メモリ内のすべてのデータと進行中のトランザクションが含まれます。 | アプリ整合性スナップショットでは、ボリューム シャドウ コピー サービス (VSS) が使用されます。<br/><br/>   1) Azure Site Recovery では、コピーのみのバックアップ (VSS_BT_COPY) 方法が使用されます。これは、Microsoft SQL のトランザクション ログのバックアップ時刻およびシーケンス番号を変更しません。 </br></br> 2) スナップショットが開始されると、VSS によってボリュームでコピーオンライト (COW) 操作が実行されます。<br/><br/>   3) COW を実行する前、VSS はマシン上のすべてのアプリに、メモリ常駐データをディスクにフラッシュする必要があることを通知します。<br/><br/>   4) その後、VSS は、バックアップ/ディザスター リカバリー アプリ (このケースでは Site Recovery) にスナップショット データを読み取って続行することを許可します。 | アプリ整合性スナップショットはユーザーが指定した頻度に従って作成されます。 この頻度は常に、復旧ポイントを保持するための設定より短くする必要があります。 たとえば、復旧ポイントを既定の設定の 24 時間を使用して保持する場合、頻度を 24 時間未満に設定する必要があります。<br/><br/>クラッシュ整合性スナップショットより複雑で、完了に時間がかかります。<br/><br/> レプリケーションが有効な VM で実行されているアプリのパフォーマンスに影響します。 

## <a name="replication-process"></a>レプリケーション プロセス

Azure VM でレプリケーションを有効にすると、次のことが行われます。

1. Site Recovery モビリティ サービス拡張機能が、VM に自動的にインストールされます。
2. 拡張機能は、VM を Site Recovery に登録します。
3. 継続的なレプリケーションが VM に対して開始されます。  ディスクへの書き込みは、ソースの場所のキャッシュ ストレージ アカウントにすぐに転送されます。
4. キャッシュ内のデータは Site Recovery によって処理され、ターゲット ストレージ アカウントまたはレプリカ マネージド ディスクに送信されます。
5. データが処理された後、クラッシュ整合性復旧ポイントが 5 分ごとに生成されます。 アプリ整合性復旧ポイントは、レプリケーション ポリシーで指定された設定に従って生成されます。

![レプリケーション プロセス (手順 2) を示す図。](./media/concepts-azure-to-azure-architecture/enable-replication-step-2-v2.png)

**レプリケーション プロセス**

## <a name="connectivity-requirements"></a>接続の要件

 レプリケートする Azure VM では、送信接続が必要です。 Site Recovery には、VM への受信接続は不要です。 

### <a name="outbound-connectivity-urls"></a>送信接続 (URL)

VM の送信アクセスが URL で制御されている場合は、次の URL を許可します。

| **名前**                  | **商用**                               | **政府**                                 | **説明** |
| ------------------------- | -------------------------------------------- | ---------------------------------------------- | ----------- |
| ストレージ                   | `*.blob.core.windows.net`                  | `*.blob.core.usgovcloudapi.net` | ソース リージョンのキャッシュ ストレージ アカウントに、VM からデータが書き込まれるよう許可します。 |
| Azure Active Directory    | `login.microsoftonline.com`                | `login.microsoftonline.us`                   | Site Recovery サービス URL に対する承認と認証を提供します。 |
| レプリケーション               | `*.hypervrecoverymanager.windowsazure.com` | `*.hypervrecoverymanager.windowsazure.com`     | VM と Site Recovery サービスの通信を許可します。 |
| Service Bus               | `*.servicebus.windows.net`                 | `*.servicebus.usgovcloudapi.net`             | VM による Site Recovery の監視および診断データの書き込みを許可します。 |
| Key Vault                 | `*.vault.azure.net`                        | `*.vault.usgovcloudapi.net`                  | ADE が有効な仮想マシンのレプリケーションをポータルを介して有効にするためのアクセスを許可します |
| Azure Automation          | `*.automation.ext.azure.com`               | `*.azure-automation.us`                      | レプリケートされる項目に対してモビリティ エージェントの自動アップグレードをポータルを介して有効にすることを許可します |

### <a name="outbound-connectivity-for-ip-address-ranges"></a>IP アドレス範囲に対する送信接続

IP アドレスを使用して VM の送信接続を制御するには、次のアドレスを許可します。
ネットワーク接続要件の詳細については、[ネットワークに関するホワイト ペーパー](azure-to-azure-about-networking.md#outbound-connectivity-using-service-tags)を参照してください。 

#### <a name="source-region-rules"></a>ソース リージョンのルール

**Rule** |  **詳細** | **サービス タグ**
--- | --- | --- 
HTTPS の送信を許可する: ポート 443 | ソース リージョンのストレージ アカウントに対応する範囲を許可します | Storage.\<region-name>
HTTPS の送信を許可する: ポート 443 | Azure Active Directory (Azure AD) に対応する範囲を許可します  | AzureActiveDirectory
HTTPS の送信を許可する: ポート 443 | ターゲットリージョンのイベントハブに対応する範囲を許可します。 | EventsHub.\<region-name>
HTTPS の送信を許可する: ポート 443 | Azure Site Recovery に対応する範囲を許可します。  | AzureSiteRecovery
HTTPS の送信を許可する: ポート 443 | Azure Key Vault に対応する範囲を許可します (これは、ADE が有効になっている仮想マシンのレプリケーションを、ポータルを介して有効にする場合にのみ必要です) | AzureKeyVault
HTTPS の送信を許可する: ポート 443 | Azure Automation コントローラーに対応する範囲を許可します (これは、レプリケートされる項目に対してモビリティ エージェントの自動アップグレードをポータルを介して有効にする場合にのみ必要です) | GuestAndHybridManagement

#### <a name="target-region-rules"></a>ターゲット リージョンのルール

**Rule** |  **詳細** | **サービス タグ**
--- | --- | --- 
HTTPS の送信を許可する: ポート 443 | ターゲット リージョンのストレージ アカウントに対応する範囲を許可します。 | Storage.\<region-name>
HTTPS の送信を許可する: ポート 443 | Azure AD に対応する範囲を許可します  | AzureActiveDirectory
HTTPS の送信を許可する: ポート 443 | ソースリージョンのイベントハブに対応する範囲を許可します。 | EventsHub.\<region-name>
HTTPS の送信を許可する: ポート 443 | Azure Site Recovery に対応する範囲を許可します。  | AzureSiteRecovery
HTTPS の送信を許可する: ポート 443 | Azure Key Vault に対応する範囲を許可します (これは、ADE が有効になっている仮想マシンのレプリケーションを、ポータルを介して有効にする場合にのみ必要です) | AzureKeyVault
HTTPS の送信を許可する: ポート 443 | Azure Automation コントローラーに対応する範囲を許可します (これは、レプリケートされる項目に対してモビリティ エージェントの自動アップグレードをポータルを介して有効にする場合にのみ必要です) | GuestAndHybridManagement


#### <a name="control-access-with-nsg-rules"></a>NSG ルールでアクセスを制御する

[NSG ルール](../virtual-network/network-security-groups-overview.md)を使用して、Azure のネットワーク/サブネットが送受信するネットワーク トラフィックをフィルタリングすることによって VM の接続を制御する場合、次の要件に注意してください。

- ソース Azure リージョンの NSG ルールでは、レプリケーション トラフィックの送信アクセスを許可する必要があります。
- 運用環境に配置する前に、テスト環境でルールを作成することをお勧めします。
- 個々の IP アドレスを許可するのではなく、[サービス タグ](../virtual-network/network-security-groups-overview.md#service-tags)を使用します。
    - サービス タグは IP アドレス プレフィックスのグループを表し、セキュリティ規則の作成の複雑さを最小限に抑えます。
    - Microsoft は、時間の経過と共に、サービス タグを自動的に更新します。 
 
詳しくは、Site Recovery の[送信接続](azure-to-azure-about-networking.md#outbound-connectivity-using-service-tags)に関する記事、および[NSG による接続の制御](concepts-network-security-group-with-site-recovery.md)に関する記事をご覧ください。


### <a name="connectivity-for-multi-vm-consistency"></a>マルチ VM 整合性の接続

マルチ VM 整合性を有効にすると、レプリケーション グループ内のマシンは、ポート 20004 を介して相互に通信します。
- ポート 20004 経由での VM 間の内部通信をブロックするファイアウォール アプライアンスがないことを確認します。
- Linux VM をレプリケーション グループに含めるには、ポート 20004 の送信トラフィックが、特定の Linux バージョンのガイダンスに従って手動で開かれていることを確認します。




## <a name="failover-process"></a>フェールオーバー プロセス

フェールオーバーの開始時、VM は、ターゲット リソース グループ、ターゲット仮想ネットワーク、ターゲット サブネット、およびターゲット可用性セットに作成されます。 フェールオーバー中は、任意の復旧ポイントを使用できます。

![ソース環境とターゲット環境を含むフェールオーバー プロセスを示す図。](./media/concepts-azure-to-azure-architecture/failover-v2.png)

## <a name="next-steps"></a>次のステップ

Azure VM をセカンダリ リージョンに[迅速にレプリケート](azure-to-azure-quickstart.md)します。
