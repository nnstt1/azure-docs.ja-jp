---
title: 2 層アプリケーションを使用するハイブリッド接続 |Microsoft Docs
description: 仮想アプライアンスと UDR をデプロイして Azure 内に多層アプリケーション環境を作成する方法について説明します。
services: virtual-network
documentationcenter: na
author: KumudD
manager: carmonm
ms.assetid: 1f509bec-bdd1-470d-8aa4-3cf2bb7f6134
ms.service: virtual-network
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: infrastructure-services
ms.date: 05/05/2016
ms.author: kumud
ms.openlocfilehash: e1d84a09ddd758f333ccb588ac341dce607509d8
ms.sourcegitcommit: 0046757af1da267fc2f0e88617c633524883795f
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 08/13/2021
ms.locfileid: "121749264"
---
# <a name="virtual-appliance-scenario"></a>仮想アプライアンスを使用するシナリオ
大型 Azure 顧客の間の一般的なシナリオは、オンプレミス データセンターからバック層へのアクセスを許可する一方でインターネットへの公開を行う 2 層アプリケーションを用意する必要があることです。 このドキュメントでは、ユーザー定義ルート (UDR)、VPN Gateway、およびネットワーク仮想アプライアンスを使用して、次の要件を満たす 2 層環境をデプロイするシナリオについて説明します。

* Web アプリケーションは、パブリック インターネットのみからアクセスできる必要がある。
* アプリケーションをホストする Web サーバーは、バックエンド アプリケーション サーバーにアクセスできる必要がある。
* インターネットから Web アプリケーションへのすべてのトラフィックは、ファイアウォール仮想アプライアンスを経由する必要がある。 この仮想アプライアンスは、インターネット トラフィックのみで使用されます。
* アプリケーション サーバーへのすべてのトラフィックは、ファイアウォール仮想アプライアンスを経由する必要がある。 この仮想アプライアンスは、バックエンド サーバーへのアクセスと、VPN Gateway 経由でのオンプレミス ネットワークからのアクセスで使用されます。
* 管理者が、管理目的でのみ使用される第 3 のファイアウォール仮想アプライアンスを使用して、オンプレミス コンピューターからファイアウォール仮想アプライアンスを管理できる必要がある。

これは、DMZ と保護されたネットワークを使用する標準的な境界ネットワーク (DMZ とも知られる) シナリオです。 このようなシナリオを、NSG、ファイアウォール仮想アプライアンス、または両方の組み合わせを使用して Azure で構築できます。 次の表は、NSG とファイアウォール仮想アプライアンスの長所と短所の一部を示しています。

|  | 長所 | 短所 |
| --- | --- | --- |
| **NSG** |コストがかかりません。 <br/>Azure RBAC に統合されます。 <br/>Azure Resource Manager テンプレートでルールを作成できます。 |大規模な環境では複雑さが変化する可能性があります。 |
| **ファイアウォール** |データ プレーンを完全に制御します。 <br/>ファイアウォール コンソールから一元管理します。 |ファイアウォール アプライアンスのコストがかかります。 <br/>Azure RBAC と統合されません。 |

下のソリューションでは、ファイアウォール仮想アプライアンスを使用して、境界ネットワーク (DMZ) や保護されたネットワークのシナリオを実装します。

## <a name="considerations"></a>考慮事項
上で説明した環境を、次に示す現在使用できるさまざまな機能を使用して Azure にデプロイできます。

* **仮想ネットワーク (VNet)** 。 Azure VNet は、オンプレミス ネットワークに似た方法で機能し、トラフィックと問題を分離するために 1 つまたは複数のサブネットにセグメント化できます。
* **仮想アプライアンス**。 複数のパートナーが、前述の 3 種類のファイアウォールのために使用できる仮想アプライアンスを Azure Marketplace で提供しています。 
* **ユーザー定義ルート(UDR)** 。 ルート テーブルに、VNet 内のパケットのフローを制御するため Azure ネットワークによって使用される UDR を含めることができます。 これらのルート テーブルをサブネットに適用できます。 Azure の最新機能の 1 つは、ルート テーブルを GatewaySubnet に適用して、Azure VNet で受信するハイブリッド接続から仮想アプライアンスへのすべてのトラフィックを転送できる機能です。
* **IP 転送**。 既定では、Azure ネットワーク エンジンは、パケットの宛先 IP アドレスが仮想ネットワーク インターフェイス カード (NIC) の IP アドレスと一致する場合のみ、パケットを NIC に転送します。 したがって、特定の仮想アプライアンスにパケットを送信する必要があることを UDR で定義している場合、Azure ネットワーク エンジンは、そのパケットを削除します。 パケットの実際の宛先ではない VM (ここでは仮想アプライアンス) にパケットが送信されるようにするには、仮想アプライアンスに対する IP 転送を有効にする必要があります。
* **ネットワーク セキュリティ グループ (NSG)** 。 次の例では NSG を使用していませんが、このソリューションでサブネットまたは NIC に適用される NSG を使用して、サブネットと NIC とのトラフィックをさらにフィルター処理できます。

![IPv6 接続](./media/virtual-network-scenario-udr-gw-nva/figure01.png)

この例で使用するサブスクリプションには、以下のものが含まれています。

* 2 つのリソース グループ (図には示されていません) 
  * **ONPREMRG**。 オンプレミス ネットワークをシミュレートするために必要なすべてのリソースを含みます。
  * **AZURERG**。 Azure 仮想ネットワーク環境に必要なすべてのリソースを含みます。 
* 次に示すようにセグメント化されたオンプレミス データセンターを模倣するための **onpremvnet** という名前の VNet。
  * **onpremsn1**。 オンプレミス サーバーを模倣するための、Ubuntu を実行中の仮想マシン (VM) を含むサブネット。
  * **onpremsn2**。 管理者によって使用されるオンプレミス コンピューターを模倣するための、Ubuntu を実行中の仮想マシン (VM) を含むサブネット。
* **onpremvnet** には、**azurevnet** へのトンネルを維持するために使用される **OPFW** という名前のファイアウォール仮想アプライアンスがあります。
* 次に示すようにセグメント化された **azurevnet** という名前の VNet。
  * **azsn1**。 外部ファイアウォールに対してのみ使用される外部ファイアウォール サブネット。 すべてのインターネット トラフィックは、このサブネットを通して受信されます。 このサブネットには、外部ファイアウォールにリンクされた NIC だけが含まれます。
  * **azsn2**。 インターネットからアクセスされる Web サーバーとして実行される VM をホストするフロントエンド サブネット。
  * **azsn3**。 フロントエンド Web サーバーによってアクセスされるバックエンド アプリケーション サーバーを実行する VM をホストするバックエンド サブネット。
  * **azsn4**。 すべてのファイアウォール仮想アプライアンスへのアクセスを管理するためにのみ使用される管理サブネット。 このサブネットには、このソリューションで使用される各ファイアウォール仮想アプライアンス用の NIC のみが含まれます。
  * **GatewaySubnet**。 Azure VNet とその他のネットワークを接続するために ExpressRoute と VPN Gateway が必要とする Azure ハイブリッド接続サブネット。 
* **azurevnet** ネットワークには、次の 3 つのファイアウォール仮想アプライアンスがあります。 
  * **AZF1**。 Azure の パブリック IP アドレス リソースを使用してパブリック インターネットに公開される外部ファイアウォール。 3-NIC 仮想アプライアンスをプロビジョニングするテンプレート (Marketplace から、またはアプライアンス ベンダーから直接取得します) があることを確認する必要があります。
  * **AZF2**。 **azsn2** と **azsn3** 間のトラフィックを制御するために使用される内部ファイアウォール。 これも 3-NIC 仮想アプライアンスです。
  * **AZF3**。 管理者がオンプレミス データセンターからアクセスでき、すべてのファイアウォール アプライアンスを管理するために使用される管理サブネットに接続されている管理ファイアウォール。 2-NIC 仮想アプライアンスのテンプレートを Marketplace で探すか、アプライアンス ベンダーに直接要求できます。

## <a name="user-defined-routing-udr"></a>ユーザー定義ルーティング (UDR)
Azure の各サブネットは、そのサブネットで開始されたトラフィックをどのようにルーティングするかを定義するために使用される UDR テーブルにリンクすることができます。 UDR が定義されていない場合、Azure では、既定のルートを使用してあるサブネットから別のサブネットにトラフィックが送信されることを許可します。 UDR の理解を深めるには、「 [ユーザー定義ルートと IP 転送](virtual-networks-udr-overview.md)」をご覧ください。

上記の要件に基づいて、適切なファイアウォール アプライアンスを経由して通信が行われることを保証するには、UDR を含む次のルート テーブルを **azurevnet** 内に作成する必要があります。

### <a name="azgwudr"></a>azgwudr
このシナリオでは、**AZF3** に接続してファイアウォールを管理するためにオンプレミスから Azure に送信されるトラフィックのみが使用され、そのトラフィックを内部ファイアウォール **AZF2** 経由で送信する必要があります。 したがって、 **GatewaySubnet** には、次に示す 1 つのルートのみが必要です。

| 宛先 | 次のホップ | 説明 |
| --- | --- | --- |
| 10.0.4.0/24 |10.0.3.11 |オンプレミスのトラフィックが管理ファイアウォール **AZF3** |

### <a name="azsn2udr"></a>azsn2udr
| 宛先 | 次のホップ | 説明 |
| --- | --- | --- |
| 10.0.3.0/24 |10.0.2.11 |アプリケーション サーバーをホストするバックエンド サブネットへのトラフィックが **AZF2** |
| 0.0.0.0/0 |10.0.2.10 |他のすべてのトラフィックが **AZF1** |

### <a name="azsn3udr"></a>azsn3udr
| 宛先 | 次のホップ | 説明 |
| --- | --- | --- |
| 10.0.2.0/24 |10.0.3.10 |**azsn2** へのトラフィックが、アプリケーション サーバーから **AZF2** 経由で Web サーバーに送信されることを許可します。 |

オンプレミス データセンターを模倣するために、 **onpremvnet** 内のサブネット用のルート テーブルも作成する必要があります。

### <a name="onpremsn1udr"></a>onpremsn1udr
| 宛先 | 次のホップ | 説明 |
| --- | --- | --- |
| 192.168.2.0/24 |192.168.1.4 |**onpremsn2** へのトラフィックが **OPFW** 経由で送信されることを許可します。 |

### <a name="onpremsn2udr"></a>onpremsn2udr
| 宛先 | 次のホップ | 説明 |
| --- | --- | --- |
| 10.0.3.0/24 |192.168.2.4 |Azure 内のバックエンド サブネットへのトラフィックが **OPFW** |
| 192.168.1.0/24 |192.168.2.4 |**onpremsn1** へのトラフィックが **OPFW** で送信されることを許可します。 |

## <a name="ip-forwarding"></a>IP 転送
UDR と IP 転送は、組み合わせて使用することで、Azure VNet 内のトラフィック フローを仮想アプライアンスで制御できるようにする機能です。  仮想アプライアンスは、アプリケーションを実行する VM にすぎません。ファイアウォールや NAT デバイスなど、ネットワーク トラフィックを何らかの方法で処理するために使用されるアプリケーションが仮想アプライアンスで実行されます。

仮想アプライアンスとして機能するこの VM は、自分宛てではない着信トラフィックを受信できることが必要です。 VM が自分以外の宛先に向かうトラフィックを受信するためには、VM の IP 転送を有効にする必要があります。 これは Azure の設定であり、ゲスト オペレーティング システムでの設定ではありません。 仮想アプライアンスは、受信トラフィックを処理し、適切にルーティングするアプリケーションを実行する必要があります。

IP 転送の詳細については、「 [ユーザー定義のルートおよび IP 転送とは](virtual-networks-udr-overview.md)」を参照してください。

たとえば、Azure VNet が次のように設定されているとします。

* サブネット **onpremsn1** に **onpremvm1** という名前の VM がある。
* サブネット **onpremsn2** に **onpremvm2** という名前の VM がある。
* **OPFW** という名前の仮想アプライアンスが **onpremsn1** と **onpremsn2** に接続されている。
* **onpremsn1** にリンクされたユーザー定義ルートで、**onpremsn2** に対するすべてのトラフィックを **OPFW** に送信する必要があると指定している。

この時点で、**onpremvm1** が **onpremvm2** との接続を確立しようとした場合は、UDR が使用され、トラフィックは次のホップで **OPFW** に送信されます。 パケットの実際の宛先は変更されず、宛先は **onpremvm2** のままであることに注意してください。 

**OPFW** に対する IP 転送が有効になっていない場合、パケットは Azure 仮想ネットワークのロジックによって削除されます。これは、パケットの VM への送信は、送信先が VM の IP アドレスである場合にのみ許可されるためです。

IP 転送が有効になっている場合、パケットは Azure 仮想ネットワークのロジックによって、元の宛先の変更なしで OPFW に転送されます。 **OPFW** は、パケットを処理し、パケットに対して何を実行するかを決定する必要があります。

上のシナリオを機能させるには、ルーティングするために使用される **OPFW**、**AZF1**、**AZF2**、および **AZF3** 用の NIC (管理サブネットにリンクされている NIC 以外のすべての NIC) に対する IP 転送を有効にする必要があります。 

## <a name="firewall-rules"></a>ファイアウォール ルール
前述したように、IP 転送は、パケットが仮想アプライアンスに送信されることを保証するだけです。 これらのパケットの処理方法はアプライアンスが決定する必要があります。 上のシナリオでは、次のルールをアプライアンスに作成する必要があります。

### <a name="opfw"></a>OPFW
OPFW は、次のルールを含むオンプレミス デバイスを表します。

* **ルート:** 10.0.0.0/16 (**azurevnet**) へのすべてのトラフィックを、トンネル **ONPREMAZURE** 経由で送信する必要があります。
* **ポリシー**:**port2** と **ONPREMAZURE** 間のすべての双方向トラフィックを許可します。

### <a name="azf1"></a>AZF1
AZF1 は、次のルールを含む Azure の仮想アプライアンスを表します。

* **ポリシー**:**port1** と **port2** 間のすべての双方向トラフィックを許可します。

### <a name="azf2"></a>AZF2
AZF2 は、次のルールを含む Azure の仮想アプライアンスを表します。

* **ポリシー**:**port1** と **port2** 間のすべての双方向トラフィックを許可します。

### <a name="azf3"></a>AZF3
AZF3 は、次のルールを含む Azure の仮想アプライアンスを表します。

* **ルート**: 192.168.0.0/16 (**onpremvnet**) へのすべてのトラフィックを、**port1** 経由で Azure ゲートウェイ IP アドレス (つまり、10.0.0.1) に送信する必要があります。

## <a name="network-security-groups-nsgs"></a>ネットワーク セキュリティ グループ (NSG)
ここで説明しているシナリオでは、NSG は使用されていません。 ただし、各サブネットに NSG を適用して、受信トラフィックと送信トラフィックを制限できます。 たとえば、次の NSG ルールを外部 FW サブネットに適用できます。

**受信**

* サブネット内のすべての VM で、インターネットから ポート 80 へのすべての TCP トラフィックを許可します。
* それ以外のインターネットからのすべてのトラフィックを拒否します。

**送信**

* インターネットへのすべてのトラフィックを拒否します。

## <a name="high-level-steps"></a>手順の概要
このシナリオをデプロイするには、次の概要手順に従います。

1. Azure サブスクリプションにログインします。
2. オンプレミス ネットワークを模倣するために VNet をデプロイする場合は、 **ONPREMRG** の一部であるリソースをプロビジョニングします。
3. **AZURERG** の一部であるリソースをプロビジョニングします。
4. **onpremvnet** から **azurevnet** へのトンネルをプロビジョニングします。
5. すべてのリソースがプロビジョニングされた後、**onpremvm2** にサインインし、10.0.3.101 への ping を実行して、**onpremsn2** と **azsn3** 間の接続をテストします。
