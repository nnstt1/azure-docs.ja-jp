---
title: Azure Virtual Network NAT 接続のトラブルシューティング
titleSuffix: Azure Virtual Network
description: Virtual Network NAT の問題のトラブルシューティングを行います。
services: virtual-network
documentationcenter: na
author: asudbring
manager: KumudD
ms.service: virtual-network
ms.devlang: na
ms.topic: troubleshooting
ms.tgt_pltfrm: na
ms.workload: infrastructure-services
ms.date: 05/20/2020
ms.author: allensu
ms.openlocfilehash: 610d24576386b311bf5e4ef5a98c1c22a705aff0
ms.sourcegitcommit: 702df701fff4ec6cc39134aa607d023c766adec3
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 11/03/2021
ms.locfileid: "131466411"
---
# <a name="troubleshoot-azure-virtual-network-nat-connectivity"></a>Azure Virtual Network NAT 接続のトラブルシューティング

この記事は、管理者が Virtual Network NAT を使用する際の接続の問題を診断および解決する場合に役立ちます。

## <a name="problems"></a>問題が発生した場合

* [SNAT の枯渇](#snat-exhaustion)
* [ICMP ping が失敗する](#icmp-ping-is-failing)
* [接続エラー](#connectivity-failures)
* [IPv6 の共存](#ipv6-coexistence)
* [NAT ゲートウェイ IP から接続が行われない](#connection-doesnt-originate-from-nat-gateway-ips)

これらの問題を解決するには、次のセクションの手順に従ってください。

## <a name="resolution"></a>解像度

### <a name="snat-exhaustion"></a>SNAT の枯渇

1 つの [NAT ゲートウェイ リソース](nat-gateway-resource.md)で、64,000 から最大 100 万件の同時フローがサポートされます。  各 IP アドレスでは、64,000 個の SNAT ポートが使用可能なインベントリに提供されます。 NAT ゲートウェイ リソースあたり最大 16 個の IP アドレスを使用できます。  SNAT のメカニズムについては、[こちら](nat-gateway-resource.md#source-network-address-translation)で詳しく説明されています。

多くの場合、SNAT が枯渇する根本的な原因は、アウトバウンド接続の確立方法と管理方法、または構成可能なタイマーの既定値に対する変更のアンチパターンです。  このセクションの内容を慎重に検討してください。

#### <a name="steps"></a>手順

1. 既定のアイドル タイムアウトを 4 分より大きい値に変更したかどうかを確認します。
2. 対象のアプリケーションで送信接続をどのように作成しているかを調査します (たとえば、コード レビューやパケット キャプチャ)。 
3. このアクティビティが予期される動作であるかどうか、またはアプリケーションが誤動作しているかどうかを判断します。  Azure Monitor で[メトリック](nat-metrics.md)を使用して、調査結果を実証します。 SNAT 接続メトリックの "失敗" カテゴリを使用してください。
4. 適切なパターンに従っているかどうかを評価します。
5. NAT ゲートウェイ リソースに割り当てられた追加の IP アドレスを使用して SNAT ポートの枯渇を軽減する必要があるかどうかを評価します。

#### <a name="design-patterns"></a>設計パターン

可能な場合は常に、接続の再利用と接続プールを利用してください。  これらのパターンは、リソース枯渇の問題を回避し、予測可能な動作をもたらします。 これらのパターンのプリミティブは、多くの開発ライブラリとフレームワークに含まれています。

_**解決方法:**_ 適切なパターンとベスト プラクティスを使用する

- NAT ゲートウェイのリソースの既定の TCP アイドルタイムアウトは 4 分です。  それよりも大きい値に変更した場合、NAT がフローを保持する時間が長くなり、[SNAT ポート インベントリに対して不要な負荷](nat-gateway-resource.md#timers)が発生する可能性があります。
- アトミック要求 (接続ごとに 1 要求) は設計の選択肢として貧弱です。 そのようなアンチパターンにより規模が制限され、パフォーマンスと信頼性が低下されます。 代わりに、HTTP/S 接続を再利用し、接続と関連付けられている SNAT ポートの数を減らします。 TLS を利用すると、ハンドシェイク、オーバーヘッド、暗号化操作による代償が減り、アプリケーションのスケールとパフォーマンスが向上します。
- DNS リゾルバーの結果がクライアントでキャッシュされないとき、DNS では個別フローを大量に導入できます。 キャッシュを使用する
- UDP フロー (DNS 参照など) によって、アイドル時間中、SNAT ポートが割り当てられます。 アイドル時間が長くなると、SNAT ポートにかかる圧力がそれだけ高くなります。 短いアイドル タイムアウト (4 分など) を使用します。
- 接続プールを使用し、接続ボリュームを形成します。
- 警告なしで TCP フローを破棄し、TCP タイマーに依存してフローを消去することは決してしないでください。 TCP で明示的に接続を閉じなかった場合、中間システムとエンドポイントで状態が割り当てられたままになり、他の接続に SNAT ポートを利用できなくなります。 このパターンによって、アプリケーション エラーと SNAT 枯渇がトリガーされる可能性があります。 
- OS レベルの TCP 終了関連のタイマー値は、影響が専門的にわからない場合、変更しないでください。 TCP スタックの復旧中、接続のエンドポイントで期待値が一致しないと、アプリケーション パフォーマンスに悪影響が出ることがあります。 タイマーの変更が望まれるということは、通常、基礎的な設計に問題がある兆候です。 次の推奨事項をご確認ください。

SNAT 枯渇は、基礎となるアプリケーションのその他のアンチパターンによって増幅することもあります。 ご自分のサービスの規模や信頼性を改善するため、こうした追加のパターンやベスト プラクティスをご確認ください。

- SNAT ポート インベントリをもっと早く解放するために、[TCP アイドル タイムアウト](nat-gateway-resource.md#timers)を、より小さい値 (既定のアイドル タイムアウトである 4 分など) に変更した場合の効果を詳しく調べます。
- 実行時間の長い操作に対しては、[非同期ポーリング パターン](/azure/architecture/patterns/async-request-reply)を使用して他の操作のために接続リソースを解放することを検討します。
- 有効期間の長いフロー (たとえば、再利用された TCP 接続) では、中間システムのタイムアウトを回避するために、TCP キープアライブまたはアプリケーション レイヤー キープアライブを使用する必要があります。アイドル タイムアウトを増やすことは最後の手段であり、根本原因が解決されるとは限りません。 タイムアウトが長いと、タイムアウトの終了時、低い率でエラーが発生し、遅延や不要な障害を引き起こす可能性があります。
- 一時的な障害または障害復旧中の積極的な再試行またはバーストを回避するには、グレースフルな[再試行パターン](/azure/architecture/patterns/retry)を使用する必要があります。
すべての HTTP 操作に対して新しい TCP 接続を作成することはアンチパターンです ("アトミック接続" とも呼ばれます)。  アトミック接続は、アプリケーションのスケーリングを妨げ、リソースを浪費します。  常に複数の操作をパイプラインで同じ接続に渡してください。  アプリケーションにとっては、トランザクション速度とリソース コストの面でメリットがあります。  アプリケーションでトランスポート レイヤー暗号化 (TLS など) を使用する場合、新しい接続の処理に関連する多大なコストがかかります。  その他のベスト プラクティス パターンについては、[Azure のクラウド設計パターン](/azure/architecture/patterns/)に関するページを確認してください。

#### <a name="additional-possible-mitigations"></a>可能な追加の軽減策

_**解決方法:**_ アウトバウンド接続を次のようにスケーリングします。

| シナリオ | 証拠 |対応策 |
|---|---|---|
| 使用率が高い期間に SNAT ポートの競合と SNAT ポートの枯渇が発生している。 | Azure Monitor の SNAT 接続[メトリック](nat-metrics.md)の "失敗" カテゴリに、一定期間にわたる一時的または永続的な失敗や、大量の接続が表示される。  | パブリック IP アドレス リソースまたはパブリック IP プレフィックス リソースをさらに追加できるかどうかを判断します。 この追加により、NAT ゲートウェイに対して合計で最大 16 個の IP アドレスを使用できるようになります。 この追加により、使用可能な SNAT ポートのインベントリが増え (IP アドレスあたり 64,000 個)、シナリオをさらにスケーリングできるようになります。|
| 既に 16 個の IP アドレスを取得したが、SNAT ポートの枯渇が引き続き発生する。 | 新たに IP アドレスを追加しようとすると失敗する。 パブリック IP アドレス リソースまたはパブリック IP プレフィックス リソースからの IP アドレスの総数が合計 16 個を超えている。 | アプリケーション環境を複数のサブネットに分散し、各サブネットに NAT ゲートウェイ リソースを提供します。  設計パターンを再評価し、前述の[ガイダンス](#design-patterns)に基づいて最適化します。 |

>[!NOTE]
>SNAT の枯渇が発生する理由を理解することが重要です。 スケーラブルで信頼性の高いシナリオに適したパターンを使用していることを確認してください。  需要の原因を理解できないままさらに多くの SNAT ポートをシナリオに追加することは最後の手段にする必要があります。 現在のシナリオで SNAT ポート インベントリに負荷がかかっている理由を理解できない場合、IP アドレスを追加することで SNAT ポートをインベントリに追加しても、アプリケーションをスケーリングしたときに同じ枯渇の障害が発生するのを遅らせるだけです。  他の非効率性やアンチパターンを隠すことになります。

### <a name="icmp-ping-is-failing"></a>ICMP ping が失敗する

[Virtual Network NAT](nat-overview.md) では、IPv4 UDP および TCP プロトコルがサポートされています。 ICMP はサポートされておらず、失敗することが予想されます。  

_**解決方法:**_ 代わりに、TCP 接続テスト ("TCP ping" など) と UDP 固有のアプリケーション レイヤー テストを使用して、エンド ツー エンドの接続を検証します。

次の表は、テストを開始するために使用するツールの出発点として使用できます。

| オペレーティング システム | 汎用 TCP 接続テスト | TCP アプリケーション レイヤー テスト | UDP |
|---|---|---|---|
| Linux | nc (汎用接続テスト) | curl (TCP アプリケーション レイヤー テスト) | アプリケーション固有 |
| Windows | [PsPing](/sysinternals/downloads/psping) | PowerShell [Invoke-WebRequest](/powershell/module/microsoft.powershell.utility/invoke-webrequest) | アプリケーション固有 |

### <a name="connectivity-failures"></a>接続エラー

[Virtual Network NAT](nat-overview.md) に関する接続の問題は、いくつかの異なる問題が原因で発生します。

* 構成の誤りによる永続的なエラー。
* NAT ゲートウェイの一時的または永続的な [SNAT の枯渇](#snat-exhaustion)。
* Azure インフラストラクチャにおける一時的な障害。 
* Azure とパブリック インターネットの宛先との間のパスに生じた一時的な障害。 
* パブリック インターネットの宛先における一時的または永続的な障害。

接続の検証には、次のようなツールを使用します。 [ICMP はサポートされていません](#icmp-ping-is-failing)。

| オペレーティング システム | 汎用 TCP 接続テスト | TCP アプリケーション レイヤー テスト | UDP |
|---|---|---|---|
| Linux | nc (汎用接続テスト) | curl (TCP アプリケーション レイヤー テスト) | アプリケーション固有 |
| Windows | [PsPing](/sysinternals/downloads/psping) | PowerShell [Invoke-WebRequest](/powershell/module/microsoft.powershell.utility/invoke-webrequest) | アプリケーション固有 |

#### <a name="configuration"></a>構成

構成を確認します。
1. NAT ゲートウェイ リソースに少なくとも 1 つのパブリック IP リソースまたは 1 つのパブリック IP プレフィックス リソースがありますか? アウトバウンド接続を提供できるようにするには、NAT ゲートウェイに少なくとも 1 つの IP アドレスが関連付けられている必要があります。
2. 仮想ネットワークのサブネットは NAT ゲートウェイを使用するように構成されていますか。
3. UDR (ユーザー定義ルート) を使用していて、宛先をオーバーライドしていますか。  NAT ゲートウェイ リソースは、構成されたサブネット上の既定のルート (0/0) になります。

#### <a name="snat-exhaustion"></a>SNAT の枯渇

この記事の「[SNAT の枯渇](#snat-exhaustion)」セクションを参照してください。

#### <a name="azure-infrastructure"></a>Azure インフラストラクチャ

Azure では、そのインフラストラクチャが慎重に監視され、運用されます。 一時的な障害が発生する可能性があります。転送が無損失であるという保証はありません。  TCP アプリケーションには、SYN 再送を見込んだ設計パターンを使用してください。 SYN パケットの損失によって生じる一時的な影響を軽減するために、接続タイムアウトには、TCP SYN 再送ができるだけの十分な長さを確保します。

_**解決方法:**_

* [SNAT の枯渇](#snat-exhaustion)が生じていないかチェックします。
* SYN 再送の動作を制御する TCP スタックの構成パラメーターは、RTO ([Retransmission Time-Out: 再送タイムアウト](https://tools.ietf.org/html/rfc793)) と呼ばれます。 RTO の値は調整できますが、通常は 1 秒以上で、指数バックオフが既定で使用されます。  アプリケーションの接続タイムアウトが短すぎると (1 秒など)、接続タイムアウトが散発的に発生する可能性があります。  アプリケーションの接続タイムアウトを長くしてください。
* 既定のアプリケーションの動作でタイムアウトが予想以上に長いと感じられる場合は、サポート ケースを開いて詳細なトラブルシューティングを行ってください。

人為的に TCP 接続タイムアウトを短縮したり、RTO パラメーターをチューニングしたりすることはお勧めしません。

#### <a name="public-internet-transit"></a>パブリック インターネット トランジット

宛先までのパスが長くなって中間システムが増えるほど、一時的な障害が発生する確率は高くなります。 [Azure インフラストラクチャ](#azure-infrastructure)と比べ、一時的な障害の頻度は高くなることが予想されます。 

前出の「[Azure インフラストラクチャ](#azure-infrastructure)」セクションと同じガイダンスに従ってください。

#### <a name="internet-endpoint"></a>インターネット エンドポイント

通信の確立に用いられるインターネット エンドポイントと共に、前のセクションが当てはまります。 その他、以下の要因も、接続の成功に影響を及ぼす可能性があります。

* 宛先側でのトラフィック管理 (以下を含む)
- 宛先側によって課される API レート制限
- Volumetric DDoS の軽減策やトランスポート層のトラフィック シェイプ
* ファイアウォールなど、宛先側のコンポーネント 

通常、発生している事象を調査するためには、送信元と宛先 (可能な場合) でのパケット キャプチャが必要です。

_**解決方法:**_

* [SNAT の枯渇](#snat-exhaustion)が生じていないかチェックします。 
* 同じリージョン (または比較のために他のリージョン) のエンドポイントとの接続を確認します。  
* 大容量または高トランザクション速度のテストを実施している場合、速度を落とすことでエラーの頻度が下がるかどうかを調べます。
* 速度を変えることでエラーの割合に変化が生じる場合は、API 速度制限など、宛先側の制約が上限に達しているかどうかを確認します。
* 調査しても結論が出ない場合は、サポート ケースを開いて詳細なトラブルシューティングを行ってください。

#### <a name="tcp-resets-received"></a>TCP リセットの受信

NAT ゲートウェイでは、進行中として認識されないトラフィックに対して、送信元 VM で TCP がリセットされます。

考えられる原因の 1 つは、TCP 接続のアイドル タイムアウトです。アイドル タイムアウトは、4 分から最大 120 分までの範囲で調整できます。

TCP リセットが NAT ゲートウェイ リソースのパブリック側で生成されることはありません。 宛先側の TCP リセットは、NAT ゲートウェイ リソースではなく、送信元 VM で生成されます。

_**解決方法:**_

* [設計パターン](#design-patterns)の推奨事項を確認します。  
* 必要であれば、サポート ケースを開いて詳細なトラブルシューティングを行ってください。

### <a name="ipv6-coexistence"></a>IPv6 の共存

[Virtual Network NAT](nat-overview.md) では、IPv4 UDP および TCP プロトコルがサポートされています。 NAT を、IPv6 パブリック IP アドレスまたは IPv6 パブリック IP プレフィックスに関連付けることはできません。 ただし、デュアル スタック サブネットに NAT をデプロイすることは可能です。

_**解決策:**_ デュアル スタック サブネットに NAT ゲートウェイをデプロイします。

### <a name="connection-doesnt-originate-from-nat-gateway-ips"></a>NAT ゲートウェイ IP から接続が行われない

NAT ゲートウェイ、使用する IP アドレス、NAT ゲートウェイ リソースを使用するサブネットを構成します。 しかし、NAT ゲートウェイが展開される前から存在していた仮想マシン インスタンスからの接続では、その IP アドレスは使用されません。  NAT ゲートウェイ リソースで使用されていない IP アドレスを使用しているようです。

_**解決方法:**_

[Virtual Network NAT](nat-overview.md) によって、構成されているサブネットの送信接続が置き換えられます。 既定の SNAT またはロード バランサーの送信 SNAT から NAT ゲートウェイを使用するように切り替えると、新しい接続から NAT ゲートウェイ リソースに関連付けられた IP アドレスの使用が直ちに開始されます。  しかし、NAT ゲートウェイ リソースへの切り替え中に、仮想マシンの接続が引き続き確立されている場合、接続の確立時に割り当てられた古い SNAT IP アドレスを使用して接続が続行されます。  OS またはブラウザーが接続プール内の接続をキャッシュしていたため、既に存在する接続を再利用するのではなく、新しい接続を実際に確立していることを確認してください。  たとえば、PowerShell で _curl_ を使用する場合は、新しい接続を強制するために _-DisableKeepalive_ パラメーターを必ず指定します。  ブラウザーを使用している場合は、接続をプールすることもできます。

NAT ゲートウェイ リソースのサブネットを構成する仮想マシンを再起動する必要はありません。  しかし、仮想マシンが再起動されると、接続状態がフラッシュされます。  接続状態がフラッシュされると、すべての接続で NAT ゲートウェイ リソースの IP アドレスの使用が開始されます。  しかし、これは再起動される仮想マシンの副作用であり、再起動が必要なインジケーターではありません。

それでも問題が解決しない場合は、さらにトラブルシューティングを行うためにサポート ケースを開いてください。

## <a name="next-steps"></a>次のステップ

* [Virtual Network NAT](nat-overview.md) について学習する。
* [NAT ゲートウェイ リソース](nat-gateway-resource.md)について学習する
* [NAT ゲートウェイ リソースのメトリックとアラート](nat-metrics.md)について学習する。
