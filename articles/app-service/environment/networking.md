---
title: App Service Environment のネットワーク
description: App Service Environment のネットワークの詳細
author: madsd
ms.topic: overview
ms.date: 11/15/2021
ms.author: madsd
ms.openlocfilehash: cdedc94e64a0646c7e4ffa8c93f082d040e440c7
ms.sourcegitcommit: 2ed2d9d6227cf5e7ba9ecf52bf518dff63457a59
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 11/16/2021
ms.locfileid: "132524077"
---
# <a name="app-service-environment-networking"></a>App Service Environment のネットワーク

> [!NOTE]
> これは、Isolated v2 App Service プランで使用される App Service Environment v3 に関する記事です
> 

App Service Environment (ASE) は、Windows および Linux のコンテナー、Web アプリ、API アプリ、ロジック アプリ、および関数アプリがホストされる Azure App Service のシングル テナント デプロイです。 ASE をインストールするときに、デプロイする Azure Virtual Network を選択します。 すべての受信および送信アプリケーション トラフィックは、指定した仮想ネットワーク内に配置されます。 ASE は、仮想ネットワーク内の 1 つのサブネットにデプロイされます。 それと同じサブネットには、他の何もデプロイできません。

## <a name="subnet-requirements"></a>サブネットの要件

サブネットは Microsoft.Web/hostingEnvironments に委任され、かつ空である必要があります。

サブネットのサイズが、ASE 内の App Service プラン インスタンスのスケーリング制限に影響を与える場合があります。 運用規模をサポートするための十分なアドレスを確保するために、サブネットには `/24` アドレス空間 (256 アドレス) を使用することをお勧めします。

それより小さなサブネットを使用するには、ASE とネットワークの設定の次の詳細に注意する必要があります。

特定のどのサブネットにも、管理のために予約されている 5 つのアドレスがあります。 管理アドレスに加えて、ASE ではサポート インフラストラクチャを動的にスケーリングし、構成と負荷に応じて 4 から 27 個のアドレスを使用します。 残りのアドレスは、App Service プランのインスタンスに使用できます。 サブネットの最小サイズは `/27` アドレス空間 (32 アドレス) です。

サブネット内のアドレスが不足している場合、ASE での App Service プランのスケールアウトが制限されたり、サポート インフラストラクチャをスケーリングできない場合、トラフィック負荷の集中時に待機時間が長くなったりすることがあります。

## <a name="addresses"></a>アドレス

ASE は作成時に以下の情報を持つことになります。

| アドレスの種類 | description |
|--------------|-------------|
| ASE 仮想ネットワーク | ASE がデプロイされる仮想ネットワーク |
| ASE サブネット | ASE のデプロイ先サブネット |
| ［ドメイン サフィックス］ | この ASE 内に作成されたアプリによって使用されるドメイン サフィックス |
| 仮想 IP | この設定は、ASE によって使用される VIP の種類です。 有効な値は、内部と外部の 2 つです。 |
| 受信アドレス | 受信アドレスは、この ASE 上のアプリに到達する場所のアドレスです。 内部 VIP がある場合は、ASE サブネット内の 1 つのアドレスです。 アドレスが外部である場合は、パブリックに公開されるアドレスとなります |
| 既定の送信アドレス | この ASE 内のアプリでは、インターネットへの送信呼び出しを行うときに、既定でこのアドレスが使用されます。 |

ASEv3 では、ASE ポータルの **[IP アドレス]** 部分に ASE によって使用されるアドレスに関する詳細が含まれています。

![ASE アドレスの UI](./media/networking/networking-ip-addresses.png)

ASE で App Service プランをスケーリングする際には、ASE サブネットのアドレスをより多く使用することになります。 使用されるアドレスの数は、使用している App Service プランのインスタンス数と、ASE でどれだけのトラフィックを受信しているかに基づいて変動します。 ASE 内のアプリには、ASE サブネット内での専用アドレスはありません。 ASE サブネット内でアプリによって使用される実際のアドレスは、時間の経過と共に変化します。

## <a name="ports-and-network-restrictions"></a>ポートとネットワークの制限

アプリがトラフィックを受信できるようにするには、受信ネットワークセキュリティグループ (NSGs) ルールで ASE サブネットが必要なポートからトラフィックを受信できるようにする必要があります。 トラフィックを受信するポートに加えて、AzureLoadBalancer がポート 80 で ASE サブネットに接続できることを確認する必要があります。 これは、内部の VM の正常性チェックに使用されます。 その場合でも、仮想ネットワークから ASE サブネットへのポート 80 のトラフィックを制御できます。

一般的に推奨されるのは、次の受信 NSG ルールを構成することです。

|ポート|ソース|到着地|
|-|-|-|
|80,443|VirtualNetwork|ASE サブネット範囲|

ASE を運用するための最小要件は次のとおりです。

|ポート|ソース|到着地|
|-|-|-|
|80|AzureLoadBalancer|ASE サブネット範囲|

最低限必要なルールを使用する場合は、アプリケーション トラフィック用に 1 つ以上のルールが必要になることがあります。また、デプロイ オプションまたはデバッグ オプションを使用している場合は、ASE サブネットへのこのトラフィックも許可する必要があります。 これらのルールのソースは、VirtualNetwork、または 1 つ以上の特定のクライアント IP または IP 範囲にすることができます。 宛先は常に ASE サブネットの範囲になります。

通常のアプリのアクセス ポートは次のとおりです。

|用途|Port|
|-|-|
|HTTP/HTTPS|80、443|
|FTP/FTPS|21、990、10001-10020|
|Visual Studio リモート デバッグ|4022、4024、4026|
|Web 配置サービス|8172|

## <a name="network-routing"></a>ネットワーク ルーティング

制限なしでルート テーブル (UDR) を設定できます。 ASE から、Azure Firewall などのエグレス ファイアウォール デバイスへのすべての送信アプリケーション トラフィックを強制的にトンネリングすることがで、アプリケーションの依存関係以外のことを心配する必要がありません。 ASE への受信トラフィックの前に、Application Gateway などの WAF デバイスを配置し、その ASE 上の特定のアプリを公開できます。 ASE でアプリケーションの送信アドレスをカスタマイズする場合は、ASE サブネットに NAT ゲートウェイを追加できます。

## <a name="dns"></a>DNS

以下のセクションでは、 DNS の考慮事項と、ASE での受信および ASE からの発信の構成について説明します。

### <a name="dns-configuration-to-your-ase"></a>ASE に対する DNS 構成

外部 VIP のある ASE が作成された場合、アプリは自動的にパブリック DNS に登録されます。 内部 VIP のある ASE が作成された場合は、それのために DNS を構成する必要が生じることがあります。 ASE の作成中に Azure DNS プライベート ゾーンが自動的に構成されるようにすることを選択した場合は、ASE 仮想ネットワーク内に DNS が構成されます。 DNS を手動で構成することを選択した場合は、独自の DNS サーバーを使用するか、Azure DNS プライベート ゾーンを構成する必要があります。 ASE の受信アドレスを見つけるには、 **[ASE ポータル] > [IP アドレス]** UI に移動します。 

独自の DNS サーバーを使用する場合は、以下のレコードを追加する必要があります。

1. `<ASE-name>.appserviceenvironment.net` のゾーンを作成する
1. ASE で使用される受信 IP アドレスに * をポイントする A レコードをそのゾーン内に作成する
1. ASE で使用される受信 IP アドレスに @ をポイントする A レコードをそのゾーン内に作成する
1. scm という名前のゾーンを `<ASE-name>.appserviceenvironment.net` に作成する
1. scm ゾーン内で、* に ASE プライベート エンドポイントで使用される IP アドレスを指し示す A レコードを作成する

Azure DNS プライベート ゾーンで DNS を構成するには、次の操作を行ってください。

1. `<ASE-name>.appserviceenvironment.net` という名前の Azure DNS プライベート ゾーンを作成する
1. そのゾーン内で、* に受信 IP アドレスを指し示す A レコードを作成する
1. 受信 IP アドレスに @ をポイントする A レコードをそのゾーン内に作成する
1. 受信 IP アドレスに *.scm をポイントする A レコードをそのゾーン内に作成する

アプリの作成時に提供される既定のドメインに加えて、カスタム ドメインをアプリに追加することもできます。 ILB ASE では、アプリの検証なしでカスタム ドメイン名を設定できます。 カスタム ドメインを使用している場合は、DNS レコードがそれらに構成されていることを確認する必要があります。 上記のガイダンスに従って、既定のドメイン名をカスタム ドメイン名に置き換え、カスタム ドメイン名の DNS ゾーンとレコードを構成できます。 カスタム ドメイン名はアプリ要求に対して機能しますが、scm サイトでは使用できません。 scm サイトは、 *&lt;appname&gt;.scm.&lt;asename&gt;.appserviceenvironment.net* でのみ使用できます。

### <a name="dns-configuration-from-your-ase"></a>ASE からの DNS の構成

ASE 内のアプリでは、仮想ネットワークの構成で使用されている DNS が使用されます。 一部のアプリで、仮想ネットワークが構成されているものとは異なる DNS サーバーを使用するようにしたい場合は、アプリ設定 WEBSITE_DNS_SERVER と WEBSITE_DNS_ALT_SERVER を使用して、アプリごとに手動でそれを設定できます。 アプリの設定 WEBSITE_DNS_ALT_SERVER により、セカンダリ DNS サーバーが構成されます。 セカンダリ DNS サーバーは、プライマリ DNS サーバーからの応答がない場合にのみ使用されます。

## <a name="limitations"></a>制限事項

ASE は確かに顧客の仮想ネットワークにデプロイされますが、ASE では使用できないネットワーク機能がいくつか存在します。

* SMTP トラフィックの送信。 メールでトリガーされるアラートは引き続き使用できますが、アプリからはポート 25 で送信トラフィックを送信できません
* 送信トラフィックを監視するための Network Watcher または NSG フローの使用

## <a name="more-resources"></a>その他のリソース

- [環境変数とアプリ設定のリファレンス](../reference-app-settings.md)