---
title: 必要なサブネットサイズおよび範囲を決める
titleSuffix: Azure SQL Managed Instance
description: このトピックでは、Azure SQL Managed Instance のデプロイ先となるサブネットのサイズを計算する方法について説明します。
services: sql-database
ms.service: sql-managed-instance
ms.subservice: deployment-configuration
ms.custom: seo-lt-2019, sqldbrb=1
ms.devlang: ''
ms.topic: how-to
author: srdan-bozovic-msft
ms.author: srbozovi
ms.reviewer: mathoma, bonova, srbozovi, wiassaf
ms.date: 06/14/2021
ms.openlocfilehash: e3c789ec59e66189753c8515235b2375aa20e5f1
ms.sourcegitcommit: 6f4378f2afa31eddab91d84f7b33a58e3e7e78c1
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 07/13/2021
ms.locfileid: "113687403"
---
# <a name="determine-required-subnet-size-and-range-for-azure-sql-managed-instance"></a>Azure SQL Managed Instance に必要なサブネット サイズおよび範囲を決める
[!INCLUDE[appliesto-sqlmi](../includes/appliesto-sqlmi.md)]

Azure SQL Managed Instance は、Azure [仮想ネットワーク](../../virtual-network/virtual-networks-overview.md)内にデプロイする必要があります。 仮想ネットワークのサブネットにデプロイできるマネージド インスタンスの数は、そのサブネットのサイズ (サブネット範囲) によって決まります。

マネージド インスタンスを作成する場合、Azure では、プロビジョニング中に選択した階層に応じて仮想マシンの数が割り当てられます。 これらの仮想マシンはお使いのサブネットに関連付けられているため、IP アドレスが必要です。 通常運用時とサービス メンテナンス時の高可用性を確保するために、Azure によってさらに仮想マシンが割り当てられることがあります。 この場合、サブネット内の必要な IP アドレスの数は、そのサブネット内のマネージド インスタンスの数より大きくなります。

仕様上、マネージド インスタンスにはサブネット内で 32 個以上の IP アドレスが必要です。 そのため、サブネットの IP 範囲の定義時には、最小で /27 サブネット マスクを使用することができます。 マネージド インスタンスのデプロイでは、サブネットのサイズを慎重に計画することをお勧めします。 計画時には次のことを考慮してください。

- 以下のインスタンス パラメーターを含むマネージド インスタンスの数。
  - サービス階層
  - ハードウェアの世代
  - 仮想コアの数
  - [メンテナンス期間](../database/maintenance-window.md)
- サービス レベルのスケールアップ、スケールダウン、または変更の計画

> [!IMPORTANT]
> 単一のマネージド インスタンスをデプロイ可能なサブネット サイズは、IP アドレス 16 個分 (/28 サブネット マスク) です。 これは評価用か、スケーリング操作を実施しない Dev/Test シナリオ用としてのみ使用してください。 

## <a name="determine-subnet-size"></a>サブネットのサイズを決める

将来的なインスタンスのデプロイとスケーリングのニーズに応じて、サブネットのサイズを設定します。 次のパラメーターを使用すると、計算を簡単に行うことができます。

- Azure では、Azure 自体のためにサブネット内の IP アドレス 5 個を使用します。
- 各仮想クラスターでは、追加のアドレスを割り当てます。 
- 各マネージド インスタンスでは、価格レベルとハードウェアの世代に応じた数のアドレスを使用します。
- 各スケーリング要求では、追加のアドレスを一時的に割り当てます。

> [!IMPORTANT]
> サブネット内にリソースが存在する場合、サブネットのアドレス範囲を変更することはできません。 また、あるサブネットから別のサブネットにマネージド インスタンスを移動することはできません。 将来的に問題が発生しないように、小さいサブネットよりも大きなサブネットを使用することをお勧めします。

GP = 汎用、BC = ビジネス クリティカル、VC = 仮想クラスター

| **ハードウェアの世代** | **価格レベル** | **Azure での使用** | **VC での使用** | **インスタンスでの使用** | **合計** |
| --- | --- | --- | --- | --- | --- |
| Gen4 | GP | 5 | 1 | 5 | 11 |
| Gen4 | BC | 5 | 1 | 5 | 11 |
| 第 5 世代 | GP | 5 | 6 | 3 | 14 |
| 第 5 世代 | BC | 5 | 6 | 5 | 16 |

上記の表では、

- **合計** 列には、サブネットにデプロイしたインスタンス 1 つあたりで使用されるアドレスの合計数を示しています。 
- サブネットにインスタンスを追加すると、インスタンスで使用されるアドレスの数が増加します。 また、合計アドレス数も増加します。 たとえば、Gen4 GP マネージド インスタンスを 1 つ追加した場合、**インスタンスでの使用** 値が 10、使用されるアドレスの数の **合計** 値が 16 に増加します。 
- **Azure での使用** 列に示されているアドレスは、複数の仮想クラスターで共有されます。  
- **VC での使用** 列に示されているアドレスは、複数の仮想クラスターで共有されます。

また、サブネットのサイズを決定する場合には、[メンテナンス期間機能](../database/maintenance-window.md)も考慮してください。これは特に、同じサブネット内に複数のインスタンスをデプロイする場合に重要です。 作成時または作成後にメンテナンス期間を指定したマネージド インスタンスは、相当するメンテナンス期間が指定されている仮想クラスターに配置されます。 そのような仮想クラスターがサブネット内に存在しない場合は、そのインスタンスを格納するために、最初に新しいものを作成する必要があります。

通常、更新操作を実行するには、[仮想クラスターのサイズ変更](management-operations-overview.md)が必要です。 SQL Managed Instance サービスは、新しい作成要求または更新要求を受信すると、新しいノードの追加を求めたコンピューティング プラットフォームと通信します。 デプロイ システムは、コンピューティングの応答に基づいて、既存の仮想クラスターを拡張するか、新しい仮想クラスターを作成します。 ほとんどのケースでは、操作が同じ仮想クラスター内で完結する場合であっても、コンピューティング側に新しいクラスターが作成されます。 


## <a name="update-scenarios"></a>更新シナリオ

スケーリング操作時、インスタンスには、価格レベルおよびハードウェアの世代に応じて追加の IP 容量が一時的に必要になります。

| **ハードウェアの世代** | **価格レベル** | **シナリオ** | **追加のアドレス数**  |
| --- | --- | --- | --- |
| Gen4<sup>1</sup> | GP または BC | 仮想コアのスケーリング | 5 |
| Gen4<sup>1</sup> | GP または BC | ストレージのスケーリング | 5 |
| Gen4 | GP または BC | GP から BC または BC から GP への切り替え | 5 |
| Gen4 | GP | Gen5 への切り替え | 9 |
| Gen4 | BC | Gen5 への切り替え | 11 |
| 第 5 世代 | GP | 仮想コアのスケーリング | 3 |
| 第 5 世代 | GP | ストレージのスケーリング | 0 |
| 第 5 世代 | GP | BC への切り替え | 5 |
| 第 5 世代 | BC | 仮想コアのスケーリング | 5 |
| 第 5 世代 | BC | ストレージのスケーリング | 5 |
| 第 5 世代 | BC | GP への切り替え | 3 |

<sup>1</sup> Gen4 ハードウェアは段階的に廃止中であり、新しいデプロイでは利用できなくなりました。 ハードウェアの世代を Gen4 から Gen5 に更新することで、Gen5 固有の機能を活用できます。
  
## <a name="calculate-the-number-of-ip-addresses"></a>IP アドレスの数を計算する

IP アドレスの総数を計算する場合、次の式をお勧めします。 この式では、後の作成要求またはインスタンスの更新で新しい仮想クラスターが作成される可能性を考慮しています。 また、仮想クラスターのメンテナンス期間の要件も考慮しています。

**式: 5 + (a * 12) + (b * 16) + (c * 16)**

- a = GP インスタンスの数
- b = BC インスタンスの数
- c = 異なるメンテナンス期間構成の数

説明:
- 5 = Azure で予約されている IP アドレスの数
- GP インスタンスあたりアドレス 12 個 = 仮想クラスター用 6 個 + マネージド インスタンス用 3 個 + スケーリング操作用 3 個
- BC インスタンスあたりアドレス 16 個 = 仮想クラスター用 6 個 + マネージド インスタンス用 5 個 + スケーリング操作用 5 個
- バックアップ用アドレス 16 個 = 新しい仮想クラスターが作成されるシナリオ

例: 
- General Purpose マネージド インスタンス 3 つおよび Business Critical マネージド インスタンス 2 つを同じサブネット内に展開するとします。 すべてのインスタンスに、同じメンテナンス期間を構成します。 この場合、IP アドレスは 5 + (3 * 12) + (2 * 16) + (1 * 16) = 89 個必要になります。 

  IP 範囲は 2 の累乗で定義されるので、サブネットでは、このデプロイに対して最小で 128 (2^7) の IP 範囲が必要です。 予約する必要があるサブネットは、/25 サブネット マスクのものになります。

> [!NOTE]
> サブネットの計算式の結果よりも IP アドレス数が少ないサブネットにマネージド インスタンスをデプロイすることは可能ですが、どのような場合でも、大きいサブネットを利用することをお勧めします。 使用するサブネットを大きくすることで、サブネット内にインスタンスを追加作成できない、既存のインスタンスをスケーリングできないなど、IP アドレスの不足に起因する問題が将来発生する事態を防ぐことができます。 

## <a name="next-steps"></a>次のステップ

- 概要については、「[Azure SQL Managed Instance とは](sql-managed-instance-paas-overview.md)」を参照してください。
- [SQL Managed Instance の接続アーキテクチャ](connectivity-architecture-overview.md)の詳細を確認します。
- [SQL Managed Instance のデプロイ先となる仮想ネットワークの作成](virtual-network-subnet-create-arm-template.md)方法を確認します。
- DNS の問題については、[カスタム DNS の構成](custom-dns-configure.md)に関するページを参照してください。
