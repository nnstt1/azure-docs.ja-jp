---
title: Azure SQL Database のデータベース アドバイザーのパフォーマンスに関する推奨事項
description: Azure SQL Database では、Azure SQL Database でのクエリのパフォーマンスを向上させることができる、データベース向けの推奨事項が提供されます。
services: sql-database
ms.service: sql-database
ms.subservice: performance
ms.custom: fasttrack-edit, sqldbrb=1
ms.devlang: ''
ms.topic: conceptual
author: NikaKinska
ms.author: nnikolic
ms.reviewer: mathoma, wiassaf
ms.date: 03/10/2020
ms.openlocfilehash: b4959d2f7f65d4a9896a2e293f47a00ed84b1acd
ms.sourcegitcommit: b11257b15f7f16ed01b9a78c471debb81c30f20c
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 06/08/2021
ms.locfileid: "111590938"
---
# <a name="database-advisor-performance-recommendations-for-azure-sql-database"></a>Azure SQL Database のデータベース アドバイザーのパフォーマンスに関する推奨事項
[!INCLUDE[appliesto-sqldb](../includes/appliesto-sqldb.md)]

Azure SQL Database は、ご使用のアプリケーションを学習して適応します。 Azure SQL Database には、パフォーマンスを最大化するためのカスタマイズされた推奨事項を提供するデータベース アドバイザーが多数用意されています。 これらのデータベース アドバイザーでは、使用履歴の評価と分析が継続的に実行され、パフォーマンスの向上に役立つワークロード パターンに基づく推奨事項が提供されます。

## <a name="performance-overview"></a>パフォーマンスの概要

パフォーマンスの概要では、データベースのパフォーマンスの概要について説明します。パフォーマンスのチューニングとトラブルシューティングを行う際に役立ちます。

![Azure SQL Database のパフォーマンスの概要](./media/database-advisor-implement-performance-recommendations/performance-overview-annotated.png)

- **[推奨事項]** タイルには、データベースのチューニングに関する推奨事項の内訳が表示されます (推奨事項が 4 つ以上ある場合は、上から 3 番目までが表示されます)。 このタイルをクリックすると、 **[[パフォーマンスの推奨事項]](database-advisor-find-recommendations-portal.md#viewing-recommendations)** が表示されます。
- **[Tuning activity]** タイルには、データベースに対して進行中のチューニング操作と完了したチューニング操作の概要が表示され、チューニング操作の履歴を簡単に確認できます。 このタイルをクリックすると、データベースのチューニング履歴がすべて表示されます。
- **[Auto-tuning]\(自動チューニング\)** タイルには、データベースの **[自動チューニング構成](automatic-tuning-enable.md)** (データベースに自動的に適用されるチューニング オプション) が表示されます。 このタイルをクリックすると、自動構成のダイアログが開きます。
- **[Database queries]** タイルには、データベースのクエリ パフォーマンスの概要 (全体的な DTU 使用量と上位のリソース消費に関するクエリ) が表示されます。 このタイルをクリックすると、 **[[Query Performance Insight]](query-performance-insight-use.md)** が表示されます。

## <a name="performance-recommendation-options"></a>パフォーマンスに関する推奨事項のオプション

Azure SQL Database で使用できるパフォーマンスに関する推奨事項のオプションは次のとおりです。

| パフォーマンスに関する推奨事項 | 単一データベースとプールされたデータベースのサポート | インスタンス データベースのサポート |
| :----------------------------- | ----- | ----- |
| **インデックスの作成に関する推奨事項** - ワークロードのパフォーマンスを向上させることができるインデックスの作成を推奨します。 | はい | いいえ |
| **インデックスの削除に関する推奨事項** - 一意なインデックスを除く冗長なインデックスや重複するインデックスの日次削除、また長期間 (90 日超) 使用されていないインデックスの削除を推奨します。 なお、このオプションはパーティション切り替えやインデックス ヒントを使用するアプリケーションと互換性がありません。 Premium および Business Critical サービスレベルでは、使われていないインデックスの削除はサポートされていません。 | はい | いいえ |
| **クエリのパラメーター化に関する推奨事項 (プレビュー)** - 継続的に再コンパイルされてはいるもののクエリ実行プランが同じままのクエリが 1 つ以上ある場合、強制パラメーター化を推奨します。 | はい | いいえ |
| **スキーマの問題の修正に関する推奨事項 (プレビュー)** - データベースで発生したスキーマ関連の SQL エラー数が異常であることが Azure SQL Database で検出すると、スキーマの修正の推奨事項が表示されます。 Microsoft は、現在、"スキーマの問題の修正" に関する推奨事項を廃止しているところです。 | はい | いいえ |

![Azure SQL Database のパフォーマンスに関する推奨事項](./media/database-advisor-implement-performance-recommendations/performance-recommendations-annotated.png)

パフォーマンスに関する推奨事項を適用するには、「[推奨事項の適用](database-advisor-find-recommendations-portal.md#applying-recommendations)」を参照してください。 推奨事項の状態を表示するには、「[監視操作](database-advisor-find-recommendations-portal.md#monitoring-operations)」を参照してください。

また、過去に適用されたチューニング アクションの履歴すべてを表示することもできます。

## <a name="create-index-recommendations"></a>インデックスの作成に関する推奨事項

Azure SQL Database は、実行されるクエリを継続的に監視し、パフォーマンスを改善する可能性があるインデックスを特定します。 特定のインデックスが欠落していることが確実になると、新しい **インデックスの作成** 推奨事項が作成されます。

Azure SQL Database は、一定の期間後にインデックスがもたらすパフォーマンス増加を見積もることで確信度を高めます。 見積もられたパフォーマンス増加に基づき、推奨事項は高、中、低で分類されます。

推奨事項を利用して作成されたインデックスには常に auto_created というフラグが設定されます。 [sys.indexes](/sql/relational-databases/system-catalog-views/sys-indexes-transact-sql) ビューを見ることで、どのインデックスが自動作成されたかを確認できます。 自動作成されたインデックスによる ALTER/RENAME コマンドのブロックは発生しません。

auto-created インデックスが設定されている列を削除しようとすると、コマンドは成功します。 auto-created インデックスもこのコマンドによって削除されます。 通常のインデックスは、インデックスが付けられた列の ALTER/RENAME コマンドをブロックします。

インデックスの作成に関する推奨事項が適用されると、Azure SQL Database はクエリのパフォーマンスをベースライン パフォーマンスと比較します。 新しいインデックスによってパフォーマンスが向上した場合、推奨事項が成功したというフラグが設定され、影響レポートが生成されます。 インデックスによってパフォーマンスが向上しなかった場合、インデックスは自動的に元に戻されます。 Azure SQL Database は、このプロセスを使用して、推奨事項が確実にデータベース パフォーマンスを向上するようにします。

**インデックスの作成** に関する推奨事項にはバックオフ ポリシーがあります。データベースまたはプールのリソース使用率が高すぎる場合、推奨事項は適用されません。 バックオフ ポリシーでは、CPU、データ IO、ログ IO、および使用可能な記憶領域が考慮されます。

CPU、データ IO、ログ IO が直前の 30 分間で 80% を超えている場合、インデックス作成の推奨事項は延期されます。 インデックスの作成により使用可能な記憶領域が 10% を下回る場合は、推奨事項がエラー状態に変わります。 数日後に自動チューニングを行ってインデックスが有効であると示される場合には、プロセスが再び開始します。

このプロセスは、インデックスの作成に十分な使用可能領域がある限り、またはインデックスが有効でないと見なさるまで繰り返されます。

## <a name="drop-index-recommendations"></a>インデックスの削除に関する推奨事項

足りないインデックスの検出だけでなく、Azure SQL Database は既存インデックスのパフォーマンスを継続的に分析します。 インデックスが使用されない場合、Azure SQL Database はその削除を推奨します。 インデックスの削除は 2 つの場合に推奨されます。

- インデックスが別のインデックスと重複している場合 (同じインデックスを付けて追加された列、パーティション スキーマ、フィルター)
- インデックスが長期間 (93 日) 使用されていない場合

インデックスの削除に関する推奨事項は、実施後に検証も通過します。 パフォーマンスが改善されると、影響レポートが入手可能になります。 パフォーマンスが低下すると、推奨事項が元に戻されます。

## <a name="parameterize-queries-recommendations-preview"></a>クエリのパラメーター化に関する推奨事項 (プレビュー)

継続的に再コンパイルされてはいるもののクエリ実行プランが同じままのクエリが 1 つ以上あると、*クエリのパラメーター化* に関する推奨事項が表示されます。 この条件によって、強制パラメーター化を適用する機会が生成されます。 強制パラメーター化では、クエリ プランをキャッシュして将来再利用できるようになり、パフォーマンスが向上し、リソース使用率が削減されます。

すべてのクエリは、実行プランの生成のために、最初にコンパイルされる必要があります。 生成された各プランがプラン キャッシュに追加されます。 同じクエリのその後の実行では、キャッシュからプランを再利用できるため、追加のコンパイルの必要がなくなります。

パラメーター化されていない値を含むクエリは、パフォーマンスのオーバーヘッドにつながる可能性があります。パラメーター化されていない値が異なるたびに、実行プランが再コンパイルされるためです。 多くの場合、パラメーター値の異なる同じクエリによって同一の実行プランが生成されます。 しかし、これらのプランは個別にプラン キャッシュに追加されます。

実行プランを再コンパイルするプロセスにより、データベース リソースが消費され、クエリ実行時間の増加とプラン キャッシュのオーバーフローが発生します。 このようなイベントは、プランがキャッシュから削除される原因となります。 この動作は、データベースで強制パラメーター化のオプションを設定することにより変更できます。

推奨事項が与える影響の予測に役立つよう、実際の CPU 使用率、および予測される CPU 使用率 (推奨事項が適用されたと仮定した場合) の比較が提供されます。 この推奨事項は、CPU 使用率を抑えるために役立ちます。 また、クエリ期間の短縮と、プラン キャッシュのオーバーヘッドの削減にも役立ちます。つまり、キャッシュに残って再利用されるプランが増加することになります。 **[適用]** コマンドを選択して、迅速にこの推奨事項を適用できます。

この推奨事項を適用すると、数分以内にデータベースで強制パラメーター化が有効になります。 監視プロセスが開始され、約 24 時間続きます。 この期間が終了すると検証レポートを表示できます。 このレポートは、推奨事項の適用前後 24 時間のデータベースの CPU 使用率を示します。 Azure SQL Database Advisor は、パフォーマンスの不具合が検出された場合に、推奨事項の適用を自動的に元に戻す安全メカニズムを備えています。

## <a name="fix-schema-issues-recommendations-preview"></a>スキーマの問題の修正に関する推奨事項 (プレビュー)

> [!IMPORTANT]
> Microsoft は、現在、"スキーマの問題の修正" に関する推奨事項を廃止しているところです。 かつて "スキーマの問題の修正" 推奨事項で扱っていたスキーマの問題を含め、データベース パフォーマンスの問題を監視するには、[Intelligent Insights](intelligent-insights-overview.md) の使用をお勧めします。

Azure SQL Database によって、データベースで発生したスキーマ関連の SQL エラー数が異常であることが検出されると、 **[スキーマの問題の修正]** 推奨事項が表示されます。 この推奨事項は、通常、データベースでスキーマ関連のエラー (無効な列名、無効なオブジェクト名など) が 1 時間に複数件発生した場合に表示されます。

"スキーマの問題" は構文エラーの一種です。 SQL クエリの定義とデータベース スキーマの定義が合っていないときに発生します。 たとえば、クエリで想定される列の 1 つがターゲット テーブルで見つからない、あるいはその逆の場合です。

Azure SQL Database によって、データベースで発生したスキーマ関連の SQL エラー数が異常であることが検出されると、"スキーマの問題の修正" 推奨事項が表示されます。 下の表は、スキーマの問題に関連したエラーを示しています。

| SQL エラー コード | Message |
| --- | --- |
| 201 |プロシージャまたは関数 ' *' にはパラメーター '* ' が必要ですが、指定されませんでした。 |
| 207 |列名 '*' が無効です。 |
| 208 |オブジェクト名 '*' が無効です。 |
| 213 |列名または指定された値の数がテーブルの定義と一致しません。 |
| 2812 |ストアド プロシージャ '*' が見つかりませんでした。 |
| 8144 |プロシージャまたは関数 * に指定された引数が多すぎます。 |

## <a name="custom-applications"></a>カスタム アプリケーション

開発者は、Azure SQL Database のパフォーマンスに関する推奨事項に基づいて、カスタム アプリケーションの開発を検討する場合があります。 データベースのポータルに一覧表示されているすべての推奨事項には、[Get-AzSqlDatabaseRecommendedAction](/powershell/module/az.sql/get-azsqldatabaserecommendedaction) API を介してアクセスできます。

## <a name="next-steps"></a>次のステップ

- データベース インデックスとクエリ実行プランの自動チューニングについては、[Azure SQL Database の自動チューニング](automatic-tuning-overview.md)に関するページを参照してください。
- パフォーマンスの問題の自動診断および根本原因分析を含むデータベース パフォーマンスの自動監視については、[Azure SQL Intelligent Insights](intelligent-insights-overview.md) に関するページを参照してください。
- よく使用されるクエリによるパフォーマンスへの影響を確認する方法については、[クエリ パフォーマンスの洞察](query-performance-insight-use.md)に関する記事をご覧ください。