---
title: ファイアウォールと VNet の内側のアクセス可能なストレージ アカウントに脆弱性評価スキャンの結果を格納する
description: ファイアウォールまたは VNet 経由でアクセスできるストレージ アカウントに脆弱性評価 (VA) スキャンを格納する手順について説明します
services: sql-database
ms.service: sql-db-mi
ms.subservice: security
ms.topic: how-to
author: davidtrigano
ms.author: datrigan
ms.reviewer: vanto
ms.date: 11/10/2021
ms.openlocfilehash: 542f82afe044c0269cf788f09d222b7489d044a1
ms.sourcegitcommit: 677e8acc9a2e8b842e4aef4472599f9264e989e7
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 11/11/2021
ms.locfileid: "132347767"
---
# <a name="store-vulnerability-assessment-scan-results-in-a-storage-account-accessible-behind-firewalls-and-vnets"></a>ファイアウォールと VNet の内側のアクセス可能なストレージ アカウントに脆弱性評価スキャンの結果を格納する
[!INCLUDE[appliesto-sqldb-sqlmi-asa](../includes/appliesto-sqldb-sqlmi-asa.md)]

特定の VNet またはサービスに対して Azure のストレージ アカウントへのアクセスを制限している場合は、SQL データベースまたはマネージド インスタンスに対する脆弱性評価 (VA) スキャンがそのストレージ アカウントにアクセスできるように、適切な構成を有効にする必要があります。

## <a name="prerequisites"></a>前提条件

SQL 脆弱性評価サービスを使用してベースラインとスキャンの結果を保存するには、ストレージ アカウントへのアクセス許可が必要です。  次の 3 つのメソッドがあります。 
- **ストレージ アカウント キーを使用する**: Azure によって SAS キーが作成され、保存されます (ただし、アカウント キーは保存されません)
- **ストレージ SAS キーを使用する**: SAS キーには次のアクセス許可が必要です: 書き込み | リスト | 読み取り | 削除
- **SQL Server マネージド ID を使用する**: SQL Server にはマネージド ID が必要です。 ストレージ アカウントには、SQL マネージド ID に[ストレージ BLOB データ共同作成者](../../role-based-access-control/built-in-roles.md#storage-blob-data-contributor)としてのロールが割り当てられている必要があります。 設定を適用する際には、VA フィールドの storageContainerSasKey および storageAccountAccessKey を空にする必要があります。 ストレージがファイアウォールまたは仮想ネットワークの内側にある場合は、SQL マネージド ID が必要です。 

Azure portal を使用して SQL VA の設定を保存するときは、ストレージの[ストレージ BLOB データ共同作成者](../../role-based-access-control/built-in-roles.md#storage-blob-data-contributor)としての新しいロールの割り当てをマネージド ID に割り当てるアクセス許可がユーザーにあるかどうかが、Azure によって確認されます。 アクセス許可が割り当てられている場合、Azure では SQL Server マネージド ID が使用されます。それ以外の場合、Azure ではキー メソッドが使用されます 

## <a name="enable-azure-sql-database-va-scanning-access-to-the-storage-account"></a>Azure SQL Database VA スキャンのストレージ アカウントへのアクセスを有効にする

特定のネットワークまたはサービスのみがアクセスできるように VA ストレージ アカウントを構成した場合は、Azure SQL Database に対する VA スキャンがストレージ アカウントにスキャンを格納できることを確認する必要があります。 [論理 SQL サーバー](logical-servers.md) のすべてのデータベースに対する VA スキャン結果を格納するには、既存のストレージ アカウントを使用することも、新しいストレージ アカウントを作成することもできます。

> [!NOTE]
> ストレージ アクセス キーが必要な場合、脆弱性評価サービスは、ファイアウォールまたは VNet で保護されているストレージ アカウントにアクセスできません。

ストレージ アカウントが含まれている **[リソース グループ]** に移動し、 **[ストレージ アカウント]** ペインにアクセスします。 **[設定]** で、 **[ファイアウォールと仮想ネットワーク]** を選択します。

**[信頼された Microsoft サービスによるこのストレージ アカウントに対するアクセスを許可します]** チェック ボックスがオンになっていることを確認します。

:::image type="content" source="media/sql-database-vulnerability-assessment-storage/storage-allow-microsoft-services.png" alt-text="[信頼された Microsoft サービスによるこのストレージ アカウントに対するアクセスを許可します] が選択されている、[ファイアウォールと仮想ネットワーク] ダイアログ ボックスを示すスクリーンショット。":::

どのストレージ アカウントが使用されているかを確認するには、[Azure portal](https://portal.azure.com) で **[SQL サーバー]** ペインに移動し、 **[セキュリティ]** の下にある **[Defender for Cloud]** を選択します。

:::image type="content" source="../database/media/azure-defender-for-sql/va-storage.png" alt-text="脆弱性評価の設定":::

> [!NOTE]
> メール アラートを設定して、組織内のユーザーにスキャンレポートの表示やアクセスを通知することができます。 これを行うには、SQL Security Manager とストレージ BLOB データ閲覧者のアクセス許可を持っている必要があります。

## <a name="store-va-scan-results-for-azure-sql-managed-instance-in-a-storage-account-that-can-be-accessed-behind-a-firewall-or-vnet"></a>Azure SQL Managed Instance に対する VA スキャン結果を、ファイアウォールまたは VNet の内側でアクセスできるストレージ アカウントに格納する

Managed Instance は信頼された Microsoft サービスではなく、ストレージ アカウントとは異なる VNet を持っているため、VA スキャンを実行するとエラーが発生します。

Managed Instance に対する VA スキャンをサポートするには、次の手順に従います。

1. **[SQL Managed Instance]** ペインの **[概要]** 見出しの下にある **[仮想ネットワーク/サブネット]** リンクをクリックします。 **[仮想ネットワーク]** ペインが表示されます。

   :::image type="content" source="../managed-instance/media/public-endpoint-configure/mi-overview.png" alt-text="mi-overview2":::

1. **[設定]** で、 **[サブネット]** を選択します。 新しいペインで **[サブネット]** をクリックしてサブネットを追加し、それを *Microsoft.Sql\managedInstance* にデリゲートします。 詳細については、[サブネットの管理](../../virtual-network/virtual-network-manage-subnet.md)に関するページを参照してください。

   :::image type="content" source="media/sql-database-vulnerability-assessment-storage/mi-subnets.png" alt-text="Microsoft.sql\managedInstance にデリゲートされたサブネットを示すスクリーンショット。":::

1. **[仮想ネットワーク]** ペインで、 **[設定]** の下の **[サービス エンドポイント]** を選択します。 新しいペインで **[追加]** をクリックし、新しいサービス エンドポイントとして *Microsoft.Storage* サービスを追加します。 *ManagedInstance* サブネットが選択されていることを確認します。 **[追加]** をクリックします。

   :::image type="content" source="media/sql-database-vulnerability-assessment-storage/mi-service-endpoint.png" alt-text="エンドポイントとして Microsoft.Storage サービスを追加する、[サービス エンドポイントの追加] を示すスクリーンショット。":::

1. VA スキャンを格納するために選択した **ストレージ アカウント** に移動します。 **[設定]** で、 **[ファイアウォールと仮想ネットワーク]** を選択します。 **[既存の仮想ネットワークを追加]** をクリックします。 マネージド インスタンスの仮想ネットワークとサブネットを選択し、 **[追加]** をクリックします。

   :::image type="content" source="media/sql-database-vulnerability-assessment-storage/storage-firewall.png" alt-text="[既存の仮想ネットワークを追加] リンクが含まれている [ファイアウォールと仮想ネットワーク] ペインを示すスクリーンショット。":::

これで、マネージド インスタンスに対する VA スキャンをストレージ アカウントに格納できるようになりました。

## <a name="troubleshoot-vulnerability-assessment-scan-related-issues"></a>脆弱性評価スキャンに関連する問題のトラブルシューティング 

脆弱性評価スキャンに関連する一般的な問題のトラブルシューティングを行います。

### <a name="failure-to-save-vulnerability-assessment-settings"></a>脆弱性評価の設定を保存できない

ストレージ アカウントがいくつかの前提条件を満たしていない場合や、アクセス許可が不足している場合には、脆弱性評価の設定の変更を保存できないことがあります。

#### <a name="storage-account-requirements"></a>ストレージ アカウントの要件

脆弱性評価スキャン結果を保存するストレージ アカウントは、次の要件を満たしている必要があります。

- **型**: StorageV2 (General Purpose V2) または Storage (General Purpose V1)
- **パフォーマンス**: Standard (のみ)
- **リージョン**:ストレージは Azure SQL Server のインスタンスと同じリージョンにある必要があります。

これらの要件のいずれかが満たされていない場合、脆弱性評価の設定に加えた変更の保存は失敗します。

#### <a name="permissions"></a>アクセス許可 

脆弱性評価の設定に加えた変更を保存するには、次のアクセス許可が必要です。

- SQL Security Manager
- ストレージ BLOB データ閲覧者
- ストレージ アカウントに対する所有者ロール

新しいロールの割り当てを設定するには、ストレージ アカウントへの所有者またはユーザー管理者のアクセス許可と、次のアクセス許可が必要です。

- ストレージ BLOB データ所有者

### <a name="storage-account-isnt-visible-for-selection-in-vulnerability-assessment-settings"></a>ストレージ アカウントが脆弱性評価設定で選択対象として表示されない

ストレージ アカウントは、いくつかの理由でストレージ アカウント ピッカーに表示されない場合があります。

- お探しのストレージ アカウントが、選択したサブスクリプションに含まれていない。
- お探しのストレージ アカウントが、Azure SQL Server のインスタンスと同じリージョンにない。
- ストレージ アカウントに対する Microsoft.Storage/storageAccounts/read アクセス許可がない。

### <a name="failure-to-open-an-email-link-for-scan-results-or-cant-view-scan-results"></a>スキャン結果のメール リンクを開くことができない、またはスキャン結果を表示できない

必要なアクセス許可を持っていない場合や、スキャン結果を開いたり表示することに対応していないブラウザーを使用している場合は、スキャン結果に関する通知メールのリンクを開いたり、スキャン結果を表示したりすることができない場合があります。

#### <a name="permissions"></a>アクセス許可

スキャン結果に関するメール通知のリンクを開いたり、スキャン結果を表示するには、次のアクセス許可が必要です。

- SQL Security Manager
- ストレージ BLOB データ閲覧者

#### <a name="browser-requirements"></a>ブラウザー要件

Firefox ブラウザーでは、スキャン結果ビューを開く、または表示する機能はサポートされていません。 脆弱性評価スキャンの結果を表示するには、Chrome または Microsoft Edge を使用することをお勧めします。

## <a name="next-steps"></a>次のステップ

- [脆弱性評価](sql-vulnerability-assessment.md)
- [Azure ストレージ アカウントの作成](../../storage/common/storage-account-create.md)
- [Microsoft Defender for SQL](azure-defender-for-sql.md)
