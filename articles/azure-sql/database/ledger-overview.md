---
title: Azure SQL Database 台帳の概要
description: Azure SQL Database 台帳機能の基本について説明します。
ms.date: 09/09/2021
ms.service: sql-database
ms.subservice: security
ms.reviewer: vanto
ms.topic: conceptual
author: rothja
ms.author: jroth
ms.openlocfilehash: 07e999f70effc7141d66e01c8fea8686c6c133c7
ms.sourcegitcommit: 61f87d27e05547f3c22044c6aa42be8f23673256
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 11/09/2021
ms.locfileid: "132056988"
---
# <a name="azure-sql-database-ledger"></a>Azure SQL Database 台帳

[!INCLUDE[appliesto-sqldb](../includes/appliesto-sqldb.md)]

> [!NOTE]
> 現在、Azure SQL Database 台帳はパブリック プレビュー段階にあります。

データベース システムに格納されているデータの整合性に関する信頼を確立することは、財務、医療、その他の機密データを管理するすべての組織にとって長年の問題でした。 [Azure SQL Database](sql-database-paas-overview.md) の台帳機能は、データベースに改ざん防止機能を提供します。 監査者や他のビジネス関係者などの他の関係者に対して、データが改ざんされていないことを暗号学的に証明できます。

台帳は、攻撃者や、データベース管理者 (DBA)、システム管理者、クラウド管理者などの高い特権を持つユーザーからデータを保護するのに役立ちます。 従来の台帳と同様に、この機能では履歴データが保持されます。 データベース内の行が更新されると、以前の値が履歴テーブルに維持および保護されます。 台帳には、時間の経過とともにデータベースに加えられたすべての変更の記録が表示されます。 

台帳と履歴データは透過的に管理され、アプリケーションの変更を行わずに保護が提供されます。 この機能では、監査、フォレンジクス、その他の目的で SQL クエリをサポートするために、履歴データはリレーショナル形式で維持されます。 Azure SQL Database の機能、柔軟性、パフォーマンスを維持しつつ、暗号化データの整合性が保証されます。

:::image type="content" source="media/ledger/ledger-table-architecture.png" alt-text="台帳テーブル アーキテクチャの図。":::

## <a name="use-cases-for-azure-sql-database-ledger"></a>Azure SQL Database 台帳のユース ケース 

### <a name="streamlining-audits"></a>監査の合理化

運用システムの値は、システムで消費および生成されているデータを信頼できるかどうかに基づきます。 データベース内のデータが悪意のあるユーザーによって改ざんされた場合、そのデータに依存するビジネス プロセスに致命的な結果が生じる可能性があります。 

データに対する信頼を維持するには、潜在的な攻撃を減らすための適切なセキュリティ制御の有効化、バックアップと復元の実践、および徹底的なディザスター リカバリー手順の組み合わせが必要です。 外部関係者の監査により、これらの行為が確実に実施されます。 

監査プロセスは、非常に時間のかかる作業です。 監査には、監査ログの確認、認証の検査、アクセス制御の検査など、実装された行為のオンサイト検査が必要です。 これらの手動プロセスでは、セキュリティの潜在的なギャップが明らかになる可能性はありますが、データが悪意をもって変更されていないという立証可能な証拠を提供することはできません。 

台帳では、データ整合性の暗号学的証拠が監査者に提供されます。 この証拠は、監査プロセスを効率化するのに役立ちます。 また、システム データの整合性に関する否認防止も提供されます。

### <a name="multiple-party-business-processes"></a>マルチパーティー ビジネス プロセス

サプライチェーン管理システムなどの一部のシステムでは、複数の組織が互いにビジネス プロセスの状態を共有する必要があります。 これらのシステムでは、どのようにデータを共有して信頼するかという課題に取り組んでいます。 多くの組織は、マルチパーティー ビジネス プロセスをデジタル変換するために、Ethereum や Hyperledger Fabric などの従来のブロックチェーンに目を向けています。 

ブロックチェーンは、ネットワークに参加しているパーティー間での信頼性が低いマルチパーティー ネットワークにとって優れたソリューションです。 これらのネットワークの多くは、信頼が重要となる、基本的に一元化されたソリューションですが、完全に分散されたインフラストラクチャは、高負荷なソリューションです。 

台帳は、これらのネットワークに対するソリューションを提供します。 参加者は、ネットワーク コンセンサスがブロックチェーン ネットワークにもたらす複雑さとパフォーマンスへの影響なしに、一元管理されたデータの整合性を検証できます。

### <a name="trusted-off-chain-storage-for-blockchain"></a>ブロックチェーン用の信頼できるオフチェーン ストレージ

マルチパーティー ビジネス プロセスにブロックチェーン ネットワークが必要な場合、パフォーマンスを犠牲にせずにブロックチェーン上のデータに対してクエリを実行できるかどうかが課題になります。 

この問題を解決するための一般的なパターンでは、ブロックチェーンからデータベースなどのオフチェーン ストアにデータをレプリケートします。 ただし、ブロックチェーンからデータベースにデータがレプリケートされた後は、データ整合性によってブロックチェーンのオファーが消失することが保証されます。 台帳により、ブロックチェーン ネットワークのオフチェーン ストレージにデータ整合性が提供され、システム全体を通じて完全なデータ信頼性が確保されます。

## <a name="how-it-works"></a>しくみ

データベースによって受信された各トランザクションは、暗号学的にハッシュされます (SHA-256)。 ハッシュ関数では、トランザクションの値と、ハッシュ関数への入力として以前のトランザクションのハッシュが使用されます。 (値には、トランザクションに含まれる行のハッシュが含まれています)。関数は、ブロックチェーンのように、すべてのトランザクションを暗号学的にリンクします。 

暗号学的にハッシュされた[データベース ダイジェスト](#database-digests)は、データベースの状態を表します。 それらは、定期的に生成されて、Azure SQL Database 外部の改ざん防止保存場所に格納されます。 保存場所の例としては、[Azure Blob Storage の不変ストレージ機能](../../storage/blobs/immutable-storage-overview.md)や [Azure Confidential Ledger](../../confidential-ledger/index.yml) があります。 データベース ダイジェストを後で使用し、ダイジェスト内のハッシュの値をデータベース内の計算されたハッシュと比較することにより、データベースの整合性を検証します。 

台帳機能は、次の 2 つの形式 Azure SQL Database テーブルに導入されます。

- テーブル内の行を更新および削除できる、[更新可能な台帳テーブル](#updatable-ledger-tables)。
- テーブルへの挿入のみが許可される、[追加専用の台帳テーブル](#append-only-ledger-tables)。

更新可能な台帳テーブルと追加専用の台帳テーブルの両方で、改ざん防止機能とデジタル フォレンジクス機能が提供されます。 改ざんの可能性のあるイベントを修復する場合や、許可されているユーザーがトランザクションをシステムに送信したことを第三者に証明する場合は、どのユーザーによって送信されたどのトランザクションの結果としてデータベースが変更されたかを把握することが重要です。 

台帳機能を使用することで、ユーザー、パートナー、または監査者は、すべての履歴操作を分析し、潜在的な改ざんを検出することができます。 各行の操作には、それを実行したトランザクションの ID が添付されています。 その ID を使用すると、ユーザーは、トランザクションが発生した時刻とそれを実行したユーザーの ID に関する詳細な情報を取得できます。 その後、ユーザーはその ID を、トランザクションによって実行された他の操作に関連付けることができます。

台帳テーブルの制限の詳細については、「[Azure SQL Database 台帳の制限事項](ledger-limits.md)」を参照してください。

### <a name="ledger-database"></a>台帳データベース

台帳データベースでは、すべてのユーザー データは改ざんされていないことが保証されて台帳テーブルに格納されます。 台帳データベースには、台帳テーブルのみを含めることができます。 各テーブルは、既定で、更新可能な台帳テーブルとして作成されます。 台帳データベースは、すべてのデータの整合性を保護する必要があるアプリケーションに使いやすいソリューションを提供します。 

### <a name="updatable-ledger-tables"></a>更新可能な台帳テーブル

[更新可能な台帳テーブル](ledger-updatable-ledger-tables.md)は、System of Record (SOR) アプリケーションなど、データベース内のテーブルに更新や削除を実行することが予期されているアプリケーション パターンに最適です。 台帳機能を有効にするために、アプリケーションの既存のデータ パターンを変更する必要はありません。  

更新可能な台帳テーブルでは、更新または削除を実行するトランザクションが発生したときに、データベース内の行に対する変更の履歴が追跡されます。 更新可能な台帳テーブルは、システムによってバージョン管理されたテーブルであり、ミラー化されたスキーマを持つ別のテーブルへの参照が含まれています。 

もう 1 つのテーブルは、"*履歴テーブル*" と呼ばれます。 システムでは、このテーブルを使用して、台帳テーブルの行が更新または削除されるたびに、その行の以前のバージョンを自動的に格納します。 履歴テーブルは、更新可能な台帳テーブルが作成されると自動的に作成されます。 

更新可能な台帳テーブルとそれに対応する履歴テーブル内の値によって、時間の経過に伴うデータベースの値の記録が提供されます。 システムによって生成された台帳ビューでは、更新可能な台帳テーブルと履歴テーブルが結合されているため、データベースのこの記録を簡単に照会できます。

更新可能な台帳テーブルの詳細については、「[更新可能な台帳テーブルを作成して使用する](ledger-how-to-updatable-ledger-tables.md)」を参照してください。

### <a name="append-only-ledger-tables"></a>追加専用の台帳テーブル

[追加専用の台帳テーブル](ledger-append-only-ledger-tables.md)は、セキュリティ情報イベント管理 (SIEM) アプリケーションなど、挿入専用のアプリケーション パターンに最適です。 追加専用の台帳テーブルでは、API レベルで更新と削除がブロックされます。 このブロックにより、システム管理者や DBA などの特権ユーザーからの改ざん防止が強化されます。 

システムに対して許可されるのは挿入のみなので、キャプチャする履歴がないため、追加専用の台帳テーブルには対応する履歴テーブルはありません。 更新可能な台帳テーブルと同様に、台帳ビューには、追加専用テーブルに行を挿入したトランザクションと、挿入を実行したユーザーに関する分析情報が提供されます。

追加専用台帳テーブルの詳細については、「[追加専用台帳テーブルを作成して使用する](ledger-how-to-append-only-ledger-tables.md)」を参照してください。

### <a name="database-ledger"></a>データベース台帳

[データベース台帳](ledger-database-ledger.md)は、システムで処理されたトランザクションの暗号学的ハッシュを格納するシステム テーブルで構成されます。 トランザクションはデータベース エンジンの[原子性](/windows/win32/cossdk/acid-properties)の単位のため、これがデータベース台帳によってキャプチャされる作業単位になります。 

具体的には、トランザクションがコミットされると、トランザクションによって変更された台帳テーブル内の行の SHA-256 ハッシュが、"*トランザクション エントリ*" としてデータベース台帳に追加されます。 トランザクション エントリには、実行したユーザーの ID やコミットのタイム スタンプなど、トランザクションのメタデータもいくつか含まれます。 

30 秒ごとに、データベースによって処理されたトランザクションは、Merkle ツリー データ構造を使用して一緒に SHA-256 ハッシュされます。 その結果、ブロックを形成するルート ハッシュが作成されます。 その後、ブロックは、ブロックのルート ハッシュと、ハッシュ関数への入力として以前のブロックのルート ハッシュを使用して SHA-256 ハッシュされます。 そのハッシュによってブロックチェーンが形成されます。

### <a name="database-digests"></a>データベース ダイジェスト

データベース台帳内の最新ブロックのハッシュは、[データベース ダイジェスト](ledger-digest-management-and-database-verification.md)と呼ばれます。 これは、ブロックが生成された時点のデータベース内のすべての台帳テーブルの状態を表します。 

ブロックが形成されると、それに関連付けられているデータベース ダイジェストが公開され、Azure SQL Database 外部の改ざん防止ストレージに格納されます。 データベース ダイジェストは、生成された時点のデータベースの状態を表しているため、ダイジェストを改ざんから保護することが最も重要です。 ダイジェストを変更するアクセス権を持つ攻撃者は、次のことを実行できます。

1. データベース内のデータを改ざんする。
2. これらの変更を含むデータベースを表すハッシュを生成する。
3. ブロック内のトランザクションの更新されたハッシュを表すダイジェストを変更する。 

台帳を使用すると、データベース ダイジェストを自動的に生成して、[不変ストレージ](../../storage/blobs/immutable-storage-overview.md)や [Azure Confidential Ledger](../../confidential-ledger/index.yml) に格納し、改ざんを防ぐことができます。 また、ユーザーが手動でデータベース ダイジェストを生成し、自分の選択した場所に格納することもできます。 データベース ダイジェストは、台帳テーブルに格納されているデータが改ざんされていないことを確認するために、後で使用されます。

### <a name="ledger-verification"></a>台帳の検証

台帳機能では、ユーザーがコンテンツを変更することはできません。 しかし、コンピューターを制御している攻撃者やシステム管理者は、すべてのシステム チェックをバイパスし、データを直接改ざんすることができます。 たとえば、攻撃者またはシステム管理者は、ストレージ内のデータベース ファイルを編集できます。 台帳は、このような攻撃を防ぐことはできませんが、台帳データを検証すると、改ざんが検出されることは保証されています。 

[台帳検証](ledger-digest-management-and-database-verification.md)プロセスは、以前に生成された 1 つ以上のデータベース ダイジェストを入力として受け取り、現在の台帳テーブルの状態に基づいて、データベース台帳に格納されているハッシュを再度計算します。 計算されたハッシュが入力されたダイジェストと一致しない場合、検証は失敗し、データが改ざんされていることを示します。 その後、台帳では、検出されたすべての不整合が報告されます。

台帳の検証では、データベース内のトランザクションのすべてのハッシュが再計算されるので、大量のデータを含むデータベースではリソースを大量に消費するプロセスになる可能性があります。 ユーザーは、台帳の検証を継続的に実行するのではなく、データベースの整合性を確認する必要がある場合にのみ実行する必要があります。 

理想的には、ユーザーは、データをホストしている組織が監査を受け、データの整合性に関する暗号学的証拠を別の関係者に提供する必要がある場合にのみ台帳の検証を実行するべきです。 検証コストを削減するために、この機能では、個々の台帳テーブル、または台帳テーブルのサブセットのみを検証するオプションが公開されています。

## <a name="next-steps"></a>次のステップ
 
- [クイックスタート: 台帳が有効化された SQL Database を作成する](ledger-create-a-single-database-with-ledger-enabled.md)
- [Azure Confidential Ledger に格納されているダイジェストにアクセスする](ledger-how-to-access-acl-digest.md)
- [台帳テーブルを検証して改ざんを検出する](ledger-verify-database.md)
