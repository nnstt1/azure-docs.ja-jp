---
title: チュートリアル:Azure プライベート エンドポイントを使用して Azure Cosmos アカウントに接続する
titleSuffix: Azure Private Link
description: このチュートリアルを読み、Azure プライベート エンドポイントを使用して Azure Cosmos アカウントに非公開で接続してみましょう。
author: asudbring
ms.author: allensu
ms.service: private-link
ms.topic: tutorial
ms.date: 9/25/2020
ms.openlocfilehash: c7c9caf5bbfd842c635b0cb887540457f15c081f
ms.sourcegitcommit: dddd1596fa368f68861856849fbbbb9ea55cb4c7
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 04/13/2021
ms.locfileid: "114297039"
---
# <a name="tutorial-connect-to-an-azure-cosmos-account-using-an-azure-private-endpoint"></a>チュートリアル:Azure プライベート エンドポイントを使用して Azure Cosmos アカウントに接続する

Azure プライベート エンドポイントは、Azure における Private Link の基本的な構成要素です。 仮想マシン (VM) などの Azure リソースと Private Link リソースとの非公開での通信が可能になります。

このチュートリアルでは、以下の内容を学習します。

> [!div class="checklist"]
> * 仮想ネットワークと bastion ホストを作成します。
> * 仮想マシンを作成します。
> * プライベート エンドポイントを備えた Cosmos DB アカウントを作成します。
> * Cosmos DB アカウントのプライベート エンドポイントに対する接続をテストします。

Azure サブスクリプションをお持ちでない場合は、開始する前に [無料アカウント](https://azure.microsoft.com/free/?WT.mc_id=A261C142F) を作成してください。

## <a name="prerequisites"></a>前提条件

* Azure サブスクリプション

## <a name="sign-in-to-azure"></a>Azure へのサインイン

[Azure portal](https://portal.azure.com) にサインインします。

## <a name="create-a-virtual-network-and-bastion-host"></a>仮想ネットワークと bastion ホストの作成

このセクションでは、仮想ネットワーク、サブネット、bastion ホストを作成します。 

bastion ホストは、プライベート エンドポイントをテストする目的で、仮想マシンに安全に接続するために使用されます。

1. 画面の左上で、 **[リソースの作成] > [ネットワーク] > [仮想ネットワーク]** の順に選択するか、検索ボックスで **Virtual network** を検索します。

2. **[仮想ネットワークの作成]** の **[基本]** タブで次の情報を入力または選択します。

    | **設定**          | **Value**                                                           |
    |------------------|-----------------------------------------------------------------|
    | **プロジェクトの詳細**  |                                                                 |
    | サブスクリプション     | Azure サブスクリプションを選択します。                                  |
    | リソース グループ   | **[myResourceGroup]** を選択します |
    | **インスタンスの詳細** |                                                                 |
    | 名前             | 「**myVNet**」と入力します                                    |
    | リージョン           | **[米国東部]** を選択します。 |

3. **[IP アドレス]** タブを選択するか、ページの下部にある **[Next: IP Addresses]\(次へ: IP アドレス\)** ボタンを選択します。

4. **[IP アドレス]** タブで、次の情報を入力します。

    | 設定            | 値                      |
    |--------------------|----------------------------|
    | IPv4 アドレス空間 | 「**10.1.0.0/16**」と入力します。 |

5. **[サブネット名]** で、 **[default]\(既定\)** という単語を選択します。

6. **[サブネットの編集]** に次の情報を入力します。

    | 設定            | 値                      |
    |--------------------|----------------------------|
    | サブネット名 | 「**mySubnet**」と入力します。 |
    | サブネットのアドレス範囲 | 「**10.1.0.0/24**」と入力します。 |

7. **[保存]** を選択します。

8. **[セキュリティ]** タブをクリックします。

9. **[BastionHost]** で **[有効にする]** を選択します。 この情報を入力します。

    | 設定            | 値                      |
    |--------------------|----------------------------|
    | 要塞名 | 「**myBastionHost**」と入力します |
    | AzureBastionSubnet のアドレス空間 | 「**10.1.1.0/24**」と入力します |
    | パブリック IP アドレス | **[新規作成]** を選択します。 </br> **[名前]** に「**myBastionIP**」と入力します。 </br> **[OK]** を選択します。 |


8. **[確認と作成]** タブを選択するか、 **[確認と作成]** ボタンを選択します。

9. **［作成］** を選択します

## <a name="create-a-virtual-machine"></a>仮想マシンの作成

このセクションでは、プライベート エンドポイントのテストに使用する仮想マシンを作成します。

1. ポータルの左上で、 **[リソースの作成]**  >  **[Compute]**  >  **[仮想マシン]** の順に選択するか、検索ボックスで「**仮想マシン**」を検索します。
   
2. **[仮想マシンの作成]** の **[Basic]** タブに、値を入力するか選択します。

    | 設定 | 値                                          |
    |-----------------------|----------------------------------|
    | **プロジェクトの詳細** |  |
    | サブスクリプション | Azure サブスクリプションを選択します。 |
    | リソース グループ | **[myResourceGroup]** を選択します |
    | **インスタンスの詳細** |  |
    | 仮想マシン名 | 「**myVM**」と入力します |
    | リージョン | **[米国東部]** を選択します。 |
    | 可用性オプション | **[インフラストラクチャ冗長は必要ありません]** を選択します |
    | Image | **[Windows Server 2019 Datacenter - Gen1]** を選択します |
    | Azure Spot インスタンス | **[いいえ]**  を選択します |
    | サイズ | VM サイズを選択するか、既定の設定を使用します |
    | **管理者アカウント** |  |
    | ユーザー名 | ユーザー名を入力します |
    | Password | [パスワード] を入力します |
    | [パスワードの確認入力] | パスワードを再入力します |

3. **[ネットワーク]** タブまたは **[次へ: ディスク]** を選択してから **[次へ: ネットワーク]** を選択します。
  
4. [ネットワーク] タブで、次を選択または入力します。

    | 設定 | 値 |
    |-|-|
    | **ネットワーク インターフェイス** |  |
    | 仮想ネットワーク | **myVNet** |
    | Subnet | **mySubnet** |
    | パブリック IP | **[なし]** を選択します。 |
    | NIC ネットワーク セキュリティ グループ | **Basic**|
    | パブリック受信ポート | **[なし]** を選択します。 |
   
5. **[Review + create]\(レビュー + 作成\)** を選択します。 
  
6. 設定を確認し、 **[作成]** を選択します。

[!INCLUDE [ephemeral-ip-note.md](../../includes/ephemeral-ip-note.md)]

## <a name="create-a-cosmos-db-account-with-a-private-endpoint"></a>プライベート エンドポイントを備えた Cosmos DB アカウントの作成

このセクションでは、Cosmos DB アカウントを作成してプライベート エンドポイントを構成します。

1. 左側のメニューで、 **[リソースの作成]**  >  **[データベース]**  >  **[Cosmos DB アカウント]** の順に選択するか、検索ボックスで「**Cosmos DB アカウント**」を検索します。

2. **[Cosmos DB アカウントの作成]** の **[基本]** タブで、次の情報を入力または選択します。

    | 設定 | 値                                          |
    |-----------------------|----------------------------------|
    | **プロジェクトの詳細** |  |
    | サブスクリプション | Azure サブスクリプションを選択します。 |
    | リソース グループ | **[myResourceGroup]** を選択します。 |
    | **インスタンスの詳細** |  |
    | アカウント名 | 「**mycosmosdb**」と入力します。 この名前が使用できない場合は、一意の名前を入力してください。 |
    | API | **コア (SQL)** を選択します。 |
    | 場所 | **[米国東部]** を選択します。 |
    | 容量モード | 既定値の **[Provisioned throughput]\(プロビジョニングされたスループット\)** のままにします。 |
    | Apply Free Tier Discount (Free レベルの割引の適用) | 既定値の **[適用しない]** のままにします。 |
    | geo 冗長性 | 既定値の **[Disable]\(無効\)** のままにします。 |
    | マルチ リージョン書き込み | 既定値の **[Disable]\(無効\)** のままにします。 |
   
3. **[ネットワーク]** タブまたは **[次へ: ネットワーク]** ボタンをクリックします。

4. **[ネットワーク]** タブで、次の情報を入力または選択します。

    | 設定 | 値 |
    | ------- | ----- |
    | **ネットワーク接続** | |
    | 接続方法 | **[プライベート エンドポイント]** を選択します。 |
    | **ファイアウォールを構成する** | |
    | Azure portal からのアクセスを許可する | 既定値の **[Allow]\(許可する\)** のままにします。 |
    | 自分の IP からのアクセスを許可する | 既定値の **[Deny]\(拒否する\)** のままにします。 |

5. **[プライベート エンドポイント]** で、 **[+ 追加]** を選択します。

6. **[プライベート エンドポイントの作成]** で、次の情報を入力または選択します。

    | 設定 | 値                                          |
    |-----------------------|----------------------------------|
    | サブスクリプション | Azure サブスクリプションを選択します。 |
    | リソース グループ | **[myResourceGroup]** を選択します |
    | 場所 | **[米国東部]** を選択します。 |
    | 名前 | 「**myPrivateEndpoint**」と入力します |
    | ターゲット サブリソース | 既定値の **[Core (SQL)]** のままにします |
    | **ネットワーク** |  |
    | 仮想ネットワーク | **[myVNet]** を選択します |
    | Subnet | **mySubnet** の選択 |
    | **プライベート DNS の統合** |
    | プライベート DNS ゾーンとの統合 | 既定値である **[はい]** のままにします |
    | プライベート DNS ゾーン | 既定値の (新規) privatelink.documents.azure.com のままにします |

7. **[OK]** を選択します。

8. **[Review + create]\(レビュー + 作成\)** を選択します。

9. **［作成］** を選択します

### <a name="add-a-database-and-a-container"></a>データベースとコンテナーを追加する

1. **[Got to resource]\(リソースに移動\)** を選択するか、Azure portal の左側のメニューで **[すべてのリソース]**  >  **[mycosmosdb]** の順に選択します。

2. 左側のメニューで **[データ エクスプローラー]** を選択します。

3. **[データ エクスプローラー]** ウィンドウで **[新しいコンテナー]** を選択します。

4. **[コンテナーの追加]** で、次の情報を入力または選択します。

    | 設定 | 値 |
    | ------- | ----- |
    | データベース ID | 既定値の **[Create new]\(新規作成\)** のままにします。 </br> テキスト ボックスに「**mydatabaseid**」と入力します。 |
    | スループット (400 から 100,000 RU/秒) | 既定値の **[手動]** のままにします。 </br> テキスト ボックスに「**400**」と入力します。 |
    | コンテナー ID | 「**mycontainerid**」と入力します |
    | パーティション キー | 「 **/mykey**」と入力します |

5. **[OK]** を選択します。

6. CosmosDB アカウントの **[設定]** セクションで、 **[キー]** を選択します。

7. **PRIMARY CONNECTION STRING** でコピーを選択します。

## <a name="test-connectivity-to-private-endpoint"></a>プライベート エンドポイントへの接続のテスト

このセクションでは、前の手順で作成した仮想マシンを使用し、プライベート エンドポイントを通じて Cosmos DB アカウントに接続します。

1. 左側のナビゲーション ペインで **[リソース グループ]** を選択します。

1. **[myResourceGroup]** を選択します。

1. **[myVM]** を選択します。

1. **myVM** の [概要] ページで **[接続]** 、 **[Bastion]** の順に選択します。

1. 青色の **[Bastion を使用する]** ボタンを選択します。

1. 仮想マシンの作成時に入力したユーザー名とパスワードを入力します。

1. 接続後にサーバーで Windows PowerShell を開きます。

1. 「`nslookup <cosmosdb-account-name>.documents.azure.com`」と入力し、名前解決を検証します。 **\<cosmosdb-account-name>** は、前の手順で作成した Cosmos DB アカウントの名前で置き換えます。 

    ```powershell
    Server:  UnKnown
    Address:  168.63.129.16

    Non-authoritative answer:
    Name:    mycosmosdb8675.privatelink.documents.azure.com
    Address:  10.1.0.5
    Aliases:  mycosmosdb8675.documents.azure.com
    ```
    Cosmos DB アカウント名に対応する **10.1.0.5** というプライベート IP アドレスが返されます。  このアドレスは、先ほど作成した仮想ネットワークのサブネット内に存在します。
    
1. ポータルから Azure Cosmos DB プライマリ接続文字列を取得します。 有効な接続文字列は、次の形式になっています。
   
   SQL API アカウントの場合: `https://<accountName>.documents.azure.com:443/;AccountKey=<accountKey>;` MongoDB 用 Azure Cosmos DB API の場合: `mongodb://<accountName>:<accountKey>@cdbmongo36.mongo.cosmos.azure.com:10255/?ssl=true&replicaSet=globaldb&retrywrites=false`

1. 仮想マシンに [Microsoft Azure Storage Explorer](../vs-azure-tools-storage-manage-with-storage-explorer.md?tabs=windows&toc=%2fazure%2fstorage%2fblobs%2ftoc.json) をインストールします。

1. **Microsoft Azure Storage Explorer** のインストール後、 **[完了]** を選択します。  アプリケーションを開くため、チェック ボックスはオンのままにしてください。

1. **[Azure Storage へ接続]** 画面で、 **[キャンセル]** を選択します。

1. Storage Explorer で、 **[Cosmos DB アカウント]** を右クリックし、 **[Cosmos DB に接続]** を選択します。

1. **[API の選択]** の下は、既定値の **[SQL]** のままにします。

1. **[接続文字列]** の下のボックスに、前の手順でコピーした Cosmos DB アカウントの接続文字列を貼り付けます。

1. **[次へ]** を選択します。

1. **[接続の概要]** で、設定が正しいことを確認します。  

1. **[接続]** を選択します。

1. **myVM** への接続を閉じます。


## <a name="clean-up-resources"></a>リソースをクリーンアップする

今後このアプリケーションを使う予定がなければ、次の手順で仮想ネットワーク、仮想マシン、Cosmos DB アカウントを削除します。

1. 左側のメニューから、 **[リソース グループ]** を選択します。

2. **[myResourceGroup]** を選択します。

3. **[リソース グループの削除]** を選択します。

4. **[リソース グループ名を入力してください]** に「**myResourceGroup**」と入力します。

5. **[削除]** を選択します。

## <a name="next-steps"></a>次のステップ

このチュートリアルでは、以下を作成しました。

* 仮想ネットワークと bastion ホスト。
* 仮想マシン。
* Cosmos DB アカウント。

Private Link サービスの作成方法を確認します。
> [!div class="nextstepaction"]
> [Private Link サービスを作成する](create-private-link-service-portal.md)
