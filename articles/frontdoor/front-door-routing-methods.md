---
title: Azure Front Door - トラフィック ルーティング方法 | Microsoft Docs
description: この記事では、Front Door で使用されるさまざまなトラフィック ルーティング方法について説明します
services: front-door
documentationcenter: ''
author: duongau
ms.service: frontdoor
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: infrastructure-services
ms.date: 07/14/2021
ms.author: duau
ms.openlocfilehash: c692c814bf3ae71b34f1c31c8ab29a4cda968f1f
ms.sourcegitcommit: abf31d2627316575e076e5f3445ce3259de32dac
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 07/15/2021
ms.locfileid: "114203815"
---
# <a name="front-door-routing-methods"></a>Front Door ルーティング方法

Azure Front Door では、さまざまなサービス エンドポイントに HTTP/HTTPS トラフィックをルーティングする方法を決定するために、さまざまなトラフィック ルーティング方法をサポートしています。 Front Door に到達するクライアント要求時に、構成されているルーティング方法が適用されて、要求は最適なバックエンド インスタンスに確実に転送されます。 

Front Door では、次の 4 つのトラフィック ルーティング方法を使用できます。

* **[[待機時間]](#latency):** 待機時間ベースのルーティングでは、感度の範囲内で許容される最低遅延のバックエンドに要求が送信されます。 基本的に、ユーザーの要求は、ネットワーク待機時間に関して "最も近い" バックエンドのセットに送信されます。
* **[[優先順位]](#priority):** すべてのトラフィックに対応するためにプライマリ サービス バックエンドを構成する場合は、バックエンドに優先順位を割り当てられます。 プライマリ バックエンドが使用できなくなった場合、セカンダリ バックエンドはバックアップになる可能性があります。
* **[重み付け](#weighted):** 一連のバックエンド間に均等に、または重み係数に従ってトラフィックを分散させる場合は、バックエンドに重みを割り当てることができます。 バックエンドの待機時間が、バックエンド プール内における待機時間の許容可能な感度範囲内にある場合、トラフィックは重みに従って分散されます。
* **[[セッション アフィニティ]](#affinity):** フロントエンド ホストまたはドメインのセッション アフィニティを構成して、同じエンド ユーザーからの要求が同じバックエンドに送信されるようにすることができます。

Front Door のすべての構成には、バックエンドの正常性および自動即時グローバル フェールオーバーの監視が含まれます。 詳しくは、[Front Door Backend Monitoring](front-door-health-probes.md) (Front Door のバックエンド監視) に関するページをご覧ください。 フロント ドアは、1 つのルーティング方法に基づいて動作することができます。 ただし、アプリケーションのニーズによっては、複数のルーティング方法を組み合わせて最適なルーティング トポロジを構築することもできます。

## <a name="lowest-latencies-based-traffic-routing"></a><a name = "latency"></a>最低遅延に基づくトラフィック ルーティング

世界中の複数の場所にバックエンドをデプロイすると、エンド ユーザーに "最も近い" 宛先にトラフィックをルーティングすることで、アプリケーションの応答性を向上させることができます。 Front Door の構成に対する既定のトラフィック ルーティング方法では、エンド ユーザーからの要求は、要求を受信した Front Door 環境の最も近いバックエンドに転送されます。 このアプローチを、Azure Front Door のエニーキャスト アーキテクチャと組み合わせると、各エンド ユーザーが、エンド ユーザーの場所に基づいて個人設定された最大限のパフォーマンスを得ることができます。

"最も近い" バックエンドは、必ずしも地理的な距離で最も近いとは限りません。 Front Door は、ネットワーク待機時間を測定することによって、最も近いバックエンドを決定します。 詳しくは、[Front Door's routing architecture](front-door-routing-architecture.md) (Front Door のルーティング アーキテクチャ) に関するページをご覧ください。 

全体的な決定の流れを次に示します。

| 使用可能なバックエンド | 優先度 | 待機時間シグナル (正常性プローブに基づく) | 重み |
|-------------| ----------- | ----------- | ----------- |
| 最初に、有効になっていて、正常性プローブに対して正常 (200 OK) を返すすべてのバックエンドを選択します。 A、B、C、D、E、F の 6 つのバックエンドがあり、その中で C は異常、E は無効であるとします。 この場合、使用可能なバックエンドのリストは、A、B、D、F です。  | 次に、使用可能なものの中で優先順位が最も高いバックエンドが選択されます。 バックエンド A、B、D は優先順位 1、バックエンド F は優先順位 2 であるとします。 この場合、選択されるバックエンドは A、B、D です。| 待機時間の範囲 (ミリ秒単位で指定された最小待機時間と待機時間感度) でバックエンドを選択します。 要求が到着する Front Door 環境からバックエンド A が 15 ミリ秒、B が 30 ミリ秒、D が 60 ミリ秒離れていて、待機時間感度が 30 ミリ秒の場合、最低遅延プールは A と B で構成されます。なぜなら、D は最も近いバックエンドつまり A から 30 ミリ秒より大きく離れているためです。 | 最後に、Front Door は、最終的に選択されたプールのバックエンドの間で、指定されている重みの比率を使用して、トラフィックをラウンドロビンします。 たとえば、バックエンド A の重みが 5、バックエンド B の重みが 8 であるとすると、トラフィックはバックエンド A と B に 5:8 の比率で分散されます。 |

>[!NOTE]
> 既定では、待機時間の感度のプロパティは 0 ms に設定されています。つまり、要求は常に使用可能な最速のバックエンドに転送され、バックエンドの重みは、2 つのバックエンドが同じネットワーク待機時間を使用しない限り有効になりません。

## <a name="priority-based-traffic-routing"></a><a name = "priority"></a>優先順位に基づくトラフィック ルーティング

多くの場合、組織ではサービスの高可用性を提供したいと考えており、主要なサービスがダウンした場合に備えて複数のバックアップ サービスをデプロイすることでこれを実行しています。 業界では、このトポロジはアクティブ/スタンバイまたはアクティブ/パッシブのデプロイ トポロジとも呼ばれます。 "優先順位" トラフィック ルーティング方法を使用すると、Azure ユーザーはこのフェールオーバー パターンを簡単に実装できます。

既定の Front Door には、優先順位が等しいバックエンドのリストが含まれています。 既定では、Front Door は優先順位が最も高い (最も小さい値) バックエンド、つまりバックエンドのプライマリ セットに対してのみ、トラフィックを送信します。 プライマリ バックエンドが使用できない場合、Front Door はバックエンドのセカンダリ セット (2 番目に小さい値) にトラフィックをルーティングします。 プライマリとセカンダリのどちらのエンドポイントも使用できない場合、トラフィックは 3 番目のバックエンドに送信されます。以降も同様です。 バックエンドの可用性は、構成されている状態 (有効または無効) と、正常性プローブによって決定される継続的なバックエンドの正常性状態に基づきます。

### <a name="configuring-priority-for-backends"></a>バックエンドの優先順位の構成

Front Door 構成のバックエンド プールの各バックエンドは、"優先順位" と呼ばれるプロパティを持っていて、設定できる値は 1 から 5 です。 Azure Front Door では、各バックエンドのこのプロパティを使用して、バックエンドの優先順位を明示的に構成します。 このプロパティの値の範囲は、1 から 5 です。 値が小さいほど、優先順位が高くなります。 複数のバックエンドに同じ優先順位の値を設定できます。

## <a name="weighted-traffic-routing-method"></a><a name = "weighted"></a>加重トラフィック ルーティング方法
"重み付け" トラフィック ルーティング方法を使用すると、トラフィックを均等に分散したり、定義済みの重み付けを使用したりできます。

重み付けトラフィック ルーティング方式では、バックエンド プールの Front Door の構成で各バックエンドに重みを割り当てます。 重みは 1 から 1000 の整数です。 このパラメーターの既定の重みは "50" です。

許容される待機時間感度の使用可能なバックエンドのリストで、トラフィックは指定された重みの比率を使ってラウンドロビン方式で分散されます。 待機時間感度が 0 ミリ秒に設定されている場合、同じネットワーク待機時間のバックエンドが複数存在しない限り、このプロパティは反映されません。 

重み付け方式を使用することで、有用なシナリオをいくつか実現できます。

* **アプリケーションの段階的アップグレード**: 新しいバックエンドにルーティングするトラフィックのパーセンテージを与え、他のバックエンドと同等になるまで時間と共にトラフィックを徐々に増やします。
* **Azure へのアプリケーション移行**: Azure と外部バックエンドの両方を含むバックエンド プールを作成します。 バックエンドの重みを調整して新しいバックエンドを優先します。 最初に新しいバックエンドを無効に設定し、次に最低の重みを割り当て、少しずつ増やしながらほとんどのトラフィックを受け取るレベルまで段階的に上げることができます。 最後に優先順位の低いバックエンドを無効にして、プールから削除します。  
* **追加容量のクラウド バースト**: Front Door に対応させることで、オンプレミスのデプロイをクラウドにすばやく拡張します。 クラウドに追加容量が必要なとき、バックエンドを追加または有効にして、各バックエンドに送るトラフィックの割り当てを指定します。

## <a name="session-affinity"></a><a name = "affinity"></a>セッション アフィニティ
既定では、セッション アフィニティを使用しない場合、Front Door は同じクライアントからの要求を別のバックエンドに転送します。 一部のステートフルなアプリケーションや、同じユーザーからの要求が続く特定のシナリオでは、最初の要求を処理したのと同じバックエンドが優先されます。 Cookie ベースのセッション アフィニティ機能は、同じバックエンド上にユーザー セッションを保持する場合に便利です。 マネージド Cookie を使用すると、Azure Front Door は、ユーザー セッションからの後続のトラフィックを、処理のために同じバックエンドに送ることができます。

セッション アフィニティは、構成されているドメイン (またはサブドメイン) ごとに、フロントエンドのホスト レベルで有効にすることができます。 有効にすると、Front Door はユーザーのセッションに Cookie を追加します。 Cookie ベースのセッション アフィニティでは、Front Door は同じ IP アドレスの背後にある場合でも異なるユーザーを識別することができ、それにより異なるバックエンド間でトラフィックをより均等に分散できます。

現在 Front Door はセッション Cookie のみをサポートしているので、Cookie の有効期間はユーザーのセッションと同じです。 

> [!NOTE]
> パブリック プロキシは、セッション アフィニティを妨げる可能性があります。 これは、セッションを確立するには Front Door はセッション アフィニティ Cookie を応答に追加する必要がありますが、応答がキャッシュ可能な場合は、同じリソースを要求している他のクライアントの Cookie を妨害するので、これを行うことはできません。 これを防ぐため、バックエンドがキャッシュ可能な応答を送信する場合は、セッション アフィニティは確立 **されません**。 セッションが既に確立されている場合は、バックエンドからの応答がキャッシュ可能であっても問題ありません。
> 応答に HTTP 304 状態コードが含まれて **いない限り**、セッション アフィニティは次の状況で確立されます。
> - 応答の ```Cache-Control``` ヘッダーにキャッシュを禁止する特定の値 ("private" や "no-store" など) が設定されている。
> - 応答に有効期限が切れていない ```Authorization``` ヘッダーが含まれる。
> - 応答に HTTP 302 状態コードが含まれている。

## <a name="next-steps"></a>次のステップ

- [フロント ドアの作成](quickstart-create-front-door.md)方法について学習します。
- [Front Door のしくみ](front-door-routing-architecture.md)について学習します。
