---
title: 不変 BLOB データに対する時間ベースのアイテム保持ポリシー
titleSuffix: Azure Storage
description: 時間ベースのアイテム保持ポリシーでは、指定された期間、BLOB データを WORM (Write-Once、Read-Many) 状態で保存します。 BLOB バージョン (プレビュー) またはコンテナーをスコープとする時間ベースのアイテム保持ポリシーを構成できます。
services: storage
author: tamram
ms.service: storage
ms.topic: conceptual
ms.date: 07/22/2021
ms.author: tamram
ms.subservice: blobs
ms.openlocfilehash: ed76c271590b4f5fbc79c7713b70186a8d9eb426
ms.sourcegitcommit: f6e2ea5571e35b9ed3a79a22485eba4d20ae36cc
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 09/24/2021
ms.locfileid: "128552068"
---
# <a name="time-based-retention-policies-for-immutable-blob-data"></a>不変 BLOB データに対する時間ベースのアイテム保持ポリシー

時間ベースのアイテム保持ポリシーでは、指定された期間、BLOB データを WORM (Write-Once、Read-Many) 形式で保存します。 時間ベースのアイテム保持ポリシーが設定されている場合、クライアントは BLOB の作成と読み取りはできますが、変更または削除はできません。 保持間隔を経過した後は BLOB を削除できますが、上書きはできません。

BLOB ストレージの不変ポリシーの詳細については、「[不変ストレージを使用してビジネスに不可欠な BLOB データを保存する](immutable-storage-overview.md)」を参照してください。

## <a name="retention-interval-for-a-time-based-policy"></a>時間ベースのポリシーの保持間隔

時間ベースのアイテム保持ポリシーの最短保持間隔は 1 日で、最長間隔は 146,000 日 (400 年) です。

時間ベースのアイテム保持ポリシーを構成すると、影響を受けるオブジェクトは、"*有効な*" 保持期間中、不変状態のままになります。 オブジェクトの有効な保持期間は、BLOB の作成時刻とユーザーが指定した保持間隔の差になります。 ポリシーの保持期間は延長できるため、不変ストレージでは、ユーザー指定の保持間隔の最新の値が、有効な保持期間の計算に使用されます。

たとえば、ユーザーが、保持間隔が 5 年の時間ベースの保持ポリシーを作成するとします。 そのコンテナー内の既存の BLOB *testblob1* は 1 年前に作成されました。したがって、*testblob1* の有効な保持期間は 4 年です。 新しい BLOB である *testblob2* がコンテナーにアップロードされると、*testblob2* の有効な保持期間は作成時点から 5 年になります。

## <a name="locked-versus-unlocked-policies"></a>ロックされたポリシーとロック解除されたポリシー

時間ベースのアイテム保持ポリシーを初めて構成する場合、ポリシーはテスト目的でロック解除されています。 テストが完了したら、SEC 17a-4(f) およびその他の規制コンプライアンスに完全に準拠するように、ポリシーをロックできます。

ポリシーは、ロックされていてもロック解除されていても、削除と上書きを防止できます。 ただし、ロック解除されたポリシーは、変更して保持期間を短縮または延長できます。 また、ロック解除されたポリシーは削除することもできます。

ロックされた時間ベースのアイテム保持ポリシーは、削除できません。 保持期間の延長はできますが、短縮はできません。 コンテナー レベルで定義された、ロックされたポリシーの有効期間中に、有効な保持期間を最大で 5 つ、増やすことができます。 BLOB バージョンに対して構成されるポリシーの場合、追加する有効期間の数に制限はありません。

> [!IMPORTANT]
> SEC 17a-4(f) や他の規制を順守するために BLOB を準拠した不変 (書き込みおよび削除禁止) 状態にするには、時間ベースのリテンション ポリシーをロックする必要があります。 Microsoft では、適切な期間 (通常 24 時間未満)、ポリシーをロックすることをお勧めします。 ロック解除の状態では不変性保護が行われますが、短期間のテスト以外の目的でのロック解除状態の使用はお勧めしません。

## <a name="time-based-retention-policy-scope"></a>時間ベースのアイテム保持ポリシーのスコープ

時間ベースのアイテム保持ポリシーは、次のいずれかのスコープで構成できます。

- バージョンレベルのポリシー (プレビュー): 時間ベースのアイテム保持ポリシーは、機密データを詳細に管理するために、BLOB バージョンに適用するように構成できます。 ポリシーは、個々のバージョンに適用することも、コンテナーの既定のポリシーを構成して、そのコンテナーにアップロードされるすべての BLOB に既定で適用することもできます。
- コンテナーレベルのポリシー: コンテナーレベルで構成される時間ベースのアイテム保持ポリシーは、そのコンテナー内のすべてのオブジェクトに適用されます。 個々のオブジェクトを、独自の不変ポリシーを使用して構成することはできません。

バージョンレベルとコンテナーレベルの両方の時間ベースのアイテム保持ポリシーで、コンテナーに対して監査ログを使用できます。 監査ログは、BLOB バージョンがスコープになっているポリシーでは使用できません。

### <a name="version-level-policy-scope-preview"></a>バージョンレベルのポリシーのスコープ (プレビュー)

バージョンレベルのアイテム保持ポリシーを構成するには、まず、親コンテナーでバージョンレベルの不変性を有効にする必要があります。 バージョンレベルの不変性は、有効にした後は無効にできません。ただし、ロック解除されたポリシーは削除できます。 詳細については、「[コンテナーでバージョンレベルの不変性のサポートを有効にする](immutable-policy-configure-version-scope.md#enable-support-for-version-level-immutability-on-a-container)」を参照してください。

コンテナーを作成するときに、バージョンレベルの不変性のサポートを有効にできます。 既存のコンテナーもバージョンレベルの不変性をサポートできますが、まず、移行プロセスを実行する必要があります。 このプロセスには時間がかかる場合があり、元に戻すことはできません。 バージョンレベルの不変性をサポートするためのコンテナーの移行の詳細については、「[バージョンレベルの不変性をサポートするために既存のコンテナーを移行する](immutable-policy-configure-version-scope.md#migrate-an-existing-container-to-support-version-level-immutability)」を参照してください。

バージョンレベルの時間ベースのアイテム保持ポリシーでは、ストレージ アカウントで [BLOB のバージョン管理](versioning-overview.md)が有効になっている必要があります。 BLOB のバージョン管理を有効にする方法については、「[BLOB のバージョン管理を有効にして管理する](versioning-enable.md)」をご覧ください。 バージョン管理を有効にすると、課金に影響する場合があることに注意してください。 詳細については、「[BLOB のバージョン管理](versioning-overview.md#pricing-and-billing)」の「**価格と課金**」セクションを参照してください。

バージョン管理を有効にした後、BLOB が初めてアップロードされると、BLOB のそのバージョンが現在のバージョンになります。 BLOB が上書きされるたびに、BLOB の以前の状態を格納する新しいバージョンが作成されます。 BLOB の現在のバージョンを削除すると、前のバージョンが現在のバージョンになり、明示的に削除されるまで保持されます。 前の BLOB バージョンには、前のバージョンが現在のバージョンになったときに有効だった時間ベースのアイテム保持ポリシーが適用されます。

コンテナーに対して既定のポリシーが有効になっている場合、上書き操作によって前のバージョンが作成されると、新しい現在のバージョンはコンテナーの既定のポリシーを継承します。

各バージョンには、時間ベースのアイテム保持ポリシーを 1 つだけ構成できます。 バージョンには、訴訟ホールドも 1 つ構成できます。 サポートされている、スコープに基づく不変ポリシー構成の詳細については、「[不変ポリシーのスコープ](immutable-storage-overview.md#immutability-policy-scope)」を参照してください。

バージョンレベルの時間ベースのアイテム保持ポリシーを構成する方法については、「[BLOB バージョンの不変ポリシーを構成する (プレビュー)](immutable-policy-configure-version-scope.md)」を参照してください。

> [!IMPORTANT]
> バージョンレベルの時間ベースのアイテム保持ポリシーは、現在、**プレビュー** の段階です。 ベータ版、プレビュー版、または一般提供としてまだリリースされていない Azure の機能に適用される法律条項については、「[Microsoft Azure プレビューの追加使用条件](https://azure.microsoft.com/support/legal/preview-supplemental-terms/)」を参照してください。
> バージョンレベルの不変性が有効になってから、バージョンレベルの時間ベースのアイテム保持ポリシーを構成できるようになるまで、最大で 30 秒かかることがあります

#### <a name="configure-a-policy-on-the-current-version"></a>現在のバージョンに対するポリシーを構成する

コンテナーに対するバージョンレベルの不変性のサポートを有効にした後、必要に応じて、コンテナーに対する既定の時間ベースのアイテム保持ポリシーを構成できます。 コンテナーに対する既定の時間ベースのアイテム保持ポリシーを構成し、BLOB をアップロードすると、その BLOB は既定でそのポリシーを継承します。 また、BLOB のアップロード時にその BLOB のカスタム ポリシーを構成することによって、既定のポリシーをオーバーライドすることもできます。

コンテナーに対する既定の時間ベースのアイテム保持ポリシーがロック解除されている場合、既定のポリシーを継承する BLOB の現在のバージョンにも、ロック解除されたポリシーが適用されます。 個々の BLOB のアップロード後、BLOB の現在のバージョンでポリシーの保持期間を短縮または延長したり、現在のバージョンを削除したりできます。 また、コンテナーの既定のポリシーがロック解除されたままでも、現在のバージョンのポリシーをロックできます。

コンテナーに対する既定の時間ベースのアイテム保持ポリシーがロックされている場合、既定のポリシーを継承する BLOB の現在のバージョンにも、ロックされたポリシーが適用されます。 ただし、BLOB をアップロードするときに、その BLOB のみに対するポリシーを設定して既定のポリシーをオーバーライドすると、その BLOB のポリシーは、明示的にロックするまでロック解除されたままになります。 現在のバージョンでのポリシーがロックされている場合、保持間隔の延長はできますが、ポリシーの削除や保持間隔の短縮はできません。

コンテナーに既定のポリシーが構成されていない場合は、BLOB のアップロードでカスタム ポリシーを使用することも、ポリシーを使用しないこともできます。

コンテナーに対する既定のポリシーが変更された場合、そのコンテナー内のオブジェクトのポリシーは、それらのポリシーが既定のポリシーから継承されている場合でも、変更されないままです。

次の表は、BLOB に対してアップロード時に時間ベースのアイテム保持ポリシーを設定するために使用できる、さまざまなオプションを示しています。

| コンテナーでの既定のポリシーの状態 | 既定のポリシーを使用して BLOB をアップロードする | カスタム ポリシーを使用して BLOB をアップロードする | ポリシーを使用せずに BLOB をアップロードする |
|--|--|--|--|
| コンテナーでの既定のポリシー (ロック解除) | BLOB は既定のロック解除されたポリシーを使用してアップロードされます | BLOB はカスタムのロック解除されたポリシーを使用してアップロードされます | BLOB はポリシーを使用せずにアップロードされます |
| コンテナーでの既定のポリシー (ロック) | BLOB は既定のロックされたポリシーを使用してアップロードされます | BLOB はカスタムのロック解除されたポリシーを使用してアップロードされます | BLOB はポリシーを使用せずにアップロードされます |
| コンテナーでの既定のポリシーなし | 該当なし | BLOB はカスタムのロック解除されたポリシーを使用してアップロードされます | BLOB はポリシーを使用せずにアップロードされます |

#### <a name="configure-a-policy-on-a-previous-version"></a>前のバージョンに対するポリシーを構成する

バージョン管理を有効にすると、BLOB に対する書き込みまたは削除操作によって、BLOB の新しい前のバージョンが作成されます。これにより、操作の前の BLOB の状態が保存されます。 既定では、現在のバージョンが前のバージョンに戻ったときに、現在のバージョンで有効だった時間ベースのアイテム保持ポリシーが (もしあれば) 前のバージョンに適用されます。 新しい現在のバージョンは、コンテナーにポリシーがあれば、それを継承します。

前のバージョンによって継承されたポリシーがロック解除されている場合は、保持間隔を短縮または延長できます。また、ポリシーを削除することもできます。 現在のバージョンのポリシーがロック解除されている場合でも、そのバージョンに対して前のバージョンのポリシーをロックすることもできます。

前のバージョンによって継承されたポリシーがロックされている場合は、保持間隔を延長できます。 ポリシーを削除したり、保持間隔を短縮したりすることはできません。

現在のバージョンでポリシーが構成されていない場合、前のバージョンはポリシーを継承しません。 そのバージョンのカスタム ポリシーを構成できます。

現在のバージョンのポリシーが変更された場合、既存の前の各バージョンのポリシーは、現在のバージョンから継承されていても変更されません。

### <a name="container-level-policy-scope"></a>コンテナーレベルのポリシーのスコープ

コンテナーレベルの時間ベースのアイテム保持ポリシーは、新規と既存、両方のコンテナーのオブジェクトすべてに適用されます。 階層型名前空間があるアカウントの場合、コンテナーレベルのポリシーは、コンテナー内のすべてのディレクトリにも適用されます。

時間ベースのアイテム保持ポリシーをコンテナーに適用すると、既存のすべての BLOB が 30 秒以内に不変 WORM 状態に移行します。 そのポリシーで保護されたコンテナーにアップロードされるすべての新しい BLOB も不変状態に移行します。 すべての BLOB が不変状態になると、不変コンテナー内の上書きまたは削除操作は許可されなくなります。 階層型名前空間があるアカウントの場合、BLOB の名前を変更したり、別のディレクトリに移動したりすることはできません。

コンテナーレベルのアイテム保持ポリシーには、次の制限が適用されます。

- ストレージ アカウントで、ロック済み時間ベースの不変ポリシーが適用されたコンテナーの最大数は 10,000 です。
- コンテナーで、ロックされた時間ベースのポリシーの保持間隔を延長する編集の最大回数は 5 です。
- コンテナーで、ロックされたポリシーに対して保持される時間ベースのアイテム保持ポリシー監査ログの最大数は 7 です。

コンテナーに対して時間ベースのアイテム保持ポリシーを構成する方法については、「[コンテナーの不変ポリシーを構成する](immutable-policy-configure-container-scope.md)」を参照してください。

## <a name="allow-protected-append-blobs-writes"></a>保護された追加 BLOB の書き込みを許可する

追加 BLOB はデータ ブロックで構成され、監査とログ記録のシナリオで必要なデータ追加操作用に最適化されています。 設計上、追加 BLOB では、BLOB の末尾に新しいブロックを追加することのみが許可されます。 不変性に関係なく、追加 BLOB の既存のブロックの変更や削除は、基本的には許可されていません。 追加 BLOB の詳細については、「[追加 BLOB について](/rest/api/storageservices/understanding-block-blobs--append-blobs--and-page-blobs#about-append-blobs)」を参照してください。

時間ベースのアイテム保持ポリシーのみにある **AllowProtectedAppendWrites** プロパティ設定を使用すると、不変性の保護とコンプライアンスを維持しつつ、追加 BLOB に新しいブロックを書き込むことができます。 この設定を有効にすると、ポリシーで保護されたコンテナー内に追加 BLOB を直接作成し、Append Block 操作を使用して、追加 BLOB の末尾に新しいデータ ブロックを追加できます。 新しいブロックを追加することだけができ、既存のブロックを変更したり削除したりすることはできません。 持続的不変性保護は引き続き適用され、有効な保持期間が経過するまで、追加 BLOB は削除に対して保護されます。 この設定を有効にしても、ブロック BLOB またはページ BLOB の不変性動作には影響しません。

この設定は時間ベースのアイテム保持ポリシーの一部なので、"*有効な*" 保持期間中、追加 BLOB は不変状態のままになります。 追加 BLOB の初期作成後に新しいデータを追加できるため、保持期間の決定方法には若干の違いがあります。 有効な保持期間は、追加 BLOB の最終変更時刻とユーザーが指定した保持間隔の差になります。 同様に、保持間隔が延長されるとき、不変ストレージでは、ユーザー指定の保持間隔の最新の値が有効な保持期間の計算に使用されます。

たとえば、ユーザーが **AllowProtectedAppendWrites** プロパティを有効にして、保持間隔が 90 日の時間ベースのアイテム保持ポリシーを作成するとします。 追加 BLOB *logblob1* は今日コンテナーに作成され、今後 10 日間、新しいログが追加 BLOB に追加されます。したがって、*logblob1* の有効な保持期間は、今日から 100 日 (最後に追加された時刻 + 90 日) です。

ロック解除された時間ベースのアイテム保持ポリシーを使用すると、**AllowProtectedAppendWrites** プロパティの設定をいつでも有効または無効にすることができます。 時間ベースのアイテム保持ポリシーがロックされると、**AllowProtectedAppendWrites** プロパティの設定は変更できなくなります。

## <a name="audit-logging"></a>監査ログ

時間ベースのアイテム保持ポリシーが有効になっている各コンテナーでは、ポリシー監査ログが提供されます。 監査ログには、ロックされた時間ベースのアイテム保持ポリシーに対して、最大 7 つの時間ベースのアイテム保持コマンドが含まれています。 ログ エントリには、ユーザー ID、コマンドの種類、タイム スタンプ、および保持間隔が含まれています。 この監査ログは、SEC 17a-4(f) 規制ガイドラインに従い、ポリシーの有効期間の間、保持されます。

すべての管理サービス アクティビティのより包括的なログは、[Azure アクティビティ ログ](../../azure-monitor/essentials/platform-logs-overview.md)に表示されます。 [Azure リソース ログ](../../azure-monitor/essentials/platform-logs-overview.md)には、データ操作に関する情報が保持されます。 規制や他の目的で必要になる可能性のあるログは、ユーザーが永続的に保存する必要があります。

バージョンレベルでの時間ベースのアイテム保持ポリシーの変更は監査されません。

## <a name="next-steps"></a>次のステップ

- [データ保護の概要](data-protection-overview.md)
- [不変ストレージを使用してビジネスに不可欠な BLOB データを保存する](immutable-storage-overview.md)
- [不変 BLOB データに対する法的な保持](immutable-legal-hold-overview.md)
- [BLOB バージョンに対する不変性ポリシーを構成する (プレビュー)](immutable-policy-configure-version-scope.md)
- [コンテナーの不変性ポリシーを構成する](immutable-policy-configure-container-scope.md)
