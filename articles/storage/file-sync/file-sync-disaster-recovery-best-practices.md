---
title: Azure File Sync を使用したディザスター リカバリーのベスト プラクティス
description: Azure File Sync を使用したディザスター リカバリーのベスト プラクティスについて説明します。具体的には、高可用性、データ保護、データの冗長性です。
author: roygara
ms.service: storage
ms.topic: how-to
ms.date: 08/18/2021
ms.author: rogarana
ms.subservice: files
ms.openlocfilehash: f5928815b6559c257319eb625587135cbf99df0d
ms.sourcegitcommit: f6e2ea5571e35b9ed3a79a22485eba4d20ae36cc
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 09/24/2021
ms.locfileid: "128645742"
---
# <a name="best-practices-for-disaster-recovery-with-azure-file-sync"></a>Azure File Sync を使用したディザスター リカバリーのベスト プラクティス

Azure File Sync の場合、ディザスター リカバリーについて考慮すべき 3 つの主要な領域があります。高可用性、データ保護とバックアップ、データ冗長性です。 この記事は各領域について説明しており、独自のディザスター リカバリー ソリューションに使用する構成を決定するのに役立ちます。

Azure File Sync デプロイにおいては、クラウド エンドポイントには常にデータの完全なコピーが含まれますが、オンプレミス サーバーはデータの破棄可能なキャッシュと見なすことができます。 サーバー側に障害が発生した場合は、新しいサーバーをプロビジョニングし、そのサーバーに Azure File Sync エージェントをインストールして、それを新しいサーバー エンドポイントとして設定することで復旧できます。

ハイブリッドという性質上、従来のサーバー バックアップとディザスター リカバリーの戦略の中には、Azure File Sync に対応していないものもあります。登録済みサーバーについて、以下のことは Azure File Sync でサポートされていません。

> [!WARNING]
> これらのアクションを実行すると、同期の問題または階層化されたファイルの破損が発生し、最終的なデータ損失につながるおそれがあります。 これらのアクションのいずれかを実行した場合は、Azure サポートに問い合わせ、ご使用のデプロイが正常であることをご確認ください。

- サーバー間でディスク ドライブを転送する
- オペレーティング システム バックアップから復元する
- サーバーのオペレーティング システムを別のサーバーに複製する
- 以前の仮想マシン チェックポイントに戻す
- クラウドを使った階層化が有効になっている場合にオンプレミス バックアップからファイルを復元する

## <a name="high-availability"></a>高可用性

オンプレミス サーバーの高可用性を実現するために使用できる、異なる 2 種類の戦略があります。 フェールオーバー クラスターを構成するか、スタンバイ サーバーを構成することができます。 どちらの構成にするかを決定する要因は、システムにどれだけ投資するつもりがあるか、また、障害が発生した場合にシステムがダウンする時間を最小限に抑えることに、その追加コストに見合う価値があるかどうかです。

フェールオーバー クラスターの場合、Azure File Sync を使用するために特別な手順を実行する必要はありません。スタンバイ サーバーの場合は、次の構成を行う必要があります。

異なるサーバー エンドポイントを持ち、同期先がプライマリ サーバーと同じ同期グループであるセカンダリ サーバーを作成しますが、サーバーへのエンドユーザー アクセスは有効にしません。 これにより、すべてのファイルをプライマリ サーバーからスタンバイ サーバーに同期できます。 名前空間だけが最初にダウンロードされるように、名前空間のみの階層化を有効にすることを検討できます。 プライマリ サーバーで障害が発生した場合は、DFS-N を使用して、スタンバイ サーバーへのエンドユーザー アクセスをすばやく再構成できます。

## <a name="data-protectionbackup"></a>データ保護とバックアップ

実際のデータの保護は、ディザスター リカバリー ソリューションの重要なコンポーネントです。 Azure ファイル共有でこれを行うには、主に 2 つの方法があります。クラウドまたはオンプレミスでデータをバックアップできます。 クラウドにデータをバックアップすることを強くお勧めします。なぜなら、クラウド エンドポイントにはデータの完全なコピーが含まれるのに対し、サーバー エンドポイントにはデータのサブセットのみが含まれるからです。

### <a name="back-up-your-data-in-the-cloud"></a>クラウド内のデータのバックアップ

クラウド バックアップ ソリューションとして [Azure Backup](../../backup/azure-file-share-backup-overview.md?toc=%2fazure%2fstorage%2ffile-sync%2ftoc.json) を使用する必要があります。 Azure Backup によって、バックアップのスケジュール設定、保持、復元などの処理が行われます。 必要に応じて、手動で[共有スナップショット](../files/storage-snapshots-files.md?toc=/azure/storage/file-sync/toc.json)を取得し、独自のスケジュール設定と保持のソリューションを構成できますが、これは理想的ではありません。 または、サードパーティのソリューションを使用して、Azure ファイル共有を直接バックアップすることもできます。

障害が発生した場合は、ファイル共有の特定の時点の読み取り専用コピーである共有スナップショットから復元できます。 これらのスナップショットは読み取り専用であるため、ランサムウェアの影響を受けません。 共有の完全復元の操作に時間がかかる大規模なデータセットの場合は、スナップショットへの直接ユーザー アクセスを有効にすることができます。そうすると、復元が完了するまでの間に、ユーザーが各自の必要なデータをローカル ドライブにコピーできます。

スナップショットは、手動で取得するか、Azure Backup で自動的に取得するかに関係なく、Azure ファイル共有に直接保存されます。 したがって、ファイル共有が誤って削除されないようにスナップショットを保護するために、[論理的な削除](../files/storage-files-prevent-file-share-deletion.md?toc=/azure/storage/file-sync/toc.json)を有効にする必要があります。

詳細については、「[Azure ファイル共有のバックアップについて](../../backup/azure-file-share-backup-overview.md)」を参照するか、バックアップ プロバイダーにお問い合わせいただき、Azure ファイル共有のバックアップがサポートされているかどうかをご確認ください。

### <a name="back-up-your-data-on-premises"></a>オンプレミスのデータをバックアップする

クラウドを使った階層化を有効にする場合は、オンプレミスのバックアップ ソリューションを実装しないでください。 クラウドを使った階層化を有効にすると、データのサブセットのみがサーバーにローカルに保存され、残りのデータはクラウド エンドポイントに保存されます。 ローカル バックアップに使用するバックアップ ソリューションに応じて、階層化されたファイルは次のいずれかになります。スキップされ、バックアップされない (FILE_ATTRIBUTE_RECALL_ONDATA_ACCESS 属性のため): 階層化されたファイルとしてのみバックアップされ、ライブ共有での変更が原因で復元時にアクセスできないおそれがあります。または、ディスクに呼び戻される: その結果、エグレス料金が高くなります。

オンプレミス バックアップ ソリューションを使用することに決定した場合、クラウドを使った階層化が無効な同期グループ内のサーバーに対してバックアップを実行する必要があります。 復元を実行するときは、ボリューム レベルまたはファイル レベルの復元オプションを使用します。 ファイル レベルの復元オプションを使用して復元されたファイルは、同期グループ内のすべてのエンドポイントに同期され、既存のファイルはバックアップから復元されたバージョンに置き換えられます。 ボリューム レベルの復元では、クラウド エンドポイントまたは他のサーバー エンドポイントの新しいファイル バージョンは置き換えられません。

Azure File Sync エージェントのバージョン 9 以上では、[ボリューム シャドウ コピー サービス (VSS) スナップショット](file-sync-deployment-guide.md#self-service-restore-through-previous-versions-and-vss-volume-shadow-copy-service) ( **[以前のバージョン]** タブを含む) が、クラウドを使った階層化が有効なボリュームでサポートされています。 これにより、自分に代わって管理者に復元を実行してもらうのではなく、セルフサービス復元を実行できます。 ただし、PowerShell を使用して以前のバージョンの互換性を有効にする必要があり、それによってスナップショット ストレージのコストが増加します。 VSS スナップショットはサーバー エンドポイント自体の障害から保護されません。そのため、必ずクラウド側のバックアップと共に使用する必要があります。 詳細については、「[以前のバージョンおよび VSS (ボリューム シャドウ コピー サービス) を使用するセルフサービス復元](file-sync-deployment-guide.md#self-service-restore-through-previous-versions-and-vss-volume-shadow-copy-service)」を参照してください。

## <a name="data-redundancy"></a>データの冗長性

堅牢なディザスター リカバリー ソリューションを確保するには、何らかの形式のデータ冗長性をインフラストラクチャに追加します。 Azure Files 用に 4 つの冗長性オファリングがあります。[ローカル冗長ストレージ (LRS)](../common/storage-redundancy.md#locally-redundant-storage)、[ゾーン冗長ストレージ (ZRS)](../common/storage-redundancy.md#zone-redundant-storage)、[geo 冗長ストレージ (GRS)](../common/storage-redundancy.md#geo-redundant-storage)、および [geo ゾーン冗長ストレージ (GZRS)](../common/storage-redundancy.md#geo-zone-redundant-storage) です。

- [ローカル冗長ストレージ (LRS)](../common/storage-redundancy.md#locally-redundant-storage): LRS を使用すると、すべてのファイルが Azure ストレージ クラスター内に 3 回保存されます。 これにより、不良ディスク ドライブなどのハードウェア障害によるデータの損失を防ぐことができます。 ただし、データセンター内で火災や洪水などの災害が発生した場合、LRS を使用しているストレージ アカウントのすべてのレプリカが失われたり、回復不能になる可能性があります。
- [ゾーン冗長ストレージ (ZRS)](../common/storage-redundancy.md#zone-redundant-storage): ZRS を使用すると、各ファイルのコピーが 3 つ保存されますが、これらのコピーは物理的に異なる Azure "*可用性ゾーン*" にある 3 つの異なるストレージ クラスターに分離されます。 可用性ゾーンは、Azure リージョン内の一意の物理的な場所です。 それぞれのゾーンは、独立した電源、冷却手段、ネットワークを備えた 1 つまたは複数のデータ センターで構成されています。 3 つの可用性ゾーンすべてのストレージ クラスターに書き込まれるまで、ストレージへの書き込みは受け入れられません。
- [Geo 冗長ストレージ (GRS)](../common/storage-redundancy.md#geo-redundant-storage): GRS の場合、プライマリ リージョンとセカンダリ リージョンの 2 つのリージョンがあります。 ファイルは、プライマリ リージョンの Azure ストレージ クラスター内に 3 回保存されます。 書き込みは、Microsoft によって定義されたセカンダリ リージョンに非同期的にレプリケートされます。 GRS を使用すると、データの 6 つのコピーが 2 つの Azure リージョンに分散して作成されます。
- [Geo ゾーン冗長ストレージ (GZRS)](../common/storage-redundancy.md#geo-zone-redundant-storage): GZRS は、ZRS のようなものと考えることができますが、geo 冗長を備えています。 GZRS を使用すると、ファイルはプライマリ リージョンの 3 つの異なるストレージ クラスターに 3 回保存されます。 その後、すべての書き込みが Microsoft で定義されたセカンダリ リージョンに非同期的にレプリケートされます。

堅牢なディザスター リカバリー ソリューションにするためには、ほとんどのお客様は ZRS を検討する必要があります。 ZRS は、追加されるデータ冗長性の利点の割に追加コストが最小限で済み、障害が発生した場合に最もシームレスです。 組織のポリシーまたは規制要件によってデータに対する geo 冗長性が必要とされる場合は、GRS または GZRS を検討してください。

### <a name="geo-redundancy"></a>geo 冗長

クラウド エンドポイントを含むストレージ アカウントで GRS または GZRS を有効にした場合は、それをストレージ同期サービスでも有効にする必要があります。 これにより、障害が発生した場合に、Azure File Sync トポロジとクラウド エンドポイントに含まれるデータに関するすべての情報が、ペアのセカンダリ リージョンに非同期的にコピーされることが確実になります。

GRS または GZRS のいずれかが構成されているリソースの場合、プライマリ リージョンが永続的に回復不可能または長時間使用できないと判断された場合、Microsoft によってサービスのフェールオーバーが開始されます。 ストレージ同期サービスで GRS または GZRS を使用している場合、リージョンの障害が発生すると、Azure File Sync サービスはペアのリージョンに自動的にフェールオーバーします。 GRS または GZRS が構成された Azure File Sync を使用している場合、障害が発生したときに自分で行う必要がある対処はありません。

GRS または GZRS のペア リージョンへのストレージ同期サービスのフェールオーバーを手動で要求することもできますが、プロセスはシームレスではなく追加コストが発生する場合があるため、大規模なリージョン停止の外部でこれを行うことはお勧めしません。 プロセスを開始するには、サポート チケットを開き、Azure ファイル共有を含む Azure ストレージ アカウントとストレージ同期サービスの両方がフェールオーバーするように要求してください。

> [!WARNING]
> このプロセスを手動で開始する場合、ご使用のストレージ同期サービスのフェールオーバーを要求するには、サポートにお問い合わせください。 同じサーバー エンドポイントを使用してセカンダリ リージョンに新しいストレージ同期サービスを作成しようとすると、Azure File Sync の以前のインストールはクリーンアップされないため、ストレージ アカウントに余分なデータが残ることがあります。

フェールオーバーが発生すると、サーバー エンドポイントは、セカンダリ リージョンのクラウド エンドポイントと自動的に同期するために切り替えられます。 ただし、サーバー エンドポイントはクラウド エンドポイントと調整する必要があります。 その結果、セカンダリ リージョンのデータがプライマリと同じにならない可能性があり、ファイルの競合が発生する場合があります。

## <a name="next-steps"></a>次の手順

[Azure ファイル共有のバックアップについて](../../backup/azure-file-share-backup-overview.md?toc=%2fazure%2fstorage%2ffile-sync%2ftoc.json)
