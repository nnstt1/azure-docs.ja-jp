---
title: Azure File Sync サーバー エンドポイントを作成する
description: サーバー エンドポイントの作成時のオプションと、状況に応じたそれらの最適な適用方法について説明します。
author: fauhse
ms.service: storage
ms.topic: how-to
ms.date: 06/01/2021
ms.author: fauhse
ms.subservice: files
ms.openlocfilehash: b981ae7394e070d4da793fddccdd52e4350bde86
ms.sourcegitcommit: 9339c4d47a4c7eb3621b5a31384bb0f504951712
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 07/14/2021
ms.locfileid: "113799474"
---
# <a name="create-an-azure-file-sync-server-endpoint"></a>Azure File Sync サーバー エンドポイントを作成する

サーバー エンドポイントは、登録済みサーバー上の特定の場所を表します。たとえば、サーバー ボリュームのフォルダーなどです。 サーバー エンドポイントは次の条件を満たす必要があります。

- サーバー エンドポイントは (マウントされた共有ではなく) 登録済みサーバー上のパスである必要があります。 ネットワーク接続ストレージ (NAS) はサポートされていません。
- サーバー エンドポイントがシステム ボリューム上に存在してもかまいませんが、システム ボリューム上のサーバー エンドポイントではクラウド階層化を使用できません。
- ボリューム上でサーバー エンドポイントを確立した後もパスまたはドライブ文字を変更することはサポートされていません。 サーバー エンドポイントの作成前に、適切なパスを使用していることを確認してください。
- 登録済みサーバーは複数のサーバー エンドポイントをサポートできますが、同期グループには、常に登録済みサーバーあたり 1 つのサーバー エンドポイントしか含めることができません。 同期グループ内のその他のサーバー エンドポイントは、異なる登録済みサーバー上に存在する必要があります。
- 名前空間が重複していない場合、各エンドポイントは一意の同期グループに同期していれば、同じボリューム上に複数のサーバー エンドポイントが存在する可能性があります (たとえば、F:\sync1 と F:\sync2 など)。 

この記事では、新しいサーバー エンドポイントを作成し、同期を開始するうえで必要となるオプションおよび判断事項について説明します。これらを実際に行うには、[Azure File Sync のデプロイの計画](file-sync-planning.md)を完了し、サーバー エンドポイントの作成に[必要なリソース](file-sync-deployment-guide.md)を事前にデプロイしている必要があります。

## <a name="prerequisites"></a>前提条件

サーバー エンドポイントを作成するには、まず次の条件を満たしていることを確認する必要があります。 
- サーバーに Azure ファイル同期エージェントがインストールされ、登録されていること。 Azure File Sync エージェントのインストールの詳細については、[Azure File Sync でのサーバーの登録と登録解除](file-sync-server-registration.md)に関するページを参照してください。 
- ストレージ同期サービスがデプロイされていること。 ストレージ同期サービスをデプロイする方法の詳細については、[Azure File Sync をデプロイする方法](file-sync-deployment-guide.md)に関するページを参照してください。 
- 同期グループがデプロイされていること。 [同期グループの作成方法](file-sync-deployment-guide.md#create-a-sync-group-and-a-cloud-endpoint)に関するセクションをご覧ください。
- サーバーがインターネットに接続され、Azure にアクセスできること。 Azure File Sync では、サーバーとクラウド サービスの間の全通信にポート 443 を使用します。

## <a name="create-a-server-endpoint"></a>サーバー エンドポイントを作成する

[!INCLUDE [storage-files-sync-create-server-endpoint](../../../includes/storage-files-sync-create-server-endpoint.md)]

### <a name="cloud-tiering-section"></a>[クラウドを使った階層化] セクション

新しいサーバー エンドポイントの作成時には、Azure File Sync のクラウドを使った階層化機能を使用するかどうかを選択できます。 **[クラウドを使った階層化]** セクションのオプションは後で変更可能です。 ただし、以下のセクションで述べる各種オプションを使用できるかどうかは、新しいサーバー ポイントに対してクラウドを使った階層化を有効にするかどうかで決まります。

詳しくは、基本事項、[ポリシー](file-sync-cloud-tiering-policy.md)、ベスト プラクティスについて解説したこちらの[クラウドを使った階層化](file-sync-cloud-tiering-overview.md)に関するページを参照してください。 

### <a name="initial-sync-section"></a>[初期同期] セクション

**[初期同期]** セクションは、同期グループの最初のサーバー エンドポイントでのみ使用できます。 サーバー エンドポイントを追加する場合は、「[[初期ダウンロード] セクション](#initial-download-section)」を参照してください。

初期同期動作には、根本的に異なる 2 つの動作があります。

:::row:::
    :::column:::
        **[マージ]**
    :::column-end:::
    :::column:::
        **[Authoritative upload]\(権限のあるアップロード\)**
    :::column-end:::
:::row-end:::
:::row:::
    :::column:::
        [マージ] は標準オプションであり、既定で選択されています。 特定の移行シナリオの場合を除いて、 **[マージ]** を選択したままにしてください。 
* サーバーの場所に参加する場合、ほとんどのシナリオでは、サーバーの場所またはクラウド共有が空白になっています。 このような場合、 **[マージ]** の動作は適切であり、期待どおりの結果が得られます。 
* 両方の場所にファイルとフォルダーが含まれている場合、名前空間はマージされます。 サーバー上のファイルまたはフォルダ名がクラウド共有上にも存在する場合、同期の競合が発生します。 [競合は自動的に解決されます](../files/storage-files-faq.md#afs-conflict-resolution)。 </br> </br> **[マージ]** オプションでは、Azure ファイル共有のコンテンツをサーバーに初めてダウンロードするときの方法を選択できます。 Azure ファイル共有が空の場合、この選択内容は影響を及ぼしません。 詳細については、この後の [[初期ダウンロード]](#initial-download-section) に関するセクションを参照してください
    :::column-end:::
    :::column:::
        **[Authoritative upload]\(権限のあるアップロード\)** は、特定の移行シナリオ専用の初期同期オプションです。 具体的には、インスタンスの Azure Data Box で、クラウド共有のシードに使用しているものと同じサーバー パスを同期するシナリオです。 この場合、クラウドおよびサーバーの場所にあるデータはほとんど同一ですが、サーバーの方が少しだけ新しくなっています。 ユーザーは、Data Box の転送中にも変更を行い続けます。 この移行シナリオでは、その後、競合が生じないように、サーバー上の変更内容 (新しい方) に合わせてクラウドをシームレスに更新する必要があります。 そのため、サーバーは名前空間の形状についての権限を持ち、サーバーからの大規模な初期アップロードを避けるために Data Box が使用されます。 クラウド ストレージのシードにオフライン データ転送メカニズムを使用する場合であっても、サーバーの権限のあるアップロードにより、クラウドをダウンタイムなしで導入できます。
    :::column-end:::
:::row-end:::

[Authoritative upload]\(権限のあるアップロード\) オプションを選択してサーバー エンドポイントをプロビジョニングできるケースは、サーバーの場所にデータが存在する場合のみに限られています。 これは、意図せず誤った構成が行われる事態を防ぐためです。 権限のあるアップロードの動作は、RoboCopy /MIR と同様です。 このモードでは、ソースをターゲットにミラーリングします。 ソースは AFS サーバーで、ターゲットはクラウド共有です。 権限のあるアップロードでは、ターゲットの形状はソースのイメージに合わせて形成されます。 

* 新規作成または更新されたファイルおよびフォルダーはサーバーからアップロードされます。
* サーバーに存在しない (しなくなった) ファイルとフォルダーは、クラウド共有から削除されます。
* サーバー上のファイルおよびフォルダーに対するメタデータのみの変更は、メタデータのみの更新として効率的にクラウド共有に反映されます。
* ファイルとフォルダーは、サーバー上とクラウド共有に存在することがあります。 ただし、Azure ファイル共有のシード処理以降に、サーバー上で一部のファイルやフォルダーの親ディレクトリが変更されている可能性があります。 これらのファイルやフォルダーは、クラウド共有から削除され、再アップロードされます。 そのため、移行中は、名前空間を大規模に再構築しないようにすることをお勧めします。

### <a name="initial-download-section"></a>[初期ダウンロード] セクション

**[初期ダウンロード]** セクションは、同期グループの 2 つ目以降のサーバー エンドポイントで使用できます。 [同期グループの最初のサーバー エンドポイントには、Azure Data Box を使用した移行に関係する特別なオプションがあります](#initial-sync-section)。 これらのオプションは、同期グループ内の最初のサーバー エンドポイントでなければ適用されません。

> [!NOTE]
> Azure ファイル共有が空の場合、[初期ダウンロード] オプションを選択しても影響はありません。

このセクションでは、Azure ファイル共有のコンテンツをサーバーに初めてダウンロードするときの方法も選択できます。

:::row:::
    :::column:::
        :::image type="content" source="media/file-sync-server-endpoint-create/initial-download-options.png" alt-text="Azure portal の [サーバー エンドポイントを作成します] ウィザードに含まれるオプションの説明画像。" lightbox="media/file-sync-server-endpoint-create/initial-download-options-expanded.png":::
    :::column-end:::
    :::column:::
* **名前空間のみ** </br> Azure ファイル共有のファイルおよびフォルダーの構造のみをローカル サーバーにダウンロードします。 ファイル コンテンツはダウンロードされません。 この新しいサーバー エンドポイントに対してクラウドを使った階層化を有効にしていた場合、このオプションが既定値になります。
* **名前空間の後にコンテンツ** </br> データを早期に利用できるようにするため、クラウドを使った階層化の設定にかかわらず、まず名前空間がダウンロードされます。 サーバーで名前空間が利用可能なってから、クラウドのファイル コンテンツがサーバーに呼び戻されます。 呼び戻しは、各ファイルの最終変更日時のタイムスタンプ順に行われます。 サーバー ボリュームの領域に空きがなくなった時点で、以降のファイルは階層化されたままになります。 このサーバー エンドポイントに対してクラウドを使った階層化を有効にしていない場合、このオプションが既定値になります。
* **階層化されたファイルを除く** </br> このオプションでは、各ファイルの全体をダウンロードしてから、サーバー上のフォルダーに表示します。 このオプションを使用すると、サーバー上に階層化されたファイルが存在しなくなります。 名前空間の項目とファイル コンテンツは、常に同時に存在します。 サーバー エンドポイントの作成目的がクラウドからのディザスター リカバリーである場合には、このオプションは選択しないでください。 全ファイルを必要とするアプリケーションがあり、その名前空間で、階層化されたファイルが許可されない場合は、この方法が理想的です。 新しいサーバー エンドポイントにクラウドを使った階層化を使用している場合、このオプションは使用できません。
    :::column-end:::
:::row-end:::

[初期ダウンロード] オプションの選択内容を、サーバー エンドポイントの作成の確定後に変更することはできません。 初期ダウンロードの完了後のサーバー上でのファイルの表示方法は、クラウドを使った階層化機能を使用しているかどうか、および[クラウドの変更の事前呼び戻し](file-sync-cloud-tiering-overview.md#proactive-recalling)を有効にしているかどうかで決まります。 後者は、同期グループに地理的な場所の異なるサーバー エンドポイントが複数含まれている場合に有用な機能です。

* **クラウドを使った階層化が有効** </br> このサーバー エンドポイントでは、他のサーバー エンドポイントの新規ファイルおよび変更済みファイルが階層化されたファイルとして表示されます。 これらの変更は、他のサーバー エンドポイントによる Azure ファイル共有の変更の[事前呼び戻し](file-sync-cloud-tiering-overview.md#proactive-recalling)を有効にしている場合のみ、完全なファイルになります。
*  **クラウドを使った階層化が無効** </br> このサーバー エンドポイントでは、他のサーバー エンドポイントの新規ファイルおよび変更済みファイルが完全なファイルとして表示されます。 これらのファイルは、まず階層化されたファイルとして表示されてから呼び戻されます。 クラウドを使った階層化により階層化されたファイルは、ディザスター リカバリーを高速化するための機能であり、初期プロビジョニング中のみ表示されます。


## <a name="next-steps"></a>次のステップ

Azure ファイル共有と Azure File Sync については、さらに押さえておくべきことがあります。以下の記事は、詳細なオプションおよびベスト プラクティスの理解に役立ちます。 また、トラブルシューティングに役立つ情報も含まれています。 これらの記事には、必要に応じて [Azure ファイル共有のドキュメント](../files/storage-files-introduction.md)へのリンクが含まれています。

* [移行の概要](../files/storage-files-migration-overview.md)
* [Azure File Sync のデプロイの計画](../file-sync/file-sync-planning.md)
* [ファイル共有を作成する](../files/storage-how-to-create-file-share.md)
* [Azure File Sync のトラブルシューティング](../file-sync/file-sync-troubleshoot.md)
