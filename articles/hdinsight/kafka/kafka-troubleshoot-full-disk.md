---
title: Azure HDInsight のディスクがいっぱいであるためにブローカーが起動できない
description: ディスク不足のエラーのために起動できない Apache Kafka ブローカー プロセスのトラブルシューティング手順。
ms.service: hdinsight
ms.topic: troubleshooting
author: Jacky-hdi
ms.author: linjzhu
ms.date: 10/11/2021
ms.openlocfilehash: 3e7d113da1c086c0a95916dd29c9149beb897862
ms.sourcegitcommit: d2875bdbcf1bbd7c06834f0e71d9b98cea7c6652
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 10/12/2021
ms.locfileid: "129859581"
---
# <a name="scenario-brokers-are-unhealthy-or-cant-restart-due-to-disk-space-full-issue"></a>シナリオ: ブローカーが異常であるか、またはディスク領域不足の問題のために再起動できない

この記事では、Azure HDInsight クラスターで Apache Kafka を使用しているときの問題のトラブルシューティング手順と考えられる解決策について説明します。

## <a name="issue"></a>問題

Azure HDInsight クラスターで Apache Kafka ブローカーによって使用されているデータ ディスクがいっぱいになる場合があります。 それが発生すると、ディスク不足のエラーのために Apache Kafka ブローカー プロセスが起動できず、失敗します。 最近、何らかの構成変更を行っている場合は、Kafka ブローカー プロセスが起動しないため、それらの変更が有効になりません。

## <a name="cause"></a>原因

この問題は、次のシナリオの 1 つ以上が原因で発生することがあります。

- Kafka クラスターを作成した後にディスクの数を増やしたり、ディスク サイズを増やしたりすることはできません。
- 通常、ディスク アラートは Apache Ambari UI で構成されます。 ディスクの使用率が上昇し 60% を超えるたびに、アラートにより、スケールアウトするか、または Kafka クラスターに存在するログの数を削減する必要があることが通知されます。
- この問題は、ディスク アラートを無視した場合にのみ発生します。 ディスク領域のアラートに対応するために、クラスターをスケールアウトしてより多くの領域を使用可能にすることもできます。
- メッセージは、保有期間が経過したとしてもすぐには削除されません。 削除される予定のメッセージは、削除のためにマークされます。 後で、バックグラウンドのクリーンアップ プロセスによってメッセージが削除されます。 パッシブ セグメント内のメッセージのみが削除されます。

> [!IMPORTANT]
> ログ クリーナーのパフォーマンスを強化する構成を使用することはできますが、メッセージの生成や使用に影響を与える可能性があるため、この強化を適用するときは "*注意が必要*" です。

## <a name="mitigation"></a>対応策

問題を軽減するには:

1. `server.properties` ファイルをチェックして、すべてのトピックの保有期間を見つけます。 ログの保有ポリシーは、トピック レベルに設定されている場合があります。 トピック レベルに構成されている保有期間を見つけるには、次のコマンドを実行します。

    ```bash
    /usr/hdp/current/kafka-broker/bin/kafka-topics.sh --describe --zookeeper <zookeeper-list>
    ```

2. その情報を入手したら、負荷の高いどのパーティションが最大のディスク領域を占有しているかを確認します。

    ```bash
    # Command to sort the directories based on size:
    du -hs * | sort -rh | head -5 
    ```

3. 新しい保有期間より古いファイルをバックアップします。

4. 使用可能な空き領域が存在する場合は、ブローカーを再起動して新しい保有期間構成を使用できます。 ブローカーを再起動すると、古いログがクリーニングされ、ディスク上の一部の領域が解放されます。

   > [!IMPORTANT]
   > バックアップの作成は、OS ディスクがいっぱいになるか、または他の Kafka ディスクが過負荷になる可能性があるため、オプションにならない場合があります。 このシナリオでは、保有期間より古いファイルの削除が必要になる可能性があります。

## <a name="resolution"></a>解像度

保有期間を短縮できたとしても、クラスター内にさらに多くのトピックを追加したい場合や、取り込まれるデータの負荷や量が増加する場合、その構成はスケーラブルではありません。

これらのシナリオを回避するには、次のいずれかのオプションの使用を検討してください。

- パーティションが大きすぎる場合は、最も負荷の高いトピックのパーティションの数を増やします。

  > [!NOTE]
  > 既存のトピックのパーティションを増やしても、そのトピック内のデータは再構成されません。 最初に、パーティションの少ない古いトピックから、パーティションの多い新しいトピックにデータを手動でコピーする必要があります。 

- クラスターをスケールアウトし、複数のディスクにまたがってすべてのパーティションを再調整します。

- SKU が大きく、かつより多くのディスクが接続されたクラスターを作成します。

## <a name="next-steps"></a>次の手順

[!INCLUDE [troubleshooting next steps](../includes/hdinsight-troubleshooting-next-steps.md)]
