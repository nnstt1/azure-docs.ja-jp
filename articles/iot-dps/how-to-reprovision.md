---
title: Azure IoT Hub Device Provisioning Service でデバイスを再プロビジョニングする
description: Device Provisioning Service (DPS) インスタンスを使用してデバイスを再プロビジョニングする方法と、何故これを実行する必要があるのかについて説明します。
author: wesmc7777
ms.author: wesmc
ms.date: 01/25/2021
ms.topic: conceptual
ms.service: iot-dps
services: iot-dps
ms.openlocfilehash: 43e0d3228937e507f988aa241b6fa0b619892c10
ms.sourcegitcommit: 613789059b275cfae44f2a983906cca06a8706ad
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 09/29/2021
ms.locfileid: "129273687"
---
# <a name="how-to-reprovision-devices"></a>デバイスを再プロビジョニングする方法

IoT ソリューションのライフサイクル中に、デバイスを IoT ハブ間で移動することはよくあります。 このトピックは、再プロビジョニング ポリシーを構成するソリューション オペレーターを支援するために記述されています。

再プロビジョニング シナリオの詳細については、「[IoT ハブ デバイスの再プロビジョニングの概念](concepts-device-reprovision.md)」を参照してください。


## <a name="configure-the-enrollment-allocation-policy"></a>登録割り当てポリシーを構成する

割り当てポリシーは、登録に関連付けられたデバイスが再プロビジョニングされた後に IoT ハブにどのように割り当てられるかを決定するものです。

次の手順に従って、デバイスの登録の割り当てポリシーを構成します。

1. [Azure portal](https://portal.azure.com) にサインインし、Device Provisioning Service インスタンスに移動します。

2. **[登録を管理します]** をクリックし、再プロビジョニングのために構成する登録グループまたは個々の登録をクリックします。 

3. **[デバイスをハブに割り当てる方法を選択してください]** で、次の割り当てポリシーのいずれかを選択します。

    * **[最低待ち時間]** : このポリシーを使用すると、デバイスはリンクされた IoT ハブに割り当てられ、デバイスと IoT ハブの間で行われる通信の待ち時間が最小に抑えられます。 このオプションを使用すると、デバイスは位置に基づいて最も近い IoT ハブと通信できます。 
    
    * **[加重が均等に分布]** : このポリシーを使用すると、デバイスは、リンクされた各 IoT ハブに割り当てられた割り当ての重みに基づいて、リンクされた IoT ハブ全体に分散されます。 このポリシーを使用すると、リンクされたハブに設定された割り当ての重みに基づいて、それらのハブのグループ全体でデバイスの負荷を分散できます。 デバイスを 1 つの IoT ハブにのみプロビジョニングする場合は、この設定をお勧めします。 これは、既定の設定です。 
    
    * **[Static configuration]\(静的構成\)** : このポリシーを使用する場合は、プロビジョニングするデバイスの登録エントリに、目的の IoT ハブを含める必要があります。 このポリシーでは、デバイスを割り当てる特定の IoT ハブを 1 つ指定することができます。

4. **[Select the IoT hubs this group can be assigned to]\(このグループを割り当てられる IoT ハブを選択してください\)** で、割り当てポリシーに含めるリンクされた IoT ハブを選択します。 必要に応じて、 **[Link a new IoT Hub]\(新しい IoT ハブのリンク\)** ボタンを使用して、リンクされた IoT ハブを新たに追加します。

    **[最短待機時間]** 割り当てポリシーでは、デバイスの割り当て先となる最も近いハブを特定するために、選択したハブが待ち時間評価の対象となります。

    **[加重が均等に分布]** 割り当てポリシーでは、構成された割り当ての重みと現在のデバイス負荷に基づいて、選択したハブ間でデバイスの負荷が分散されます。

    **[Static configuration]\(静的構成\)** 割り当てポリシーでは、デバイスを割り当てる IoT ハブを選択します。

4. **[保存]** をクリックします。または、次のセクションに進み、再プロビジョニング ポリシーを設定します。

    ![登録割り当てポリシーを選択する](./media/how-to-reprovision/enrollment-allocation-policy.png)



## <a name="set-the-reprovisioning-policy"></a>再プロビジョニング ポリシーを設定する

1. [Azure portal](https://portal.azure.com) にサインインし、Device Provisioning Service インスタンスに移動します。

2. **[登録を管理します]** をクリックし、再プロビジョニングのために構成する登録グループまたは個々の登録をクリックします。

3. **[Select how you want device data to be handled on re-provision to a different IoT hub]\(別の IoT ハブに再プロビジョニングするときのデバイス データの処理方法を選択してください\)** で、次の再プロビジョニング ポリシーのいずれかを選択します。

    * **[Re-provision and migrate data]\(再プロビジョニングしてデータを移行する\)** : このポリシーは、登録エントリに関連付けられているデバイスが新しいプロビジョニング要求を送信するときにアクションを実行します。 登録エントリの構成に応じて、デバイスは別の IoT ハブに再割り当てされる可能性があります。 デバイスの割り当て先の IoT ハブが変更されると、最初の IoT ハブへのデバイスの登録は削除されます。 最初の IoT ハブからのすべてのデバイス状態情報は、新しい IoT ハブに移行されます。 移行中、デバイスの状態は "**割り当てています**" と報告されます

    * **[Re-provision and reset to initial config]\(再プロビジョニングして初期構成にリセットする\)** : このポリシーは、登録エントリに関連付けられているデバイスが新しいプロビジョニング要求を送信するときにアクションを実行します。 登録エントリの構成に応じて、デバイスは別の IoT ハブに再割り当てされる可能性があります。 デバイスの割り当て先の IoT ハブが変更されると、最初の IoT ハブへのデバイスの登録は削除されます。 デバイスがプロビジョニングされたときにプロビジョニング サービス インスタンスが受け取った初期構成のデータは、新しい IoT ハブに提供されます。 移行中、デバイスの状態は "**割り当てています**" と報告されます。

4. **[保存]** をクリックして、変更に基づくデバイスの再プロビジョニングを有効にします。

    ![行った変更と [保存] ボタンが強調表示されているスクリーンショット。](./media/how-to-reprovision/reprovisioning-policy.png)



## <a name="send-a-provisioning-request-from-the-device"></a>デバイスからプロビジョニング要求を送信する

前のセクションで行った構成の変更に基づいてデバイスを再プロビジョニングするには、これらのデバイスから再プロビジョニングを要求する必要があります。 

デバイスからプロビジョニング要求を送信する頻度は、シナリオによって異なります。 ただし、再起動時にデバイスからプロビジョニング サービス インスタンスにプロビジョニング要求が送信されるようにプログラムすると共に、必要に応じて手動でプロビジョニングをトリガーする[メソッド](../iot-hub/iot-hub-devguide-direct-methods.md)をサポートすることをお勧めします。 プロビジョニングは、[必要なプロパティ](../iot-hub/iot-hub-devguide-device-twins.md#desired-property-example)を設定することによってトリガーすることもできます。 

登録エントリの再プロビジョニング ポリシーによって、Device Provisioning Service インスタンスでこれらのプロビジョニング要求を処理する方法と、再プロビジョニング中にデバイス状態データを移行する必要があるかどうかが決定されます。 同じポリシーを個別の登録と登録グループに利用できます。

ブート シーケンス中にデバイスからプロビジョニング要求を送信する場合のコード例については、[シミュレートされたデバイスの自動プロビジョニング](quick-create-simulated-device-tpm.md)に関するページを参照してください。


## <a name="next-steps"></a>次のステップ

- 再プロビジョニングの詳細については、「[IoT Hub Device reprovisoning concepts](concepts-device-reprovision.md)」(IoT Hub デバイスの再プロビジョニングの概念) をご覧ください 
- プロビジョニング解除の詳細については、「[自動プロビジョニングされた以前のデバイスのプロビジョニングを解除する方法](how-to-unprovision-devices.md)」をご覧ください 











