---
title: Azure IoT Hub Device Provisioning Service - X.509 証明書の構成証明
description: Device Provisioning Service (DPS) および IoT Hub による X.509 証明書の構成証明の使用に固有の概念について説明します
author: wesmc7777
ms.author: wesmc
ms.date: 09/14/2020
ms.topic: conceptual
ms.service: iot-dps
services: iot-dps
ms.openlocfilehash: d3847ec5ce253d2d5f2ad18ce9a0cc912335e2f4
ms.sourcegitcommit: 4a54c268400b4158b78bb1d37235b79409cb5816
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 04/28/2021
ms.locfileid: "108141999"
---
# <a name="x509-certificate-attestation"></a>X.509 証明書の構成証明

この記事では、X.509 証明書の構成証明を使用してデバイスをプロビジョニングするときに必要となる Device Provisioning Service (DPS) の概念について概説します。 この記事は、デプロイのために準備されたデバイスの取得に関わるすべてのユーザーに最も役立ちます。

X.509 証明書は、ハードウェア セキュリティ モジュール HSM に格納できます。

> [!TIP]
> 運用環境のデバイスに、X.509 証明書などのシークレットを安全に格納するために、デバイスで HSM を使用することを強くお勧めします。


## <a name="x509-certificates"></a>X.509 証明書

X.509 証明書を構成証明メカニズムとして使用することは、実稼働環境を拡張し、デバイスのプロビジョニングを簡素化するための優れた方法です。 X.509 証明書は通常、信頼する証明書チェーンに配置されます。証明書チェーンでは、チェーン内の各証明書が次の上位証明書の秘密キーによって署名され、最後は自己署名ルート証明書で終わります。 この配置により、信頼されたルート証明機関 (CA) によって生成されるルート証明書から、各中間 CA 証明書やデバイスにインストールされたエンドエンティティ "リーフ" 証明書に至る、信頼する委任チェーンが確立されます。 詳細については、「[X.509 CA 証明書を使用したデバイス認証](../iot-hub/iot-hub-x509ca-overview.md)」をご覧ください。 

証明書チェーンは、多くの場合、デバイスに関連付けられている論理的または物理的階層を表します。 たとえば、製造元は次の事項ができます。
- 自己署名のルート CA 証明書を発行する
- 発行されたルート証明書を使用してファクトリごとに一意の中間 CA 証明書を生成する
- 各ファクトリの証明書を使用して工場の生産ラインごとに一意の中間 CA 証明書を生成する
- 最後に生産ラインの証明書を使用して生産ラインで製造されるデバイスごとに一意のデバイス (エンドエンティティ) 証明書を生成する 

詳細については、「[IoT 業界における X.509 CA 証明書の概念理解](../iot-hub/iot-hub-x509ca-concept.md)」をご覧ください。 

### <a name="root-certificate"></a>ルート証明書

ルート証明書は、証明機関 (CA) を表す自己署名の X.509 証明書です。 証明書チェーンの終端、つまりトラスト アンカーになります。 ルート証明書は組織が自ら発行することも、ルート証明機関から購入することもできます。 詳細については、「[X.509 CA 証明書を入手する](../iot-hub/tutorial-x509-scripts.md)」をご覧ください。 ルート証明書は、ルート CA 証明書とも呼ばれます。

### <a name="intermediate-certificate"></a>中間証明機関の証明書

中間証明書は、ルート証明書 (または、証明書チェーン内のルート証明書を使用する別の中間証明書) によって署名された X.509 証明書です。 チェーン内の最後の中間証明書は、リーフ証明書の署名に使用されます。 中間証明書は、中間 CA 証明書とも呼ばれます。

##### <a name="why-are-intermediate-certs-useful"></a>中間証明書が役に立つ理由
中間証明書は、さまざまな方法で使用されます。 たとえば中間証明書を使用して、製品ラインや顧客の購入デバイス、会社の部門、工場別にデバイスをグループ化できます。 

Contoso という大企業が、*ContosoRootCert* という名前のルート証明書を使用している独自の公開キー基盤 (PKI) を持っていると仮定します。 Contoso の各子会社には、*ContosoRootCert* によって署名された独自の中間証明書があります。 各子会社では、中間証明書を使用して各デバイスのリーフ証明書に署名します。 このシナリオでは、Contoso は *ContosoRootCert* が [所有証明](./how-to-verify-certificates.md)によって検証されている、1 つの DPS インスタンスを使用できます。 各子会社に対する登録グループを持つことができます。 この方法により、個々の子会社は証明書の検証について心配する必要がなくなります。


### <a name="end-entity-leaf-certificate"></a>エンド エンティティ "リーフ" 証明書

リーフ証明書、つまりエンドエンティティ証明書は、証明書の所有者を識別します。 リーフ証明書には、証明書チェーン内のルート証明書と 0 個以上の中間証明書が含まれます。 リーフ証明書は、他の証明書の署名には使用されません。 プロビジョニング サービスに対してデバイスを一意に識別し、デバイス証明書と呼ばれることもあります。 デバイスは認証時に、この証明書に関連付けられた秘密キーを使用して、サービスからの所有証明チャレンジに応答します。

[個別の登録](./concepts-service.md#individual-enrollment)エントリで使用されるリーフ証明書には、**サブジェクト名** を個別の登録エントリの登録 ID に設定しなければならないという要件があります。 [登録グループ](./concepts-service.md#enrollment-group)エントリで使用されるリーフ証明書では、**サブジェクト名** が、登録グループ内にある認証済みデバイスの **登録レコード** に表示されているご希望のデバイス ID に設定される必要があります。

詳細については、「[X.509 CA 証明書で署名されたデバイスを認証する](../iot-hub/iot-hub-x509ca-overview.md#authenticating-devices-signed-with-x509-ca-certificates)」をご覧ください。

## <a name="controlling-device-access-to-the-provisioning-service-with-x509-certificates"></a>X.509 証明書を使用してプロビジョニング サービスへのデバイスのアクセスを制御する

プロビジョニング サービスでは、X.509 構成証明メカニズムによるデバイス アクセスの制御に使用できる 2 つの登録タイプが公開されています。  

- [個別登録](./concepts-service.md#individual-enrollment)エントリは、特定のデバイスに関連付けられたデバイス証明書を使用して構成されます。 これらのエントリは、特定のデバイスの登録を制御します。
- [登録グループ](./concepts-service.md#enrollment-group) エントリは、特定の中間 CA 証明書やルート CA 証明書に関連付けられます。 これらのエントリは、証明書チェーン内にその中間証明書やルート証明書を持つすべてのデバイスの登録を制御します。 

#### <a name="dps-device-chain-requirements"></a>DPS デバイス チェーンの要件

デバイスから登録グループを使用した DPS 経由での登録が試行されている場合、デバイスによってリーフ証明書から[所有証明](how-to-verify-certificates.md)で検証済みの証明書までの証明書チェーンが送信される必要があります。 そうでない場合、認証は失敗します。

たとえば、ルート証明書のみが検証され、中間証明書が登録グループにアップロードされている場合、デバイスによってリーフ証明書から検証済みのルート証明書に至るまでの証明書チェーンが提示される必要があります。 この証明書チェーンには、間にあるすべての中間証明書が含まれます。 DPS が証明書チェーンを検証済みの証明書まで追跡できない場合、認証は失敗します。

たとえば、ある会社でデバイスに次のデバイス チェーンを使用しているとします。

![デバイス証明書チェーンの例](./media/concepts-x509-attestation/example-device-cert-chain.png) 

ルート証明書のみが検証済みで、*intermediate2* 証明書が登録グループにアップロードされています。

![ルートが検証済みの例](./media/concepts-x509-attestation/example-root-verified.png) 

プロビジョニング中にデバイスから次のデバイス チェーンのみが送信された場合、認証は失敗します。 DPS は *intermediate1* 証明書の有効性を仮定して認証を試行できないためです。

![失敗する証明書チェーンの例](./media/concepts-x509-attestation/example-fail-cert-chain.png) 

プロビジョニング中にデバイスから次のような完全なデバイス チェーンが送信された場合、DPS はデバイスの認証を試みることができます。

![デバイス証明書チェーンの例](./media/concepts-x509-attestation/example-device-cert-chain.png) 




> [!NOTE]
> 中間証明書は、[所有証明](how-to-verify-certificates.md)で確認することもできます。


#### <a name="dps-order-of-operations-with-certificates"></a>証明書に対する DPS 操作の順序
デバイスからプロビジョニング サービスへの接続時には、サービスは具体性の高い登録エントリを、具体性の低いエントリよりも優先します。 つまり、デバイスに個別登録がある場合、プロビジョニング サービスでは個別登録のエントリが適用されます。 デバイスに個別登録がなく、デバイスの証明書チェーン内の最初の中間証明書に登録グループが存在する場合、サービスによってこの登録グループ エントリが適用されます。これが証明書チェーンのルートまで同様に行われます。 サービスは次のようにして、最初に見つけた適用可能なエントリを適用します。

- 最初に見つけた登録エントリが有効な場合、サービスはデバイスをプロビジョニングします。
- 最初に見つけた登録エントリが無効な場合、サービスはデバイスをプロビジョニングしません。  
- デバイスの証明書チェーン内のどの証明書にも登録エントリが見つからない場合、サービスはデバイスをプロビジョニングしません。 

このメカニズムと証明書チェーン階層構造により、個別のデバイスやデバイス グループへのアクセスを柔軟に制御できます。 たとえば、次の証明書チェーンを持つ 5 つのデバイスがあるとします。 

- *デバイス 1*: ルート証明書 -> 証明書 A -> デバイス 1 の証明書
- *デバイス 2*: ルート証明書 -> 証明書 A -> デバイス 2 の証明書
- *デバイス 3*: ルート証明書 -> 証明書 A -> デバイス 3 の証明書
- *デバイス 4*: ルート証明書 -> 証明書 B -> デバイス 4 の証明書
- *デバイス 5*: ルート証明書 -> 証明書 B -> デバイス 5 の証明書

最初に、5 つすべてのデバイスのアクセスを有効にする、ルート証明書の有効なグループ登録エントリを 1 つ作成します。 後で証明書 B が侵害された場合には、証明書 B に無効な登録グループ エントリを作成して、*デバイス 4* と *デバイス 5* が登録されるのを防ぐことができます。 さらにその後、*デバイス 3* が侵害された場合には、デバイス 3 の証明書に無効な個別登録エントリを作成できます。 これにより *デバイス 3* へのアクセスが取り消されますが、*デバイス 1* と *デバイス 2* ではまだ登録が可能です。