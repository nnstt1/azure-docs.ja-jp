---
title: ベスト プラクティス
description: Azure Batch ソリューションを開発するためのベスト プラクティスと役立つヒントについて説明します。
ms.date: 09/03/2021
ms.topic: conceptual
ms.openlocfilehash: e910fd444fc443ef93d9cc513632ad6ab11a124e
ms.sourcegitcommit: 702df701fff4ec6cc39134aa607d023c766adec3
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 11/03/2021
ms.locfileid: "131461573"
---
# <a name="azure-batch-best-practices"></a>Azure Batch のベスト プラクティス

この記事では、Azure Batch サービスを効果的に使用するためのベスト プラクティスと役に立つヒントについて説明します。 これらのヒントは、パフォーマンスを向上させ、Batch ソリューションの設計上の落とし穴を回避するために役立ちます。

> [!TIP]
> Azure Batch のセキュリティのガイダンスについては、「[Batch のセキュリティとコンプライアンスのベスト プラクティス](security-best-practices.md)」を参照してください。

## <a name="pools"></a>プール

[プール](nodes-and-pools.md#pools)は、Batch サービスでジョブを実行するためのコンピューティング リソースです。 以下のセクションでは、Batch プールを使用するための推奨事項について説明します。

### <a name="pool-configuration-and-naming"></a>プールの構成と名前指定

- **プール割り当てモード:** Batch アカウントの作成時に、**Batch サービス** または **ユーザー サブスクリプション** の 2 つのプール割り当てモードのいずれかを選択できます。 ほとんどの場合、既定の Batch サービス モードを選択することになります。このモードでは、Batch で管理されているサブスクリプションにバックグラウンドでプールが割り当てられます。 もう一方のユーザー サブスクリプション モードでは、プールの作成時に Batch VM などのリソースがサブスクリプションに直接作成されます。 ユーザー サブスクリプション アカウントは主に、小規模であるが重要なシナリオのサブセットを有効にするために使用されます。 詳細については、「[ユーザー サブスクリプション モードのための追加構成](batch-account-create-portal.md#additional-configuration-for-user-subscription-mode)」を参照してください。

- **"virtualMachineConfiguration" または "cloudServiceConfiguration":** 現在、いずれかの構成を使用してプールを作成できますが、新しいプールは "cloudServiceConfiguration" ではなく "virtualMachineConfiguration" を使用して構成する必要があります。 現在および新しいすべての Batch 機能は、仮想マシンの構成プールによってサポートされます。 Cloud Services の構成プールでは、すべての機能はサポートされず、新しい機能は計画されていません。 [2024 年 2 月 29 日以降](https://azure.microsoft.com/updates/azure-batch-cloudserviceconfiguration-pools-will-be-retired-on-29-february-2024/)、新しい 'cloudServiceConfiguration' プールを作成したり、既存のプールに新しいノードを追加したりすることはできなくなります。 詳細については、「[Batch プールの構成を Cloud Services から仮想マシンに移行する](batch-pool-cloud-service-to-virtual-machine-configuration.md)」を参照してください。

- **ジョブとタスクの実行時間に関する考慮事項:** ジョブが主に実行時間の短いタスクで構成されていて、かつ予想されるタスクの総数が少ないため、ジョブで予想される全体的な実行時間が長くない場合は、ジョブごとに新しいプールを割り当てないでください。 ノードの割り当て時間により、ジョブの実行時間が減少します。

- **複数の計算ノード:** 個々のノードが常に使用可能な状態であるとは限りません。 まれなケースですが、ハードウェア障害、オペレーティング システムの更新、その他の多くの問題によって、個々のノードがオフラインになることがあります。 Batch ワークロードの進捗が確実で保証されている必要がある場合、複数のノードでプールを割り当てる必要があります。

- **サポート終了日 (EOL) が近いイメージ:** Batch のサポート終了日 (EOL) が近いイメージは、使用しないようにすることを強くお勧めします。 このような日付は、[ `ListSupportedImages` API](/rest/api/batchservice/account/listsupportedimages)、[PowerShell](/powershell/module/az.batch/get-azbatchsupportedimage)、または [Azure CLI](/cli/azure/batch/pool/supported-images) で確認することができます。 プールに関連する EOL 日のビューを定期的に更新し、EOL 日になる前にワークロードを移行することは、お客様の責任となります。 指定されたノード エージェントでカスタム イメージを使用している場合は、カスタム イメージが派生されている、または連携しているイメージについて、Batch のサポート終了日を追跡できていることを確認してください。

- **一意のリソース名:** 多くの場合、Batch リソース (ジョブ、プールなど) は、時間の経過と共に作成されたり削除されたりします。 たとえば、月曜日にプールを作成し、火曜日に削除した後、木曜日にもう 1 つ同じプールを作成することがあります。 新しく作成した各リソースには、以前に使用したことのない一意の名前を付ける必要があります。 一意の名前を付けるには、GUID を使用するか (リソース名全体、またはその一部として)、リソースが作成された日付と時間をリソース名に埋め込みます。 Batch では [DisplayName](/dotnet/api/microsoft.azure.batch.jobspecification.displayname) がサポートされています。これにより、実際のリソース ID が人間にとってわかりやすいものではない場合でも、より判読しやすい名前をリソースに付けることができます。 一意の名前を使用すると、ログとメトリックで何らかの処理を行った特定のリソースを簡単に識別できます。 また、リソースのサポート ケースを提出する必要がある場合にも、あいまいさが解消されます。

- **プールのメンテナンス中とエラー発生時の継続性:** ジョブではプールを動的に使用することをお勧めします。 ジョブですべてのものに同じプールを使用する場合、プールで問題が発生した場合にジョブが実行されない可能性があります。 これは、時間の制約のあるワークロードでは特に重要です。 この問題を解決するには、各ジョブをスケジュールするときにプールを動的に選択または作成するか、異常なプールをバイパスできるようにプール名をオーバーライドする方法を用意しておきます。

- **プールのメンテナンス中とエラー発生時のビジネス継続性:** 必要なサイズまでプールを拡大できない原因として、内部エラーや容量の制約など、多くのことが考えられます。 必要に応じて、別のプールでジョブを再ターゲットできることを確認します (別の VM サイズが使用される可能性がありますが、これは [UpdateJob](/dotnet/api/microsoft.azure.batch.protocol.joboperationsextensions.update) を介して Batch でサポートされます)。 削除や変更が行われないことを前提にして静的プール ID に依存することは避けてください。

### <a name="pool-lifetime-and-billing"></a>プールの有効期間と課金

プールの有効期間は、割り当ての方法とプール構成に適用されるオプションによって異なります。 プールには、任意の有効期間と、さまざまな数の計算ノードをいつでも指定できます。 プール内の計算ノードを明示的、またはサービスによって提供される機能 ([自動スケーリング](nodes-and-pools.md#automatic-scaling-policy)または[自動プール](nodes-and-pools.md#autopools)) を介して管理するのはユーザーの責任です。

- **プールの鮮度:** 数か月ごとにプールのサイズを 0 に変更して、[最新のノード エージェントの更新とバグ修正](https://github.com/Azure/Batch/blob/master/changelogs/nodeagent/CHANGELOG.md)を確実に取得する必要があります。 プールは、再作成されない限り (または計算ノードのサイズが 0 に変更されない限り)、ノード エージェントの更新を受け取りません。 プールを再作成またはサイズ変更する前に、デバッグ目的でノード エージェント ログをダウンロードする必要があります (「[ノード](#nodes)」セクションを参照)。

- **プールの再作成:** 同様に、プールを毎日削除して再作成することは避けてください。 代わりに、新しいプールを作成し、その新規プールを参照するように既存のジョブを更新します。 すべてのタスクを新しいプールに移動したら、古いプールを削除します。

- **プールの効率と課金:** Batch 自体に追加料金は発生しませんが、使用されるコンピューティング リソースに対して料金が発生します。 プール内のすべての計算ノードに対して、その状態に関係なく課金されます。 これには、ストレージやネットワーク コストなど、ノードを実行するために必要な料金がすべて含まれます。 詳細については、「[Azure Batch のコスト分析と予算](budget.md)」を参照してください。

- **エフェメラル OS ディスク:** 仮想マシン構成プールでは、VM キャッシュまたは一時 SSD 上に OS ディスクを作成する [エフェメラル OS ディスク](create-pool-ephemeral-os-disk.md)を使用して、マネージド ディスクに関連した追加コストを回避できます。

### <a name="pool-allocation-failures"></a>プール割り当ての失敗

プール割り当ての失敗は、最初の割り当て中またはその後のサイズ変更中の任意の時点で発生する可能性があります。 これは、リージョン内の一時的な容量不足や、Batch が使用している他の Azure サービスの障害が原因で発生する可能性があります。 コア クォータは保証ではなく、制限です。

### <a name="unplanned-downtime"></a>計画外のダウンタイム

Batch プールでは、Azure のダウンタイム イベントが発生する可能性があります。 Batch のシナリオまたはワークフローの計画および開発時には、この点に留意してください。 ノードで障害が発生した場合、Batch は自動的にそれらの計算ノードを回復しようとします。 これにより、回復されたノードで実行中のタスクの再スケジュールがトリガーされることがあります。 中断されたタスクの詳細については、[再試行のための設計](#design-for-retries-and-re-execution)に関するセクションを参照してください。

### <a name="custom-image-pools"></a>カスタム イメージ プール

仮想マシンの構成を使用して Azure Batch プールを作成するときは、プールの各コンピューティング ノードにオペレーティング システムを提供する VM イメージを指定します。 サポートされている Azure Marketplace イメージを使ってプールを作成したり、[Azure Compute Gallery のイメージを使ってカスタム イメージを作成したり](batch-sig-images.md)できます。 [マネージド イメージ](batch-custom-images.md)を使ってカスタム イメージ プールを作成することもできますが、可能であれば、Azure Compute Gallery を使ってカスタム イメージを作成することをお勧めします。 Azure Compute Gallery を使うと、プールを迅速にプロビジョニングしたり、VM の数を増やしたり、VM のプロビジョニング時に信頼性を向上させたりできます。

### <a name="third-party-images"></a>サード パーティのイメージ

プールは、Azure Marketplace に発行されたサード パーティのイメージを使用して作成できます。 ユーザー サブスクリプション モードの Batch アカウントを使用すると、特定のサード パーティのイメージでプールを作成する場合、"Marketplace での購入資格の確認のため、割り当てに失敗しました" というエラーが表示されることがあります。 このエラーを解決するには、イメージの発行者によって設定された条項に同意します。 これを行うには、[Azure PowerShell](/powershell/module/azurerm.marketplaceordering/set-azurermmarketplaceterms) または [Azure CLI](/cli/azure/vm/image/terms) を使用します。

### <a name="azure-region-dependency"></a>Azure リージョンの依存関係

時間に制約のあるワークロードまたは運用ワークロードがある場合は、単一の Azure リージョンに依存しないようにします。 まれに、リージョン全体に影響する可能性がある問題が発生することがあります。 たとえば、特定の時刻に処理を開始する必要がある場合は、*開始時刻の十分前に*、プライマリ リージョンでプールをスケールアップすることを検討してください。 プールのスケーリングに失敗した場合は、バックアップ リージョン (複数可) のプールのスケールアップにフォールバックできます。

さまざまなリージョンの複数のアカウントにまたがるプールには、他のプールで問題が発生した場合に、簡単にアクセスできるバックアップが用意されています。 詳細については、「[高可用性を実現するようにアプリケーションを設計する](high-availability-disaster-recovery.md)」を参照してください。

## <a name="jobs"></a>ジョブ

[ジョブ](jobs-and-tasks.md#jobs)は、数百、数千、あるいは数百万ものタスクを含むように設計されたコンテナーです。 ジョブを作成するときは、次のガイドラインに従ってください。

### <a name="fewer-jobs-more-tasks"></a>ジョブを少なくし、タスクを多くする

1 つのジョブを使用して 1 つのタスクを実行するのは効率的ではありません。 たとえば、10 個のタスクをそれぞれ含む 100 個のジョブを作成するのではなく、1000 個のタスクを含む 1 つのジョブを使用する方が効率的です。 それぞれが 1 つのタスクを持つ 1000 個のジョブを実行することは、最も非効率的かつ低速で、最もコストがかかる方法です。

このため、数千個のアクティブなジョブを同時に必要とする Batch ソリューションは設計しないようにしてください。 タスクにはクォータがないため、できるだけ少ないジョブでできるだけ多くのタスクを実行すると、[ジョブとジョブ スケジュールのクォータ](batch-quota-limit.md#resource-quotas)が効率的に使用されます。

### <a name="job-lifetime"></a>ジョブの有効期間

Batch ジョブは、システムから削除されるまで無期限の有効期限を持っています。 ジョブの状態は、スケジューリングの際にさらに多くのタスクを受け入れることができるかどうかを示します。

明示的に終了されない限り、ジョブは自動的に完了状態に移行しません。 これは、[onAllTasksComplete](/dotnet/api/microsoft.azure.batch.common.onalltaskscomplete) プロパティまたは [maxWallClockTime](/rest/api/batchservice/job/add#jobconstraints) を使用して自動的にトリガーできます。

既定の[アクティブ ジョブおよびジョブ スケジュールのクォータ](batch-quota-limit.md#resource-quotas)があります。 完了状態のジョブおよびジョブ スケジュールは、このクォータにはカウントされません。

## <a name="tasks"></a>タスク

[タスク](jobs-and-tasks.md#tasks)は、ジョブを構成する個々の作業単位です。 タスクはユーザーによって送信され、Batch によって計算ノードに対してスケジュールされます。 以下のセクションでは、問題を処理して効率的に実行するためのタスクの設計に関する推奨事項を示しています。

### <a name="save-task-data"></a>タスク データを保存する

計算ノードはその性質上、短い期間しか存在しません。 [自動プール](nodes-and-pools.md#autopools)や[自動スケーリング](nodes-and-pools.md#automatic-scaling-policy)などの Batch の機能を使用すると、ノードを簡単に消失することができます。 ノードが (サイズ変更やプールの削除により) プールを離れると、それらのノード上のすべてのファイルも削除されます。 このため、タスクでは、完了する前に、実行されているノードから永続ストアに出力を移動する必要があります。 同様に、タスクが失敗した場合は、障害を診断するために必要なログを永続ストアに移動する必要があります。

Batch には、[OutputFiles](batch-task-output-files.md) およびさまざまな共有ファイル システムを介してデータをアップロードするための Azure Storage サポートが統合されています。あるいは、タスクでのアップロードをユーザー自身で実行することもできます。

### <a name="manage-task-lifetime"></a>タスクの有効期間を管理する

不要になったタスクを削除するか、[retentionTime](/dotnet/api/microsoft.azure.batch.taskconstraints.retentiontime) タスク制約を設定します。 `retentionTime` が設定されている場合、`retentionTime` の有効期限が切れると、Batch はタスクによって使用されているディスク領域を自動的にクリーンアップします。

タスクを削除すると、次の 2 つのことが行われます。 ジョブ内にタスクが蓄積されなくなり、目的のタスクのクエリや検索が容易にできなくなる場合があります (完了したタスクをフィルター処理する必要があるため)。 また、ノード上の対応するタスク データがクリーンアップされます (`retentionTime` にまだ達していない場合)。 これにより、ノードがタスク データでいっぱいにならず、ディスク領域が不足することがなくなります。

### <a name="submit-large-numbers-of-tasks-in-collection"></a>コレクション内で多数のタスクを送信する

タスクは、個別にまたはコレクションとして送信できます。 オーバーヘッドと送信時間を削減するためにタスクを一括送信する際に、一度に最大 100 個のタスクの[コレクション](/rest/api/batchservice/task/addcollection)としてタスクを送信します。

### <a name="set-max-tasks-per-node-appropriately"></a>ノードごとの最大タスク数を適切に設定する

Batch では、ノードでのタスクのオーバーサブスクライブ (ノードが持つコアの数よりも多くのタスクを実行) をサポートしています。 プール内のノードにタスクが "適合する" ようにするのはユーザーの責任です。 たとえば、1 つのノードでそれぞれ 25% の CPU 使用量を消費する 8 個のタスクを (`taskSlotsPerNode = 8` のプール内に) スケジュールしようとすると、ユーザー エクスペリエンスが低下する可能性があります。

### <a name="design-for-retries-and-re-execution"></a>再試行と再実行に対応して設計する

タスクは、Batch によって自動的に再試行できます。 再試行には、ユーザー制御と内部の 2 種類があります。 ユーザー制御の再試行は、タスクの [maxTaskRetryCount](/dotnet/api/microsoft.azure.batch.taskconstraints.maxtaskretrycount) で指定されます。 タスクで指定されたプログラムがゼロ以外の終了コードで終了した場合、タスクは `maxTaskRetryCount` の値まで再試行されます。

まれなケースですが、計算ノードでの障害 (たとえば、内部状態を更新できない、タスクの実行中にノードで障害が発生したなど) によってタスクが内部的に再試行されることがあります。 タスクは、可能であれば、同じ計算ノード上で内部限度に達するまで再試行されます。その後、タスクの実行が中断されて、Batch で再スケジュール (別の計算ノード上の可能性があります) するためにタスクが延期されます。

タスクを専用ノードで実行する場合も低優先度ノードで実行する場合も、設計上の違いはありません。 タスクが低優先度ノードでの実行中に割り込まれた場合も、専用ノードでの障害によって中断された場合も、障害に耐えるようにタスクを設計することで両方の状況が緩和されます。

### <a name="build-durable-tasks"></a>持続的なタスクを構築する

タスクは、耐障害性があり、再試行に対応できるように設計する必要があります。 このことは、長時間実行されるタスクにとって特に重要です。 これを行うには、タスクが複数回実行されている場合でも、タスクによって同じ単一の結果が生成されるようにします。 これを達成する 1 つの方法は、タスクを "ゴール シーク" にすることです。 もう 1 つの方法は、タスクがべき等になるようにすることです (タスクの実行回数に関係なく、同じ結果が得られます)。

一般的な例として、計算ノードにファイルをコピーするタスクが挙げられます。 単純な方法は、実行されるたびに、指定されたすべてのファイルをコピーするタスクを作成することですが、これは非効率的で、障害に耐えるように構築されていません。 代わりに、ファイルが計算ノードにあることを確認するタスク、つまり、既に存在するファイルを再度コピーしないタスクを作成します。 このようにして、タスクは中断された場合に、中断された場所から処理を再開します。

### <a name="avoid-short-execution-time"></a>短い実行時間を避ける

実行時間が 1 秒から 2 秒間のみのタスクは理想的ではありません。 個々のタスクで大量の作業を行うようにします (10 秒以上、最大で数時間から数日)。 各タスクが1分間 (またはそれ以上) 実行されている場合、全体的な計算時間の割合としてのスケジュールのオーバーヘッドはわずかです。

### <a name="use-pool-scope-for-short-tasks-on-windows-nodes"></a>Windows ノードでの短いタスクにプール スコープを使用する

Batch ノードでタスクをスケジュールするとき、それをタスク スコープで実行するか、またはプール スコープで実行するかを選択できます。 タスクの実行時間が短い場合、そのタスクの自動ユーザー アカウントの作成にリソースが必要なため、タスク スコープでは効率が悪い場合があります。 効率を高めるには、これらのタスクをプール スコープに設定することを検討してください。 詳細については、[プール スコープを使用したタスクの自動ユーザーとしての実行](batch-user-accounts.md#run-a-task-as-an-auto-user-with-pool-scope)に関するページを参照してください。

## <a name="nodes"></a>Nodes

[コンピューティング ノード](nodes-and-pools.md#nodes)は、アプリケーションの一部のワークロードの処理に特化した Azure 仮想マシン (VM) またはクラウド サービス VM です。 ノードを操作するときは、次のガイドラインに従ってください。

### <a name="idempotent-start-tasks"></a>べき等な開始タスク

他のタスクと同様に、ノードの[開始タスク](jobs-and-tasks.md#start-task)はノードが起動するたびに再実行されるため、べき等である必要があります。 べき等タスクとは、複数回実行したときに一貫した結果が得られる単純なタスクのことです。

### <a name="isolated-nodes"></a>分離ノード

コンプライアンスまたは規制要件があるワークロードには、分離された VM サイズの使用を検討してください。 仮想マシン構成モードでサポートされている分離サイズには、`Standard_E80ids_v4`、`Standard_M128ms`、`Standard_F72s_v2`、`Standard_G5`、`Standard_GS5`、`Standard_E64i_v3` があります。 分離された VM サイズの詳細については、「[Azure における仮想マシンの分離性](../virtual-machines/isolation.md)」をご覧ください。

### <a name="manage-long-running-services-via-the-operating-system-services-interface"></a>オペレーティング システム サービスのインターフェイスを使用して、実行時間の長いサービスを管理する

ノード内の Batch エージェントと一緒に別のエージェントを実行する必要がある場合があります。 たとえば、ノードからデータを収集して報告することがあります。 これらのエージェントは、Windows サービスや Linux `systemd` サービスなどの OS サービスとしてデプロイすることをお勧めします。

これらのサービスを実行する場合、ノード上の Batch 管理ディレクトリ内のどのファイルに対してもファイル ロックを取得してはなりません。ファイル ロックを取得すると、ファイル ロックが原因でこれらのディレクトリを Batch で削除できなくなるためです。 たとえば、Windows サービスを開始タスクにインストールする場合、開始タスクの作業ディレクトリから直接サービスを起動するのではなく、ファイルを別の場所にコピーします (または、ファイルが存在する場合は、コピーをスキップします)。 その後、その場所からサービスをインストールします。 バッチが開始タスクを再実行すると、開始タスクの作業ディレクトリが削除され、再度作成されます。 これは、サービスが開始タスクの作業ディレクトリではなく、他のディレクトリに対してファイル ロックを持っているために機能します。

### <a name="avoid-creating-directory-junctions-in-windows"></a>Windows ではディレクトリ ジャンクションの作成は避ける

ディレクトリ ジャンクション (ディレクトリのハードリンクと呼ばれることもあります) は、タスクおよびジョブのクリーンアップ時の処理が困難です。 ハードリンクではなく、シンボリックリンク (ソフトリンク) を使用します。

### <a name="collect-batch-agent-logs"></a>Batch エージェント ログを収集する

ノードまたはノードで実行されているタスクの動作に関連する問題が発生した場合は、該当するノードの割り当てを解除する前に、Batch エージェント ログを収集します。 Batch エージェント ログは、Batch サービス ログのアップロード API を使用して収集できます。 これらのログは、サポート チケットの一部として Microsoft に提供することができ、問題のトラブルシューティングと解決に役立ちます。

### <a name="manage-os-upgrades"></a>OS のアップグレードを管理する

ユーザー サブスクリプション モードの Batch アカウントの場合、実行時間の長いタスクでは特に、OS の自動アップグレードによってタスクの進行が中断される場合があります。 [べき等タスクを構築](#build-durable-tasks)することで、こうした中断によるエラーを減らすことができます。 また、OS イメージのアップグレードは、[タスクの実行が行われないと予想される時間にスケジュール設定](../virtual-machine-scale-sets/virtual-machine-scale-sets-automatic-upgrade.md#manually-trigger-os-image-upgrades)することをお勧めします。

Windows プールの場合、`enableAutomaticUpdates` は既定で `true` に設定されます。 自動更新を許可することをお勧めしますが、OS の更新が予期せずに行われないようにする必要がある場合は、この値を `false` に設定できます。

## <a name="isolation-security"></a>分離のセキュリティ

分離のために、シナリオでジョブを相互に分離する必要がある場合は、それらのジョブを別々のプールに配置することで行います。 プールは、Batch のセキュリティ分離の境界であり、既定では、2つのプールは表示されないか、相互に通信できません。 分離の手段として、別個の Batch アカウントを使用しないでください。

## <a name="connectivity"></a>接続

Batch ソリューションの接続に関する次のガイダンスを確認してください。

### <a name="network-security-groups-nsgs-and-user-defined-routes-udrs"></a>ネットワーク セキュリティ グループ (NSG) とユーザー定義ルート (UDR)

[仮想ネットワークに Batch プール](batch-virtual-network.md)をプロビジョニングするときは、必ず `BatchNodeManagement` サービス タグ、ポート、プロトコル、およびルールの方向の使用に関するガイドラインを厳守してください。 基になる Batch サービスの IP アドレスを使用するのではなく、サービス タグを使用することを強くお勧めします。 これは、IP アドレスは、時間の経過と共に変化することがあるためです。 Batch サービスの IP アドレスを直接使用すると、Batch プールの不安定性、中断、または障害が発生する可能性があります。

ユーザー定義ルート (UDR) では、IP アドレスは時間の経過と共に変更されるため、ルート テーブル内の Batch サービスの IP アドレスを定期的に更新するプロセスがあることを確認します。 Batch サービスの IP アドレスの一覧を取得する方法については、「[オンプレミスのサービス タグ](../virtual-network/service-tags-overview.md)」をご覧ください。 Batch サービスの IP アドレスは、`BatchNodeManagement` サービス タグ (または Batch アカウント リージョンと一致するリージョン バリアント) に関連付けられます。

### <a name="honoring-dns"></a>DNS を優先する

お使いのシステムで Batch アカウント サービス URL に対して DNS の Time-to-Live (TTL) が優先されていることを確認します。 また、お使いの Batch サービス クライアントと Batch サービスへのその他の接続メカニズムが IP アドレス (または以下に説明する [静的なパブリック IP アドレスを使用したプールの作成](create-pool-public-ip.md)) に依存していないことを確認してください。

要求で 5xx レベルの HTTP 応答が受信され、応答に "Connection: close" ヘッダーが含まれている場合は、Batch サービス クライアントで推奨事項に従う必要があります。これを行うには、既存の接続を閉じ、Batch アカウント サービス URL の DNS を再度解決し、新しい接続で次の要求を再試行します。

### <a name="retry-requests-automatically"></a>要求の自動的な再試行

要求を自動的に再試行する適切な再試行ポリシーが Batch サービス クライアントに設定されていることを確認します。この再試行は、サービス メンテナンス期間中だけでなく、通常の操作時にも実行されます。 これらの再試行ポリシーの間隔は、5 分以上にする必要があります。 自動再試行機能は、[.NET RetryPolicyProvider クラス](/dotnet/api/microsoft.azure.batch.retrypolicyprovider)などのさまざまな Batch SDK で提供されています。

### <a name="static-public-ip-addresses"></a>静的パブリック IP アドレス

通常、Batch プール内の仮想マシンには、パブリック IP アドレスを使用してアクセスしますが、これはプールの有効期間中に変更される可能性があります。 これにより、特定の IP アドレスへのアクセスが制限されるデータベースやその他の外部サービスと対話ができなくなる場合があります。 お使いのプールのパブリック IP アドレスが予期せず変更されないようにするには、ご自身が制御する静的パブリック IP アドレスのセットを使用してプールを作成してください。 詳細については、「[特定のパブリック IP アドレスの Azure Batch プールを作成する](create-pool-public-ip.md)」を参照してください。

### <a name="testing-connectivity-with-cloud-services-configuration"></a>Cloud Services 構成を使用した接続のテスト

Azure ロード バランサー経由の ICMP プロトコルは許可されていないため、クラウド サービスに通常の "ping" や ICMP プロトコルを使用することはできません。 詳細については、[Azure Cloud Services の接続とネットワーク](../cloud-services/cloud-services-connectivity-and-networking-faq.yml#can-i-ping-a-cloud-service-)に関するページを参照してください。

## <a name="batch-node-underlying-dependencies"></a>Batch ノードの基になる依存関係

Batch ソリューションを設計するときは、次の依存関係と制限事項を考慮してください。

### <a name="system-created-resources"></a>システムで作成されたリソース

Azure Batch では、VM 上にユーザーとグループのセットが作成されて管理されますが、それを変更しないでください。 制限事項は次のとおりです。

Windows の場合:

- **PoolNonAdmin** という名前のユーザー
- **WATaskCommon** という名前のユーザー グループ

Linux:

- **_azbatch** という名前のユーザー

### <a name="file-cleanup"></a>ファイルのクリーンアップ

Batch では、タスクが実行されている作業ディレクトリのクリーンアップが、保有期間の終了後にアクティブに試行されます。 このディレクトリの外部に書き込まれたファイルは、ディスク領域の不足を防ぐため、[ユーザーがクリーンアップする必要があります](#manage-task-lifetime)。

startTask 作業ディレクトリから Windows でサービスを実行すると、そのフォルダーがまだ使用されているため、作業ディレクトリの自動クリーンアップはブロックされます。 これにより、パフォーマンスが低下します。 この問題を解決するには、そのサービス用のディレクトリを、Batch によって管理されていない別のディレクトリに変更します。

## <a name="next-steps"></a>次のステップ

- [Batch サービスのワークフローと主要なリソース](batch-service-workflow-features.md) (プール、ノード、ジョブ、タスクなど) について学習します。
- [既定の Azure Batch のクォータ、制限、および制約と、クォータの引き上げを要求する方法](batch-quota-limit.md)について説明します
- [プールとノードのバックグラウンド操作の失敗を検出して回避する](batch-pool-node-error-checking.md)方法について説明します。
