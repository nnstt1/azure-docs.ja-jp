---
title: Azure Load Balancer でのアウトバウンド接続のトラブルシューティング
description: Azure Load Balancer を介したアウトバウンド接続に関する一般的な問題の解決策。
services: load-balancer
author: anavinahar
ms.service: load-balancer
ms.topic: troubleshooting
ms.date: 05/7/2020
ms.author: anavin
ms.openlocfilehash: ba421e8996e37e79bf7044709d53be8d6f2a01f4
ms.sourcegitcommit: f6e2ea5571e35b9ed3a79a22485eba4d20ae36cc
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 09/24/2021
ms.locfileid: "128549960"
---
# <a name="troubleshooting-outbound-connections-failures"></a><a name="obconnecttsg"></a>アウトバウンド接続エラーのトラブルシューティング

この記事は、Azure Load Balancer からのアウトバウンド接続で発生する可能性のある一般的な問題の解決策を提供することを目的としています。 顧客が体験するアウトバウンド接続に関する問題のほとんどは、SNAT (Source Network Address Translation) ポートの枯渇と、接続タイムアウトを原因とするパケットのドロップです。 この記事では、これらの各問題を軽減する手順について説明します。

## <a name="avoid-snat"></a>SNAT を避ける

SNAT ポートの枯渇を回避する最善の方法は、可能であれば SNAT のそもそもの必要性を排除することです。 ときには、それが不可能な場合もあります。 たとえば、パブリック エンドポイントに接続する場合などです。 ただし、中にはそれが可能であるケースもあり、リソースに対してプライベートに接続することで実現できます。 Azure サービス、たとえば Storage や SQL、Cosmos DB など、[こちらに記載されている Azure サービス](../private-link/availability.md)に接続する場合、Azure Private Link を活用することで SNAT が不要になります。 このため、SNAT ポートの枯渇に起因する接続の問題が生じるおそれはありません。

Private Link サービスは、Snowflake、MongoDB、Confluent、Elastic などのサービスでもサポートされます。

## <a name="managing-snat-pat-port-exhaustion"></a><a name="snatexhaust"></a> SNAT (PAT) ポート不足の管理
[PAT](load-balancer-outbound-connections.md) に使用される[エフェメラル ポート](load-balancer-outbound-connections.md)は、「[パブリック IP アドレスなしのスタンドアロン VM](load-balancer-outbound-connections.md)」および「[パブリック IP アドレスなしの負荷分散 VM](load-balancer-outbound-connections.md)」で説明されている有限のリソースです。 [この](./load-balancer-standard-diagnostics.md#how-do-i-check-my-snat-port-usage-and-allocation)ガイドを使用して、エフェメラル ポートの使用状況を監視し、現在の割り当てと比較して、SNAT の枯渇のリスクを判断したり確認したりできます。

同じ宛先 IP アドレスとポートに対して多数の TCP 送信接続または UDP 送信接続が開始されることがわかっている場合、送信接続エラーが出る場合、または SNAT ポート ([PAT](load-balancer-outbound-connections.md) によって使用される事前割り当て済みの[エフェメラル ポート](load-balancer-outbound-connections.md#preallocatedports)) が不足しているとサポートから指摘された場合、いくつかの一般的な軽減策の選択肢があります。 これらのオプションを確認し、使用可能であり、実際のシナリオに最適な選択肢を判断してください。 それらを 1 つまたは複数組み合わせることが状況改善に役立つ場合もあります。

送信接続の動作の理解が難しい場合は、IP スタック統計 (netstat) を使用できます。 また、パケット キャプチャを使用した接続動作を観察することも効果的です。 これらのパケット キャプチャはインスタンスのゲスト OS で実行できます。また、[パケット キャプチャには Network Watcher](../network-watcher/network-watcher-packet-capture-manage-portal.md) も使用できます。 

## <a name="manually-allocate-snat-ports-to-maximize-snat-ports-per-vm"></a><a name ="manualsnat"></a>VM あたりの SNAT ポートを最大化するために SNAT ポートを手動で割り当てる
[事前に割り当てられたポート](load-balancer-outbound-connections.md#preallocatedports)で定義されているように、ロード バランサーでは、バックエンドの VM の数に基づいてポートが自動的に割り当てられます。 既定では、これは、スケーラビリティを確保するために控えめに実行されます。 バックエンドに存在する VM の最大数がわかっている場合は、各アウトバウンド規則に SNAT ポートを手動で割り当てることができます。 たとえば、最大で 10 台の VM があることがわかっている場合は、VM ごとに、既定の 1,024 ではなく、6,400 の SNAT ポートを割り当てることができます。 

## <a name="modify-the-application-to-reuse-connections"></a><a name="connectionreuse"></a>接続を再利用するようにアプリケーションを変更する 
SNAT に使用される一時ポートの需要は、アプリケーションで接続を再利用することで減らすことができます。 接続の再利用は、接続の再利用が既定である HTTP/1.1 などのプロトコルに特に関連しています。 また、HTTP が転送に使用されるその他のプロトコル (REST など) も活用できます。 

要求ごとに個別にアトミック TCP 接続するよりも、再利用するほうが常に効果的です。 再利用は、TCP トランザクションのパフォーマンス向上と大幅な効率化につながります。

## <a name="modify-the-application-to-use-connection-pooling"></a><a name="connection pooling"></a>接続プーリングを使用するようにアプリケーションを変更する
アプリケーションでは接続プーリング スキームを利用できます。この場合、接続の固定セットに対して要求が内部的に分散されます (各要求で利用可能な接続が再利用されます)。 このスキームにより、使用される一時ポートの数が制限され、環境の予測可能性が高まります。 さらに、このスキームを使用すると、ある操作の応答で 1 つの接続がブロックされている際に同時に複数の操作を行えるようにして、要求のスループットを向上させることもできます。  

接続プーリングは既に、アプリケーションの開発に使用しているフレームワーク、またはアプリケーションの構成設定の中に存在している可能性があります。 接続プーリングは接続の再利用と組み合わせることができます。 同じ宛先 IP アドレスとポートに対する複数の要求で、固定された予測可能な数のポートを消費します。 これらの要求で、TCP トランザクションを非常に効率的に使用して、待ち時間とリソース使用率を減らすこともできます。 また、UDP フローの数を管理すると不足状態を回避して SNAT ポートの使用率を管理できるので、UDP トランザクションにもメリットがあります。

## <a name="modify-the-application-to-use-less-aggressive-retry-logic"></a><a name="retry logic"></a>再試行の頻度を抑えるようにアプリケーションのロジックを変更する
[PAT](load-balancer-outbound-connections.md) に使用される[事前割り当て済みのエフェメラル ポート](load-balancer-outbound-connections.md#preallocatedports)が不足している場合、またはアプリケーションのエラーが発生している場合、減退やバックオフ ロジックを使わず単純に再試行を繰り返すと、ポート不足が発生したり持続したりします。 エフェメラル ポートの需要は、再試行の頻度を抑えたロジックを使用することで減らすことができます。 

エフェメラル ポートには 4 分間のアイドル タイムアウトが設定されています (調整不可)。 再試行の頻度が高すぎた場合、不足が自動的に解消されることはありません。 そのため、アプリケーションがトランザクションを再試行する方法と頻度を考慮することは、設計において非常に重要です。

## <a name="assign-a-public-ip-to-each-vm"></a><a name="assignilpip"></a>各 VM にパブリック IP を割り当てる
パブリック IP アドレスを割り当てると、シナリオが [VM に対するパブリック IP](load-balancer-outbound-connections.md) に変わります。 この VM で、VM ごとに使用されるパブリック IP のすべてのエフェメラル ポートを使用できます。 (パブリック IP のエフェメラル ポートが、それぞれのバックエンド プールに関連付けられているすべての VM で共有されるシナリオとは対照的です。)パブリック IP アドレスの追加コストや、大量の IP アドレスを個別にフィルター処理することの潜在的な影響など、考慮すべきトレードオフがあります。

>[!NOTE] 
>このオプションは、worker ロールでは使用できません。

## <a name="use-multiple-frontends"></a><a name="multifesnat"></a> 複数のフロントエンドを使用する
パブリック Standard Load Balancer を使用する場合は、[発信接続用に複数のフロントエンド IP アドレス](load-balancer-outbound-connections.md)を割り当て、[使用可能な SNAT ポートの数を増やします](load-balancer-outbound-connections.md#preallocatedports)。  フロントエンドのパブリック IP への SNAT のプログラミングをトリガーするには、フロントエンド IP の構成、ルール、およびバックエンド プールを作成します。  このルールが機能する必要はなく、正常性プローブが成功する必要はありません。  (送信だけでなく) 受信にも複数のフロントエンドを使用する場合は、カスタム正常性プローブを適切に使用して信頼性を確保する必要があります。

>[!NOTE]
>ほとんどの場合、SNAT ポートの枯渇は設計に問題があることを示します。  より多くのフロントエンドを使用して SNAT ポートを追加する前に、ポートが枯渇している理由を把握してください。  後で障害につながる可能性のある問題が隠れている可能性があります。

## <a name="scale-out"></a><a name="scaleout"></a>スケールアウト
[事前割り当てポート](load-balancer-outbound-connections.md#preallocatedports)は、バックエンド プール サイズに基づいて割り当てられ、ポートの一部を再割り当てして 1 つ大きいバックエンド プール サイズ レベルに対応する必要があるときに中断を最小限に抑えるために、複数のレベルにグループ化されます。  場合によっては、バックエンド プールを特定のレベルの最大サイズにスケーリングすることで、特定のフロントエンドの SNAT ポート使用率を向上させることもできます。  SNAT が枯渇するリスクを回避しながらアプリケーションを効率的にスケールアウトするには既定のポート割り当てが必要であることに留意してください。

たとえば、バックエンド プール内の 2 つの仮想マシンでは IP 構成あたり 1024 個の SNAT ポートを使用できるため、デプロイには合計 2048 個の SNAT ポートを使用できます。  デプロイを 50 個の仮想マシンに増やした場合、事前割り当てポートの数が仮想マシンごとに一定のままであっても、合計 51,200 (50 × 1024) 個の SNAT ポートをデプロイで使用できます。  対象のデプロイをスケールアウトする場合は、レベルごとの[事前割り当てポート](load-balancer-outbound-connections.md#preallocatedports)の数を確認して、スケールアウトをそれぞれのレベルの最大数に必ず合わせます。  前の例で、50 個のインスタンスではなく、51 個にスケールアウトすることにした場合、次のレベルに進むと、VM ごとの SNAT ポート数と合計が減ることになります。

割り当てられたポートを再割り当てする必要がある場合に、次に大きなバックエンド プール サイズ レベルにスケールアウトすると、送信接続の一部がタイムアウトする可能性があります。  SNAT ポートの一部しか使用していない場合は、次に大きなバックエンド プール サイズにスケールアウトすることは重要ではありません。  既存のポートの半分は、次のバックエンド プール レベルに移行するたびに再割り当てされます。  これを行わない場合は、デプロイをそのレベルのサイズに合わせる必要があります。  または、必要に応じてアプリケーションが検出し、再試行できる必要があります。  TCP キープアライブは、再割り当てによって SNAT ポートが機能しなくなったときの検出に役立ちます。

## <a name="use-keepalives-to-reset-the-outbound-idle-timeout"></a><a name="idletimeout"></a>キープアライブを使用して送信アイドル タイムアウトをリセットする
送信接続には、4 分間のアイドル タイムアウトが設けられています。 このタイムアウトは、[送信ルール](outbound-rules.md)を使用して調整できます。 必要に応じて、転送 (TCP キープアライブなど) またはアプリケーション レイヤー キープアライブを使用して、アイドル フローを更新したりこのアイドル タイムアウトをリセットしたりできます。  

TCP キープアライブを使用するときは、接続の一方で有効にすれば十分です。 たとえば、フローのアイドル タイマーをリセットするときは、サーバー側でのみ有効にすれば十分であり、両側が TCP キープアライブを開始する必要はありません。  データベースのクライアント/サーバー構成など、アプリケーション レイヤーにも同様の概念があります。  サーバー側で、アプリケーション固有のキープアライブのどのようなオプションが存在するかを確認します。

## <a name="next-steps"></a>次の手順
Microsoft では、常にお客様のエクスペリエンスを改善することを目指しています。 この記事に記載されていない、または解決されていないアウトバウンド接続の問題が発生している場合は、このページの下部にある GitHub からフィードバックをお送りください。お客様からのフィードバックにはできるだけ早く対処します。
