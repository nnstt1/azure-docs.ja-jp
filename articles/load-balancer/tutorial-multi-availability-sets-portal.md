---
title: 'チュートリアル: バックエンド プールに複数の可用性セットを備えたロード バランサーを作成する - Azure portal'
titleSuffix: Azure Load Balancer
description: このチュートリアルでは、バックエンド プールに複数の可用性セットを備えた Azure ロード バランサーをデプロイします。
author: asudbring
ms.author: allensu
ms.service: load-balancer
ms.topic: tutorial
ms.date: 08/12/2021
ms.custom: template-tutorial
ms.openlocfilehash: a59f97e41705e222bbbca6656cd67d2e692ec5fa
ms.sourcegitcommit: 692382974e1ac868a2672b67af2d33e593c91d60
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 10/22/2021
ms.locfileid: "130232406"
---
# <a name="tutorial-create-a-load-balancer-with-more-than-one-availability-set-in-the-backend-pool-using-the-azure-portal"></a>チュートリアル: Azure portal を使用してバックエンド プールに複数の可用性セットを備えたロード バランサーを作成する

高可用性デプロイでは、多くの場合、その過程で仮想マシンが複数の可用性セットへとグループ化されます。 

ロード バランサーでは、バックエンド プール内の仮想マシンが含まれる複数の可用性セットがサポートされます。

このチュートリアルでは、以下の内容を学習します。

> [!div class="checklist"]
> * 仮想ネットワークの作成
> * アウトバウンド接続用の NAT ゲートウェイを作成する
> * Standard SKU の Azure ロード バランサーを作成する
> * 4 つの仮想マシンと 2 つの可用性セットを作成する
> * 可用性セット内の仮想マシンをロード バランサーのバックエンド プールに追加する
> * ロード バランサーをテストする

## <a name="prerequisites"></a>前提条件

- アクティブなサブスクリプションが含まれる Azure アカウント。 [無料でアカウントを作成できます](https://azure.microsoft.com/free/?WT.mc_id=A261C142F)。

## <a name="create-a-virtual-network"></a>仮想ネットワークの作成

このセクションでは、ロード バランサーの仮想ネットワークなど、このチュートリアルで使用するリソースを作成します。

1. [Azure portal](https://portal.azure.com) にサインインします。

2. ポータルの上部にある検索ボックスに、「**仮想ネットワーク**」と入力します。

3. 検索結果で、**[仮想ネットワーク]** を選択します。

4. **[+ 作成]** を選択します。

5. **[仮想ネットワークの作成]** の **[基本]** タブで、次の情報を入力するか選択します。

    | 設定 | 値 |
    | ------- | ------|
    | **プロジェクトの詳細** |   |
    | サブスクリプション | サブスクリプションを選択します。 |
    | Resource group | **[新規作成]** を選択します。 </br> **[名前]** に「**TutorLBmultiAVS-rg**」と入力します。 |
    | **インスタンスの詳細** |   |
    | 名前 | 「**myVNet**」と入力します。 |
    | リージョン | **[(米国) 米国西部 2]** を選択します。 |

6. **[IP アドレス]** タブを選択するか、ページ下部の **[次へ: IP アドレス]** ボタンを選択します。

7. **[IP アドレス]** タブの **[サブネット名]** で **[default]\(既定\)** を選択します。

8. **[サブネットの編集]** ペインの **[サブネット名]** に「**myBackendSubnet**」と入力します。

9. **[保存]** を選択します。

10. **[セキュリティ]** タブを選択するか、ページ下部にある **[次へ: セキュリティ]** ボタンを選択します。

11. **[セキュリティ]** タブの **[BastionHost]** で **[Enable]\(有効\)** を選択します。

12. 次の情報を入力または選択します。

    | 設定 | 値 |
    | ------- | ----- |
    | 要塞名 | 「**MyBastionHost**」と入力します。 |
    | AzureBastionSubnet のアドレス空間 | 「**10.1.1.0/27**」と入力します。 |
    | パブリック IP アドレス | **[新規作成]** を選択します。 </br> **[名前]** に「**myBastionIP**」と入力します。 |

13. **[Review + create]\(確認と作成\)** タブを選択するか、ページの下部にある青色の **[Review + create]\(確認と作成\)** ボタンを選択します。

14. **［作成］** を選択します

## <a name="create-nat-gateway"></a>NAT ゲートウェイの作成 

このセクションでは、仮想マシンのアウトバウンド接続に使用する NAT ゲートウェイを作成します。

1. ポータルの上部にある検索ボックスに、「**NAT ゲートウェイ**」と入力します。

2. 検索結果から **[NAT ゲートウェイ]** を選択します。

3. **[+ 作成]** を選択します。

4. **[ネットワーク アドレス変換 (NAT) ゲートウェイを作成します]** の **[基本]** タブで、次の情報を入力または選択します。

    | 設定 | 値 |
    | ------- | ----- |
    | **プロジェクトの詳細** |   |
    | サブスクリプション | サブスクリプションを選択します。 |
    | Resource group | **[TutorLBmultiAVS-rg]** を選択します。 |
    | **インスタンスの詳細** |   |
    | NAT ゲートウェイ名 | 「**myNATgateway**」と入力します。 |
    | リージョン | **[(米国) 米国西部 2]** を選択します。 |
    | 可用性ゾーン | **[なし]** を選択します。 |
    | アイドル タイムアウト (分) | 「**15**」と入力します。 |

5. **[Outbound IP]\(アウトバウンド IP\)** タブを選択するか、ページの下部にある **[Next: Outbound IP]\(次へ: アウトバウンド IP\)** を選択します。

6. **[Outbound IP]\(アウトバウンド IP\)** タブで、 **[パブリック IP アドレス]** の横にある **[新しいパブリック IP アドレスの作成]** を選択します。

7. **[名前]** に、「**myNATgatewayIP**」と入力します。

8. **[OK]** を選択します。

9. **[サブネット]** タブを選択するか、ページの下部にある **[次へ: サブネット]** ボタンを選択します。

10. **[仮想ネットワーク]** の下のプルダウン メニューで **[myVNet]** を選択します。

11. **[myBackendSubnet]** の横にあるチェック ボックスをオンにします。

12. **[Review + create]\(確認と作成\)** タブを選択するか、ページの下部にある青色の **[Review + create]\(確認と作成\)** ボタンを選択します。

13. **［作成］** を選択します

## <a name="create-load-balancer"></a>ロード バランサーの作成

このセクションでは、仮想マシンのロード バランサーを作成します。

1. ポータルの上部にある検索ボックスに、「**ロード バランサー**」と入力します。 検索結果で **[ロード バランサー]** を選択します。

2. **[ロード バランサー]** ページで、 **[作成]** を選択します。

3. **[ロード バランサーの作成]** ページの **[基本]** タブで、次の情報を入力または選択します。 

    | 設定                 | 値                                              |
    | ---                     | ---                                                |
    | **プロジェクトの詳細** |   |
    | サブスクリプション               | サブスクリプションを選択します。    |    
    | Resource group         | **[TutorLBmultiAVS-rg]** を選択します。 |
    | **インスタンスの詳細** |   |
    | 名前                   | 「**myLoadBalancer**」と入力します                                   |
    | リージョン         | **[(米国) 米国西部 2]** を選択します。                                        |
    | Type          | **[パブリック]** を選択します。                                        |
    | SKU           | 既定値 **[標準]** のままにします。 |
    | レベル          | **[地域]** は既定値のままにします。 |

4. ページ下部にある **[次へ: フロントエンド IP の構成]** を選択します。

5. **[フロントエンド IP 構成]** で、 **[+ フロントエンド IP の追加]** を選択します。

6. **[名前]** に、「**LoadBalancerFrontend**」と入力します。

7. **[IP バージョン]** には **[IPv4]** または **[IPv6]** を選択します。

    > [!NOTE]
    > IPv6 は現在、ルーティングの優先順位およびリージョン間の負荷分散 (グローバル階層) ではサポートされていません。

8. **[IP の種類]** として **[IP アドレス]** を選択します。

    > [!NOTE]
    > IP プレフィックスの詳細については、[Azure パブリック IP アドレス プレフィックス](../virtual-network/ip-services/public-ip-address-prefix.md)に関するページを参照してください。

9. **[パブリック IP アドレス]** で **[新規作成]** を選択します。

10. **[パブリック IP アドレスの追加]** で、 **[名前]** に「**myPublicIP-lb**」と入力します。

11. **[可用性ゾーン]** で、 **[ゾーン冗長]** を選択します。

    > [!NOTE]
    > [Availability Zones](../availability-zones/az-overview.md?toc=%2fazure%2fvirtual-network%2ftoc.json#availability-zones) があるリージョンでは、ゾーンなし (既定のオプション)、特定のゾーン、またはゾーン冗長を選択できます。 この選択は、特定のドメイン障害要件によって異なる場合があります。 Availability Zones がないリージョンでは、このフィールドは表示されません。 </br> 可用性ゾーンの詳細については、[可用性ゾーンの概要](../availability-zones/az-overview.md)に関するページを参照してください。

12. **[ルーティングの優先順位]** は、既定値の **[Microsoft ネットワーク]** のままにします。

13. **[OK]** を選択します。

14. **[追加]** を選択します。

15. ページ下部で **[次へ: バックエンド プール]** を選択します。

16. **[バックエンド プール]** タブで、 **[+ バックエンド プールの追加]** を選択します。

17. **[バックエンド プールの追加]** の **[名前]** に「**myBackendPool**」と入力します。

18. **[仮想ネットワーク]** で **[myVNet]** を選択します。

19. **[バックエンド プールの構成]** には **[NIC]** または **[IP アドレス]** を選択します。

20. **[IP バージョン]** には **[IPv4]** または **[IPv6]** を選択します。

21. **[追加]** を選択します。

22. ページ下部にある **[次へ: 受信規則]** ボタンを選択します。

23. **[受信規則]** タブの **[負荷分散規則]** で、 **[+ 負荷分散規則の追加]** を選択します。

24. **[負荷分散規則の追加]** で、次の情報を入力または選択します。

    | 設定 | [値] |
    | ------- | ----- |
    | 名前 | 「**myHTTPRule**」と入力します。 |
    | IP バージョン | 要件に応じて、 **[IPv4]** または **[IPv6]** を選択します。 |
    | フロントエンド IP アドレス | **[LoadBalancerFrontend]** を選択します。 |
    | Protocol | **[TCP]** を選択します。 |
    | Port | 「**80**」と入力します。 |
    | バックエンド ポート | 「**80**」と入力します。 |
    | バックエンド プール | **[myBackendPool]** を選択します。 |
    | 正常性プローブ | **[新規作成]** を選択します。 </br> **[名前]** に、「**myHealthProbe**」と入力します。 </br> **[プロトコル]** で、 **[HTTP]** を選択します。 </br> 残りの部分は既定値のままにし、 **[OK]** を選択します。 |
    | セッション永続化 | **[なし]** を選択します。 |
    | アイドル タイムアウト (分) | 「**15**」を入力または選択します。 |
    | TCP リセット | **[Enabled]** を選択します。 |
    | フローティング IP | **[無効]** をクリックします。 |
    | アウトバウンド送信元ネットワーク アドレス変換 (SNAT) | 既定値の **[(推奨) アウトバウンド規則を使用して、バックエンド プールのメンバーがインターネットにアクセスできるようにします。]** のままにします。 |

25. **[追加]** を選択します。

26. ページ下部にある青色の **[確認と作成]** ボタンを選択します。

27. **［作成］** を選択します

    > [!NOTE]
    > この例では、送信インターネット アクセスを提供する NAT ゲートウェイを作成しました。 構成の [アウトバウンド規則] タブは省略可能であり、NAT ゲートウェイでは不要なためバイパスされました。 Azure NAT ゲートウェイの詳細については、「[Virtual Network NAT とは](../virtual-network/nat-gateway/nat-overview.md)」を参照してください。
    > Azure でのアウトバウンド接続の詳細については、[アウトバウンド接続の送信元ネットワーク アドレス変換 (SNAT)](../load-balancer/load-balancer-outbound-connections.md) に関するページを参照してください。

## <a name="create-virtual-machines"></a>仮想マシンを作成する

このセクションでは、それぞれ 2 つの仮想マシンを含む 2 つの可用性グループを作成します。 これらのマシンは、作成時にロード バランサーのバックエンド プールに追加されます。 

### <a name="create-first-set-of-vms"></a>1 つ目の VM セットを作成する

1. ポータルの左上のセクションにある **[+ リソースの作成]** を選択します。

2. **[New]\(新規\)** で、 **[Compute]\(コンピューティング\)**  >  **[仮想マシン]** を選択します。

3. **[仮想マシンの作成]** の **[基本]** タブで、次の情報を入力または選択します。

    | 設定 | 値 |
    | ------- | ----- |
    | **プロジェクトの詳細** |   |
    | サブスクリプション | サブスクリプションを選択します。 |
    | Resource group | **[TutorLBmultiAVS-rg]** を選択します。 |
    | **インスタンスの詳細** |   |
    | 仮想マシン名 | 「**myVM1**」と入力します。 |
    | リージョン | **[(米国) 米国西部 2]** を選択します。 |
    | 可用性のオプション | **[可用性セット]** を選択します。 |
    | 可用性セット | **[新規作成]** を選択します。 </br> **[名前]** に「**myAvailabilitySet1**」と入力します。 </br> **[OK]** を選択します。 |
    | Image | **[Windows Server 2019 Datacenter - Gen1]** を選択します。 |
    | Azure Spot インスタンス | 既定値のオフのままにします。 |
    | サイズ | 仮想マシンのサイズを選択します。 |
    | **管理者アカウント** |   |
    | ユーザー名 | ユーザー名を入力します。 |
    | Password | パスワードを入力します。 |
    | **受信ポートの規則** |   |
    | パブリック受信ポート | **[なし]** を選択します。 |

4. **[ネットワーク]** タブを選択するか、 **[次へ: ディスク]** を選択し、ページ下部の **[次へ: ネットワーク]** ボタンを選択します。

5. **[ネットワーク]** タブで、次の情報を入力または選択します。

    | 設定 | [値] |
    | ------- | ----- |
    | **ネットワーク インターフェイス** |   |
    | 仮想ネットワーク | **[myVNet]** を選択します。 |
    | Subnet | **[myBackendSubnet]** を選択します。 |
    | パブリック IP | **[なし]** を選択します。 |
    | NIC ネットワーク セキュリティ グループ | **[Advanced] \(詳細設定)** を選択します。 |
    | ネットワーク セキュリティ グループを構成する | **[新規作成]** を選択します。 </br> **[名前]** には、「**myNSG**」と入力します。 </br> **[受信規則]** の **[+ 受信規則の追加]** を選択します。 </br> **[サービス]** で **[HTTP]** を選択します。 </br> **[名前]** に「**myHTTPrule**」と入力します。 </br> **[追加]** を選択します。 </br> **[OK]** を選択します。 | 
    | **負荷分散** |   |
    | この仮想マシンを既存の負荷分散ソリューションの後ろに配置しますか? | チェック ボックスをオンにします。 |
    | **負荷分散の設定** |   |
    | 負荷分散のオプション | **[Azure Load Balancer]** を選択します。 |
    | ロード バランサーを選択する | **[myLoadBalancer]** を選択します。 |
    | バックエンド プールを選択する | **[myBackendPool]** を選択します。 |

6. **[Review + create]\(確認と作成\)** タブを選択するか、ページの下部にある青色の **[Review + create]\(確認と作成\)** ボタンを選択します。

7. **［作成］** を選択します

8. 手順 1. から 7. を繰り返して、セットの 2 つ目の仮想マシンを作成します。 VM の設定は、次の情報に置き換えます。

    | 設定 | [値] |
    | ------- | ----- |
    | 名前 | 「**myVM2**」と入力します。 |
    | 可用性セット | **[myAvailabilitySet1]** を選択します。 |
    | Virtual Network | **[myVNet]** を選択します。 |
    | Subnet | **[myBackendSubnet]** を選択します。 |
    | パブリック IP | **[なし]** を選択します。 |
    | ネットワーク セキュリティ グループ | **[myNSG]** を選択します。 |
    | 負荷分散のオプション | **[Azure Load Balancer]** を選択します。 |
    | ロード バランサーを選択する | **[myLoadBalancer]** を選択します。 |
    | バックエンド プールを選択する | **[myBackendPool]** を選択します。 |

### <a name="create-second-set-of-vms"></a>2 つ目の VM セットを作成する

1. ポータルの左上のセクションにある **[+ リソースの作成]** を選択します。

2. **[New]\(新規\)** で、 **[Compute]\(コンピューティング\)**  >  **[仮想マシン]** を選択します。

3. **[仮想マシンの作成]** の **[基本]** タブで、次の情報を入力または選択します。

    | 設定 | 値 |
    | ------- | ----- |
    | **プロジェクトの詳細** |   |
    | サブスクリプション | サブスクリプションを選択します。 |
    | Resource group | **[TutorLBmultiAVS-rg]** を選択します。 |
    | **インスタンスの詳細** |   |
    | 仮想マシン名 | 「**myVM3**」と入力します。 |
    | リージョン | **[(米国) 米国西部 2]** を選択します。 |
    | 可用性のオプション | **[可用性セット]** を選択します。 |
    | 可用性セット | **[新規作成]** を選択します。 </br> **[名前]** に「**myAvailabilitySet2**」と入力します。 </br> **[OK]** を選択します。 |
    | Image | **[Windows Server 2019 Datacenter - Gen1]** を選択します。 |
    | Azure Spot インスタンス | 既定値のオフのままにします。 |
    | サイズ | 仮想マシンのサイズを選択します。 |
    | **管理者アカウント** |   |
    | ユーザー名 | ユーザー名を入力します。 |
    | Password | パスワードを入力します。 |
    | **受信ポートの規則** |   |
    | パブリック受信ポート | **[なし]** を選択します。 |

4. **[ネットワーク]** タブを選択するか、 **[次へ: ディスク]** を選択し、ページ下部の **[次へ: ネットワーク]** ボタンを選択します。

5. **[ネットワーク]** タブで、次の情報を入力または選択します。

    | 設定 | [値] |
    | ------- | ----- |
    | **ネットワーク インターフェイス** |   |
    | 仮想ネットワーク | **[myVNet]** を選択します。 |
    | Subnet | **[myBackendSubnet]** を選択します。 |
    | パブリック IP | **[なし]** を選択します。 |
    | NIC ネットワーク セキュリティ グループ | **[Advanced] \(詳細設定)** を選択します。 |
    | ネットワーク セキュリティ グループを構成する | **[myNSG]** を選択します。 | 
    | **負荷分散** |   |
    | この仮想マシンを既存の負荷分散ソリューションの後ろに配置しますか? | チェック ボックスをオンにします。 |
    | **負荷分散の設定** |   |
    | 負荷分散のオプション | **[Azure Load Balancer]** を選択します。 |
    | ロード バランサーを選択する | **[myLoadBalancer]** を選択します。 |
    | バックエンド プールを選択する | **[myBackendPool]** を選択します。 |

6. **[Review + create]\(確認と作成\)** タブを選択するか、ページの下部にある青色の **[Review + create]\(確認と作成\)** ボタンを選択します。

7. **［作成］** を選択します

8. 手順 1. から 7. を繰り返して、セットの 2 つ目の仮想マシンを作成します。 VM の設定は、次の情報に置き換えます。

    | 設定 | [値] |
    | ------- | ----- |
    | 名前 | 「**myVM4**」と入力します。 |
    | 可用性セット | **[myAvailabilitySet2]** を選択します。 |
    | Virtual Network | **[myVNet]** を選択します。 |
    | ネットワーク セキュリティ グループ | **[myNSG]** を選択します。 |
    | 負荷分散のオプション | **[Azure Load Balancer]** を選択します。 |
    | ロード バランサーを選択する | **[myLoadBalancer]** を選択します。 |
    | バックエンド プールを選択する | **[myBackendPool]** を選択します。 |

## <a name="install-iis"></a>IIS のインストール

このセクションでは、先ほど作成した Azure Bastion ホストを使用して仮想マシンに接続し、IIS をインストールします。

1. ポータルの上部にある検索ボックスに、「**仮想マシン**」と入力します。

2. 検索結果から **[仮想マシン]** を選択します。

3. **[myVM1]** を選択します。

4. myVM1 の **[概要]** ページで、 **[接続]**  >  **[Bastion]** を選択します。

5. **[Bastion を使用する]** を選択します。

6. 仮想マシンの作成時に作成した **ユーザー名** と **パスワード** を入力します。

7. **[接続]** を選択します。

7. サーバーのデスクトップで、 **[Windows 管理ツール]**  >  **[Windows PowerShell]** の順に移動します。

8. PowerShell ウィンドウで、次のコマンドを実行して以下の作業を行います。

    * IIS サーバーをインストールする
    * 既定の iisstart.htm ファイルを削除する
    * VM の名前が表示された新しい iisstart.htm ファイルを追加する。

   ```powershell
    # Install IIS server role
    Install-WindowsFeature -name Web-Server -IncludeManagementTools
    
    # Remove default htm file
    Remove-Item  C:\inetpub\wwwroot\iisstart.htm
    
    # Add a new htm file that displays server name
    Add-Content -Path "C:\inetpub\wwwroot\iisstart.htm" -Value $("Hello World from " + $env:computername)
   ```
8. **myVM1** との Bastion セッションを閉じます。

9. **myVM2**、**myVM3**、**myVM4** について、手順 1. から 8. を繰り返します。

## <a name="test-the-load-balancer"></a>ロード バランサーをテストする

このセクションでは、ロード バランサーのパブリック IP アドレスを検出します。 その IP アドレスを使用して、ロード バランサーの動作をテストします。

1. ポータルの上部にある検索ボックスに、「**パブリック IP**」と入力します。

2. 検索結果から **[パブリック IP アドレス]** を選択します。

3. **[myPublicIP-lb]** を選択します。

4. **myPublicIP-lb** の **[概要]** ページの **[IP アドレス]** に表示されるパブリック IP アドレスをメモします。

    :::image type="content" source="./media/tutorial-multi-availability-sets-portal/find-public-ip.png" alt-text="ロード バランサーのパブリック IP アドレスを見つける。" border="true":::

5. Web ブラウザーを開いて、アドレス バーにパブリック IP アドレスを入力します。

    :::image type="content" source="./media/tutorial-multi-availability-sets-portal/verify-load-balancer.png" alt-text="Web ブラウザーを使用してロード バランサーをテストする。" border="true":::

6. ブラウザーの [更新] を選択すると、バックエンド プール内の他の仮想マシンに負荷分散されたトラフィックが表示されます。

## <a name="clean-up-resources"></a>リソースをクリーンアップする

このアプリケーションを引き続き使用する予定がなければ、次の手順に従ってロード バランサーと関連リソースを削除します。

1. ポータル上部の [検索] ボックスに「**リソース グループ**」と入力します。

2. 検索結果から **[リソース グループ]** を選択します。

3. **[TutorLBmultiAVS-rg]** を選択します。

4. **TutorLBmultiAVS-rg** の概要ページで、 **[リソース グループの削除]** を選択します。

5. **[リソース グループ名を入力してください]** に「**TutorLBmultiAVS-rg**」と入力します。

6. **[削除]** を選択します。

## <a name="next-steps"></a>次のステップ

このチュートリアルでは、次のことを行いました。

* 仮想ネットワークと Azure Bastion ホストを作成しました。
* Azure Standard ロード バランサーを作成しました。
* それぞれ 2 つの仮想マシンを含む可用性セットを 2 つ作成しました。
* IIS をインストールし、ロード バランサーをテストしました。

次の記事に進んで、リージョン間 Azure ロード バランサーの作成方法を学習してください。
> [!div class="nextstepaction"]
> [リージョン間ロード バランサーを作成する](tutorial-cross-region-portal.md)