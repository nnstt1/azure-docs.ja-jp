---
title: Azure VM のマネージド ディスクのバックアップとディザスター リカバリー
description: この記事では、Azure の IaaS 仮想マシンとマネージド ディスクのバックアップおよびディザスター リカバリーを計画する方法について説明します。
author: roygara
ms.service: storage
ms.topic: conceptual
ms.date: 08/26/2021
ms.author: rogarana
ms.subservice: disks
ms.openlocfilehash: a2c060362a74400a1356d96fb85a4e62d20cac57
ms.sourcegitcommit: dcf1defb393104f8afc6b707fc748e0ff4c81830
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 08/27/2021
ms.locfileid: "123101801"
---
# <a name="backup-and-disaster-recovery-for-azure-managed-disks"></a>Azure マネージド ディスクのバックアップとディザスター リカバリー

**適用対象:** :heavy_check_mark: Linux VM :heavy_check_mark: Windows VM :heavy_check_mark: フレキシブル スケール セット

この記事では、Azure マネージド ディスクのバックアップおよびディザスター リカバリーを計画する方法について説明します。

最初に Azure プラットフォームに組み込まれているフォールト トレランス機能について説明します。この機能は、局所的な障害に対する保護となります。 次に、組み込みの機能では完全にはカバーされない障害のシナリオについて説明します。 また、別のバックアップとディザスター リカバリーの考慮事項を適用できるワークロード シナリオの例を複数紹介します。 また、マネージド ディスクのディザスター リカバリー ソリューションもいくつか取り上げます。

## <a name="introduction"></a>はじめに

Azure では、局所的なハードウェア障害からお客様を保護するために、冗長性とフォールト トレランスに関するさまざまなメソッドが使用されています。 局所的な障害には、仮想ディスクのデータの一部を格納する Azure Storage サーバー マシンに関する問題や、これらのサーバー上のソリッドステート ドライブ (SSD) またはハード ディスク ドライブ (HDD) の障害などが含まれます。 孤立したハードウェア コンポーネントの障害は通常の操作中に発生する可能性があります。

Azure は、これらの障害に対する回復性を備えています。 大規模災害によって、多数のストレージ サーバーまたはデータ センター全体にも障害が発生する可能性や、それらにアクセスできなくなる可能性があります。 仮想マシン (VM) とディスクは通常、局所的な障害からは保護されていますが、VM とディスクに影響を与える可能性のある、リージョン全体にわたる致命的な障害 (大規模災害など) からワークロードを保護するためには、追加の手順が必要になります。

プラットフォームに障害が発生する可能性だけでなく、お客様のアプリケーションやデータに問題が発生する場合もあります。 たとえば、アプリケーションのバージョンを新しくしたことで、中断の原因となるデータ変更が意図せずに加えられる場合があります。 その場合は、以前のバージョンのうち、正常な状態であることがわかっている最新のバージョンに、アプリケーションやデータを戻したいと思うでしょう。 これには、定期的なバックアップを継続する必要があります。

リージョンのディザスター リカバリーについては、サービスとしてのインフラストラクチャ (IaaS) VM ディスクを別のリージョンにバックアップする必要があります。 

バックアップとディザスター リカバリーのオプションについて考える前に、局所的な障害の処理に使用できるいくつかの方法を要約します。

### <a name="azure-iaas-resiliency"></a>Azure IaaS 回復性

回復性とは、ハードウェア コンポーネントで発生する通常の障害の許容範囲のことです。 回復性は、障害から回復して、機能を継続する能力です。 障害を回避することではなく、ダウンタイムまたはデータの損失を回避するように障害に対応することです。 回復性の目的は、障害後にアプリケーションを完全に機能している状態に戻すことです。 Azure VM とマネージド ディスクは、一般的なハードウェア障害から復旧するように設計されています。 Azure IaaS プラットフォームがこの回復性をどのように提供するのか見てみましょう。

VM は、主にコンピューティング サーバーと永続的なディスクの 2 つの部分で構成されています。 どちらも VM のフォールト トレランスに影響します。

VM を格納する Azure のコンピューティング ホスト サーバーで、まれにハードウェア障害が発生する場合、Azure が別のサーバー上で VM を自動的に復元するように設計されています。 このシナリオでは、コンピューターが再起動し、しばらくしてから VM が再び起動します。 Azure はこのようなハードウェア障害を自動的に検出して復旧を開始し、VM をできるだけ早く使用可能にすることをお客様に保証します。

マネージド ディスクに関していえば、データの持続性は、永続的なストレージ プラットフォームにとって重要です。 Azure のお客様は、重要なビジネス アプリケーションを IaaS で実行し、データの持続性に依存しています。 Azure は、ローカルに格納されているデータの冗長コピーを 3 つ保持することで、これらの IaaS ディスクを保護するように設計されています。 これらのコピーによって、局所的な障害に対する高い持続性が提供されます。 ディスクを保持するハードウェア コンポーネントの 1 つが故障しても、ディスクの要求をサポートする別のコピーが 2 つあるため、VM は影響を受けません。 (まれですが) ディスクをサポートする別のハードウェア コンポーネントが 2 つ同時に故障した場合でも、正常に動作します。 

常に 3 つのレプリカを維持できるように、Azure では、3 つのコピーのいずれかが利用不可になった場合でも、データの新しいコピーをバックグラウンドで自動的に生成します。 そのため、フォールト トレランス用に Azure ディスクで RAID を使用する必要はありません。 大規模なボリュームの作成が必要な場合、ディスクのストライピングには、シンプルな RAID 0 構成で十分です。

このアーキテクチャにより、Azure は IaaS ディスクのエンタープライズ レベルの持続性を、業界トップ レベルの[年間故障率](https://en.wikipedia.org/wiki/Annualized_failure_rate) 0% で一貫して提供できます。

コンピューティング ホストまたはストレージ プラットフォームの局所的なハードウェア障害によって、VM の可用性に関する [Azure SLA](https://azure.microsoft.com/support/legal/sla/virtual-machines/) で保証対象となっている VM が一時的に使用できなくなる場合があります。 Azure では、Azure Premium SSD を使用する単一の VM インスタンスを対象とする、業界トップ レベルの SLA も提供されています。

ディスクまたは VM が一時的に使用できないことによるダウンタイムからアプリケーション ワークロードを保護するために、お客様は[可用性セット](./availability.md)を使用できます。 可用性セット内にある複数の仮想マシンによって、アプリケーションの冗長性が確保されます。 Azure では、異なる電源、ネットワーク、サーバー コンポーネントを使用する別々の障害ドメインに、これらの VM とディスクが作成されます。

このような別々の障害ドメインにより、局所的なハードウェア障害は通常、セット内の複数の VM に同時に影響することはありません。 別々の障害ドメインを持つことで、アプリケーションの高可用性が実現されます。 高可用性が要求される場合に、可用性セットを使用することは優れた選択であると考えられます。

### <a name="backup-and-disaster-recovery"></a>バックアップと障害復旧

ディザスター リカバリーとは、まれに発生する大きなインシデントから復旧する能力です。 このようなインシデントには、リージョン全体に影響するサービス中断のように、一時的なものではない大規模な障害が含まれます。 ディザスター リカバリーには、データ バックアップやアーカイブの他に、バックアップからのデータベースの復元などの手動操作も含まれる場合があります。

局所的な障害に対する Azure プラットフォーム組み込みの保護機能は、大規模な障害を引き起こす可能性がある大きな災害の場合には、VM/ディスクを完全に保護できない場合があります。 このような大規模な障害には、データ センターがハリケーン、地震、火災に襲われた場合や、大規模なハードウェア ユニットの障害が発生した場合などの大惨事が含まれます。 さらに、アプリケーションやデータの問題による障害が発生する可能性もあります。

IaaS ワークロードを障害から保護するには、回復を可能にする冗長性とバックアップの計画を立てる必要があります。 ディザスター リカバリーのためには、プライマリ サイトから地理的に離れた別の場所でバックアップをとる必要があります。 この方法によって、VM またはディスクに最初に影響したものと同じ出来事がバックアップに影響することはなくなります。 詳細については、「[Disaster recovery for Azure applications (Azure アプリケーションのディザスター リカバリー)](/azure/architecture/resiliency/disaster-recovery-azure-applications)」をご覧ください。

ディザスター リカバリーの考慮事項には、次の側面が含まれます。

- 高可用性: 大幅なダウンタイムなしに、正常な状態で実行を継続するアプリケーションの能力です。 "正常な状態" とは、アプリケーションが応答し、ユーザーがアプリケーションに接続して対話できるという意味です。 特定のミッション クリティカルなアプリケーションとデータベースは、プラットフォームに障害が発生した場合でも、常に使用可能であることが求められます。 これらのワークロードについては、データだけでなく、アプリケーションの冗長性を計画する必要があります。

- データの持続性: 主な検討事項が、災害が発生した場合にも確実にデータを保持することである場合もあります。 そのため、別のサイトでデータをバックアップする必要があるかもしれません。 このようなワークロードの場合、アプリケーションの完全な冗長性の必要はなく、ディスクの定期的なバックアップのみが必要となります。

## <a name="backup-and-disaster-recovery-scenarios"></a>バックアップとディザスター リカバリーのシナリオ

アプリケーション ワークロードのシナリオの一般的ないくつかの例と、ディザスター リカバリー計画に関する検討事項について考えてみましょう。

### <a name="scenario-1-major-database-solutions"></a>シナリオ 1: 大規模なデータベースのソリューション

高可用性をサポートできる SQL Server または Oracle のような実稼働データベース サーバーについて考えてみます。 重要な実稼働アプリケーションとユーザーは、このデータベースに依存しています。 このシステムのディザスター リカバリー計画は、次の要件をサポートする必要があります。

- データは保護され、かつ回復可能である必要があります。
- サーバーは使用可能である必要があります。

ディザスター リカバリー計画では、異なるリージョンにバックアップとしてデータベースのレプリカを維持する必要があります。 サーバーの可用性とデータ復旧の要件によっては、アクティブ/アクティブ レプリカ サイトまたはアクティブ/パッシブ レプリカ サイトから、データの定期的なオフライン バックアップまでに及ぶソリューションが考えられます。 SQL Server、Oracle などのリレーショナル データベースでは、レプリケーションに関するさまざまなオプションが提供されています。 SQL Server では、高可用性を実現するために、[SQL Server AlwaysOn 可用性グループ](/sql/database-engine/availability-groups/windows/always-on-availability-groups-sql-server)を使用します。

MongoDB のような NoSQL データベースでは、冗長性を実現するために[レプリカ](https://docs.mongodb.com/manual/replication/)もサポートされています。 高可用性向けのレプリカが使用されます。

### <a name="scenario-2-a-cluster-of-redundant-vms"></a>シナリオ 2: 冗長 VM のクラスター

冗長性と負荷分散を提供する VM クラスターによって処理されるワークロードを検討します。 一例として、リージョンにデプロイされた Cassandra クラスターがあります。 このタイプのアーキテクチャは、リージョン内で高レベルの冗長性を既に提供しています。 ただし、リージョン レベルの障害からワークロードを保護するには、クラスターを 2 つのリージョンに分散させるか、別のリージョンに定期的なバックアップを実行することを検討する必要があります。

### <a name="scenario-3-iaas-application-workload"></a>シナリオ 3: IaaS アプリケーション ワークロード

IaaS アプリケーション ワークロードを見てみましょう。 たとえば、Azure VM で実行されている一般的な実稼働ワークロードが考えられます。 あるサイトのコンテンツと他のリソースを保持している Web サーバーまたはファイル サーバーが考えられます。 また、データ、リソース、アプリケーション状態などを VM ディスクに格納し、VM 上で実行されるカスタムビルドのビジネス アプリケーションかもしれません。 この場合は、定期的なバックアップを確実に行うことが重要です。 バックアップの頻度は、VM のワークロードの特性に基づいている必要があります。 たとえば、アプリケーションが毎日実行されてデータを変更している場合は、1 時間ごとにバックアップをとる必要があります。

別の例は、他のソースからデータをプルして集計レポートを生成するレポート サーバーです。 この VM やディスクが失われると、レポートが失われることがあります。 ただし、レポート プロセスを再実行し、出力を再生成できる場合があります。 その場合は、レポート サーバーが災害に遭っても、実際にはデータは失われません。 その結果、レポート サーバー上のデータの部分的な消失に対しては、耐性が高くなります。 その場合は、バックアップの頻度を下げることが、コスト削減の方法の 1 つになります。

### <a name="scenario-4-iaas-application-data-issues"></a>シナリオ 4: IaaS アプリケーション データの問題

IaaS アプリケーション データの問題も別の可能性として存在します。 価格情報などの重要な商用データを計算し、保守し、提供するアプリケーションについて考えます。 新しいバージョンのアプリケーションには、価格を誤って計算するソフトウェア バグがあり、プラットフォームによって提供される既存の商用データが破損しました。 ここでの最善策は、アプリケーションとデータを以前のバージョンに戻すことです。 これを可能にするには、定期的にシステムのバックアップをとります。

## <a name="disaster-recovery-solution-azure-disk-backup"></a>ディザスター リカバリー ソリューション: Azure ディスク バックアップ 

Azure ディスク バックアップは、マネージド ディスク内のデータを保護するネイティブのクラウドベースのバックアップ ソリューションです。 これはわずかな手順でマネージド ディスクの保護を構成できる、シンプルで安全なコスト効率の高いソリューションです。 これによって災害時にデータを復旧できるようになります。

Azure ディスク バックアップは、スナップショットの定期的な作成を自動化し、バックアップ ポリシーを使用して構成された期間にわたってそのスナップショットを保持することで、マネージド ディスクのスナップショット ライフサイクル管理を提供する、ターンキー ソリューションを提供します。 インフラストラクチャ コストなしでディスク スナップショットを管理でき、カスタム スクリプトも管理費用も必要ありません。 これは、1 日に複数のバックアップをサポートする増分スナップショットを使用してマネージド ディスクの特定時点のバックアップを作成する、クラッシュ整合性バックアップ ソリューションです。 また、エージェントレスのソリューションでもあり、運用アプリケーションのパフォーマンスに影響しません。 実行中の Azure VM に OS とデータ ディスク (共有ディスクを含む) が現在接続されているかどうかにかかわらず、この両方のバックアップと復元がサポートされます。

Azure ディスク バックアップの詳細については、「[Azure ディスク バックアップの概要](../backup/disk-backup-overview.md)」を参照してください。

## <a name="alternative-solution-consistent-snapshots"></a>代替のソリューション: 整合性スナップショット

Azure Backup を使用できない場合は、スナップショットを使用して、独自のバックアップ メカニズムを実装できます。 VM で使用されるすべてのディスクの整合性スナップショットを作成し、そのスナップショットを別のリージョンにレプリケートする方法は複雑です。 このため、Azure では、バックアップ サービスの使用はカスタム ソリューションの構築よりも良いオプションであると考えています。

ディスクのローカル冗長ストレージを使用する場合は、自分でデータをレプリケートする必要があります。

スナップショットは、特定の時点におけるオブジェクトを表現したものです。 スナップショットによって、保持しているデータのサイズの増分に対する請求が発生します。 詳細については、「[マネージド ディスクの増分スナップショットの作成](disks-incremental-snapshots.md)」を参照してください。

### <a name="create-snapshots-while-the-vm-is-running"></a>VM の実行中にスナップショットを作成する

スナップショットはいつでも取得可能ですが、VM を実行している場合は、ディスクに送信されている最中のデータが存在します。 そのため、スナップショットには実行中のオペレーションが部分的に含まれる場合があります。 また、複数のディスクが対象となっている場合は、それぞれのディスクのスナップショットが異なる時刻に取得された可能性があります。 このようなシナリオでは、スナップショットが調整されないことがあります。 このような調整がない場合、バックアップ中に変更が行われた場合にファイルが破損する可能性があるストライプ ボリュームでは、特に問題です。

この状況を避けるために、バックアップ プロセスで次の手順を実施する必要があります。

1.  すべてのディスクを凍結します。

1.  保留中のすべての書き込みをフラッシュします。

1.  すべてのディスクに、[マネージド ディスクの増分スナップショットを作成](disks-incremental-snapshots.md)します。

SQL Server などの一部の Windows アプリケーションは、アプリケーション整合性バックアップを作成するボリューム シャドウ サービスを通して、連携のとれたバックアップ メカニズムを提供します。 Linux では、ディスクを調整するために *fsfreeze* などのツールを使用できます。 このツールはファイル整合性バックアップを提供していますが、アプリケーション整合性スナップショットは提供していません。 このプロセスは複雑なため、[Azure ディスク バックアップ](../backup/disk-backup-overview.md)を使用するか、既にこの手順を実装しているサードパーティのバックアップ ソリューションの使用を検討する必要があります。

上記のプロセスによって、すべての VM ディスクに対する連携のとれた一連のスナップショットが生成されます。これは、特定の時点の VM の状態を表します。 これが、VM のバックアップの復元ポイントです。 スケジュールされた間隔で処理を繰り返し、定期的にバックアップを作成できます。 ディザスター リカバリーのためにスナップショットを別のリージョンにコピーする手順については、[バックアップの別のリージョンへのコピー](#copy-the-snapshots-to-another-region)に関する項目をご覧ください。

### <a name="create-snapshots-while-the-vm-is-offline"></a>VM がオフラインのときにスナップショットを作成する

整合性バックアップを作成する別のオプションは、VM をシャットダウンし、各ディスクのスナップショットを作成することです。 オフラインのスナップショットの作成は、実行中の VM のスナップショットの連携よりも簡単ですが、数分間のダウンタイムが必要です。

### <a name="copy-the-snapshots-to-another-region"></a>スナップショットを別のリージョンにコピーする

スナップショットを作成しただけでは、ディザスター リカバリーには不十分です。 スナップショットを別のリージョンにコピーする必要もあります。 [増分スナップショットの差分機能で別のリージョンに Azure マネージド ディスク バックアップをコピーする](https://github.com/Azure-Samples/managed-disks-dotnet-backup-with-incremental-snapshots)方法に関するページの手順を確認してください。

## <a name="other-options"></a>その他のオプション

### <a name="sql-server"></a>SQL Server

VM で実行されている SQL Server には、SQL Server データベースを Azure Blob Storage やファイル共有にバックアップする独自の組み込み機能があります。 詳細については、「[Azure Virtual Machines における SQL Server のバックアップと復元](../azure-sql/virtual-machines/windows/azure-storage-sql-server-backup-restore-use.md)」をご覧ください。 バックアップと復元に加えて、[SQL Server AlwaysOn 可用性グループ](../azure-sql/virtual-machines/windows/business-continuity-high-availability-disaster-recovery-hadr-overview.md)ではデータベースのセカンダリ レプリカを管理できます。 この機能により、ディザスター リカバリーの時間が大幅に短縮されます。

## <a name="next-steps"></a>次のステップ

「[Azure の非管理対象の仮想マシン ディスクを増分スナップショットでバックアップする](linux/incremental-snapshots.md)」を参照してください。

[1]: ./media/virtual-machines-common-backup-and-disaster-recovery-for-azure-iaas-disks/backup-and-disaster-recovery-for-azure-iaas-disks-1.png
[2]: ./media/virtual-machines-common-backup-and-disaster-recovery-for-azure-iaas-disks/backup-and-disaster-recovery-for-azure-iaas-disks-2.png