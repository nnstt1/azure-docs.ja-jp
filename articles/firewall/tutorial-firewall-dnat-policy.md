---
title: 'チュートリアル: ポータルで Azure Firewall DNAT ポリシーを使用してインバウンド インターネット トラフィックをフィルター処理する'
description: このチュートリアルでは、Azure portal を使用して、Azure Firewall DNAT ポリシーをデプロイして構成する方法について説明します。
services: firewall
author: vhorne
ms.service: firewall
ms.topic: tutorial
ms.date: 08/26/2021
ms.author: victorh
ms.custom: mvc
ms.openlocfilehash: 2f863c9fc5bad369813ee37c51ded73e96980a54
ms.sourcegitcommit: 03f0db2e8d91219cf88852c1e500ae86552d8249
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 08/27/2021
ms.locfileid: "123034208"
---
# <a name="tutorial-filter-inbound-internet-traffic-with-azure-firewall-policy-dnat-using-the-azure-portal"></a>チュートリアル: Azure portal で Azure Firewall DNAT ポリシーを使用してインバウンド インターネット トラフィックをフィルター処理する

サブネットへのインバウンド インターネット トラフィックを変換し、フィルター処理するように、Azure Firewall 宛先ネットワーク アドレス変換 (DNAT) ポリシーを構成できます。 DNAT を構成すると、"*規則コレクション アクション*" が **DNAT** に設定されます。 その後、NAT ルール コレクション内の各ルールを使用して、ファイアウォールのパブリック IP アドレスおよびポートをプライベート IP アドレスおよびポートに変換できます。 DNAT ルールは、変換されたトラフィックを許可するための対応するネットワーク ルールを暗黙的に追加します。 セキュリティ上の理由から、ネットワークへの DNAT アクセスを許可するための特定のインターネット ソースを追加し、ワイルドカードは使用しないようにすることが推奨されています。 Azure Firewall ルール処理ロジックの詳細については、「[Azure Firewall ルール処理ロジック](rule-processing.md)」を参照してください。

このチュートリアルでは、以下の内容を学習します。

> [!div class="checklist"]
> * テスト ネットワーク環境を設定する
> * ファイアウォールとポリシーをデプロイする
> * 既定のルートを作成する
> * DNAT ルールを構成する
> * ファイアウォールをテストする

## <a name="prerequisites"></a>前提条件

Azure サブスクリプションをお持ちでない場合は、開始する前に [無料アカウント](https://azure.microsoft.com/free/?WT.mc_id=A261C142F) を作成してください。



## <a name="create-a-resource-group"></a>リソース グループを作成する

1. Azure Portal [https://portal.azure.com](https://portal.azure.com) にサインインします。
2. Azure portal のホーム ページで **[リソース グループ]** を選択し、 **[追加]** を選択します。
4. **[サブスクリプション]** で、ご使用のサブスクリプションを選択します。
1. **[リソース グループ名]** に「**RG-DNAT-Test**」と入力します。
5. **[リージョン]** でリージョンを選択します。 作成する他のすべてのリソースも、同じリージョン内のものである必要があります。
6. **[Review + create]\(レビュー + 作成\)** を選択します。
1. **［作成］** を選択します

## <a name="set-up-the-network-environment"></a>ネットワーク環境を設定する

このチュートリアルでは、2 つのピアリングされた VNet を作成します。

- **VN-Hub** - ファイアウォールはこの VNet 内にあります。
- **VN-Spoke** - ワークロード サーバーはこの VNet 内にあります。

最初に VNet を作成し、次にそれらをピアリングします。

### <a name="create-the-hub-vnet"></a>ハブ VNet を作成する

1. Azure portal のホーム ページで、 **[すべてのサービス]** を選択します。
2. **[ネットワーク]** で、 **[仮想ネットワーク]** を選択します。
3. **[追加]** を選択します。
7. **[リソース グループ]** で、 **[RG-DNAT-Test]** を選択します。
1. **[名前]** に「**VN-Hub**」と入力します。
1. **[リージョン]** で、前に使用したのと同じリージョンを選択します。
1. **次へ:[次へ: IP アドレス]** を選択します。
1. **[IPv4 アドレス空間]** には、既定値の **10.0.0.0/16** をそのまま使用します。
1. **[サブネット名]** で、 **[default]\(既定\)** を選択します。
1. **[サブネット名]** を編集し、「**AzureFirewallSubnet**」と入力します。

     ファイアウォールはこのサブネットに配置されます。サブネット名は AzureFirewallSubnet **でなければなりません**。
     > [!NOTE]
     > AzureFirewallSubnet サブネットのサイズは /26 です。 サブネットのサイズの詳細については、「[Azure Firewall に関する FAQ](firewall-faq.yml#why-does-azure-firewall-need-a--26-subnet-size)」を参照してください。

10. **[サブネット アドレス範囲]** に「**10.0.1.0/26**」と入力します。
11. **[保存]** を選択します。
1. **[Review + create]\(レビュー + 作成\)** を選択します。
1. **［作成］** を選択します

### <a name="create-a-spoke-vnet"></a>スポーク VNet を作成する

1. Azure portal のホーム ページで、 **[すべてのサービス]** を選択します。
2. **[ネットワーク]** で、 **[仮想ネットワーク]** を選択します。
3. **[追加]** を選択します。
1. **[リソース グループ]** で、 **[RG-DNAT-Test]** を選択します。
1. **[名前]** に「**VN-Spoke**」と入力します。
1. **[リージョン]** で、前に使用したのと同じリージョンを選択します。
1. **次へ:[次へ: IP アドレス]** を選択します。
1. **[IPv4 アドレス空間]** で、既定値を編集し、 **「192.168.0.0/16**」と入力します。
1. **[サブネットの追加]** を選択します。
1. **[サブネット名]** に「**SN-Workload**」と入力します。
10. **[サブネット アドレス範囲]** に「**192.168.1.0/24**」と入力します。
11. **[追加]** を選択します。
1. **[確認および作成]** を選択します。
1. **［作成］** を選択します

### <a name="peer-the-vnets"></a>VNet をピアリングする

次に、2 つの VNet をピアリングします。

1. **VN-Hub** 仮想ネットワークを選択します。
2. **[設定]** で **[ピアリング]** を選択します。
3. **[追加]** を選択します。
4. **[この仮想ネットワーク]** の **[ピアリング リンク名]** に「**Peer-HubSpoke**」と入力します。
5. **[リモート仮想ネットワーク]** の **[ピアリング リンク名]** に「**Peer-SpokeHub**」と入力します。 
1. 仮想ネットワークとして **[VN-Spoke]** を選択します。
1. 他のすべての既定値をそのまま使用し、 **[追加]** を選択します。

## <a name="create-a-virtual-machine"></a>仮想マシンの作成

ワークロード仮想マシンを作成して、**SN-Workload** サブネットに配置します。

1. Azure portal メニューから **[リソースの作成]** を選択します。
2. **[人気順]** で、 **[Windows Server 2016 Datacenter]** を選択します。

**基本操作**

1. **[サブスクリプション]** で、ご使用のサブスクリプションを選択します。
1. **[リソース グループ]** で、 **[RG-DNAT-Test]** を選択します。
1. **[仮想マシン名]** に「**Srv-Workload**」と入力します。
1. **[リージョン]** で、以前使用したのと同じ場所を選択します。
1. ユーザー名とパスワードを入力します。
1. **ディスク** を選択します。

**ディスク**
1. **ネットワーク** を選択します。

**ネットワーク**

1. **[仮想ネットワーク]** で **[VN-Spoke]** を選択します。
2. **[サブネット]** で、 **[SN-Workload]** を選択します。
3. **[パブリック IP]** で、 **[なし]** を選択します。
4. **[パブリック受信ポート]** で **[なし]** を選択します。 
2. 他の設定については既定値のままにし、 **[次へ: 管理]** を選択します。

**管理**

1. **[起動の診断]** で、 **[Disable]\(無効\)** を選択します。
1. **[確認および作成]** を選択します。

**[確認および作成]**

概要を確認し、 **[作成]** を選択します。 これが完了するまでに数分かかります。

デプロイが完了したら、仮想マシンのプライベート IP アドレスをメモしてください。 これは、後でファイアウォールを構成するときに使用します。 仮想マシンの名前を選択し、 **[設定]** で **[ネットワーク]** を選択して、プライベート IP アドレスを見つけます。

## <a name="deploy-the-firewall-and-policy"></a>ファイアウォールとポリシーをデプロイする

1. ポータルのホーム ページから **[リソースの作成]** を選択します。
1. **[ファイアウォール]** を検索し、 **[ファイアウォール]** を選択します。
1. **［作成］** を選択します 
1. **[ファイアウォールの作成]** ページで、次の表を使用してファイアウォールを構成します。

   |設定  |値  |
   |---------|---------|
   |サブスクリプション     |\<your subscription\>|
   |Resource group     |**RG-DNAT-Test** を選択します |
   |名前     |**FW-DNAT-test**|
   |リージョン     |以前使用したのと同じ場所を選択します|
   |ファイアウォール管理|**ファイアウォール ポリシーを使用してこのファイアウォールを管理する**|
   |ファイアウォール ポリシー|**新規追加**:<br>**fw-dnat-pol**<br>選択したリージョン 
   |仮想ネットワークの選択     |**既存のものを使用**: VN-Hub|
   |パブリック IP アドレス     |**[新規追加]** 、名前: **fw-pip**。|

5. 他の既定値をそのまま使用し、 **[確認および作成]** を選択します。
6. 概要を確認し、 **[作成]** を選択してファイアウォールを作成します。

   このデプロイには数分かかります。
7. デプロイが完了したら、**RG-DNAT-Test** リソース グループに移動し、**FW-DNAT-test** ファイアウォールを選択します。
8. ファイアウォールのプライベートおよびパブリック IP アドレスをメモします。 これらは、後で既定のルートと NAT ルールを作成するときに使用します。

## <a name="create-a-default-route"></a>既定のルートを作成する

**SN-Workload** サブネットで、送信の既定ルートがファイアウォールを通過するように構成します。

1. Azure portal のホーム ページで、 **[すべてのサービス]** を選択します。
2. **[ネットワーク]** で、 **[ルート テーブル]** を選択します。
3. **[追加]** を選択します。
5. **[サブスクリプション]** で、ご使用のサブスクリプションを選択します。
1. **[リソース グループ]** で、 **[RG-DNAT-Test]** を選択します。
1. **[リージョン]** で、前に使用したのと同じリージョンを選択します。
1. **[名前]** に「**RT-FW-route**」と入力します。
1. **[Review + create]\(レビュー + 作成\)** を選択します。
1. **［作成］** を選択します
1. **[リソースに移動]** を選択します。
1. **[サブネット]** を選択し、 **[関連付け]** を選択します。
1. **[仮想ネットワーク]** で **[VN-Spoke]** を選択します。
1. **[サブネット]** で、**[SN-Workload]** を選択します。
1. **[OK]** を選択します。
1. **[ルート]** 、 **[追加]** の順に選択します。
1. **[ルート名]** に「**fw-dg**」と入力します。
1. **[アドレス プレフィックス]** に「**0.0.0.0/0**」と入力します。
1. **[次ホップの種類]** で、 **[仮想アプライアンス]** を選択します。

    Azure Firewall は実際はマネージド サービスですが、この状況では仮想アプライアンスが動作します。
18. **[次ホップ アドレス]** に、前にメモしておいたファイアウォールのプライベート IP アドレスを入力します。
19. **[OK]** を選択します。

## <a name="configure-a-nat-rule"></a>NAT ルールを構成する

このルールを使用すると、ファイアウォールを介して、リモート デスクトップを Srv-Workload 仮想マシンに接続できます。

1. **RG-DNAT-Test** リソース グループを開き、**fw-dnat-pol** ファイアウォール ポリシーを選択します。 
1. **[設定]** で、 **[DNAT rules]\(DNAT ルール\)** を選択します。
2. **[規則コレクションの追加]** を選択します。
3. **[名前]** に「**rdb**」と入力します。
1. **[優先度]** に「**200**」と入力します。
1. **[規則コレクション グループ]** で、**DefaultDnatRuleCollectionGroup** を選択します。
1. **[ルール]** の **[名前]** に「**rdp-nat**」と入力します。
1. **[Source type]\(送信元の種類\)** で、 **[IP アドレス]** を選択します。
1. **[送信元]** に「 **\*** 」と入力します。
1. **[プロトコル]** で **[TCP]** を選択します。
1. **[宛先ポート]** に「**3389**」と入力します。
1. **[送信先の種類]** で **[IP アドレス]** を選択します。
1. **[送信先]** に、ファイアウォールのパブリック IP アドレスを入力します。
1. **[変換されたアドレス]** に、**Srv-Workload** のプライベート IP アドレスを入力します。
1. **[Translated port] (変換されたポート)** に「**3389**」と入力します。
1. **[追加]** を選択します。


## <a name="test-the-firewall"></a>ファイアウォールをテストする

1. リモート デスクトップをファイアウォールのパブリック IP アドレスに接続します。 **Srv-Workload** 仮想マシンに接続する必要があります。
2. リモート デスクトップを閉じます。

## <a name="clean-up-resources"></a>リソースのクリーンアップ

次のチュートリアルのためにファイアウォール リソースを残しておくことができます。不要であれば、**RG-DNAT-Test** リソース グループを削除して、ファイアウォール関連のすべてのリソースを削除します。

## <a name="next-steps"></a>次のステップ

> [!div class="nextstepaction"]
> [Azure Firewall Premium をデプロイして構成する](premium-deploy.md)