---
title: Azure AD オンプレミス アプリケーション プロビジョニングのアーキテクチャ | Microsoft Docs
description: オンプレミス アプリケーション プロビジョニングのアーキテクチャの概要について説明します。
services: active-directory
author: billmath
manager: karenh444
ms.service: active-directory
ms.workload: identity
ms.topic: overview
ms.date: 05/28/2021
ms.subservice: hybrid
ms.author: billmath
ms.collection: M365-identity-device-management
ms.openlocfilehash: 89a0f2bd6b48d195836303a89143593c4d959bfb
ms.sourcegitcommit: 106f5c9fa5c6d3498dd1cfe63181a7ed4125ae6d
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 11/02/2021
ms.locfileid: "131028008"
---
# <a name="azure-ad-on-premises-application-provisioning-architecture"></a>Azure AD オンプレミス アプリケーション プロビジョニングのアーキテクチャ

>[!IMPORTANT]
> オンプレミス プロビジョニング プレビューは現在、招待のみのプレビューとなります。 この機能へのアクセスを要求するには、[アクセス要求フォーム](https://aka.ms/onpremprovisioningpublicpreviewaccess)を使用してください。 今後数か月の間に、より多くのお客様および接続ユーザーにプレビューを公開し、一般提供 (GA) に向けて準備を進めていく予定です。

## <a name="overview"></a>概要

次の図は、オンプレミス アプリケーション プロビジョニングのしくみを示しています。

![オンプレミス アプリケーション プロビジョニングのアーキテクチャを示す図。](.\media\on-premises-application-provisioning-architecture\arch-3.png)

オンプレミス アプリケーションへのユーザー プロビジョニングには、主要なコンポーネントが 3 つあります。

- プロビジョニング エージェントは、Azure Active Directory (Azure AD) とオンプレミス環境とを接続する役割を担います。
- ECMA ホストは、Azure AD からのプロビジョニング要求を、ターゲット アプリケーションへの要求に変換します。 Azure AD とアプリケーションとの間のゲートウェイとして機能します。 これを使用して、Microsoft Identity Manager で使用される既存の ECMA2 コネクタをインポートすることができます。 SCIM アプリケーションまたは SCIM ゲートウェイを構築済みである場合、ECMA ホストは必要ありません。
- Azure AD プロビジョニング サービスは、同期エンジンとして機能します。

>[!NOTE]
> Microsoft Identity Manager の同期は必要ありません。 ただし、ECMA ホストに ECMA コネクタをインポートする前の構築とテストに使用することができます。


### <a name="firewall-requirements"></a>ファイアウォールの要件

企業ネットワークへの受信接続を開く必要がありません。 プロビジョニング エージェントは、プロビジョニング サービスへのアウトバウンド接続のみを使用します。つまり、受信接続用のファイアウォール ポートを開放する必要はありません。 接続はすべてアウトバウンドであり、セキュリティで保護されたチャネル上で行われるため、境界 (DMZ) ネットワークは不要です。

## <a name="ecma-connector-host-architecture"></a>ECMA Connector Host のアーキテクチャ
ECMA Connector Host には、オンプレミスのプロビジョニングを実現するために使用されるいくつかの領域があります。  下の図は、これらの個々の領域を示す概念図です。  下の表で、各領域について詳細に説明しています。

[![ECMA Connector Host](.\media\on-premises-application-provisioning-architecture\ecma-2.png)](.\media\on-premises-application-provisioning-architecture\ecma-2.png#lightbox)



|領域|説明|
|-----|-----|
|エンドポイント|Azure AD プロビジョニング サービスとの通信およびデータ転送を実行します|
|メモリ内キャッシュ|オンプレミスのデータ ソースからインポートしたデータを格納するために使用されます|
|自動同期|ECMA Connector Host とオンプレミスのデータソース間の非同期データ同期を提供します|
|ビジネス ロジック|ECMA Connector Host のすべてのアクティビティを調整するために使用されます。  自動同期の時刻は、ECMA ホストで構成できます。 これはプロパティ ページにあります。|

### <a name="about-anchor-attributes-and-distinguished-names"></a>アンカー属性と識別名について
次の情報は、genericSQL コネクタで特に使用される、アンカー属性と識別名を詳しく説明したものです。

アンカー属性は、変更されないオブジェクトの種類の一意の属性であり、ECMA Connector Host のメモリ内キャッシュ内でそのオブジェクトを表します。

識別名 (DN) は、ディレクトリ階層内のオブジェクトの現在の場所を示すことによって、それを一意に識別する名前です。  または、SQL の場合はパーティション内の場所です。 名前は、アンカー属性をディレクトリ パーティションのルートに連結して形成されます。 

Active Directory や LDAP などのための従来の形式の DN では、以下のようなものが想定されます。

  `CN=Lola Jacobson,CN=Users,DC=contoso,DC=com`

ただし、階層型ではなくフラットである SQL などのデータ ソースでは、DN はテーブルのいずれかに既に存在しているか、ECMA Connector Host に提供する情報から作成される必要があります。  

これを実現するには、genericSQL コネクタを構成するときに、チェックボックスで **[Autogenerated]\(自動生成\)** を有効にします。 DN を自動生成することを選択すると、ECMA ホストによって LDAP 形式 (CN=&lt;anchorvalue&gt;,OBJECT=&lt;type&gt;) で DN が生成されます。 この場合、[接続] ページで [DN is Anchor]\(DN はアンカー\) が **オフ** になっていることも前提としています。 
 
 [![[DN is Anchor]\(DN はアンカー\) がオフになっている](.\media\on-premises-application-provisioning-architecture\user-2.png)](.\media\on-premises-application-provisioning-architecture\user-2.png#lightbox)

genericSQL コネクタでは、LDAP 形式を使用して DN を設定することが想定されています。  汎用 SQL コネクタでは、コンポーネント名が "OBJECT=" の LDAP スタイルを使用しています。 これにより、パーティションを使用できるようになります (各オブジェクトの種類はパーティションです)。

ECMA Connector Host は現在、USER オブジェクトの種類のみをサポートしているため、OBJECT=&lt;type&gt; は OBJECT=USER になります。  したがって、anchorvalue が ljacobson のユーザーの DN は次のようになります。

  CN=ljacobson,OBJECT=USER


### <a name="user-creation-workflow"></a>ユーザー作成ワークフロー

1.  Azure AD プロビジョニング サービスは、ユーザーが存在するかどうかを確認するために ECMA Connector Host に対してクエリを実行します。  フィルターとして **一致属性** が使用されます。  この属性は、Azure AD ポータルの [エンタープライズ アプリケーション] -> [On-premises provisioning]\(オンプレミスのプロビジョニング\) -> [プロビジョニング] -> [attribute matching]\(属性の照合\) に定義されています。  照合の優先順位 1 によって示されています。
1 つまたは複数の一致する属性を定義し、優先順位に基づいて優先度を付けることができます。  一致属性を変更する必要がある場合は、これを行うこともできます。
 [![一致属性](.\media\on-premises-application-provisioning-architecture\match-1.png)](.\media\on-premises-application-provisioning-architecture\match-1.png#lightbox)

2.  ECMA Connector Host は GET 要求を受け取り、その内部キャッシュでクエリを実行して、ユーザーが存在し、インポート済みかどうかを確認します。  これは **クエリ属性** を使用して実行されます。 クエリ属性は、[object types]\(オブジェクトの種類\) ページで定義されます。  
 [![クエリ属性](.\media\on-premises-application-provisioning-architecture\match-2.png)](.\media\on-premises-application-provisioning-architecture\match-2.png#lightbox)


3. ユーザーが存在しない場合、Azure AD はユーザーを作成する POST 要求を行います。  ECMA Connector Host は、HTTP 201 を使用して Azure AD に応答し、ユーザーの ID を提供します。 この ID は、[object types]\(オブジェクトの種類\) ページで定義されているアンカー値から派生します。 このアンカーは、今後および後続の要求のために ECMA Connector Host に対してクエリを実行するために Azure AD によって使用されます。 
4. Azure AD でユーザーに変更が加えられた場合、Azure AD は、手順 1 の一致する属性ではなく、前の手順のアンカーを使用してユーザーを取得する GET 要求を行います。 これにより、たとえば、Azure AD のユーザーとアプリの間のリンクを壊さずに UPN を変更することができます。  


## <a name="agent-best-practices"></a>エージェントのベスト プラクティス
- Azure AD Connect プロビジョニング エージェントの自動更新サービスが実行されていることを確認します。 エージェントをインストールすると、既定で有効になります。 Microsoft がデプロイをサポートするには自動更新が必要です。
- エージェントと Azure との間のアウトバウンド TLS 通信に対しては、どのような形式のインライン検査も行わないでください。 この種のインライン検査では、通信フローが低下します。
- エージェントは Azure とアプリケーションの両方と通信を行う必要があるため、エージェントの配置場所はこの 2 つの接続の待ち時間に影響します。 各ネットワーク接続を最適化することによって、エンド ツー エンドのトラフィック待機時間を最小化することができます。 各接続は次の方法で最適化できます。
  - ホップの両端間の距離を短縮します。
  - 経由する適切なネットワークを選択します。 たとえば、パブリック インターネットではなく、プライベート ネットワークを経由した方が、専用リンクのため高速である可能性があります。



## <a name="provisioning-agent-questions"></a>プロビジョニング エージェントに関する質問
ここでは、いくつかの一般的な質問に回答します。

### <a name="what-is-the-ga-version-of-the-provisioning-agent"></a>プロビジョニング エージェントの一般提供 (GA) バージョンは何ですか?

プロビジョニング エージェントの最新の GA バージョンについては、「[Azure Active Directory Connect プロビジョニング エージェント: バージョンのリリース履歴](provisioning-agent-release-version-history.md)」を参照してください。

### <a name="how-do-i-know-the-version-of-my-provisioning-agent"></a>プロビジョニング エージェントのバージョンを確認する方法を教えてください。

 1. プロビジョニング エージェントがインストールされている Windows サーバーにサインインします。
 2. **[コントロール パネル]**  >  **[プログラムのアンインストールまたは変更]** に移動します。
 3. エントリ **Microsoft Azure AD Connect プロビジョニング エージェント** に対応するバージョンを探します。

### <a name="does-microsoft-automatically-push-provisioning-agent-updates"></a>Microsoft からプロビジョニング エージェントの更新プログラムは自動的にプッシュされますか?

はい。 Windows サービス Microsoft Azure AD Connect Agent Updater が稼働している場合、Windows ではプロビジョニング エージェントが自動的に更新されます。 問題のトラブルシューティングをサポートするには、エージェントが最新であることが必要です。

### <a name="can-i-install-the-provisioning-agent-on-the-same-server-running-azure-ad-connect-or-microsoft-identity-manager"></a>Azure AD Connect や Microsoft Identity Manager を実行しているのと同じサーバーにプロビジョニング エージェントをインストールできますか?

はい。 Azure AD Connect や Microsoft Identity Manager を実行しているのと同じサーバーにプロビジョニング エージェントをインストールすることができます。ただし、それらは必須ではありません。

### <a name="how-do-i-configure-the-provisioning-agent-to-use-a-proxy-server-for-outbound-http-communication"></a>送信 HTTP 通信にプロキシ サーバーを使用するようにプロビジョニング エージェントを構成するにはどうすればよいですか?

プロビジョニング エージェントは送信プロキシの使用をサポートしています。 構成するには、エージェントの構成ファイル **C:\Program Files\Microsoft Azure AD Connect Provisioning Agent\AADConnectProvisioningAgent.exe.config** を編集します。ファイルの末尾近くにある `</configuration>` の終了タグの直前に次の行を追加します。 `[proxy-server]` 変数と `[proxy-port]` 変数をお使いのプロキシ サーバー名とポート値に置き換えてください。

```
    <system.net>
        <defaultProxy enabled="true" useDefaultCredentials="true">
            <proxy
                usesystemdefault="true"
                proxyaddress="http://[proxy-server]:[proxy-port]"
                bypassonlocal="true"
            />
        </defaultProxy>
    </system.net>
```
### <a name="how-do-i-ensure-the-provisioning-agent-can-communicate-with-the-azure-ad-tenant-and-no-firewalls-are-blocking-ports-required-by-the-agent"></a>プロビジョニング エージェントが Azure AD テナントと通信できること、ファイアウォールがエージェントに必要なポートをブロックしていないことを確認するにはどうすればよいですか?

必要なポートがすべて開いているかどうかを確認することもできます。

### <a name="how-do-i-uninstall-the-provisioning-agent"></a>プロビジョニング エージェントをアンインストールするにはどうすればよいですか?
 1. プロビジョニング エージェントがインストールされている Windows サーバーにサインインします。
 2. **[コントロール パネル]**  >  **[プログラムのアンインストールまたは変更]** に移動します。
 3. 次のプログラムをアンインストールします。
     - Microsoft Azure AD Connect プロビジョニング エージェント
     - Microsoft Azure AD Connect Agent Updater
     - Microsoft Azure AD Connect Provisioning Agent Package





## <a name="next-steps"></a>次のステップ

- [アプリ プロビジョニング](user-provisioning.md)
