---
title: Azure Active Directory アプリケーション プロキシのデプロイ計画
description: 組織内でアプリケーション プロキシのデプロイを計画するためのエンド ツー エンド ガイド
services: active-directory
author: kenwith
manager: karenh444
ms.service: active-directory
ms.subservice: app-proxy
ms.workload: identity
ms.topic: conceptual
ms.date: 04/27/2021
ms.author: kenwith
ms.openlocfilehash: 0779297a60d3dc6561e5df461e63b432afd219bf
ms.sourcegitcommit: 611b35ce0f667913105ab82b23aab05a67e89fb7
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 10/14/2021
ms.locfileid: "129989553"
---
# <a name="plan-an-azure-ad-application-proxy-deployment"></a>Azure AD アプリケーション プロキシのデプロイ計画

Azure Active Directory (Azure AD) アプリケーション プロキシは、オンプレミスのアプリケーションに、簡単、安全、かつコスト効率の高いリモート アクセス ソリューションを提供します。 これによって、最新のプロトコルをまだ使用できない従来のオンプレミス アプリケーションに対するアクセスを管理するためにすぐに移行できるパスがクラウド ファーストの組織に提供されます。 その他の概要については、「[アプリケーション プロキシとは](./application-proxy.md)」をご覧ください。

リモート ユーザーに対して内部リソースへのアクセス権を付与するには、アプリケーション プロキシをお勧めします。 このようなリモート アクセスのユース ケースでは、アプリケーション プロキシを使用することで、VPN またはリバース プロキシは必要なくなります。 これは、企業ネットワーク上のユーザーを対象としていません。 これらのユーザーがイントラネット アクセス用にアプリケーション プロキシを使用した場合、望ましくないパフォーマンス上の問題が発生する可能性があります。

この記事には、Azure AD アプリケーション プロキシの計画、操作、および管理に必要なリソースが含まれています。

## <a name="plan-your-implementation"></a>実装の計画

次のセクションでは、効率的なデプロイ エクスペリエンスに向けて準備する重要な計画要素の概要を説明します。

### <a name="prerequisites"></a>前提条件

実装を開始する前に次の前提条件を満たしている必要があります。 これらの前提条件を含め環境の設定について詳しくは、この[チュートリアル](application-proxy-add-on-premises-application.md)をご覧ください。

* **コネクタ**:コネクタは、以下の上にデプロイできる軽量エージェントです。
   * オンプレミスの物理ハードウェア
   * 任意のハイパーバイザー ソリューション内でホストされている VM
   * アプリケーション プロキシ サービスへの送信接続を有効にする、Azure 内にホストされている VM

* 詳しくは、「[Azure AD アプリケーション プロキシ コネクタを理解する](application-proxy-connectors.md)」をご覧ください。

     * コネクタ コンピューターは、コネクタをインストールする前に [TLS 1.2 に対して有効](application-proxy-add-on-premises-application.md)にしておく必要があります。

     * 可能であれば、バックエンド Web アプリケーション サーバーと[同じネットワーク](application-proxy-network-topology.md)とセグメント内にコネクタをデプロイします。 アプリケーションの検出を完了した後でコネクタをデプロイすることをお勧めします。
     * 高可用性とスケールを実現するために、各コネクタ グループには少なくとも 2 つのコネクタを用意することをお勧めします。 任意の時点でコンピューターにサービスを提供する必要がある場合は、3 つのコネクタを用意するのが最適です。 [コネクタ キャパシティ テーブル](./application-proxy-connectors.md#capacity-planning)を参照すれば、コネクタのインストール先とするコンピューターの種類を容易に決定できます。 コンピューターが大きくなればなるほど、コネクターはより大きなバッファーとなり、より高いパフォーマンスを発揮します。

* **ネットワーク アクセスの設定**:Azure AD アプリケーション プロキシ コネクタは [HTTPS (TCP ポート 443) および HTTP (TCP ポート 80) を介して Azure に接続します](application-proxy-add-on-premises-application.md)。

   * 終端コネクタ TLS トラフィックはサポートされていません。終端コネクタ TLS トラフィックでは、コネクタがそれぞれの Azure アプリケーション プロキシ エンドポイントとセキュリティで保護されたチャネルを確立できません。

   * コネクタと Azure の間の送信 TLS 通信に対してすべての形式のインライン検査を行わないでください。 コネクタとバックエンド アプリケーション間の内部検査は可能ですが、ユーザー エクスペリエンスを低下させることがあるためお勧めしません。

   * また、コネクタそのものの負荷分散はサポートされません。不必要な場合さえあります。

### <a name="important-considerations-before-configuring-azure-ad-application-proxy"></a>Azure AD アプリケーション プロキシを構成する前の重要な考慮事項

Azure AD アプリケーション プロキシを構成して実装するには、次のコア要件を満たす必要があります。

*  **Azure のオンボード**:アプリケーション プロキシをデプロイする前に、ユーザー ID をオンプレミス ディレクトリと同期するか、Azure AD テナント内に直接作成する必要があります。 ID 同期によって、Azure AD が、アプリケーション プロキシが発行したアプリケーションへのアクセス権をユーザーに付与する前にユーザーを事前に認証でき、シングル サインオン (SSO) を実行するために必要なユーザー ID 情報を得ることができます。

* **条件付きアクセスの要件**:イントラネット アクセスにアプリケーション プロキシを使用することはお勧めできません。これによって、ユーザーに影響を与える待機時間が追加されるためです。 アプリケーション プロキシは、インターネットからのリモート アクセスを対象にした事前認証および条件付きアクセス ポリシーと一緒に使用することをお勧めします。  イントラネット用に条件付きアクセスを提供するアプローチとしては、AAD で直接認証できるようにアプリケーションを近代化することです。 詳細については、「[アプリケーションを AAD に移行するためのリソース](../manage-apps/migration-resources.md)」を参照してください。

* **サービスの制限**: 個々のテナントによるリソースの過剰消費から保護するために、アプリケーションおよびテナントごとにスロットリングの制限が設定されています。 これらの制限については、「[Azure AD サービスの制限と制約](../enterprise-users/directory-service-limits-restrictions.md)」を参照してください。 このようなスロットルの制限は、通常の使用量をはるかに超えるベンチマークに基づいて行われます。これにより、ほとんどのデプロイに十分なバッファーが提供されます。

* **公開証明書**:カスタム ドメイン名を使用している場合は、SSL 証明書を取得する必要があります。 組織の要件によって異なりますが、証明書の入手には時間がかかることがあります。できるだけ早くこのプロセスを開始することをお勧めします。 Azure アプリケーション プロキシでは、標準、[ワイルドカード](application-proxy-wildcard.md)、または SAN ベースの証明書がサポートされます。 詳細については、「[Azure AD アプリケーション プロキシでカスタム ドメインを構成する](application-proxy-configure-custom-domain.md)」を参照してください。

* **ドメインの要件**:Kerberos 制約付き委任 (KCD) を利用してご自分の発行済みアプリケーションにシングル サインオンするには、コネクタを実行するサーバーとアプリを実行するサーバーがドメインに参加し、かつ同じドメインまたは信頼する側のドメインに属していることが必要です。
このトピックについて詳しくは、「[KCD for single sign-on with Application Proxy (アプリケーション プロキシを使用したシングル サインオンのための KCD)](application-proxy-configure-single-sign-on-with-kcd.md)」をご覧ください。 コネクタ サービスはローカル システムのコンテキストで実行します。カスタム ID を使用するように構成しないでください。

* **URL の DNS レコード**

   * アプリケーション プロキシ内でカスタム ドメインを使用する前に、パブリック DNS に CNAME レコードを作成する必要があります。これにより、カスタム定義された外部 URL をクライアントが事前定義済みアプリケーション プロキシ アドレスに解決できるようになります。 カスタム ドメインを使用するアプリケーションのために CNAME レコードを作成できないと、リモート ユーザーがアプリケーションに接続できなくなります。 CNAME レコードを追加するために必要な手順は DNS プロバイダーごとに異なるため、[Azure portal を使用して DNS レコードおよびレコード セットを管理する](../../dns/dns-operations-recordsets-portal.md)方法をご覧ください。

   * 同様に、コネクタ ホストは、発行されるアプリケーションの内部 URL を解決できる必要があります。

* **管理者権限とロール**

   * **コネクタのインストール** では、インストール先の Windows サーバーに対するローカル管理者権限が必要です。 また、コネクタ インスタンスを Azure AD テナントに認証して登録するために最小限の *アプリケーション管理者* ロールも必要です。

   * **アプリケーションの発行と管理** には、"*アプリケーション管理者*" ロールが必要です。 アプリケーション管理者ロールは、登録、SSO 設定、ユーザーとグループの割り当てとライセンス、アプリケーション プロキシ設定、同意など、ディレクトリ内のすべてのアプリケーションを管理できます。 条件付きアクセスの管理権限は付与されません。 "*クラウド アプリケーション管理者*" ロールには、アプリケーション プロキシ設定を管理できない以外は、アプリケーション管理者のすべての権限が含まれます。

* **ライセンス**: アプリケーション プロキシは Azure AD Premium サブスクリプションで利用できます。 ライセンス オプションと機能の完全な一覧については、[Azure Active Directory の価格ページ](https://www.microsoft.com/security/business/identity-access-management/azure-ad-pricing)をご覧ください。

### <a name="application-discovery"></a>アプリケーションの検出

以下の情報を収集して、アプリケーション プロキシで発行されるスコープ内アプリケーションすべてのインベントリをまとめます。

| 情報の種類| 収集する情報 |
|---|---|
| サービスの種類| 次に例を示します。SharePoint、SAP、CRM、カスタム Web アプリケーション、API |
| アプリケーション プラットフォーム | 次に例を示します。Windows IIS、Linux 上の Apache、Tomcat、NGINX |
| ドメイン メンバーシップ| Web サーバーの完全修飾ドメイン名 (FQDN) |
| アプリケーションの場所 | インフラストラクチャ内で Web サーバーまたはファームがある場所 |
| 内部アクセス | 内部でアプリケーションにアクセスするときに使用される正確な URL。 <br> ファームでどの種類の負荷分散が使用されているか。 <br> アプリケーションがそれ自体以外のソースのコンテンツを描画するかどうか。<br> アプリケーションが WebSocket で動作するかどうかを決定します。 |
| 外部アクセス | 既にアプリケーションが外部に公開されているベンダー ソリューション。 <br> 外部アクセス用に使用する URL です。 SharePoint の場合は、[このガイダンス](/SharePoint/administration/configure-alternate-access-mappings)に従って代替アクセス マッピングを構成してください。 それ以外の場合、外部 URL を定義する必要があります。 |
| 公開証明書 | カスタム ドメインを使用している場合は、対応するサブジェクト名の証明書を取得します。 証明書が存在する場合は、そのシリアル番号と取得できる場所をメモします。 |
| 認証の種類| アプリケーションによってサポートされる認証の種類では、Basic、Windows 統合認証、フォームベース、ヘッダーベース、要求などがサポートされます。 <br>特定のドメイン アカウントで実行するようにアプリケーションが構成されている場合は、サービス アカウントの完全修飾ドメイン名 (FQDN) をメモします。<br> SAML ベースの場合は、識別子と応答 URL。 <br> ヘッダーベースの場合は、ベンダー ソリューションと認証の種類を処理するための特定の要件。 |
| コネクタ グループ名 | このバックエンド アプリケーションにコンジットと SSO を提供するように指定されたコネクタ グループの論理名。 |
| ユーザー/グループのアクセス | アプリケーションへの外部アクセスが許可されるユーザーまたはユーザー グループ。 |
| その他の要件 | アプリケーションの発行に組み込む必要があるその他のリモート アクセスまたはセキュリティの要件に注意してください。 |

この[アプリケーション インベントリ スプレッドシート](https://aka.ms/appdiscovery)をダウンロードして、アプリケーションのインベントリを管理できます。

### <a name="define-organizational-requirements"></a>組織の要件を定義する

以下に示すのは、組織のビジネス要件を定義する必要がある区分です。 各区分には要件の例が含まれています。

 **Access (アクセス)**

* ドメイン参加デバイスまたは Azure AD 参加デバイスを使用するリモート ユーザーは、シームレスなシングル サインオン (SSO) により発行済みのアプリケーションに安全にアクセスできます。

* 承認済みの個人用デバイスを利用するリモート ユーザーが MFA に登録され、携帯電話上の Microsoft Authenticator アプリを認証方法として登録している場合は、発行済みのアプリケーションに安全にアクセスできます。

**ガバナンス**

* 管理者は、アプリケーション プロキシを介して発行されたアプリケーションに対するユーザー割り当てのライフサイクルを定義して監視できます。

**Security**

* グループ メンバーシップで、または個別にアプリケーションに割り当てられたユーザーのみが、それらのアプリケーションにアクセスできます。

**パフォーマンス**

* 内部ネットワークからのアプリケーションへのアクセスに比較してアプリケーションのパフォーマンスが低下しません。

**ユーザー エクスペリエンス**

* ユーザーは、任意のデバイス プラットフォームで使い慣れた会社の URL を使用することにより、アプリケーションにアクセスする方法を認識します。

**監査**
* 管理者はユーザーのアクセス アクティビティを監査できます。


### <a name="best-practices-for-a-pilot"></a>パイロットのベスト プラクティス

シングル サインオン (SSO) を使用したリモート アクセスのために 1 つのアプリケーションを完全に作動させるために必要な時間と労力を確認します。 このためには、初期の検出、発行、および一般的なテストを検討するパイロットを実行します。 統合 Windows 認証 (IWA) が既に構成されている単純な IIS ベースの Web アプリケーションを使用すると、基準計画の確立に役立ちます。この設定ではリモート アクセスと SSO のパイロットを成功させるために最小の労力しか必要としないためです。

以下の設計要素によって、パイロットを運用環境テナントに直接実装する成功率が高まります。

**コネクタの管理**:

* コネクタは、オンプレミス コンジットをアプリケーションに提供するために重要な役割を果たします。 **既定** コネクタ グループの使用が、運用環境で動作させる前の発行済みアプリケーションの最初のパイロット テストに適しています。 この後、テストが成功したアプリケーションを運用環境のコネクタ グループに移すことができます。

**アプリケーション管理**:

* 従業員は外部 URL に慣れて関連性が高いものとしてそれを記憶する可能性が高くなります。 事前定義済みの msappproxy.net または onmicrosoft.com サフィックスを使用してアプリケーションを発行しないでください。 代わりに、*intranet.<customers_domain>.com* のように、使い慣れた最上位レベルの確認済みドメイン前に論理的なホスト名を指定します。

* 起動アイコンを Azure MyApps ポータルでは表示せず、パイロット アプリケーションのアイコンの表示をパイロット グループのみに制限します。 運用の準備が整ったら、アプリのスコープをそれぞれの対象ユーザーに設定できます。これは、同じ実稼働前テナント内で行うか、ご使用の運用環境テナントにアプリケーションを発行します。

**シングル サインオンの設定**:一部の SSO 設定には、設定に時間がかかる固有の依存関係があるため、依存関係を事前に対処しておくことで、変更制御の遅延を回避します。 これには、Kerberos 制約付き委任 (KCD) を使用し、時間のかかる他のアクティビティを処理して SSO を実行する、ドメイン参加コネクタ ホストが含まれます。 たとえば、ヘッダーベース SSO が必要な場合には、PING アクセス インスタンスを設定します。

**コネクタ ホストとターゲット アプリケーションの間の TLS**:セキュリティは非常に重要であるため、コネクタ ホストとターゲット アプリケーション間の TLS は常に使用する必要があります。 Web アプリケーションでフォームベース認証 (FBA) が構成されている場合は、ユーザー資格情報が効率よくクリア テキストで送信されるため特に当てはまります。

**段階的な実装と手順ごとのテスト**
以下の指示に従い、アプリケーションの発行後に基本的な機能テストを実施して、すべてのユーザーとビジネスの要件が満たされていることを確認します。

1. 事前認証が無効になっている Web アプリケーションへの一般的なアクセスをテストして検証します。
2. 成功した場合は、事前認証を有効にし、ユーザーとグループを割り当てます。 アクセスをテストおよび検証します。
3. 次に、アプリケーションの SSO 手法を追加し、再びテストしてアクセスを検証します。
4. 必要に応じて条件付きアクセスおよび MFA ポリシーを適用します。 アクセスをテストおよび検証します。

**トラブルシューティング ツール**:トラブルシューティングの際には、常に最初にコネクタ ホスト上のブラウザーから発行済みアプリケーションへのアクセスを検証して、アプリケーションが予期されるとおりに機能していることを確認します。 セットアップが単純であるほど根本原因の判別が容易になります。このため、SSO は使用せずに 1 つのコネクタのみを使用するなど、最小の構成で問題を再現することを検討してください。 場合によっては、プロキシによってアクセスされるアプリケーションのアクセスまたはコンテンツの問題をトラブルシューティングするために Telerik Fiddler などの Web デバッグ ツールが不可欠と判明することがあります。 Fiddler はプロキシとしても作動し、iOS や Android などモバイル プラットフォームのトラフィックとプロキシ経由でルーティングするように構成できる実質的にすべてのトラフィックをトレースしてデバッグするときに役立ちます。 詳細については、[トラブルシューティング ガイド](application-proxy-troubleshoot.md)を参照してください。

## <a name="implement-your-solution"></a>ソリューションを実装する

### <a name="deploy-application-proxy"></a>アプリケーション プロキシをデプロイする

アプリケーション プロキシをデプロイする手順は、[リモート アクセスのためにオンプレミス アプリケーションを追加するチュートリアル](application-proxy-add-on-premises-application.md)で説明しています。 インストールが正常に終了していない場合は、ポータルで **[Troubleshoot Application Proxy]\(アプリケーション プロキシのトラブルシューティング\)** を選択するか、[アプリケーション プロキシ エージェント コネクタのインストールに関する問題](application-proxy-connector-installation-problem.md)に対するトラブルシューティング ガイドを使用します。

### <a name="publish-applications-via-application-proxy"></a>アプリケーション プロキシを介してアプリケーションを発行する

アプリケーションの発行では、すべての前提条件が満たされていることと、いくつかのコネクタが [アプリケーション プロキシ] ページに登録済みかつアクティブとして表示されていることが前提です。

[PowerShell](/powershell/module/azuread/?view=azureadps-2.0-preview&preserve-view=true) を使用してアプリケーションを発行することもできます。

アプリケーションを発行するときに従ういくつかのベスト プラクティスを次に示します。

* **コネクタ グループの使用**:それぞれのアプリケーションを発行するために指定されているコネクタ グループを割り当てます。 高可用性とスケールを実現するために、各コネクタ グループには少なくとも 2 つのコネクタを用意することをお勧めします。 任意の時点でコンピューターにサービスを提供する必要がある場合は、3 つのコネクタを用意するのが最適です。 さらに、「[コネクタ グループを使用して別のネットワークや場所にアプリケーションを発行する](application-proxy-connector-groups.md)」を参照してください。コネクタグループを使用することでネットワークまたは場所によってご利用のコネクタをセグメント化する方法も確認できます。

* **バックエンド アプリケーションのタイムアウトの設定**:この設定は、アプリケーションがクライアント トランザクションを処理するために必要な時間が 75 秒を超える可能性があるシナリオで役立ちます。 たとえば、データベースに対するフロント エンドとして動作する Web アプリケーションにクライアントがクエリを送信するときです。 フロント エンドはこのクエリをバックエンド データベース サーバーに送信して応答を待機しますが、応答を受信するまでに会話のクライアント側がタイムアウトします。タイムアウトを [長] に設定すると、長いトランザクションが完了できるように 180 秒が指定されます。

* **適切な Cookie タイプの使用**

   * **HTTP 専用 Cookie**:アプリケーション プロキシの set-cookie HTTP 応答ヘッダーに HTTPOnly フラグを含むことにより、追加のセキュリティが提供されます。 この設定は、クロスサイト スクリプティング (XSS) などの悪用の軽減に役立ちます。 セッション Cookie へのアクセス権が必要なクライアント/ユーザー エージェントの場合は、この設定を [いいえ] にしておきます。 たとえば、アプリケーション プロキシによって発行されたリモート デスクトップ ゲートウェイに接続する RDP/MTSC クライアントです。

   * **セキュリティで保護された Cookie**:Secure 属性を使用して Cookie を設定すると、ユーザー エージェント (クライアント側アプリ) が Cookie を HTTP 要求に含めるのは要求が TLS セキュリティ チャネルを介して送信される場合のみです。 これにより、クリア テキスト チャネル上で cookie が危害を受けるリスクが軽減するため、有効にする必要があります。

   * **永続 Cookie**:アプリケーション プロキシのセッション Cookie を期限切れになるか削除されるまで有効にしておくことで、ブラウザーをクローズした後でも永続化できます。 ユーザーが認証を再度求められずに、Office などの多機能アプリケーションが発行済み Web アプリケーション内のドキュメントにアクセスするというシナリオで使用されます。 ただし、有効にするときは慎重に行います。永続 Cookie は、他の補完コントロールと組み合わせて使用しないと、最終的にサービスを未承認アクセスのリスクにさらす可能性があるためです。 この設定は、プロセス間で Cookie を共有できない古いアプリケーションにのみ使用する必要があります。 この設定を使用するのではなく、プロセス間での Cookie の共有を処理するようにアプリケーションを更新する方が適切です。

* **ヘッダーの URL の変換**:これは、組織のパブリック名前空間と一致するように内部 DNS を構成できないシナリオ (分割 DNS) で有効にします。 アプリケーションがクライアント要求内の元のホスト ヘッダーを必要とする場合を除き、この値の設定は [はい] のままにします。 代わりに、コネクタが、実際のトラフィックのルーティングに内部 URL の FQDN を使用し、ホストヘッダーとして外部 URL の FQDN を使用するようにします。 ほとんどのケースで、リモートからアクセスしたとき、この代替方法によってアプリケーションが正常に作動しますが、内部と外部の URL が一致するというユーザーのメリットは失われます。

* **アプリケーション本文の URL を変換する**:クライアントへの応答で、そのアプリからのリンクを変換したい場合に、アプリのアプリケーション本文のリンク変換をオンにします。 この機能を有効にすると、クライアントに返される HTML および CSS 応答でアプリケーション プロキシが検出するすべての内部リンクの変換をベスト エフォートで試行します。 これは、ハードコーディングされた絶対リンクまたは NetBIOS 短縮名リンクをコンテンツに含むアプリを発行するとき、または他のオンプレミス アプリケーションにリンクするコンテンツを含むアプリを発行するときに役立ちます。

発行済みアプリが他の発行済みアプリにリンクするシナリオでは、各アプリケーションのリンクの変換を有効にして、各アプリ レベルでのユーザー エクスペリエンスを制御できるようにします。

たとえば、すべてが相互にリンクする、アプリケーション プロキシ経由で公開された 3 つのアプリケーション (福利厚生、経費、出張) に加えて、アプリケーション プロキシ経由で公開されていないフィードバックという 4 番目のアプリがあります。

![画像 1](media/App-proxy-deployment-plan/link-translation.png)

福利厚生アプリのリンク変換を有効にすると、経費と出張へのリンクは、それらのアプリの外部 URL にリダイレクトされるため、企業ネットワークの外部からアプリケーションにアクセスしているユーザーがアクセスできます。 経費と出張のアプリに対してはリンク変換が有効になっていないため、この 2 つのアプリから福利厚生へのリンクは機能しません。 外部 URL がないため、フィードバックへのリンクはリダイレクトされません。したがって、福利厚生アプリを使用するユーザーは、企業ネットワークの外部からフィードバック アプリにアクセスすることはできません。 リンク変換とその他のリダイレクト オプションについて詳しくは、[こちら](application-proxy-configure-hard-coded-link-translation.md)をご覧ください。

### <a name="access-your-application"></a>アプリケーションにアクセスする

アプリケーション プロキシで発行したリソースへのアクセスを管理するためにいくつかの方法があります。ご使用のシナリオとスケーラビリティのニーズに最適なものを選んでください。 一般的なアプローチには、Azure AD Connect を使用して同期されるオンプレミス グループの使用、ユーザー属性に基づいた Azure AD での動的グループの作成、リソース所有者によって管理されるセルフサービス グループの使用、これらの組み合わせがあります。 それぞれの利点についてはリンクされたリソースを参照してください。

アプリケーションにユーザー アクセスを割り当てる最もわかりやすい方法は、発行済みアプリケーションの左側のウィンドウの **[ユーザーとグループ]** オプションに移動し、グループまたはユーザーを直接割り当てることです。

![画像 24](media/App-proxy-deployment-plan/add-user.png)

また、ユーザーが現在メンバーになっていないグループを割り当て、セルフサービス オプションを構成することで、ユーザーがアプリケーションにセルフサービスでアクセスできるようにすることもできます。

![画像 25](media/App-proxy-deployment-plan/allow-access.png)

有効にすると、ユーザーは MyApps ポータルにログインして、アクセスを要求できるようになります。自動承認されて既に許可されたセルフサービス グループに追加されるか、指定された承認者からの承認を必要とします。

ゲスト ユーザーは、[Azure AD B2B を介してアプリケーション プロキシによって発行された内部アプリケーションにアクセスするように招待](../external-identities/add-users-information-worker.md)することもできます。

通常匿名でアクセスでき、認証が不要なオンプレミス アプリケーションの場合には、アプリケーションの **[プロパティ]** にあるオプションを無効にすることをお勧めします。

![画像 26](media/App-proxy-deployment-plan/assignment-required.png)


このオプションの設定を [いいえ] にしておくと、ユーザーが許可なしで Azure AD アプリケーション プロキシを介してオンプレミス アプリケーションにアクセスできます。従って慎重に使用してください。

アプリケーションがいったん発行されると、外部 URL をブラウザーに入力するか [https://myapps.microsoft.com](https://myapps.microsoft.com/) のアイコンを使用してアクセスできます。

### <a name="enable-pre-authentication"></a>事前認証を有効化する

ご利用のアプリケーションには、外部 URL 経由でアクセスするアプリケーション プロキシを介してアクセス可能であることを確認してください。

1. **[Azure Active Directory]**  >  **[エンタープライズ アプリケーション]**  >  **[すべてのアプリケーション]** の順に移動し、管理するアプリを選択します。

2. **[アプリケーション プロキシ]** を選択します。

3. **[事前認証]** フィールドで、ドロップダウン リストを使用して **[Azure Active Directory]** を選択し、 **[保存]** を選択します。

事前認証が有効にされている場合、Azure AD では最初にユーザーに認証を要求します。さらにシングル サインオンが構成されている場合は、バックエンド アプリケーションもアプリケーションへのアクセスが許可される前にユーザーを確認します。 また、事前認証モードをパススルーから Azure AD に変更すると、HTTPS を使用する外部 URL が構成されるため、最初は HTTP が構成されていたすべてのアプリケーションが HTTPS によって保護されるようになります。

### <a name="enable-single-sign-on"></a>Enable Single Sign-On

SSO では、最適なユーザー エクスペリエンスとセキュリティが提供されます。ユーザーは Azure AD にアクセスするときに 1 回だけサインインすればよいためです。 ユーザーが事前認証されると、アプリケーション プロキシ コネクタがユーザーのために SSO を実行し、オンプレミス アプリケーションに対して認証します。 バックエンド アプリケーションが、ユーザーそのものであるかのようにログインを処理します。

**[パススルー]** オプションを選択すると、ユーザーは Azure AD に対して認証する必要はなく、発行済みアプリケーションにアクセスできます。

SSO の実行が可能なのは、Azure AD が、リソースへのアクセスを要求するユーザーを識別できる場合のみです。したがって、SSO が機能するには、アクセス時に Azure AD を使用してユーザーを事前認証するようにアプリケーションを構成する必要があります。そうしないと、SSO オプションが無効になります。

「[Azure Active Directory でのアプリケーションへのシングル サインオン](../manage-apps/what-is-single-sign-on.md)」を読むと、アプリケーションを構成するときに最適な SSO 方法を選択するために役立ちます。

###  <a name="working-with-other-types-of-applications"></a>他の種類のアプリケーションを操作する

Azure AD アプリケーション プロキシは、[Microsoft 認証ライブラリ (MSAL)](../develop/v2-overview.md) を使用するように開発されたアプリケーションもサポートできます。 これは、クライアント要求のヘッダー情報で受け取った Azure AD 発行のトークンを使用して、ユーザーのために事前認証を実行することにより、ネイティブ クライアント アプリをサポートします。

アプリケーション プロキシの使用可能な構成については、[ネイティブおよびモバイル クライアント アプリの発行](./application-proxy-configure-native-client-application.md)に関するページや[要求ベースのアプリケーション](./application-proxy-configure-for-claims-aware-applications.md)に関するページをご覧ください。

### <a name="use-conditional-access-to-strengthen-security"></a>条件付きアクセスを使用してセキュリティを強化する

アプリケーションのセキュリティでは、オンプレミスおよびクラウドでの複雑な脅威から保護して対応できる、一連の高度なセキュリティ機能が必要です。 多くの場合、攻撃者が脆弱な資格情報、管理が行き届いていない資格情報、または盗んだ資格情報を利用して、企業のネットワークに侵入しています。  マイクロソフトの ID に基づくセキュリティでは、権限を持つ ID と権限を持たない ID の両方を管理して保護することにより、盗まれた資格情報の使用を減らしています。

Azure AD アプリケーション プロキシをサポートするために次の機能を使用できます。

* ユーザーおよびロケーションベースの条件付きアクセス:[ロケーションベースの条件付きアクセス ポリシー](../conditional-access/location-condition.md)では、地理的な場所や IP アドレスに基づいてユーザー アクセスを制限することで機密データを保護します。

* デバイスベースの条件付きアクセス:[デバイスベースの条件付きアクセス](../conditional-access/require-managed-devices.md)では、登録され承認された準拠デバイスのみが会社のデータにアクセスできます。

* アプリケーションベースの条件付きアクセス:会社のネットワークに接続していないときでも、仕事を中断するわけにはいきません。 [企業クラウドおよびオンプレミス アプリへのアクセスを保護](../conditional-access/app-based-conditional-access.md)し、条件付きアクセスによる制御を管理します。

* リスクベースの条件付きアクセス:[リスクベースの条件付きアクセス ポリシー](https://www.microsoft.com/cloud-platform/conditional-access)を使用し、悪意のあるハッカーからデータを保護しましょう。これらのポリシーは、オンプレミスかクラウドかにかかわらず、すべてのアプリとすべてのユーザーに適用できます。

* Azure AD マイ アプリ:アプリケーション プロキシ サービスがデプロイされ、アプリケーションが安全に発行されると、すべてのアプリケーションを検出してアクセスするための単純なハブがユーザーに提供されます。 [マイ アプリ](https://aka.ms/AccessPanelDPDownload)を使用すると、ユーザーが新しいアプリやグループへのアクセスを要求したり、他のユーザーに代わってこれらのリソースへのアクセスを管理したりする機能などのセルフサービス機能を使用して生産性が向上します。

## <a name="manage-your-implementation"></a>実装を管理する

### <a name="required-roles"></a>必要なロール

マイクロソフトでは Azure AD で必要なタスクを実行するために最小限の権限を付与するという原則を提唱しています。 [使用可能なさまざまな Azure ロールを確認](../roles/permissions-reference.md)し、個々のニーズに対処できる適したものを選択します。 場合によっては、一部のロールは、一時的に適用してデプロイが完了した後で削除する必要があります。

| ビジネス ロール| ビジネス タスク| Azure AD ロール |
|---|---|---|
| ヘルプ デスク管理者 | 通常、エンド ユーザーが報告した問題の特定、ユーザーのパスワード変更、リフレッシュ トークンの無効化、サービス ヘルスの監視といった限られたタスクの実行に限定されます。 | ヘルプデスク管理者 |
| ID 管理者| Azure AD サインイン レポートおよび監査ログを読み、アプリケーション プロキシ関連の問題をデバッグします。| セキュリティ閲覧者 |
| アプリケーションの所有者| エンタープライズ アプリケーション、アプリケーション登録、アプリケーション プロキシの設定の全側面を作成して管理します。| アプリケーション管理者 |
| インフラストラクチャ管理者 | 証明書のロールオーバー所有者 | アプリケーション管理者 |

セキュリティで保護された情報またはリソースへのアクセス権を持つユーザーの数を最小限に抑えると、悪意のあるアクターが許可されていないアクセス権を手にしたり、許可されているユーザーの不注意で機密性の高いリソースに影響が及んだりする可能性が抑えられます。

ただし、ユーザーは特権を使用する操作を毎日実行する必要があるため、Just-In-Time (JIT) ベースの [Privileged Identity Management](../privileged-identity-management/pim-configure.md)ポリシーを適用して、Azure リソースおよび Azure AD にオンデマンド特権アクセスを提供することを、効果的な管理アクセスの管理と監査のアプローチとしてお勧めします。

### <a name="reporting-and-monitoring"></a>レポートと監視

Azure AD は、[監査ログとレポート](../reports-monitoring/concept-provisioning-logs.md?context=azure/active-directory/manage-apps/context/manage-apps-context)によって組織のアプリケーション使用状況と操作の正常性に関する追加の分析情報を提供します。 また、アプリケーション プロキシを使用すると、Azure AD ポータルと Windows イベント ログからのコネクタの監視が非常に簡単になります。

#### <a name="application-audit-logs"></a>アプリケーションの監査ログ

これらのログでは、アプリケーション プロキシで構成されたアプリケーションへのログインと、アプリケーションにアクセスしているデバイスおよびユーザーに関する詳細情報が提供されます。 [監査ログ](../reports-monitoring/concept-provisioning-logs.md?context=azure/active-directory/manage-apps/context/manage-apps-context)は Azure portal 内に、およびエクスポート用の [Audit API](/graph/api/resources/directoryaudit) にあります。 また、[使用状況と分析情報のレポート](../reports-monitoring/concept-usage-insights-report.md?context=azure/active-directory/manage-apps/context/manage-apps-context)もアプリケーションで利用できます。

#### <a name="application-proxy-connector-monitoring"></a>アプリケーション プロキシ コネクタの監視

コネクタとサービスは、高可用性のすべてのタスクに対処します。 Azure AD ポータルの [アプリケーション プロキシ] ページからコネクタの状態を監視できます。 コネクタのメンテナンスの詳細については、「[Azure AD アプリケーション プロキシ コネクタを理解する](./application-proxy-connectors.md#maintenance)」を参照してください。

![例:Azure AD アプリケーション プロキシ コネクタ](./media/application-proxy-connectors/app-proxy-connectors.png)

#### <a name="windows-event-logs-and-performance-counters"></a>Windows イベント ログおよびパフォーマンス カウンター

コネクタには管理者ログとセッション ログがあります。 管理者ログには主要なイベントとそのエラーが含まれます。 セッション ログには、すべてのトランザクションとその処理の詳細が含まれます。 ログとカウンターは Windows イベント ログにあります。詳細については、「[Azure AD アプリケーション プロキシ コネクタを理解する](./application-proxy-connectors.md#under-the-hood)」を参照してください。 [Azure Monitor でイベント ログのデータ ソースを構成するにはこのチュートリアル](../../azure-monitor/agents/data-sources-windows-events.md)に従ってください。

### <a name="troubleshooting-guide-and-steps"></a>トラブルシューティングのガイドと手順

一般的な問題や、それらの問題を解決するためにエラー メッセージを[トラブルシューティング](application-proxy-troubleshoot.md)する方法について学びます。

次の記事では一般的なシナリオが説明されています。これらを使用してサポート組織のために独自のトラブルシューティング ガイドを作成することもできます。

* [アプリ ページを表示できない](application-proxy-page-appearance-broken-problem.md)
* [アプリケーション読み込みに時間がかかりすぎる](application-proxy-page-load-speed-problem.md)
* [アプリケーション ページ上のリンクが動作しない](application-proxy-page-links-broken-problem.md)
* [アプリに対して開く必要のあるポート](application-proxy-add-on-premises-application.md)
* [アプリのコネクタ グループに動作するコネクタがない](application-proxy-connectivity-no-working-connector.md)
* [管理ポータルでの構成](application-proxy-config-how-to.md)
* [アプリに対するシングル サインオンの構成](application-proxy-config-sso-how-to.md)
* [管理ポータルでのアプリの作成に関する問題](application-proxy-config-problem.md)
* [Kerberos の制約付き委任を構成する](application-proxy-back-end-kerberos-constrained-delegation-how-to.md)
* [PingAccess を使用した構成](application-proxy-ping-access-publishing-guide.md)
* ["この企業アプリケーションにアクセスできない" というエラー](application-proxy-sign-in-bad-gateway-timeout-error.md)
* [アプリケーション プロキシ エージェント コネクタのインストールに関する問題](application-proxy-connector-installation-problem.md)
* [サインインの問題](application-sign-in-problem-on-premises-application-proxy.md)
