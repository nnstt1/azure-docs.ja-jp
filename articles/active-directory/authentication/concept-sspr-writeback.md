---
title: セルフサービス パスワード リセットを使用したオンプレミスでのパスワード ライトバック - Azure Active Directory
description: Azure Active Directory でのパスワードの変更またはリセットのイベントを、オンプレミスのディレクトリ環境に書き戻す方法について説明します
services: active-directory
ms.service: active-directory
ms.subservice: authentication
ms.topic: conceptual
ms.date: 10/25/2021
ms.author: justinha
author: justinha
manager: daveba
ms.reviewer: tilarso
ms.collection: M365-identity-device-management
ms.custom: ignite-fall-2021
ms.openlocfilehash: a695c5d207bb441bfc3393ee0c5c1222efac4e79
ms.sourcegitcommit: 106f5c9fa5c6d3498dd1cfe63181a7ed4125ae6d
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 11/02/2021
ms.locfileid: "131063387"
---
# <a name="how-does-self-service-password-reset-writeback-work-in-azure-active-directory"></a>Azure Active Directory でのセルフサービス パスワード リセットによる書き戻しのしくみ

Azure Active Directory (Azure AD) セルフサービス パスワード リセット (SSPR) を使用すると、ユーザーはクラウドでパスワードをリセットできますが、ほとんどの企業にはユーザー向け オンプレミスの Active Directory Domain Services (AD DS) 環境もあります。 パスワード ライトバックを使用すると、クラウド内のパスワード変更を、[Azure AD Connect](../hybrid/whatis-hybrid-identity.md)または [Azure AD Connect クラウド同期](tutorial-enable-cloud-sync-sspr-writeback.md)を使用して、オンプレミスのディレクトリにリアルタイムで書き戻しできます。ユーザーがクラウドで SSPR を使用してパスワードを変更またはリセットすると、更新されたパスワードもオンプレミスの AD DS 環境に書き戻されます。

> [!IMPORTANT]
> 概念に関するこの記事では、セルフサービス パスワード リセットの書き戻しのしくみを管理者向けに説明します。 既にセルフサービス パスワード リセットの登録が済んでいて、自分のアカウントに戻る必要があるエンド ユーザーは、 https://aka.ms/sspr にアクセスしてください。
>
> ユーザーが自分でパスワードをリセットする機能が IT チームによって有効にされていない場合は、ヘルプデスクに連絡して追加のサポートを依頼してください。

パスワード ライトバックは、以下のハイブリッド ID モデルを使用する環境でサポートされます。

* [パスワード ハッシュの同期](../hybrid/how-to-connect-password-hash-synchronization.md)
* [パススルー認証](../hybrid/how-to-connect-pta.md)
* [Active Directory フェデレーション サービス (AD FS)](../hybrid/how-to-connect-fed-management.md)

パスワード ライトバックには、次の機能が用意されています。

* **オンプレミスの Active Directory Domain Services (AD DS) パスワード ポリシーの強制**: ユーザーが自分のパスワードをリセットすると、パスワードがオンプレミスの AD DS ポリシーに準拠していることが確認されてから、そのディレクトリにコミットされます。 この確認には、履歴、複雑さ、年齢、パスワード フィルター、AD DS で定義された他のパスワード制限のチェックが含まれます。
* **ゼロ遅延フィードバック**:  パスワード ライトバックは同期操作です。 ユーザーのパスワードがポリシーに合わなかった場合や、何らかの理由でリセットまたは変更できなかった場合は、すぐにユーザーに通知します。
* **アクセス パネルと Microsoft 365 からのパスワード変更のサポート**: フェデレーション ユーザーかパスワード ハッシュ同期されたユーザーが有効期限切れ、または有効期限切れでないパスワードを変更すると、これらのパスワードは AD DS に書き戻されます。
* **管理者が Azure portal でパスワードをリセットするときのパスワード ライトバックのサポート**: 管理者が [Azure portal](https://portal.azure.com) でユーザーのパスワードをリセットするときに、そのユーザーがフェデレーションまたはパスワード ハッシュ同期されている場合は、パスワードがオンプレミスに書き戻されます。 現在、この機能は Office 管理ポータルではサポートされていません。
* **受信ファイアウォール規則は不要**: パスワード ライトバックは、基盤の通信チャネルとして Azure Service Bus リレーを使います。 すべての通信はポート 443 経由で送信されます。
* **[Azure AD Connect](tutorial-enable-sspr-writeback.md)または[クラウド同期](tutorial-enable-cloud-sync-sspr-writeback.md)を使用した side-by-side ドメインレベルのデプロイをサポートし**、接続されていないドメイン内のユーザーを含め、ニーズに応じて異なるユーザー セットを対象とします。  

> [!NOTE]
> オンプレミスの AD の保護グループ内に存在する管理者アカウントは、パスワード ライトバックに使用できます。 管理者はクラウドでパスワードを変更できますが、忘れたパスワードをリセットすることはできません。 保護グループの詳細については、[AD DS の保護アカウントとグループ](/windows-server/identity/ad-ds/plan/security-best-practices/appendix-c--protected-accounts-and-groups-in-active-directory)に関する記事を参照してください。

SSPR ライトバックの使用を開始するには、次のチュートリアルのいずれかまたは両方を完了します：

- [チュートリアル:セルフサービス パスワード リセット (SSPR) の書き戻しを有効にする](tutorial-enable-cloud-sync-sspr-writeback.md)
- [チュートリアル:クラウドAzure Active Directory Connectオンプレミス環境へのセルフサービス パスワード リセット ライトバックを有効にする (プレビュー)](tutorial-enable-cloud-sync-sspr-writeback.md)

## <a name="azure-ad-connect-and-cloud-sync-side-by-side-deployment"></a>Azure AD Connectクラウド同期のサイド バイ サイド デプロイ

異なるドメインAzure AD Connectクラウド同期をサイド バイ サイドでデプロイして、異なるユーザー セットをターゲットにできます。 これにより、既存のユーザーは引き続きパスワードの変更を書き戻しながら、会社の合併または分割のためにユーザーが切断されたドメインに入っている場合にオプションを追加できます。 Azure AD Connectとクラウド同期を異なるドメインで構成して、あるドメインのユーザーが Azure AD Connect を使用し、別のドメインのユーザーがクラウド同期を使用するようにすることができます。クラウド同期では、クラウド同期の 1 つのインスタンスに依存しないので、より高い可用性Azure AD Connect。 2 つのデプロイ オプションの機能の比較については、「2 つのデプロイ オプションとクラウド同期[Azure AD Connect比較」を参照してください](../cloud-sync/what-is-cloud-sync.md#comparison-between-azure-ad-connect-and-cloud-sync)。

## <a name="how-password-writeback-works"></a>パスワード ライトバックのしくみ

フェデレーション用に構成されたユーザー アカウントで、パスワード ハッシュ同期 (または Azure AD Connect デプロイの場合はパススルー認証) がクラウドでパスワードのリセットまたは変更を試みる場合、次のアクションが実行されます：

1. ユーザーのパスワードの種類のチェックが実行されます。 パスワードがオンプレミスで管理されている場合:
   * ライトバック サービスが稼働しているかどうかのチェックが実行されます。 稼働している場合、ユーザーは続行できます。
   * ライトバック サービスがダウンしている場合は、パスワードを今すぐにはリセットできないことがユーザーに通知されます。
1. 次に、ユーザーが適切な認証ゲートを通過すると、 **[パスワードのリセット]** ページが表示されます。
1. ユーザーは新しいパスワードを選択して確認します。
1. ユーザーが **[送信]** を選択すると、プレーンテキスト パスワードがライトバックのセットアップ プロセス時に作成された公開キーを使って暗号化されます。
1. 暗号化されたパスワードは、HTTPS チャネル経由でテナント固有の Service Bus Relay (ライトバックのセットアップ中に設定される) に送信されるペイロードに含められます。 このリレーは、オンプレミスのインストールのみを認識するランダムに生成されたパスワードによって保護されます。
1. メッセージが Service Bus に到達した後、パスワード リセット エンドポイントが自動的にアクティブになり、保留中のリセット要求があるかどうかが確認されます。
1. サービスは、クラウドのアンカー属性を使ってユーザーを探します。 この検索が成功するには、次の条件が満たされている必要があります。

   * AD DS コネクタ スペースにユーザー オブジェクトが存在している必要がある。
   * ユーザー オブジェクトが対応するメタバース (MV) オブジェクトにリンクされている必要があります。
   * ユーザー オブジェクトが対応する Azure AD コネクタ オブジェクトにリンクされている必要がある。
   * AD DS コネクタ オブジェクトから MV へのリンク上に、同期ルール `Microsoft.InfromADUserAccountEnabled.xxx` が存在する必要があります。

   クラウドからの呼び出しがあると、同期エンジンは **cloudAnchor** 属性を使って Azure AD コネクタ スペース オブジェクトを検索します。 その後、リンクをたどって MV オブジェクトに戻り、さらにリンクをたどって AD DS オブジェクトに戻ります。 同じユーザーに対して複数の AD DS オブジェクト (マルチ フォレスト) がある可能性があるため、同期エンジンは `Microsoft.InfromADUserAccountEnabled.xxx` のリンクに依存して正しいユーザー アカウントを選択します。

1. ユーザー アカウントが見つかると、適切な AD DS フォレスト内で直接パスワードのリセットが試行されます。
1. パスワードの設定操作に成功すると、ユーザーにパスワードが変更されたことが通知されます。

   > [!NOTE]
   > ユーザーのパスワード ハッシュがパスワード ハッシュ同期を使って Azure AD に同期される場合、オンプレミスのパスワード ポリシーが、クラウドのパスワード ポリシーと比べて厳密ではない可能性があります。 この場合は、オンプレミスのポリシーが適用されます。 このポリシーにより、パスワード ハッシュ同期やフェデレーションによるシングル サインオンを提供していたとしても、クラウドでオンプレミスのポリシーが確実に適用されます。

1. パスワード設定操作が失敗した場合、ユーザーにもう一度試すように求めるエラーが表示されます。 次の理由により、操作が失敗することがあります。
    * サービスがダウンしていた。
    * 選択したパスワードが組織のポリシーを満たしていない。
    * ローカル AD DS 環境でユーザーが見つからない。

   エラー メッセージはユーザーにガイダンスを提供するので、ユーザーは管理者の介入なしに解決を試みることができます。

## <a name="password-writeback-security"></a>パスワード ライトバックのセキュリティ

パスワード ライトバックは、安全性の高いサービスです。 ユーザーの情報を確実に保護するために、次のように 4 層のセキュリティ モデルが有効になります。

* **テナント固有の Service Bus Relay**
   * サービスを設定すると、Microsoft でもアクセスできない、ランダムに生成された強力なパスワードで保護されたテナント固有の Service Bus Relay が設定されます。
* **ロックダウンされ、暗号強度の高いパスワード暗号化キー**
   * Service Bus Relay が作成されると、強力な非対称キーが作成され、ネットワーク経由でパスワードが渡されるときに暗号化に使用されます。 このキーは、クラウド内の会社のシークレット ストアのみに存在し、厳重にロックダウンされ、ディレクトリ内の他のパスワードと同様に監査されます。
* **業界標準のトランスポート層セキュリティ (TLS)**
   1. クラウド内でパスワードのリセットや変更操作が行われる場合は、プレーンテキスト パスワードが公開キーを使用して暗号化されます。
   1. 暗号化されたパスワードが HTTPS メッセージに配置され、Microsoft の TLS/SSL 証明書を使って暗号化されたチャネルを介して Service Bus Relay に送信されます。
   1. Service Bus にメッセージが到着すると、オンプレミスのエージェントが起動され、以前に生成された強力なパスワードを使用して Service Bus に認証します。
   1. オンプレミスのエージェントは、暗号化されたメッセージを取得し、秘密キーを使用して復号化します。
   1. オンプレミスのエージェントは、AD DS SetPassword API を使用して、パスワードの設定を試行します。 この手順に従うと、クラウドで AD DS のオンプレミスのパスワード ポリシー (複雑さ、年齢、履歴、フィルターなど) を適用できます。
* **メッセージの有効期限ポリシー**
   * オンプレミスのサービスがダウンしているためメッセージが Service Bus に残っている場合はタイムアウトになり、数分後に削除されます。 タイムアウトとメッセージの削除により、セキュリティがさらに強化されます。

### <a name="password-writeback-encryption-details"></a>パスワード ライトバックの暗号化の詳細

ユーザーがパスワードのリセットを送信した後、リセット要求はオンプレミスの環境に届く前に、いくつかの暗号化ステップを通過します。 これらの暗号化ステップにより、サービスの最大限の信頼性とセキュリティが保証されます。 暗号化ステップの説明を次に示します。

1. **2048 ビット RSA キーによるパスワードの暗号化**: ユーザーが、オンプレミスに書き戻すパスワードを送信すると、送信されたパスワードそのものが 2048 ビット RSA キーを使って暗号化されます。
1. **256 ビット AES-GCM によるパッケージ レベルの暗号化**: AES-GCM を使って、パッケージ全体 (パスワードと必要なメタデータ) が暗号化されます (キー サイズは 256 ビット)。 この暗号化により、Service Bus チャネルに直接アクセスできる人物による内容の表示または改ざんを防止します。
1. **すべての通信が TLS/SSL 経由で行われる**: Service Bus でのすべての通信は、SSL/TLS チャネルで実行されます。 この暗号化により、権限がないサード パーティに対してコンテンツが保護されます。
1. **半年ごとの自動キー ロールオーバー**:半年ごとに、または Azure AD Connect でパスワード ライトバックが無効化されて再び有効化されるたびに、すべてのキーがロールオーバーされ、最大限のサービスのセキュリティと安全性が確保されます。

### <a name="password-writeback-bandwidth-usage"></a>パスワード ライトバックの帯域幅の使用

パスワード ライトバックは帯域幅の低いサービスで、次の状況でのみ要求をオンプレミスのエージェントに戻します。

* Azure AD Connect を通じて機能が有効または無効にされると、2 つのメッセージが送信されます。
* サービスのハートビートとして 5 分おきに 1 回 1 つのメッセージが、サービスを実行している間中、送信されます。
* 新しいパスワードが送信されるたびに 2 つのメッセージが送信されます。
   * 1 番目のメッセージは操作の実行を要求します。
   * 2 番目のメッセージには操作の結果が含まれ、次の状況で送信されます。
      * ユーザーのセルフサービス パスワード リセット時に新しいパスワードが送信された場合
      * ユーザーのパスワード変更操作時に新しいパスワードが送信された場合
      * 管理者によるユーザー パスワードのリセット時に新しいパスワードが送信された場合 (Azure 管理ポータルからのみ)

#### <a name="message-size-and-bandwidth-considerations"></a>メッセージ サイズと帯域幅に関する考慮事項

前に説明した各メッセージのサイズは、通常 1 KB 未満です。 負荷が大きい場合でも、パスワード ライトバック サービス自体で 1 秒間に数キロビットの帯域幅しか消費されないことを意味します。 各メッセージは、パスワードの更新操作で必要になった場合にのみリアルタイムで送信されるため、またメッセージのサイズが非常に小さいため、ライトバック機能の帯域幅は非常に小さく、測定可能な影響を及ぼすには至りません。

## <a name="supported-writeback-operations"></a>サポートされるライトバック操作

パスワードは次の状況で書き戻されます。

* **サポートされるエンドユーザーの操作**
   * エンド ユーザーの自発的なパスワード変更操作。
   * エンドユーザーによる強制的なパスワード変更 (パスワードの期限切れなど)。
   * エンドユーザーにより、[パスワード リセット ポータル](https://passwordreset.microsoftonline.com)から実行されたセルフサービス パスワード リセット。

* **サポートされる管理者の操作**
   * 管理者による自発的なパスワード変更。
   * 管理者による強制的なパスワード変更 (パスワードの期限切れなど)。
   * 管理者により[パスワード リセット ポータル](https://passwordreset.microsoftonline.com)から実行された管理者によるセルフサービス パスワード リセット。
   * [Azure portal](https://portal.azure.com) から管理者が開始したエンドユーザーのパスワードのリセット。
   * [Microsoft Graph API](/graph/api/passwordauthenticationmethod-resetpassword?tabs=http) から管理者が開始したエンドユーザーのパスワードのリセット。

## <a name="unsupported-writeback-operations"></a>サポートされないライトバック操作

パスワードの書き戻しは、次の状況では実行されません。

* **サポートされないエンドユーザーの操作**
   * PowerShell バージョン 1、バージョン 2、または Microsoft Graph API を使った、エンド ユーザーによるパスワードのリセット。
* **サポートされない管理者の操作**
   * PowerShell バージョン 1、またはバージョン 2 から管理者が開始したエンドユーザーのパスワードのリセット。
   * [Microsoft 365 管理センター](https://admin.microsoft.com)から管理者が開始したエンドユーザーのパスワードのリセット。
   * すべての管理者は、パスワード リセット ツールを使用して自身のパスワード ライトバック用パスワードをリセットすることはできません。

> [!WARNING]
> [Active Directory ユーザーとコンピューター] や [Active Directory 管理センター] などのオンプレミスの AD DS 管理ツールでの [ユーザーは次回ログオン時にパスワードの変更が必要] チェックボックスの使用は、Azure AD Connect のプレビュー機能としてサポートされています。 詳細については、「[Azure AD Connect 同期を使用したパスワード ハッシュ同期の実装](../hybrid/how-to-connect-password-hash-synchronization.md)」をご覧ください。

## <a name="next-steps"></a>次のステップ

SSPR 書き戻しの使用を開始するには、次のチュートリアルをご覧ください。

> [!div class="nextstepaction"]
> [チュートリアル:セルフサービス パスワード リセット (SSPR) の書き戻しを有効にする](./tutorial-enable-sspr-writeback.md)
