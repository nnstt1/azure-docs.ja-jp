---
title: シナリオ:仮想ネットワークとブランチのカスタム分離
titleSuffix: Azure Virtual WAN
description: 一部の VNet およびブランチが相互に到達できないようにするための、Virtual WAN ルーティング シナリオについて説明します。
services: virtual-wan
author: cherylmc
ms.service: virtual-wan
ms.topic: conceptual
ms.date: 04/27/2021
ms.author: cherylmc
ms.openlocfilehash: 49e6a65bf14b3d7678a996685efde1b1a2c0a9d3
ms.sourcegitcommit: bb1c13bdec18079aec868c3a5e8b33ef73200592
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 07/27/2021
ms.locfileid: "114719690"
---
# <a name="scenario-custom-isolation-for-virtual-networks-and-branches"></a>シナリオ:仮想ネットワークとブランチのカスタム分離

Virtual WAN の仮想ハブ ルーティングを使用する場合、多くのシナリオを利用できます。 仮想ネットワーク (VNet) とブランチの両方のカスタム分離シナリオでは、VNet の特定のセットが別のセットの VNet に到達するのを防ぐことが目標です。 同様に、ブランチ (VPN、ER、またはユーザー VPN) は、特定の VNet のセットへの接続のみが許可されるようにします。

また、Azure Firewall でブランチから VNet へのトラフィックと VNet からブランチへのトラフィックを検査するが、VNet 間のトラフィックを検査 **しない** 必要があるという追加要件についても説明します。  

仮想ハブ ルーティングの詳細については、「[仮想ハブのルーティングについて](about-virtual-hub-routing.md)」を参照してください。

## <a name="design"></a><a name="design"></a>デザイン

必要なルート テーブルの数を確認するには、接続マトリックスを作成します。 このシナリオでは、次のようになります。各セルは、ソース (行) が宛先 (列) と通信できるかどうかを表します。

| ソース | 移動先:| *青の VNet* | *赤の VNet* | *赤のブランチ*| *青のブランチ*| 
|---|---|---|---|---|---|
| **青の VNet** |   &#8594;|   直接     |           |   |  AzFW|
| **赤の VNet**  |   &#8594;|              |   直接  |  AzFW  | 
| **赤のブランチ**   |   &#8594;|   |   AzFW  |  直接 | 直接
| **青のブランチ**| &#8594;| AzFW  |   |直接   | 直接

前の表の各マスは、仮想 WAN 接続 (フローの "ソース" 側、行ヘッダー) が宛先 (フローの "ターゲット" 側、斜体の列ヘッダー) と通信するかどうかを示しています。 **直接** は、トラフィックが仮想 WAN を介して直接流れることを意味します。一方、**AzFW** は、トラフィックが送信先に転送される前に Azure Firewall によって検査されることを意味します。 空のエントリは、この設定でフローがブロックされていることを意味します。

この場合、VNet の 2 つのルーティング テーブルは、パス内で Azure Firewall なしに VNet 分離の目標を達成するために必要です。 これらのルーティング テーブルは、**RT_BLUE** と **RT_RED** を呼び出します。

また、ブランチは常に **既定の** ルーティング テーブルに関連付けられている必要があります。 ブランチとの間のトラフィックが Azure Firewall によって検査されるようにするには、**既定**、**RT_RED**、**RT_BLUE** の各ルーティング テーブルが、トラフィックを Azure Firewall にポイントする静的ルートを追加し、必要なトラフィックを許可するネットワーク ルールを設定します。 また、ブランチが **RT_BLUE** および **RT_RED** に伝達 **しない** ことも保証します。

その結果、最終的な設計は次のようになります。

* 青の仮想ネットワーク:
  * 関連付けられたルート テーブル:**RT_BLUE**
  * ルート テーブルへの伝達:**RT_BLUE**
* 赤の仮想ネットワーク:
  * 関連付けられたルート テーブル:**RT_RED**
  * ルート テーブルへの伝達:**RT_RED** 
* ブランチ:
  * 関連付けられたルート テーブル: **[Default]**
  * ルート テーブルへの伝達: **[Default]**
* 静的ルート:
    * **既定のルーティング テーブル**:次ホップ Azure Firewall での Virtual Network アドレス空間
    * **RT_RED**:次ホップ Azure Firewall での 0.0.0.0/0
    * **RT_BLUE**:次ホップ Azure Firewall での 0.0.0.0/0
* ファイアウォール ネットワーク ルール:
    * **ALLOW RULE** **ソース プレフィックス**:青のブランチ アドレス プレフィックス **宛先プレフィックス**:青の VNet プレフィックス 
    * **ALLOW RULE** **ソース プレフィックス**:赤のブランチ アドレス プレフィックス **宛先プレフィックス**:赤の VNet プレフィックス

> [!NOTE]
> すべてのブランチは Default ルート テーブルに関連付けられ、同じルーティング テーブルのセットに伝達する必要があるため、すべてのブランチは同じ接続プロファイルを持つことになります。 言い換えると、VNet の赤と青の概念を、ブランチに当てはめることはできません。 ただし、ブランチのカスタム ルーティングを実現するために、ブランチから Azure Firewall にトラフィックを転送できます。

> [!NOTE]
> 既定では Azure Firewall は、ゼロ信頼モデルのトラフィックを拒否します。 検査されたパケットに一致する明示的な **ALLOW** ルールがない場合、Azure Firewall はパケットを削除します。

仮想ハブ ルーティングの詳細については、「[仮想ハブのルーティングについて](about-virtual-hub-routing.md)」を参照してください。



## <a name="workflow"></a><a name="architecture"></a>ワークフロー

**図 1** では、青と赤の VNet に加えて、青または赤のいずれかの VNet にアクセスできるブランチがあります。

* 青の接続された VNet は、互いに通信できるだけでなく、すべての青のブランチ (VPN、ER、または P2S) 接続にも到達できます。 この図では、青のブランチはサイト間 VPN サイトです。
* 赤の接続された VNet は、互いに通信できるだけでなく、すべての赤のブランチ (VPN、ER、または P2S) 接続にも到達できます。 図では、赤のブランチはポイント対サイト VPN ユーザーです。

ルーティングを設定するときは、次の手順を考慮してください。

1. Azure portal に、これらの VNet へのトラフィックをカスタマイズするために、**RT_BLUE** および **RT_RED** の 2 つのカスタム ルーティング テーブルを作成します。
2. ルーティング テーブル **RT_BLUE** では、次の設定を適用して、青の VNet が他のすべての青の VNet のアドレス プレフィックスを学習できるようにします。
   * **Association**: 青の VNet をすべて選択します。
   * **Propagation**:青の VNet をすべて選択します。
3. 赤の VNet の **RT_RED** ルーティング テーブルにも同じ手順を繰り返します。
4. 仮想 WAN で Azure Firewall をプロビジョニングします。 仮想 WAN ハブでの Azure Firewall の詳細については、[仮想 WAN ハブでの Azure Firewall の構成](howto-firewall.md)に関するトピックを参照してください。
5. 仮想ハブの **既定** のルーティング テーブルに静的ルートを追加して、VNet アドレス空間 (青と赤の両方) 宛てのすべてのトラフィックを Azure Firewall に誘導します。 この手順により、ブランチからのパケットが検査のために Azure Firewall に送信されるようになります。
    * 例: **Destination Prefix**:  10.0.0.0/8 **Next Hop**: Azure Firewall
    >[!NOTE]
    > この手順は、Azure Firewall Manager を使用して、[セキュリティで保護されたプライベート トラフィック] オプションを選択することによっても実行できます。 これにより、VNet とブランチに適用されるすべての RFC1918 プライベート IP アドレスのルートが追加されます。 RFC1918 に準拠していないすべてのブランチまたは仮想ネットワークには、手動で追加する必要があります。 

6. **RT_RED** と **RT_BLUE** に、すべてのトラフィックを Azure Firewall に向ける静的ルートを追加します。 この手順により、VNet はブランチに直接アクセスできなくなります。 これらの仮想ネットワークは既定のルーティング テーブルに関連付けられていないため、Azure Firewall Manager を使用してこの手順を実行することはできません。
    * 例:**宛先プレフィックス**: 0.0.0.0/0 **次ホップ**: Azure Firewall

    > [!NOTE]
    > 最長プレフィックス一致 (LPM) を使用してルーティングが実行されます。 その結果、0.0.0.0/0 静的ルートが、**BLUE_RT** と **RED_RT** に存在する正確なプレフィックスよりも優先されることはあり **ません**。 その結果、VNet 内のトラフィックは Azure Firewall によって検査されません。

これで、ルーティング構成が次の図に示すように変更されます。

**図 1**
[ ![図 1](./media/routing-scenarios/custom-branch-vnet/custom-branch.png)](./media/routing-scenarios/custom-branch-vnet/custom-branch.png#lightbox)

## <a name="next-steps"></a>次のステップ

* Virtual WAN の詳細については、[FAQ](virtual-wan-faq.md) を参照してください。
* 仮想ハブ ルーティングの詳細については、「[仮想ハブのルーティングについて](about-virtual-hub-routing.md)」を参照してください。
