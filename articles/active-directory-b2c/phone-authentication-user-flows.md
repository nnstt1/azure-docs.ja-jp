---
title: ローカル アカウント ID プロバイダーを設定する
titleSuffix: Azure AD B2C
description: Azure Active Directory B2C テナントでユーザー フローを設定するときに、ローカル アカウント認証に使用できる ID の種類 (メール アドレス、ユーザー名、電話番号) を定義します。
services: active-directory-b2c
author: kengaderdus
manager: CelesteDG
ms.service: active-directory
ms.workload: identity
ms.topic: how-to
ms.date: 09/20/2021
ms.author: kengaderdus
ms.subservice: B2C
ms.openlocfilehash: 5c63cb4f4e2ce41fa488e49201ba90bfc4b16222
ms.sourcegitcommit: 106f5c9fa5c6d3498dd1cfe63181a7ed4125ae6d
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 11/02/2021
ms.locfileid: "131012835"
---
# <a name="set-up-phone-sign-up-and-sign-in-for-user-flows"></a>ユーザー フローの電話でのサインアップとサインインを設定する

メール アドレスとユーザー名に加えて、電話でのサインアップとサインインをローカル アカウント ID プロバイダーに追加することで、電話番号をサインアップ オプションとしてテナント全体で有効にできます。 ローカル アカウントに対して電話でのサインアップとサインインを有効にすると、ユーザー フローに電話でのサインアップを追加できるようになります。

ユーザー フローにおける電話でのサインアップとサインインの設定には、次の手順が含まれます。

- ローカル アカウント ID プロバイダーで[電話でのサインアップとサインインをテナント全体で構成して](#configure-phone-sign-up-and-sign-in-tenant-wide)、電話番号をユーザーの ID として受け入れます。 

- [電話でのサインアップをユーザー フローに追加して](#add-phone-sign-up-to-a-user-flow)、ユーザーが自分の電話番号を使用してアプリケーションにサインアップできるようにします。

- [回復用メール プロンプト (プレビュー) を有効にして](#enable-the-recovery-email-prompt-preview)、ユーザーが携帯電話を持っていないときにアカウントを回復するために使用できるメール アドレスをユーザーが指定できるようにします。

- サインアップまたはサインインのフロー中にユーザーに[同意情報を表示](#enable-consent-information)します。 既定の同意情報を表示するか、独自の同意情報をカスタマイズできます。

電話でのサインアップを使用したユーザー フローを構成するときは、多要素認証 (MFA) が既定で無効化されます。 電話でのサインアップを使用したユーザー フローで MFA を有効にすることはできますが、電話番号がプライマリ ID として使用されるため、2 番目の認証要素に使用できる唯一のオプションは電子メールによるワンタイム パスコードです。

## <a name="configure-phone-sign-up-and-sign-in-tenant-wide"></a>電話でのサインアップとサインインをテナント全体で構成する

ローカル アカウント ID プロバイダーの設定では、メール アドレスでのサインアップが既定で有効になっています。 テナントでサポートする ID の種類を変更するには、メール アドレスでのサインアップ、ユーザー名、または電話番号を選択または選択解除します。

1. [Azure portal](https://portal.azure.com) にサインインします。
1. ご自分の Azure AD B2C テナントが含まれるディレクトリを必ず使用してください。 ポータル ツールバーの **[Directories + subscriptions]\(ディレクトリ + サブスクリプション\)** アイコンを選択します。
1. **[ポータルの設定] | [Directories + subscriptions]\(ディレクトリ + サブスクリプション\)** ページで Azure AD B2C ディレクトリを **[ディレクトリ名]** リストで見つけ、 **[Switch]** を選択します。
1. Azure portal の左上隅にある **[すべてのサービス]** を選択してから、 **[Azure AD B2C]** を検索して選択します。
1. **[管理]** で、 **[ID プロバイダー]** を選択します。
1. ID プロバイダー リストで、 **[ローカル アカウント]** を選択します。

   ![[ID プロバイダー] で [ローカル アカウント] を選択する](media/phone-authentication-user-flows/identity-provider-local-account.png)

1. **[Configure local IDP]\(ローカル IDP を構成します\)** ページで、コンシューマーが Azure AD B2C テナントにローカル アカウントを作成するために使用できる、許可される ID の種類の 1 つとして **[電話]** が選択されていることを確認します。

   ![許可される ID の種類を選択する](media/phone-authentication-user-flows/configure-local-idp.png)

1. **[保存]** を選択します。

## <a name="add-phone-sign-up-to-a-user-flow"></a>ユーザー フローに電話でのサインアップを追加する

ローカル アカウントの ID オプションとして電話でのサインアップを追加した後で、これをユーザー フローに追加できます。ただし、**推奨されている** 最新のユーザー フロー バージョンである場合に限ります。 新しいユーザー フローに電話でのサインアップを追加する方法を示す例を次に示します。 ただし、既存の推奨されるバージョンのユーザー フローに電話でのサインアップを追加することもできます ( **[ユーザー フロー]**  > *ユーザーフロー名* >  **[ID プロバイダー]**  >  **[Local Account Phone signup]\(ローカル アカウントの電話サインアップ\)** を選択)。 

新しいユーザー フローに電話でのサインアップを追加する方法を示す例を次に示します。

1. [Azure portal](https://portal.azure.com) にサインインします。
1. ご自分の Azure AD B2C テナントが含まれるディレクトリを必ず使用してください。 ポータル ツールバーの **[Directories + subscriptions]\(ディレクトリ + サブスクリプション\)** アイコンを選択します。
1. **[ポータルの設定] | [Directories + subscriptions]\(ディレクトリ + サブスクリプション\)** ページの **[ディレクトリ名]** の一覧で自分の Azure AD B2C ディレクトリを見つけて、 **[切り替え]** を選択します。
1. Azure portal で、 **[Azure AD B2C]** を検索して選択します。
1. **[ポリシー]** で、 **[ユーザー フロー]** を選択し、 **[新しいユーザー フロー]** を選択します。

    ![[新しいユーザー フロー] ボタンが強調表示されているポータル内の [ユーザー フロー] ページ](./media/phone-authentication-user-flows/sign-up-sign-in-user-flow.png)

1. **[ユーザー フローを作成する]** ページで、 **[サインアップとサインイン]** ユーザー フローを選択します。

    ![サインアップとサインインのフローが強調表示されている [ユーザー フローの選択] ページ](./media/phone-authentication-user-flows/select-user-flow-type.png)

1. **[バージョンの選択]** で **[Recommended]\(推奨\)** を選択して、 **[作成]** を選択します。 (ユーザー フローのバージョンに関する[詳細情報](user-flow-versions.md))。

    ![ユーザー フローの作成ボタン](./media/phone-authentication-user-flows/select-version.png)

1. ユーザー フローの **[名前]** (*signupsignin1* など) を入力します。
1. **[ID プロバイダー]** セクションの **[ローカル アカウント]** の下にある **[Phone signup]\(電話でのサインアップ\)** を選択します。

   ![ユーザー フロー **電話でのサインアップ** オプションの選択](media/phone-authentication-user-flows/user-flow-phone-signup.png)

1. **[ソーシャル ID プロバイダー]** で、このユーザー フローに対して許可するその他の ID プロバイダーを選択します。

   > [!NOTE]
   > サインアップのユーザー フローでは、多要素認証 (MFA) は既定で無効になっています。 電話でのサインアップのユーザー フローで MFA を有効にすることはできますが、電話番号がプライマリ ID として使用されるため、2 番目の認証要素に使用できる唯一のオプションは電子メールによるワンタイム パスコードです。

1. **[ユーザー属性とトークン要求]** セクションで、サインアップ中にユーザーから収集して送信する要求と属性を選択します。 たとえば、 **[Show more]\(さらに表示\)** を選択し、 **[国/リージョン]** 、 **[表示名]** 、 **[郵便番号]** の属性と要求を選択します。 **[OK]** を選択します。

1. **[作成]** を選択して、ユーザー フローを追加します。 *B2C_1* というプレフィックスが自動的に名前に追加されます。

## <a name="enable-the-recovery-email-prompt-preview"></a>回復用メール プロンプトを有効にする (プレビュー)

ユーザー フローで電話でのサインアップとサインインを有効にする場合、回復用メール機能を有効にすることもお勧めします。 この機能を使用すると、ユーザーが自分の電話を持っていないときにアカウントを回復するために使用できるメール アドレスを指定できます。 このメール アドレスは、アカウントの回復のみに使用されます。 サインインに使用することはできません。

- 回復用メール プロンプトが **オン** の場合、ユーザーが初めてサインアップするときに、バックアップのメール アドレスの確認を求められます。 前に回復用メールを提供していないユーザーは、次回のサインイン時にバックアップのメール アドレスの確認を求められます。

- 回復用メールが **オフ** の場合、ユーザーがサインアップまたはサインインしても、回復用メール プロンプトは表示されません。
 
ユーザー フローのプロパティで、回復用メール プロンプトを有効にすることができます。

> [!NOTE]
> 開始する前に、前に説明したように、[ユーザー フローに電話でのサインアップが追加されている](#add-phone-sign-up-to-a-user-flow)ことを確認してください。

### <a name="to-enable-the-recovery-email-prompt"></a>回復用メール プロンプトを有効にするには

1. [Azure portal](https://portal.azure.com) にサインインします。
1. ご自分の Azure AD B2C テナントが含まれるディレクトリを必ず使用してください。 ポータル ツールバーの **[Directories + subscriptions]\(ディレクトリ + サブスクリプション\)** アイコンを選択します。
1. **[ポータルの設定] | [Directories + subscriptions]\(ディレクトリ + サブスクリプション\)** ページの **[ディレクトリ名]** の一覧で自分の Azure AD B2C ディレクトリを見つけて、 **[切り替え]** を選択します。
1. Azure portal で、 **[Azure AD B2C]** を検索して選択します。
1. Azure AD B2C の **[ポリシー]** で、 **[ユーザー フロー]** を選択します。
1. 一覧からユーザー フローを選択します。
1. **[設定]** で **[プロパティ]** を選択します。
1. **[Enable recovery email prompt for phone number signup and sign in (preview)]\(電話番号でのサインアップとサインインの回復用メール プロンプトを有効にする (プレビュー)\)** の横で、次のように選択します。

   - **[オン]** : サインアップとサインインの両方で回復用メール プロンプトを表示する。
   - **[オフ]** : 回復用メール プロンプトを非表示にする。

    ![回復用メールを有効にしたユーザー フロー プロパティ](./media/phone-authentication-user-flows/recovery-email-settings.png)

1. **[保存]** を選択します。

### <a name="to-test-the-recovery-email-prompt"></a>回復用メール プロンプトをテストする

ユーザー フローで電話でのサインアップとサインインを有効にし、回復用メール プロンプトを有効にしたら、 **[ユーザー フローを実行します]** を使用してユーザー エクスペリエンスをテストすることができます。

1. **[ポリシー]**  >  **[ユーザー フロー]** を選択して、作成したユーザー フローを選択します。 ユーザー フローの [概要] ページで、 **[ユーザー フローを実行します]** を選択します。

1. **[アプリケーション]** で、手順 1. で登録した Web アプリケーションを選択します。 **[応答 URL]** に `https://jwt.ms` と表示されます。

1. **[ユーザー フローを実行します]** を選択し、次の動作を確認します。

   - 初めてサインアップしたユーザーは、回復用メールを提供するように求められます。 
   - 既にサインアップしていても、回復用メールを提供していないユーザーについては、サインイン時にこれを提供するように求められます。

1. メール アドレスを入力し、 **[確認コードの送信]** を選択します。 指定したメール アドレスの受信トレイにコードが送信されていることを確認します。 コードを取得し、 **[確認コード]** ボックスに入力します。 次に、 **[コードの確認]** を選択します。

## <a name="enable-consent-information"></a>同意情報を有効にする

サインアップおよびサインインのフローに同意情報を含めることを強くお勧めします。 サンプル テキストが提供されています。 [CTIA Web サイト](https://www.ctia.org/programs)にある「Short Code Monitoring Handbook」(ショート コード監視に関するハンドブック) を参照し、ご自身のコンプライアンス ニーズを満たすための最終的なテキストと機能の構成に関するガイダンスについては、法務またはコンプライアンスの専門家に相談してください。
>
> "*電話番号を入力すると、テキスト メッセージによって送信されるワンタイム パスコードの受信に同意したことになり、 *&lt;挿入: アプリケーション名&gt; にサインインできるようになります*"。標準メッセージとデータの通信料が適用される場合があります。*
>
> *&lt;挿入: プライバシーに関する声明へのリンク&gt;*<br/>*&lt;挿入: サービス利用規約へのリンク&gt;*

同意情報を有効にするには

1. [Azure portal](https://portal.azure.com) にサインインします。
1. ご自分の Azure AD B2C テナントが含まれるディレクトリを必ず使用してください。 ポータル ツールバーの **[Directories + subscriptions]\(ディレクトリ + サブスクリプション\)** アイコンを選択します。
1. **[ポータルの設定] | [Directories + subscriptions]\(ディレクトリ + サブスクリプション\)** ページの **[ディレクトリ名]** の一覧で自分の Azure AD B2C ディレクトリを見つけて、 **[切り替え]** を選択します。
1. Azure portal で、 **[Azure AD B2C]** を検索して選択します。
1. Azure AD B2C の **[ポリシー]** で、 **[ユーザー フロー]** を選択します。
1. 一覧からユーザー フローを選択します。
1. **[カスタマイズ]** で、 **[言語]** を選択します。
1. 同意テキストを表示するには、 **[言語のカスタマイズを有効化]** を選択します。
  
    ![言語のカスタマイズを有効化](./media/phone-authentication-user-flows/enable-language-customization.png)

1. 同意情報をカスタマイズするには、一覧から言語を選択します。
1. 言語パネルで、 **[Phone signIn page]\(電話サインイン ページ\)** を選択します。
1. [既定値のダウンロード] を選択します。

    ![既定値のダウンロード](./media/phone-authentication-user-flows/phone-sign-in-language-override.png)

1. ダウンロードした JSON ファイルを開きます。 次のテキストを検索し、それをカスタマイズします。

    - **disclaimer_link_1_url**: **override** を "true" に変更し、プライバシー情報の URL を追加します。

    - **disclaimer_link_2_url**: **override** を "true" に変更し、使用条件の URL を追加します。  

    - **disclaimer_msg_intro**: **override** を "true" に変更し、**value** を目的の免責の文字列に変更します。  

1. ファイルを保存します。 **[Upload new overrides]\(新しいオーバーライドのアップロード\)** で、ファイルを参照して選択します。 "オーバーライドは正常にアップロードされました" という通知が表示されたことを確認します。
1. **[Phone signUp page]\(電話サインアップ ページ\)** を選択し、手順 10 から 12 を繰り返します。 


## <a name="get-a-users-phone-number-in-your-directory"></a>ディレクトリ内のユーザーの電話番号を取得する

1. Graph エクスプローラーで、次の要求を実行します。

   `GET https://graph.microsoft.com/v1.0/users/{object_id}?$select=identities`

1. 返された応答で `issuerAssignedId` プロパティを見つけます。

   ```json
       "identities": [
           {
               "signInType": "phoneNumber",
               "issuer": "contoso.onmicrosoft.com",
               "issuerAssignedId": "+11231231234"
           }
       ]
   ```

## <a name="next-steps"></a>次のステップ

- [外部 ID プロバイダーを追加する](add-identity-provider.md)
- [ユーザー フローを作成する](tutorial-create-user-flows.md)
