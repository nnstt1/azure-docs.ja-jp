---
title: Azure Database for PostgreSQL - フレキシブル サーバー (プレビュー) でのゾーン冗長の高可用性の概要
description: Azure Database for PostgreSQL - フレキシブル サーバーでのゾーン冗長の高可用性の概念について説明します。
author: sr-msft
ms.author: srranga
ms.service: postgresql
ms.topic: conceptual
ms.date: 10/26/2021
ms.openlocfilehash: 80b0d18eec8bbc37eda407d07873786f4155f4be
ms.sourcegitcommit: 702df701fff4ec6cc39134aa607d023c766adec3
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 11/03/2021
ms.locfileid: "131422617"
---
# <a name="high-availability-concepts-in-azure-database-for-postgresql---flexible-server"></a>Azure Database for PostgreSQL - フレキシブル サーバーでの高可用性の概念



Azure Database for PostgreSQL - フレキシブル サーバーは、**ゾーン冗長** サーバー デプロイを使用した自動フェールオーバー機能による高可用性構成を提供します。 ゾーン冗長構成でデプロイされた場合、フレキシブル サーバーによって自動的に、スタンバイ レプリカがプロビジョニングされ、別の可用性ゾーンで管理されます。 データは、PostgreSQL ストリーミング レプリケーションを使用して、**同期** モードでスタンバイ レプリカ サーバーにレプリケートされます。 

ゾーン冗長構成では、ユーザーが開始したコンピューティングのスケーリング操作などの計画的なイベント中だけでなく、基になるハードウェアやソフトウェアの障害、ネットワーク障害、可用性ゾーンの障害などの計画外のイベント中にも、データ損失のない自動フェールオーバー機能が有効になります。 

:::image type="content" source="./media/business-continuity/concepts-zone-redundant-high-availability-architecture.png" alt-text="ゾーン冗長の高可用性"::: 

## <a name="zone-redundant-high-availability-architecture"></a>ゾーン冗長の高可用性のアーキテクチャ

ゾーン冗長デプロイを使用すると、フレキシブル サーバーの高可用性を実現できます。 プライマリ データベース サーバーをデプロイするリージョンと可用性ゾーンを選択できます。 スタンバイ レプリカ サーバーは、プライマリ サーバーと同じコンピューティング、ストレージ、ネットワーク構成を使用して、同じリージョン内の別の可用性ゾーンに **自動的に** プロビジョニングされて管理されます。 データ ファイルとトランザクション ログ ファイル (先書きログ、別名 WAL) は、3 つのデータ コピーとして自動的に格納される、各可用性ゾーン内のローカル冗長ストレージに格納されます。 これにより、プライマリとスタンバイ サーバー間でスタック全体が物理的に分離されます。  

アプリケーションで PostgreSQL ストリーミング レプリケーションを使用して書き込みまたはコミットが実行されると、トランザクション ログ (先書きログ (WAL)) がローカル ディスクに書き込まれ、さらに、"*同期*" モードでスタンバイ レプリカにレプリケートされます。 ログがスタンバイ レプリカに保持されると、書き込みまたはコミットがアプリケーションに通知されます。 スタンバイ サーバーは、ログを適用し続ける復旧モードになりますが、プライマリ サーバーは適用が完了するまで待機しません。

自動バックアップはプライマリ データベース サーバーから定期的に実行されますが、トランザクション ログはスタンバイ レプリカからバックアップ ストレージに継続的にアーカイブされます。

プライマリとスタンバイ サーバーの正常性は継続的に監視され、スタンバイ サーバーへのフェールオーバーのトリガーなど、問題を修復するための適切なアクションが実行されます。 ゾーン冗長の高可用性の状態は次のとおりです。

| **状態** | **説明** |
| ------- | ------ |
| <b> 初期化中 | 新しいスタンバイ サーバーの作成中です。 |
| <b> データのレプリケーション | スタンバイが作成された後、そのスタンバイがプライマリに追いついているところです。 |
| <b> 正常 | レプリケーションは安定状態にあり、正常です。 |
| <b> フェールオーバー | データベース サーバーはスタンバイにフェールオーバー中です。 |
| <b> スタンバイの削除中 | スタンバイ サーバーの削除中です。 | 
| <b> 有効ではない | ゾーン冗長の高可用性は有効ではありません。  |

>[!NOTE]
> 高可用性の有効化はサーバーの作成時に行うことも、後で行うこともできます。 作成後のステージで高可用性の有効化または無効化を行う場合は、プライマリ サーバーのアクティビティが少ないときに操作を実行することをお勧めします。

## <a name="steady-state-operations"></a>安定状態の操作

PostgreSQL クライアント アプリケーションは、DB サーバー名を使用してプライマリ サーバーに接続されます。 アプリケーションの読み取りがプライマリ サーバーから直接処理されるのに対して、コミットと書き込みは、ログ データがプライマリ サーバーとスタンバイ レプリカの両方で保持された後にのみアプリケーションに確認されます。 この追加のラウンド トリップのために、アプリケーションでは、書き込みとコミットの待機時間が長くなることが予想されます。 高可用性の正常性はポータルで監視できます。

:::image type="content" source="./media/business-continuity/concepts-high-availability-steady-state.png" alt-text="ゾーン冗長の高可用性 - 安定状態"::: 

1. クライアントがフレキシブル サーバーに接続し、書き込み操作を実行します。
2. 変更はスタンバイ サイトにレプリケートされます。
3. プライマリが受信確認を受信します。
4. 書き込み/コミットが確認されます。

## <a name="failover-process---planned-downtimes"></a>フェールオーバー プロセス - 計画的なダウンタイム

計画的なダウンタイムのイベントには、Azure のスケジュールされた定期的なソフトウェア更新やマイナー バージョンのアップグレードが含まれます。 高可用性で構成されている場合は、アプリケーションが引き続きプライマリ サーバーにアクセスしている間、これらの操作は最初にスタンバイ レプリカに適用されます。 スタンバイ レプリカが更新されると、プライマリ サーバーの接続がドレインされ、スタンバイ レプリカを同じデータベース サーバー名を持つプライマリとしてアクティブ化するフェールオーバーがトリガーされます。 クライアント アプリケーションは、同じデータベース サーバー名を使用して新しいプライマリ サーバーに再接続する必要があり、その後に操作を再開できます。 新しいスタンバイ サーバーは、古いプライマリと同じゾーン内に確立されます。 

他のユーザーが開始した操作 (コンピューティングのスケーリングやストレージのスケーリングなど) の場合、変更は最初にスタンバイで、その後にプライマリで適用されます。 現在、サービスはスタンバイにフェールオーバーされないので、スケール操作がプライマリ サーバーで実行されている間、アプリケーションで短時間のダウンタイムが発生します。

### <a name="reducing-planned-downtime-with-managed-maintenance-window"></a>管理されたメンテナンス期間による計画的なダウンタイムの短縮

フレキシブル サーバーでは、必要に応じて、データベース上のアクティビティが少ないと予測される任意の日の 30 分の期間を選択することによって、Azure によって開始されるメンテナンス アクティビティをスケジュールできます。 修正プログラムの適用やマイナー バージョンのアップグレードなどの Azure のメンテナンス タスクは、そのメンテナンス期間中に実行されます。 カスタム期間を選択しない場合は、システムによって割り当てられたローカル時刻午後 11 時から午前 7 時の間の 1 時間がサーバーに対して選択されます。 
 
高可用性が構成されているフレキシブル サーバーの場合、これらのメンテナンス アクティビティは最初にスタンバイ レプリカで実行され、サービスはスタンバイにフェールオーバーされます。アプリケーションはスタンバイに再接続できます。

## <a name="failover-process---unplanned-downtimes"></a>フェールオーバー プロセス - 計画外のダウンタイム

計画外の停止には、データベースの可用性に影響を与えるソフトウェアのバグやインフラストラクチャ コンポーネントの障害が含まれます。 プライマリ サーバーが使用できなくなった場合は、監視システムによってそれが検出され、フェールオーバー プロセスが開始されます。  このプロセスには、擬陽性でないことを確認するための数秒間の待機時間が含まれます。 スタンバイ レプリカへのレプリケーションは停止され、スタンバイ レプリカがアクティブ化されてプライマリ データベース サーバーになります。 これには、スタンバイでの残りの WAL ファイルの回復が含まれます。 完全に復旧すると、同じエンド ポイントの DNS がスタンバイ サーバーの IP アドレスで更新されます。 その後、クライアントでは、同じ接続文字列を使用してデータベース サーバーへの再接続を試行し、操作を再開できます。 

>[!NOTE]
> ゾーン冗長の高可用性が構成されているフレキシブル サーバーでは、**ゼロ** (データ損失なし) の回復ポイントの目標 (RPO) が提供されます。目標復旧時間 (RTO) は、通常のケースで **120 秒未満** になることが予想されています。 ただし、フェールオーバー時点でのプライマリ データベース サーバー内のアクティビティによっては、フェールオーバーがこれより長くなる可能性があります。 

フェールオーバー後、新しいスタンバイ サーバーがプロビジョニングされている間、アプリケーションは引き続きプライマリ サーバーに接続し、読み取り/書き込み操作を続行できます。 スタンバイ サーバーが確立されると、フェールオーバー後に生成されたログの復旧が開始されます。 

:::image type="content" source="./media/business-continuity/concepts-high-availability-failover-state.png" alt-text="ゾーン冗長の高可用性 - フェールオーバー"::: 

1. プライマリ データベース サーバーがダウンし、クライアントがデータベース接続を失います。 
2. スタンバイ サーバーが新しいプライマリ サーバーになるようにアクティブ化されます。 クライアントは、同じ接続文字列を使用して新しいプライマリ サーバーに接続します。 クライアント アプリケーションをプライマリ データベース サーバーと同じゾーン内に配置すると、待機時間が短縮され、パフォーマンスが向上します。
3. スタンバイ サーバーは古いプライマリ サーバーと同じゾーン内に確立され、ストリーミング レプリケーションが開始されます。 
4. 安定状態のレプリケーションが確立されると、データが両方のサイトで保持された後、クライアント アプリケーションのコミットと書き込みが確認されます。

## <a name="on-demand-failover"></a>オンデマンド フェールオーバー

フレキシブル サーバーには、スタンバイ サーバーへのオンデマンド フェールオーバーを実行する 2 つの方法が用意されています。 これらは、アプリケーションに対するフェールオーバー時間とダウンタイムの影響をテストする場合や、優先可用性ゾーンにフェールオーバーする場合に便利です。 

### <a name="forced-failover"></a>強制フェールオーバー

この機能を使用すると、運用ワークロードの実行中に計画外の停止シナリオをシミュレートし、アプリケーションのダウンタイムを観察できます。 または、何らかの理由でプライマリ サーバーが応答しなくなるまれなケースで、この機能を使用できます。 

この機能によってプライマリ サーバーの停止がトリガーされ、スタンバイ 昇格操作が実行されるフェールオーバー ワークフローが開始されます。 スタンバイは、最後にコミットされたデータまで復旧プロセスを完了すると、プライマリ サーバーに昇格されます。 DNS レコードが更新され、アプリケーションは昇格されたプライマリ サーバーに接続できます。 新しいスタンバイ サーバーがバックグラウンドで確立されている間、アプリケーションは引き続きプライマリに書き込みを行うことができます。そのことが稼働時間に影響を及ぼすことはありません。 

強制フェールオーバー中は、以下のステップが実行されます。

  | **Step** | **説明** | **アプリのダウンタイムが予想されるかどうか** |
  | ------- | ------ | ----- |
  | 1 | フェールオーバー要求が受信された直後に、プライマリ サーバーが停止されます。 | はい |
  | 2 | プライマリ サーバーがダウンしているため、アプリケーションでダウンタイムが発生します。 | はい |
  | 3 | 内部監視システムによってエラーが検出され、スタンバイ サーバーへのフェールオーバーが開始されます。 | はい |
  | 4 | スタンバイ サーバーは、独立したサーバーとして完全に昇格される前に、回復モードに移行します。 | はい |
  | 5 | フェールオーバー プロセスは、スタンバイの復旧が完了するまで待機します。 | はい |
  | 6 | サーバーが起動すると、DNS レコードは同じホスト名で更新されますが、スタンバイの IP アドレスが使用されます。 | はい |
  | 7 | アプリケーションは新しいプライマリ サーバーに再接続して操作を再開できます。 | いいえ |
  | 8 | 優先ゾーン内のスタンバイ サーバーが確立されます。 | いいえ |
  | 9 | スタンバイ サーバーで、その確立中に失われたログの復旧が (Azure BLOB から) 開始されます。 | いいえ |
  | 10 | プライマリ サーバーとスタンバイ サーバーの間に安定した状態が確立されます。 | いいえ |
  | 11 | 強制フェールオーバー プロセスが完了します。 | いいえ |

アプリケーションのダウンタイムは、ステップ 1 の後に始まり、ステップ 6 が完了するまで継続することが予想されます。 残りの手順は、アプリケーションの書き込みとコミットに影響を与えることなく、バックグラウンドで行われます。

>[!Important]
>エンドツーエンドのフェールオーバー プロセスには、(a) プライマリの障害発生後のスタンバイ サーバーへのフェールオーバーと (b) 定常状態での新しいスタンバイ サーバーの確立が含まれます。 アプリケーションが被るダウンタイムは、あくまでスタンバイへのフェールオーバーが完了するまでです。ダウンタイムは、エンドツーエンドのフェールオーバー プロセス全体ではなく、**アプリケーションとクライアントの観点から測定** してください。 

### <a name="planned-failover"></a>計画されたフェールオーバー

この機能を使用すると、ダウンタイムを短縮してスタンバイ サーバーにフェールオーバーできます。 たとえば、計画されていないフェールオーバーの後に、プライマリがアプリケーションとは異なる可用性ゾーンにあり、そのプライマリ サーバーを前のゾーンに戻してアプリケーションと同じ場所に配置するとします。

この機能を実行する場合は、アプリケーションで読み取りや書き込みを続行できるように、まず、最新のトランザクションに追い付いていることを確認するための準備がスタンバイ サーバーで行われます。 その後、スタンバイが昇格され、プライマリへの接続が切断されます。 新しいスタンバイ サーバーがバックグラウンドで確立されている間、アプリケーションは引き続きプライマリに書き込みを行うことができます。 計画されたフェールオーバーに関連する手順を次に示します。

| **Step** | **説明** | **アプリのダウンタイムが予想されるかどうか** |
  | ------- | ------ | ----- |
  | 1 | スタンバイ サーバーがプライマリに追い付くまで待ちます。 | いいえ |
  | 2 | 内部監視システムによって、フェールオーバー ワークフローが開始されます。 | いいえ |
  | 3 | スタンバイ サーバーがプライマリのログ シーケンス番号 (LSN) に近い場合、アプリケーションの書き込みはブロックされます。 | はい |
  | 4 | スタンバイ サーバーが独立したサーバーに昇格されます。 | はい |
  | 5 | DNS レコードがスタンバイ サーバーの新しい IP アドレスで更新されます。 | はい |
  | 6 | アプリケーションが新しいプライマリに再接続され、読み取り/書き込みが再開されます。 | いいえ |
  | 7 | 別のゾーンの新しいスタンバイ サーバーが確立されます。 | いいえ |
  | 8 | スタンバイ サーバーで、確立中に失われたログの復旧が (Azure BLOB から) 開始されます。 | いいえ |
  | 9 | プライマリ サーバーとスタンバイ サーバーの間に安定した状態が確立されます。 | いいえ |
  | 10 |  計画されたフェールオーバーのプロセスが完了します。 | いいえ |

アプリケーションのダウンタイムは手順 3 から始まり、手順 5 の後に操作を再開できます。 残りの手順は、アプリケーションの書き込みとコミットに影響を与えることなく、バックグラウンドで行われます。 

### <a name="considerations-while-performing-on-demand-failovers"></a>オンデマンド フェールオーバーを実行する際の考慮事項

* エンドツーエンドの全体的な操作時間は、アプリケーションで発生する実際のダウンタイムよりも長く見える可能性があります。 **アプリケーションの観点からダウンタイムを観察してください**。
* フェールオーバーは、すぐに連続して実行しないでください。 次のフェールオーバーまで少なくとも 15 分から 20 分待つと、新しいスタンバイ サーバーが完全に確立されます。
* ダウンタイムが減少する計画されたフェールオーバーの場合、アクティビティの少ない期間中に実行することをお勧めします。

高可用性の管理については、[こちらのガイド](how-to-manage-high-availability-portal.md)を参照してください。


## <a name="point-in-time-restore-of-ha-servers"></a>HA サーバーのポイントインタイム リストア

高可用性が構成されているフレキシブル サーバーでは、ログ データはリアルタイムでスタンバイ サーバーにレプリケートされます。 プライマリ サーバー上のユーザー エラー (テーブルの誤った削除やデータの間違った更新など) もすべて、スタンバイ レプリカにレプリケートされます。 そのため、このような論理エラーから回復するためにスタンバイを使用することはできません。 このようなエラーから回復するには、バックアップからポイントインタイム リストアを実行する必要があります。  フレキシブル サーバーのポイントインタイム リストア機能を使用すると、エラーが発生する前の時刻に復元できます。 高可用性が構成されているデータベースの場合は、新しいデータベース サーバーが、ユーザーが指定した新しいサーバー名を持つ単一ゾーンのフレキシブル サーバーとして復元されます。 復元されたサーバーは、次のような少数のユース ケースに使用できます。

  1. 復元されたサーバーを運用環境で使用でき、必要に応じて、ゾーン冗長の高可用性を有効にできます。 
  2. 単にオブジェクトを復元したい場合は、復元されたデータベース サーバーからオブジェクトをエクスポートして、運用データベース サーバーにインポートできます。 
  3. テストと開発のためにデータベース サーバーを複製したい場合や、その他の目的のために復元したい場合は、ポイントインタイム リストアを実行できます。

## <a name="zone-redundant-high-availability---features"></a>ゾーン冗長の高可用性 - 機能

* スタンバイ レプリカは、仮想コア、ストレージ、ネットワーク設定 (VNET、ファイアウォール) などを含め、プライマリ サーバーとまったく同じ VM 構成でデプロイされます。

* 既存のデータベース サーバーに高可用性を追加できます。

* 高可用性を無効にして、スタンバイ レプリカを削除できます。

* プライマリ データベース サーバーの可用性ゾーンのみ選択できます。 スタンバイ ゾーンは自動選択されます。

* 停止、開始、再起動などの操作は、プライマリとスタンバイの両方のデータベース サーバーで同時に実行されます。

* 自動バックアップはプライマリ データベース サーバーから実行され、ゾーン冗長ストレージに格納されます。

* クライアントは常に、プライマリ データベース サーバーのエンド ホスト名に接続されます。

* サーバー パラメーターへの変更は、スタンバイ レプリカにも適用されます。

* 静的サーバー パラメーターの変更を取得するためにサーバーを再起動する機能。
  
* マイナー バージョンのアップグレードなどの定期的なメンテナンス アクティビティは、ダウンタイムを短縮するために最初にスタンバイで実行され、サービスがフェールオーバーされます。  

## <a name="zone-redundant-high-availability---limitations"></a>ゾーン冗長の高可用性 - 制限

* 高可用性は、バースト可能なコンピューティング レベルではサポートされません。
* 高可用性は、複数のゾーンが使用可能なリージョンでのみサポートされます。
* 別の可用性ゾーンへの同期レプリケーションのために、アプリケーションで書き込みとコミットの待機時間が長くなる場合があります。

* スタンバイ レプリカを読み取りクエリに使用することはできません。

* プライマリ サーバーでのワークロードとアクティビティによっては、昇格する前にスタンバイ レプリカで復旧が必要な場合、フェールオーバー プロセスにかかる時間が 120 秒を超える場合があります。 
* スタンバイ サーバーでは通常、40 MB/秒の速度で WAL ファイルが復旧されます。 ワークロードがこの制限を超える場合、フェールオーバー中または新しいスタンバイの確立後、復旧完了までの時間が延びる可能性があります。 

* プライマリ データベース サーバーを再起動すると、スタンバイ レプリカも再起動されます。 

* 追加の読み取りレプリカの構成はサポートされていません。

* 顧客が開始する管理タスクの構成を、管理されたメンテナンス期間中にスケジュールすることはできません。

* コンピューティングのスケーリングやストレージのスケーリングなどの計画的なイベントは、最初にスタンバイで、その後にプライマリ サーバーで実行されます。 現在、これらの計画的な操作については、サーバーのフェールオーバーは行われません。 

* 論理デコードまたは論理レプリケーションが HA で構成されたフレキシブル サーバーで構成されている場合、スタンバイ サーバーでのフェールオーバー発生時に、論理レプリケーション スロットがスタンバイ サーバーにコピーされることはありません。  

## <a name="availability-without-zone-redundant-ha"></a>ゾーン冗長 HA を使用しない可用性

ゾーン冗長高可用性 **なし** で構成されたフレキシブル サーバーの場合、このサービスにより、計画的または計画外のダウンタイム イベントからの復旧に役立つ組み込みの可用性、ストレージの冗長性、回復性が引き続き提供されます。

### <a name="planned-downtime"></a>計画されたダウンタイム 

次に、計画的なメンテナンス シナリオをいくつか示します。

| **シナリオ** | **説明**|
| ------------ | ----------- |
| <b>コンピューティングのスケールアップ/スケールダウン | ユーザーがコンピューティングのスケールアップ/ダウン操作を実行すると、スケーリングされたコンピューティング構成を使用して新しいデータベース サーバーがプロビジョニングされます。 古いデータベース サーバーでは、アクティブなチェックポイントを完了でき、クライアント接続がドレインされ、コミットされていないトランザクションが取り消され、サーバー自体がシャットダウンされます。 続いてストレージが古いデータベース サーバーからデタッチされ、新しいデータベース サーバーに接続されます。 接続を受け入れるために、稼働状態になります。|
| <b>ストレージのスケール アップ | ストレージのスケールアップは、現在、短時間のダウンタイムを伴うオフライン操作です。|
| <b>新しいソフトウェアのデプロイ (Azure) | 新機能のロールアウトやバグ修正プログラムは、サービスの計画的なメンテナンスの一環として自動的に行われます。 詳細については、[ドキュメント](./concepts-maintenance.md)を参照し、自身の[ポータル](https://aka.ms/servicehealthpm)を確認してください。|
| <b>マイナー バージョンのアップグレード | Azure Database for PostgreSQL では、Azure によって決定されたマイナー バージョンへの修正プログラムが自動的にデータベース サーバーに適用されます。 これは、サービスの計画的なメンテナンスの一環として行われます。 これにより、秒単位の短いダウンタイムが発生し、データベース サーバーは新しいマイナー バージョンで自動的に再起動されます。 詳細については、[ドキュメント](./concepts-maintenance.md)を参照し、自身の[ポータル](https://aka.ms/servicehealthpm)を確認してください。|


###  <a name="unplanned-downtime"></a>計画外のダウンタイム 

計画外のダウンタイムは、基になるハードウェアの障害、ネットワークの問題、ソフトウェアのバグなど、予期しない障害の結果として発生する可能性があります。 データベース サーバーが予期せず停止した場合は、新しいデータベース サーバーが数秒で自動的にプロビジョニングされます。 リモート ストレージは、新しいデータベース サーバーに自動的に接続されます。 PostgreSQL エンジンは、WAL およびデータベース ファイルを使用して復旧操作を実行し、データベース サーバーを開いてクライアントが接続できるようにします。 コミットされていないトランザクションは失われ、アプリケーションが再試行する必要があります。 計画外のダウンタイムは回避できませんが、フレキシブル サーバーでは、データベース サーバーとストレージ レイヤーの両方で、ユーザーの介入を必要とすることなく復旧操作を自動的に実行することでダウンタイムが軽減されます。 

いくつかの障害シナリオと、フレキシブル サーバーが自動的に復旧されるしくみを次に示します。

| **シナリオ** | **自動復旧** |
| ---------- | ---------- |
| <B>データベース サーバーの障害 | 基になるハードウェアの障害が原因でデータベース サーバーが停止した場合、アクティブな接続は切断され、処理中のすべてのトランザクションは中止されます。 新しいデータベース サーバーが自動的にデプロイされ、リモート データ ストレージが新しいデータベース サーバーに接続されます。 データベースの復旧が完了すると、クライアントは同じエンドポイントを使用して新しいデータベース サーバーに接続できるようになります。 <br /> <br /> 復旧時間 (RTO) は、大規模なトランザクションや、データベース サーバーの起動プロセス中に実行される復旧の量など、障害発生時のアクティビティを含め、さまざまな要因によって異なります。 <br /> <br /> PostgreSQL データベースを使用するアプリケーションは、切断された接続や失敗したトランザクションを検出し、再試行するように構築されている必要があります。  |
| <B>ストレージの障害 | アプリケーションは、ディスク障害や物理ブロックの破損など、ストレージ関連の問題の影響を一切認識しません。 データが 3 つのコピーに格納されるので、データのコピーは存続しているストレージから提供されます。 ブロックの破損は自動的に修正されます。 データのコピーが失われると、データの新しいコピーが自動的に作成されます。 |

次に、復旧にユーザーの操作が必要な障害シナリオをいくつか示します。

| **シナリオ** | **復旧計画** |
| ---------- | ---------- |
| <b> 可用性ゾーンの障害 | リージョンで複数の可用性ゾーンがサポートされている場合、バックアップはゾーン冗長バックアップ ストレージに自動的に格納されます。 ゾーンで障害が発生した場合は、バックアップから別の可用性ゾーンに復元できます。 これにより、ゾーン レベルの回復性が提供されます。 ただし、これには復元と回復の時間を伴います。 すべての WAL レコードがバックアップ ストレージにコピーされていない可能性があるため、データ損失が発生する可能性があります。 <br> <br> 短いダウンタイムと高いアップタイムを希望する場合は、ゾーン冗長の高可用性を使用してサーバーを構成することをお勧めします。 |
| <b> 論理/ユーザー エラー | 誤って破棄されたテーブルや間違って更新されたデータなどのユーザーエラーからの復旧には、エラーが発生する直前の時間までデータを復元および復旧することによる、[特定の時点への復旧](./concepts-backup-restore.md) (PITR) の実行が含まれます。<br> <br>  データベース サーバー内のすべてのデータベースではなく、データベースまたは特定のテーブルのサブセットのみを復元する場合は、新しいインスタンスでデータベース サーバーを復元し、[pg_dump](https://www.postgresql.org/docs/13/app-pgdump.html) を使用してテーブルをエクスポートし、[pg_restore](https://www.postgresql.org/docs/13/app-pgrestore.html) を使用してそれらのテーブルをデータベースに復元することができます。 |

## <a name="frequently-asked-questions"></a>よく寄せられる質問

### <a name="ha-configuration-questions"></a>HA 構成に関する質問

* **計画外の停止からサーバーを保護するには、ゾーン冗長 HA が必要ですか?** <br>
    いいえ。 フレキシブル サーバーは、データのコピーが 3 つあるローカル冗長ストレージ、ゾーン冗長バックアップ (サポートされるリージョン内) を提供します。また、クラッシュしたサーバーを自動的に再起動し、サーバーを別の物理ノードに再配置する組み込みのサーバー回復性も提供します。 ゾーン冗長 HA では、別のゾーン内の別の実行中 (スタンバイ) サーバーに対して自動フェールオーバーを実行することで、より高いアップタイムが提供されるため、データ損失がゼロのゾーン回復性がある高可用性が提供されます。

* **ゾーン冗長 HA はすべてのリージョンで利用できますか?** <br>
    ゾーン冗長 HA は、リージョン内で複数の AZ がサポートされているリージョンで利用できます。 最新のリージョン サポートについては、[こちらのドキュメント](overview.md#azure-regions)を参照してください。 Microsoft では継続的に、より多くのリージョンを追加し、複数の AZ を有効にしています。 

* **プライマリ サーバーとスタンバイ サーバーの間のレプリケーション モードはどのようなものですか?** <br>
    プライマリ サーバーとスタンバイ サーバーの間では、同期モードのレプリケーションが確立されます。 アプリケーションの書き込みとコミットは、先書きログ (WAL) データがスタンバイ サイトに保持された後にのみ認められます。 これにより、フェールオーバーが発生した場合のデータ損失をゼロにできます。

* **同期モードでは待機時間が発生します。使用中のアプリケーションには、どのようなパフォーマンスへの影響が予期されるでしょうか?** <br>
    HA での構成により、書き込みとコミットの一定の待機時間が発生します。 読み取りクエリに対する影響はありません。 パフォーマンスへの影響は、実際のワークロードによって異なります。 一般的なガイドラインとして、書き込みとコミットへの影響は、約 20 ～ 30% の影響となる可能性があります。 

* **ゾーン冗長 HA では、計画内の停止や計画外の停止からの保護が提供されますか?** <br>
    はい。 HA の主な目的は、あらゆる停止を減少させる、より高いアップタイムを提供することです。 データベース、VM、物理ノード、データセンター、または AZ レベルでの障害を含め、計画外の停止が発生した場合は、監視システムによって、サーバーは自動的にスタンバイ状態にフェールオーバーされます。 同様に、予定されたメンテナンス期間中に発生する、マイナー バージョンの更新やインフラストラクチャへのパッチ適用などの計画内の停止中には、最初にスタンバイで更新プログラムが適用され、古いプライマリが更新プロセスを実行している間にサービスがフェールオーバーされます。 こうして、全体としてのダウンタイムが短縮されています。 

* **任意の時点で HA を有効または無効にすることはできますか?** <br>

    はい。 サーバーが、停止中、再起動中、既にフェールオーバー処理中などの特定の状態である場合を除き、ゾーン冗長 HA はいつでも有効または無効にできます。 

* **スタンバイ用の AZ を選択できますか?** <br>
    いいえ。 現在のところ、スタンバイ用の AZ を選択することはできません。 この機能は今後追加される予定となっています。

* **プライベート (VNET) アクセスとパブリック アクセスの間に HA を構成できますか?** <br>
    いいえ。 HA を構成できるのは (1 つのリージョン内の複数の AZ にまたがる) VNET 内またはパブリック アクセス内のいずれかです。 

* **リージョン間で HA を構成できますか?** <br>
    いいえ。 HA は 1 つのリージョン内に構成されますが、複数の可用性ゾーンにわたって構成されます。 今後は、ディザスター リカバリー (DR) 目的で、複数のリージョンにわたって構成できる読み取りレプリカを提供する予定です。 この機能が有効になるときに、より多くの詳細が提供されます。 

* **HA で構成されたサーバーで論理レプリケーションを使用できますか?** <br>
    HA と共に論理レプリケーションを構成できます。 ただしフェールオーバー後は、スタンバイに論理スロットの詳細がコピーされません。 このため現時点では、この構成に対するサポートは限定的です。

### <a name="replication-and-failover-related-questions"></a>レプリケーションとフェールオーバーに関連する質問

* **フレキシブル サーバーでは、AZ エラーなどのエラーが発生した場合、どのように高可用性が提供されますか?** <br>
    サーバーでゾーン冗長 HA を有効にすると、プライマリと同じコンピューティングおよびストレージ構成を持つ物理スタンバイ レプリカが、プライマリとは異なる可用性ゾーンに自動的にデプロイされます。 PostgreSQL ストリーミング レプリケーションが、プライマリ サーバーとスタンバイ サーバーの間で確立されます。 

* **停止中の通常のフェールオーバー プロセスは、どのようなものですか?** <br>
    監視システムで障害が検出されると、読み取りや書き込みのためにスタンバイを開く前に、スタンバイで残りの WAL ファイルがすべて適用されていて、完全に遅れを取り戻したことの確認を伴うフェールオーバー ワークフローが開始されます。 次に、スタンバイの IP アドレスを使用して DNS が更新されると、クライアントが同じエンドポイント (ホスト名) を使用してサーバーに再接続できるようになります。 構成を高可用性モードで維持するため、新しいスタンバイがインスタンス化されます。

* **停止中の一般的なフェールオーバー時間と予期されるデータ損失はどれほどですか?** <br>
    一般的なケースでは、フェールオーバー時間、またはアプリケーション側で発生するダウンタイムは、60 秒から 120 秒の間です。 長時間実行されているトランザクション、インデックスの作成、または大量の書き込み操作の間に停止が発生した場合はもっと長くなることがあります。これは、スタンバイで復旧プロセスを完了するのに、より長い時間がかかる可能性があるためです。

    レプリケーションは同期モードで行われるため、データ損失は予期されていません。

* **フェールオーバー時間についての SLA は提供されていますか?** <br>
    フェールオーバー時間については、その操作に通常かかる時間に関するガイドラインを提供しています。 サービスを GA にするときに、全体としてのアップタイムについて正式な SLA が提供されます。 SLA は、パブリック プレビューの間は提供されません。

* **フェールオーバー後、アプリケーションはサーバーに自動的に接続されますか?** <br>
    いいえ。 アプリケーションに、同じエンドポイント (ホスト名) に再接続するための再試行メカニズムを備える必要があります。

* **フェールオーバーのテストはどのように行うのですか?** <br>
    フェールオーバーをテストするには、**強制フェールオーバー** または **計画されたフェールオーバー** 機能を使用できます。 詳細については、このドキュメントの「**オンデマンド フェールオーバー**」セクションを参照してください。

* **レプリケーションの状態は、どのように確認するのですか?** <br>
    ポータル上のサーバーの概要ページに、ゾーン冗長高可用性の状態とサーバーの状態が表示されます。 サーバー ポータルの [高可用性] ブレードで、プライマリとスタンバイの状態と AZ を確認することもできます。 

    psql からは、`select * from pg_stat_replication;` を実行できます。これによって、他の状態とともにストリーミングの状態が表示されます。

* **スタンバイ レプリカでの読み取りクエリはサポートされていますか?** <br>
    いいえ。 スタンバイ レプリカでの読み取りクエリはサポートされていません。

* **ポイントインタイム リストア (PITR) を行うと、復元されたサーバーは HA 内で自動的に構成されますか?** <br>
    いいえ。 PITR サーバーは、スタンドアロン サーバーとして復元されます。 HA を有効にする場合は、復元が完了した後にそれを行えます。


## <a name="next-steps"></a>次のステップ

-   [ビジネス継続性](./concepts-business-continuity.md)について確認する
-   [高可用性を管理する](./how-to-manage-high-availability-portal.md)方法を確認する
-   [バックアップと復旧](./concepts-backup-restore.md)について確認する
