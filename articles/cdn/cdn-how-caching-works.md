---
title: キャッシュのしくみ | Microsoft Docs
description: キャッシュは、後でデータに対する要求があった場合により迅速にアクセスできるように、そのデータをローカルに保存するプロセスです。
services: cdn
documentationcenter: ''
author: duongau
manager: danielgi
editor: ''
ms.assetid: ''
ms.service: azure-cdn
ms.workload: tbd
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 10/19/2021
ms.author: duau
ms.openlocfilehash: d3ffe6cbfb55651664be4bf845099561916aeee1
ms.sourcegitcommit: 702df701fff4ec6cc39134aa607d023c766adec3
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 11/03/2021
ms.locfileid: "131450649"
---
# <a name="how-caching-works"></a>キャッシュのしくみ

この記事では、キャッシュの全般的概念の概要と、[Azure Content Delivery Network (CDN)](cdn-overview.md) がキャッシュを使用してパフォーマンスを向上させるしくみについて説明します。 CDN エンドポイントでのキャッシュの動作をカスタマイズする方法については、[キャッシュ規則による Azure CDN キャッシュ動作の制御](cdn-caching-rules.md)に関するページ、および[クエリ文字列による Azure CDN キャッシュ動作の制御](cdn-query-string.md)に関するページをご覧ください。

## <a name="introduction-to-caching"></a>キャッシュの概要

キャッシュは、後でデータに対する要求があった場合により迅速にアクセスできるように、そのデータをローカルに保存するプロセスです。 キャッシュの種類として最も一般的な Web ブラウザー キャッシュでは、Web ブラウザーによって、静的なデータのコピーがローカルのハード ドライブに格納されます。 キャッシュを使用すると、Web ブラウザーは、サーバーとのラウンド トリップを何回も行わずに済みます。代わりに、ローカルで同じデータにアクセスすることで、時間とリソースを節約できます。 キャッシュは、静的なイメージ、CSS ファイル、JavaScript ファイルなど、小さな静的データをローカルで管理するのに適しています。

同様に、ユーザーに近いエッジ サーバー上のコンテンツ配信ネットワークによって使用されるキャッシュでは、要求が配信元に戻らないようにして、エンドユーザーの待機時間を短縮します。 1 人のユーザーを対象とした Web ブラウザーのキャッシュとは異なり、CDN には共有キャッシュがあります。 CDN 共有キャッシュでは、あるユーザーによって要求されたファイルに、別のユーザーが後からアクセスできるため、配信元サーバーへの要求の数が大幅に少なくなります。

頻繁に変更される動的リソースや、個々のユーザーに固有の動的リソースをキャッシュすることはできません。 ただし、このような種類のリソースは、パフォーマンスを向上させるために、Azure Content Delivery Network で動的サイトの高速化 (DSA) による最適化を利用できます。

キャッシュは、配信元サーバーとエンド ユーザーの間の複数のレベルで発生します。

- Web サーバー:共有キャッシュを使用します (複数のユーザーが対象)。
- コンテンツ配信ネットワーク:共有キャッシュを使用します (複数のユーザーが対象)。
- インターネット サービス プロバイダー (ISP):共有キャッシュを使用します (複数のユーザーが対象)。
- Web ブラウザー:プライベート キャッシュを使用します (1 人のユーザーが対象)。

通常、各キャッシュが独自のリソース更新間隔を管理し、ファイルが古くなったときに検証を実行します。 この動作は、HTTP のキャッシュの仕様 [RFC 7234](https://tools.ietf.org/html/rfc7234) で定義されています。

### <a name="resource-freshness"></a>リソースの更新間隔

キャッシュされたリソースは、(配信元サーバーの対応するリソースと比べて) 古くなっている可能性があるため、コンテンツを最新の情報に更新するタイミングの制御は、すべてのキャッシュ メカニズムにとって重要です。 時間と帯域幅の消費を抑える必要があるため、キャッシュされたリソースにアクセスがあるたびに、配信元サーバーのバージョンと比較されることはありません。 代わりに、キャッシュされたリソースが新鮮であると見なされている間は、最新バージョンであると想定され、クライアントに直接送信されます。 キャッシュされたリソースは、その経過日数が、キャッシュ設定によって定義された経過日数や期間を下回る場合に新鮮であると見なされます。 たとえば、ブラウザーは、Web ページを再度読み込むとき、ハード ドライブ上のキャッシュされた各リソースが新鮮であることを確認したうえで、読み込みます。 リソースが新鮮でない (古くなっている) 場合は、最新のコピーがサーバーから読み込まれます。

### <a name="validation"></a>検証

リソースが古くなっていると見なされると、配信元サーバーは、そのリソースを検証するよう、つまりキャッシュ内のデータが、配信元サーバー上のものとまだ一致しているかどうかを確認するよう求められます。 配信元サーバーのファイルが変更されていると、キャッシュは、そのバージョンのリソースを更新します。 それ以外の場合、つまりリソースが新鮮なときは、データは先に検証されることなく、キャッシュから直接配信されます。

### <a name="cdn-caching"></a>CDN キャッシュ

イメージ、フォント、ビデオなどの静的アセットの配信を高速化し、配信元の負荷を軽減する CDN のしくみにとって、キャッシュは不可欠です。 CDN キャッシュでは、静的リソースが、ユーザーのより近い場所に戦略的に配置されたサーバーに選択的に保存されます。これには、次の利点があります。

- Web トラフィックのほとんどが静的であるため (イメージ、フォント、ビデオなど)、CDN キャッシュでは、ユーザーの近くにコンテンツを移動し、データの移動距離を短くすることで、ネットワークの待ち時間を短縮します。

- CDN に作業をオフロードすることで、キャッシュを通じて、ネットワーク トラフィックと配信元サーバーの負荷を削減できます。 これにより、ユーザー数が多くても、アプリケーションのコストとリソース要件が軽減されます。

Web ブラウザーでキャッシュを実装する方法と同様、キャッシュ ディレクティブ ヘッダーを送信することによって CDN でのキャッシュの実行方法を制御できます。 キャッシュ ディレクティブ ヘッダーは HTTP ヘッダーであり、通常は、配信元サーバーによって追加されます。 元来、こうしたヘッダーのほとんどはクライアント ブラウザーでのキャッシュに対応するためのものでしたが、現在は CDN などのすべての中間キャッシュでも使用されます。 

2 つのヘッダー (`Cache-Control` と `Expires`) を使用して、キャッシュの更新間隔を定義できます。 `Cache-Control` が最新で、`Expires` に優先します (両方が存在する場合)。 検証に使用されるヘッダーの種類も 2 つあります (検証コントロールと呼ばれます)。これは、`ETag` と `Last-Modified` です。 `ETag` が最新で、`Last-Modified` に優先します (両方が定義されている場合)。  

## <a name="cache-directive-headers"></a>キャッシュ ディレクティブ ヘッダー

> [!IMPORTANT]
> 既定では、DSA 用に最適化された Azure CDN エンドポイントは、キャッシュ ディレクティブ ヘッダーを無視し、キャッシュをバイパスします。 **Azure CDN Standard from Verizon** プロファイルおよび **Azure CDN Standard from Akamai** プロファイルの場合は、[CDN キャッシュ ルール](cdn-caching-rules.md)を使ってキャッシュを有効にすることで、Azure CDN エンドポイントがこれらのヘッダーを処理する方法を調整できます。 **Azure CDN Premium from Verizon** プロファイルの場合のみ、[ルール エンジン](./cdn-verizon-premium-rules-engine.md)を使ってキャッシュを有効にします。

Azure CDN では、次の HTTP キャッシュ ディレクティブ ヘッダーがサポートされます。こうしたヘッダーを使用して、キャッシュ期間やキャッシュ共有を定義します。

**Cache-Control:**
- HTTP 1.1 で導入されました。Web 発行元がコンテンツを詳細に制御できるようにします。また、`Expires` ヘッダーの制限に対処します。
- `Expires` ヘッダーをオーバーライドします (これと `Cache-Control` の両方が定義されている場合)。
- クライアントから CDN POP への HTTP 要求で使用すると、`Cache-Control` は、既定ですべての Azure CDN プロファイルによって無視されます。
- クライアントから CDN POP への HTTP 応答で使用された場合は、次のようになります。
     - **Azure CDN Standard/Premium from Verizon** と **Microsoft Azure CDN Standard** はすべての `Cache-Control` ディレクティブをサポートします。
     - **Azure CDN Standard/Premium From Verizon** および **Azure CDN Standard from Microsoft** では、[RFC 7234 - ハイパーテキスト転送プロトコル (HTTP/1.1): キャッシュ (ietf.org)](https://tools.ietf.org/html/rfc7234#section-5.2.2.8) に記載の Cache-Control ディレクティブのキャッシュ動作が優先されます。
     - **Azure CDN Standard from Akamai** は、次の `Cache-Control` ディレクティブのみをサポートし、その他はすべて無視します。
         - `max-age`:キャッシュは、指定された秒数だけコンテンツを格納できます。 たとえば、「 `Cache-Control: max-age=5` 」のように入力します。 このディレクティブは、コンテンツが新鮮であると見なされる最大時間を指定します。
         - `no-cache`:コンテンツをキャッシュします。ただし、毎回キャッシュから配信する前に、そのコンテンツを検証します。 `Cache-Control: max-age=0` と同等です。
         - `no-store`:コンテンツをキャッシュしません。 以前に保存されている場合は、そのコンテンツを削除します。

**Expires:**
- HTTP 1.0 で導入されたレガシ ヘッダー。下位互換性のためにサポートされています。
- 日付ベースの期限切れ日時 (秒単位) を使用します。 
- `Cache-Control: max-age` に似ています。
- `Cache-Control` が存在しない場合に使用されます。

**Pragma:**
   - 既定では、Azure CDN では受け入れられません。
   - HTTP 1.0 で導入されたレガシ ヘッダー。下位互換性のためにサポートされています。
   - `no-cache` ディレクティブを含むクライアント要求ヘッダーとして使用されます。 このディレクティブは、最新バージョンのリソースを配信するようにサーバーに指示します。
   - `Pragma: no-cache` は `Cache-Control: no-cache` に相当します。

## <a name="validators"></a>検証コントロール

キャッシュが古い場合は、HTTP キャッシュ検証コントロールを使用して、キャッシュされたバージョンのファイルと、配信元サーバーのバージョンが比較されます。 **Azure CDN Standard/Premium from Verizon** では、`ETag` 検証コントロールと `Last-Modified` 検証コントロールの両方が既定でサポートされますが、**Microsoft Azure CDN Standard** と **Azure CDN Standard from Akamai** が既定でサポートするのは、`Last-Modified` 検証コントロールのみです。

**ETag:**
- **Azure CDN Standard/Premium from Verizon** では、`ETag` が既定でサポートされますが、**Microsoft Azure CDN Standard** と **Azure CDN Standard from Akamai** ではサポートされていません。
- `ETag` は、すべてのファイルとファイルのバージョンに対して一意の文字列を定義します。 たとえば、「 `ETag: "17f0ddd99ed5bbe4edffdd6496d7131f"` 」のように入力します。
- HTTP 1.1 で導入され、`Last-Modified` よりも新しいものです。 最終更新日を判断するのが難しいときに便利です。
- 強い検証と弱い検証の両方をサポートしますが、Azure CDN では、強い検証のみがサポートされます。 強い検証では、2 つのリソース表現がバイト単位で同一である必要があります。 
- キャッシュは、要求で 1 つ以上の `ETag` 検証コントロールを含む `If-None-Match` ヘッダーを送信することで、`ETag` が使用されているファイルを検証します。 たとえば、「 `If-None-Match: "17f0ddd99ed5bbe4edffdd6496d7131f"` 」のように入力します。 サーバーのバージョンが一覧の `ETag` 検証コントロールと一致する場合、応答で状態コード 304 (変更なし) が送信されます。 バージョンが異なる場合、サーバーは、状態コード 200 (OK) と、更新されたリソースで応答します。

**Last-Modified:**
- **Azure CDN Standard/Premium from Verizon** でのみ、`ETag` が HTTP 応答に含まれない場合、`Last-Modified` が使用されます。 
- リソースが最後に更新されたことが配信元サーバーによって確認された日時を指定します。 たとえば、「 `Last-Modified: Thu, 19 Oct 2017 09:28:00 GMT` 」のように入力します。
- キャッシュは、要求で日時を含む `If-Modified-Since` ヘッダーを送信することで、`Last-Modified` が使用されているファイルを検証します。 配信元サーバーは、その日付と、最新リソースの `Last-Modified` ヘッダーを比較します。 指定されている時刻以降、リソースが変更されていない場合、サーバーは、応答で状態コード 304 (変更なし) を返します。 リソースが変更されている場合、サーバーは、状態コード 200 (OK) と、更新されたリソースを返します。

## <a name="determining-which-files-can-be-cached"></a>キャッシュできるファイルの確認

すべてのリソースをキャッシュできるわけではありません。 次の表は、HTTP 応答の種類に基づいて、どのリソースをキャッシュできるかを示しています。 HTTP 応答で配信されるリソースで、これらの条件のすべてを満たしていないものは、キャッシュすることができません。 **Azure CDN Premium from Verizon** でのみ、ルール エンジンを使用して、これらの条件の一部をカスタマイズできます。

|                       | Microsoft Azure CDN          | Azure CDN from Verizon | Azure CDN from Akamai        |
|-----------------------|-----------------------------------|------------------------|------------------------------|
| **HTTP 状態コード** | 200、203、206、300、301、410、416 | 200                    | 200、203、300、301、302、401 |
| **HTTP メソッド**      | GET、HEAD                         | GET                    | GET                          |
| **ファイル サイズ制限**  | 300 GB                            | 300 GB                 | - 一般的な Web 配信の最適化:1.8 GB<br />- メディア ストリーミングの最適化:1.8 GB<br />- 大きなファイルの最適化:150 GB |

**Microsoft Azure CDN Standard** キャッシュをリソースに対して機能させるには、元のサーバーで、すべての HEAD および GET HTTP 要求をサポートしている必要があり、コンテンツ長の値は、アセットのすべての HEAD および GET HTTP 応答で同じである必要があります。 HEAD 要求の場合、元のサーバーは HEAD 要求をサポートしている必要があり、GET 要求を受信した場合のように、同じヘッダーで応答する必要があります。

## <a name="default-caching-behavior"></a>既定のキャッシュ動作

次の表では、Azure CDN 製品の既定のキャッシュ動作とその最適化について説明します。

|    | Microsoft:一般的な Web 配信 | Verizon:一般的な Web 配信 | Verizon:DSA | Akamai:一般的な Web 配信 | Akamai:DSA | Akamai:大容量ファイルのダウンロード | Akamai: 一般的なメディア ストリーミングまたは VOD メディア ストリーミング |
|------------------------|--------|-------|------|--------|------|-------|--------|
| **配信元を優先**       | はい    | はい   | いいえ   | はい    | いいえ   | はい   | はい    |
| **CDN キャッシュ期間** | 2 日 |7 日 | なし | 7 日 | なし | 1 日 | 1 年 |

**配信元を優先**:サポートされているキャッシュ ディレクティブ ヘッダーを優先するかどうかを指定します (配信元サーバーからの HTTP 応答にそれらのヘッダーが存在する場合)。

**CDN キャッシュ期間**:Azure CDN でリソースをキャッシュする期間を指定します。 ただし、**配信元を優先** が "はい" で、配信元サーバーからの HTTP 応答にキャッシュ ディレクティブ ヘッダー `Expires` または `Cache-Control: max-age` が含まれている場合、Azure CDN は、ヘッダーによって指定された期間の値を代わりに使用します。 

> [!NOTE]
> Azure CDN では、オブジェクトがキャッシュに格納される最小時間については保証されません。 キャッシュされたコンテンツは、より頻繁に要求されるコンテンツの領域を確保するために、それほど頻繁に要求されない場合、期限切れになる前に、CDN キャッシュから削除される可能性があります。
> 

## <a name="next-steps"></a>次のステップ

- キャッシュ規則を使用して CDN の既定のキャッシュ動作をカスタマイズおよびオーバーライドする方法については、[キャッシュ規則による Azure CDN キャッシュ動作の制御](cdn-caching-rules.md)に関するページをご覧ください。 
- クエリ文字列を使用してキャッシュ動作を制御する方法については、[クエリ文字列による Azure CDN キャッシュ動作の制御](cdn-query-string.md)に関するページをご覧ください。
