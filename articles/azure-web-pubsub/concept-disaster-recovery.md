---
title: Azure Web PubSub Service の回復性とディザスター リカバリー
description: 複数の Azure Web PubSub サービス インスタンスをセットアップして回復性とディザスター リカバリーを実現する方法についての概要。
author: vicancy
ms.service: azure-web-pubsub
ms.topic: conceptual
ms.date: 11/08/2021
ms.author: lianwei
ms.openlocfilehash: 14a6661196f7bfa16d3611137d1517c41f21b00d
ms.sourcegitcommit: 512e6048e9c5a8c9648be6cffe1f3482d6895f24
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 11/10/2021
ms.locfileid: "132156524"
---
# <a name="resiliency-and-disaster-recovery-in-azure-web-pubsub-service"></a>Azure Web PubSub Service の回復性とディザスター リカバリー

回復性とディザスター リカバリーは、各種オンライン システムに共通の要件です。 Azure Web PubSub Service では既に 99.9% の可用性が保証されていますが、それはまだリージョン サービスです。

サービス インスタンスはリージョン サービスであり、インスタンスは 1 つのリージョンで実行されます。 リージョン規模の停止が発生したときに、サービスによるリアルタイム メッセージの処理を、別のリージョンで続行することが極めて重要です。 この記事では、ディザスター リカバリーを可能にするサービスをデプロイするために使用できる、いくつかの戦略について説明します。

## <a name="high-available-architecture-for-web-pubsub-service"></a>Web PubSub サービスの高可用性アーキテクチャ

Web PubSub サービスでリージョンをまたぐ回復性を確保するためには、複数のサービス インスタンスを異なるリージョンにセットアップする必要があります。 そうすることで、1 つのリージョンがダウンしても、その他のリージョンをバックアップとして使用することができます。

リージョンをまたぐシナリオの一般的な 1 つの構成は、Web PubSub サービス インスタンスとアプリ サーバーのペアを 2 組 (またはそれ以上) 用意することです。

アプリ サーバーと Web PubSub サービスのペアはそれぞれ同じリージョンに配置され、Web PubSub サービスによって同じリージョン内のアプリ サーバーへのイベント ハンドラー アップストリームが設定されます。

アーキテクチャをわかりやすく説明するために、Web PubSub サービスを同じペアのアプリ サーバーに対する **プライマリ** サービスと呼びます。 また、他のペアの Web PubSub サービスを、アプリ サーバーに対する **セカンダリ** サービスと呼びます。

アプリケーション サーバーでは、[サービス正常性チェック API](/rest/api/webpubsub/dataplane/health-api/get-service-status) を使用して、**プライマリ** サービスと **セカンダリ** サービスが正常であるかどうかが検出されます。 たとえば、`demo` という名前の Web PubSub サービスの場合、サービスが正常であれば、`https://demo.webpubsub.azure.com/api/health` エンドポイントによって 200 が返されます。 アプリ サーバーでは、エンドポイントを定期的に呼び出すかオンデマンドでエンドポイントを呼び出して、エンドポイントが正常かどうかを確認できます。 WebSocket クライアントでは、通常、まずアプリケーション サーバーとの **ネゴシエート** を行って、Web PubSub サービスに接続するための URL が取得され、アプリケーションでは、この **ネゴシエート** 手順を使用して、クライアントの他の正常な **セカンダリ** サービスへのフェールオーバーが行われます。 詳細な手順は次のとおりです。

1. クライアントによるアプリ サーバーとの **ネゴシエート** 時、アプリ サーバーによって返されるのはプライマリ Web PubSub サービス エンドポイントのみであるため、通常の場合、クライアントの接続先はプライマリ エンドポイントのみになります。
1. プライマリ インスタンスがダウンしている場合は、**ネゴシエート** によって正常なセカンダリ エンドポイントが返されるため、クライアントの接続は引き続き可能であり、クライアントはセカンダリ エンドポイントに接続されます。
1. プライマリ インスタンスが起動している場合は、**ネゴシエート** によって正常なプライマリ エンドポイントが返されるため、クライアントではプライマリ エンドポイントに接続できるようになります。
1. アプリ サーバーでメッセージを **ブロードキャスト** する場合は、**プライマリ** と **セカンダリ** の両方を含むすべての **正常** なエンドポイントにメッセージが **ブロードキャスト** される必要があります。
1. アプリ サーバーでは、**セカンダリ** エンドポイントに接続されている接続を閉じることで、クライアントが正常なプライマリ エンドポイントに再接続するように強制できます。

このトポロジによって、すべてのアプリ サーバーと Web PubSub サービス インスタンスが相互接続されているので、引き続き 1 つのサーバーからのメッセージをすべてのクライアントに配信できます。

この戦略は SDK にまだ統合されていないため、今のところ、アプリケーションでこの戦略を単独で実装する必要があります。 

アプリケーション側で実装する必要があるものの要約を次に示します。
1. 正常性チェック: アプリケーションでは、[サービス正常性チェック API](/rest/api/webpubsub/dataplane/health-api/get-service-status) をバックグラウンドで定期的に使用するか、すべての **ネゴシエート** 呼び出しに対してオンデマンドで実行して、サービスが正常であるかどうかを確認できます。
1. ネゴシエート ロジック: 既定では、アプリケーションによって正常な **プライマリ** エンドポイントが返されます。 **プライマリ** エンドポイントがダウンしている場合は、アプリケーションによって正常な **セカンダリ** エンドポイントが返されます。
1. ブロードキャスト ロジック: 複数のクライアントにメッセージを送信する場合、アプリケーションでは、**正常** なすべてのエンドポイントにメッセージをブロードキャストする必要があります。

次の図は、そのようなトポロジを示したものです。

![この図は、それぞれにアプリ サーバーと Web PubSub サービスが存在する 2 つのリージョンを示しています。各サーバーは、プライマリとしてそのリージョン内の Web PubSub サービスに関連付けられ、セカンダリとして他のリージョン内のサービスに関連付けられています。](media/concept-disaster-recovery/topology.png)

## <a name="failover-sequence-and-best-practice"></a>フェールオーバーのシーケンスとベスト プラクティス

以上で、適切なシステム トポロジのセットアップが完了しました。 片方の Web PubSub サービス インスタンスがダウンすると、オンライン トラフィックは他方のインスタンスにルーティングされます。
プライマリ インスタンスがダウンしたとき (そしてその後しばらくしてから復旧するとき) の挙動を次に示します。

1. プライマリ サービス インスタンスがダウンすると、このインスタンスに接続されているすべてのサーバーが切断されます。
2. 新しいクライアントまたは再接続クライアントによるアプリ サーバーとの **ネゴシエート**
2. アプリ サーバーによってプライマリ サービス インスタンスの停止が検出され、ネゴシエートでこのエンドポイントを返すことが停止され、正常なセカンダリエンド ポイントを返すことが開始されます。
3. クライアントは、セカンダリ インスタンスに接続されます。
4. これですべてのオンライン トラフィックがセカンダリ インスタンスに向かうようになりました。 セカンダリはすべてのアプリ サーバーに接続されているため、サーバーからクライアントへのメッセージは依然としてすべて配信されます。 ただし、クライアントからサーバーへのイベント メッセージは、同じリージョン内のアップストリーム アプリ サーバーにのみ送信されます。
5. プライマリ インスタンスが回復してオンラインに戻ると、アプリ サーバーによってプライマリ インスタンスが正常な状態に戻ったことが検出されます。 以後ネゴシエートでは再びプライマリ エンドポイントが返されるようになるので、新しいクライアントは元どおりプライマリに接続されます。 ただし、既存のクライアントは切断されず、自ら切断するまでそのままセカンダリへの接続が続行されます。

下の図は、フェールオーバーのしくみを示しています。

図 1 フェールオーバー前 ![フェールオーバー前](media/concept-disaster-recovery/before-failover.png)

図 2 フェールオーバー後 ![フェールオーバー後](media/concept-disaster-recovery/after-failover.png)

図 3 プライマリの復旧後間もなく ![プライマリの復旧後間もなく](media/concept-disaster-recovery/after-recover.png)

通常は、プライマリのアプリ サーバーと Web PubSub サービスにのみオンライン トラフィック (青色) があることがわかります。

フェールオーバー後は、セカンダリのアプリ サーバーと Web PubSub サービスもアクティブになります。
プライマリの Web PubSub サービスがオンラインに戻った後、新しいクライアントはプライマリの Web PubSub に接続されます。 一方、既存のクライアントはそのままセカンダリに接続された状態になるので、両方のインスタンスにトラフィックが向かうことになります。

既存のクライアントがすべて切断されると、システムが正常な状態に戻ります (図 1)。

リージョンをまたぐ高可用性アーキテクチャを導入する場合、主に次の 2 つのパターンがあります。

1. 1 つ目は、アプリ サーバーと Web PubSub サービス インスタンスの 1 つのペアですべてのオンライン トラフィックを処理し、別のペアをバックアップとして使用する方法です (これは "アクティブ/パッシブ" と呼ばれます。図 1 を参照)。 
2. もう 1 つは、アプリ サーバーと Web PubSub サービス インスタンスのペアを 2 つ (またはそれ以上) 用意し、それぞれのペアでオンライン トラフィックを分担して処理し、他のペアのバックアップとして機能させる方法です (これは "アクティブ/アクティブ" と呼ばれます。図 3 と同様)。

Web PubSub サービスでは両方のパターンをサポートできます。主な違いはアプリ サーバーの実装方法です。
アプリ サーバーがアクティブ/パッシブである場合、Web PubSub サービスもアクティブ/パッシブになります (プライマリのアプリ サーバーから返されるのはそのプライマリ Web PubSub サービス インスタンスのみであるため)。
アプリ サーバーがアクティブ/アクティブである場合、Web PubSub サービスもアクティブ/アクティブになります (すべてのアプリ サーバーから、それぞれのプライマリ Web PubSub インスタンスが返されるので、そのすべてのインスタンスでトラフィックを受けることができます)。

どちらのパターンを使用するにしても、それぞれの Web PubSub サービス インスタンスを **プライマリ** ロールとしてアプリ サーバーに接続する必要があることに注意してください。

また、WebSocket 接続 (長時間接続) の性質上、障害とフェールオーバーが発生すると、クライアントで接続の切断が発生します。
そのようなケースはクライアント側で処理して、エンド ユーザーからは見えないようにする必要があります。 たとえば、接続が閉じられた後で再接続を行うことが考えられます。

## <a name="next-steps"></a>次のステップ

この記事では、Web PubSub サービスに回復性を持たせるためのアプリケーションの構成方法について説明しました。 

[!INCLUDE [next step](includes/include-next-step.md)]
